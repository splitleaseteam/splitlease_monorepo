openapi: 3.0.3
info:
  title: Split Lease API
  description: |
    API for the Split Lease rental marketplace platform.

    ## Authentication

    Most endpoints require authentication via Supabase Auth JWT. Include the token in the Authorization header:

    ```
    Authorization: Bearer YOUR_ACCESS_TOKEN
    ```

    ## Request Format

    All endpoints use action-based routing:

    ```json
    {
      "action": "action_name",
      "payload": {
        "field1": "value1",
        "field2": "value2"
      }
    }
    ```

    ## Response Format

    Success response:
    ```json
    {
      "success": true,
      "data": {
        "result_field1": "value1"
      }
    }
    ```

    Error response:
    ```json
    {
      "success": false,
      "error": "Error message describing what went wrong"
    }
    ```
  version: 1.0.0
  contact:
    name: Split Lease Engineering
    email: support@split.lease
    url: https://split.lease

servers:
  - url: https://splitlease-backend.supabase.co/functions/v1
    description: Production server
  - url: http://localhost:54321/functions/v1
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Proposals
    description: Booking proposals and negotiations
  - name: Listings
    description: Property listings and pricing
  - name: Messages
    description: Real-time messaging
  - name: Reviews
    description: Host and guest reviews

paths:
  /auth-user:
    post:
      tags:
        - Authentication
      summary: Authentication operations
      description: |
        Handle user authentication operations including login, signup, logout, password reset, and OAuth flows.

        **Actions:**
        - `login` - User login via email/password
        - `signup` - User registration
        - `logout` - User logout
        - `validate` - Validate token and fetch user data
        - `request_password_reset` - Send password reset email
        - `update_password` - Update password after reset
        - `oauth_signup` - Handle OAuth signup callback
        - `oauth_login` - Handle OAuth login callback
      operationId: authUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [login, signup, logout, validate, request_password_reset, update_password, oauth_signup, oauth_login]
                  description: The authentication action to perform
                payload:
                  type: object
                  description: Action-specific payload data
            examples:
              login:
                summary: User login
                value:
                  action: login
                  payload:
                    email: john@example.com
                    password: securepass123
              signup:
                summary: User signup
                value:
                  action: signup
                  payload:
                    email: john@example.com
                    password: securepass123
                    retype: securepass123
                    additionalData:
                      firstName: John
                      lastName: Doe
                      userType: Guest
                      birthDate: '1990-01-01'
                      phoneNumber: '+1234567890'
              validate:
                summary: Validate token
                value:
                  action: validate
                  payload:
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    user_id: user_abc123
              request_password_reset:
                summary: Request password reset
                value:
                  action: request_password_reset
                  payload:
                    email: john@example.com
                    redirectTo: https://split.lease/reset-password
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/AuthSuccessResponse'
                  - $ref: '#/components/schemas/UserDataResponse'
              examples:
                login_success:
                  summary: Login successful
                  value:
                    success: true
                    data:
                      accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      userId: user_abc123
                      supabaseUserId: auth_xyz789
                      userType: Guest
                      hostAccountId: host_123
                      guestAccountId: guest_456
                      expiresIn: 3600
                validate_success:
                  summary: Validation successful
                  value:
                    success: true
                    data:
                      userId: user_abc123
                      firstName: John
                      fullName: John Doe
                      email: john@example.com
                      profilePhoto: https://example.com/photo.jpg
                      userType: Guest
                      accountHostId: host_123
                      aboutMe: Software engineer
                      needForSpace: Quiet place to work
                      specialNeeds: None
                      proposalCount: 5
                      hasSubmittedRentalApp: true
                      isUsabilityTester: false
                      phoneNumber: '+1234567890'
                password_reset_sent:
                  summary: Password reset email sent
                  value:
                    success: true
                    data:
                      message: If an account with that email exists, a password reset link has been sent.
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: Validation failed
                  value:
                    success: false
                    error: Email is required
                password_mismatch:
                  summary: Passwords don't match
                  value:
                    success: false
                    error: The two passwords do not match!
        '401':
          description: Unauthorized - authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_credentials:
                  summary: Invalid credentials
                  value:
                    success: false
                    error: Invalid email or password
                token_expired:
                  summary: Token expired
                  value:
                    success: false
                    error: Token has expired. Please log in again.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: An unexpected error occurred. Please try again.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []

  /proposal:
    post:
      tags:
        - Proposals
      summary: Proposal operations
      description: |
        Handle proposal CRUD operations, counteroffers, and acceptance flows.

        **Actions:**
        - `create` - Create new proposal (auth required)
        - `update` - Update existing proposal
        - `get` - Get proposal details
        - `suggest` - Find and create suggestion proposals
        - `acceptProposal` - Accept proposal
        - `create_counteroffer` - Create counteroffer
        - `accept_counteroffer` - Accept counteroffer
      operationId: proposal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [create, update, get, suggest, acceptProposal, create_counteroffer, accept_counteroffer]
                payload:
                  type: object
            examples:
              create:
                summary: Create proposal
                value:
                  action: create
                  payload:
                    listingId: listing_abc123
                    checkInDate: '2026-02-01'
                    checkOutDate: '2026-02-28'
                    selectedDays: [1, 2, 3, 4, 5]
                    guestMessage: Looking forward to staying!
                    rentalApplicationId: rental_app_xyz
              get:
                summary: Get proposal
                value:
                  action: get
                  payload:
                    proposalId: proposal_abc123
              accept:
                summary: Accept proposal
                value:
                  action: acceptProposal
                  payload:
                    proposalId: proposal_abc123
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ProposalResponse'
                  - $ref: '#/components/schemas/SuccessResponse'
              examples:
                proposal_created:
                  summary: Proposal created
                  value:
                    success: true
                    data:
                      proposalId: proposal_abc123
                      listingId: listing_abc123
                      status: pending
                      pricing:
                        nightlyRate: 150
                        weeklyRate: 900
                        fourWeekRate: 3600
                        totalRent: 3600
                        serviceFee: 360
                        total: 3960
                      dates:
                        checkIn: '2026-02-01'
                        checkOut: '2026-02-28'
                        selectedDays: [1, 2, 3, 4, 5]
                proposal_accepted:
                  summary: Proposal accepted
                  value:
                    success: true
                    data:
                      proposalId: proposal_abc123
                      leaseId: lease_xyz789
                      message: Proposal accepted successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: Proposal not found
      security:
        - ApiKeyAuth: []
        - BearerAuth: []

  /listing:
    post:
      tags:
        - Listings
      summary: Listing operations
      description: |
        Handle listing CRUD operations and pricing calculations.

        **Actions:**
        - `create` - Create new listing (minimal data)
        - `get` - Get listing details
        - `submit` - Full listing submission (auth required)
      operationId: listing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [create, get, submit]
                payload:
                  type: object
            examples:
              get:
                summary: Get listing
                value:
                  action: get
                  payload:
                    listingId: listing_abc123
              create:
                summary: Create listing
                value:
                  action: create
                  payload:
                    title: Beautiful Brooklyn Apartment
                    description: Spacious 2BR in prime location
                    streetAddress: 123 Main St
                    city: Brooklyn
                    state: NY
                    zipCode: '11201'
                    baseNightlyRate: 150
                    availableDays: [1, 2, 3, 4, 5]
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListingResponse'
              examples:
                listing_found:
                  summary: Listing found
                  value:
                    success: true
                    data:
                      _id: listing_abc123
                      title: Beautiful Brooklyn Apartment
                      description: Spacious 2BR in prime location
                      baseNightlyRate: 150
                      baseWeeklyRate: 900
                      baseFourWeekRate: 3600
                      availableDays: [1, 2, 3, 4, 5]
                      photos:
                        - photo1.jpg
                        - photo2.jpg
                      status: active
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: Listing not found
      security:
        - ApiKeyAuth: []

  /messages:
    post:
      tags:
        - Messages
      summary: Messaging operations
      description: |
        Handle real-time messaging between guests and hosts.

        **Actions:**
        - `send` - Send message (auth required)
        - `get_thread` - Get message thread (auth required)
        - `list_threads` - List message threads (auth required)
      operationId: messages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [send, get_thread, list_threads]
                payload:
                  type: object
            examples:
              send:
                summary: Send message
                value:
                  action: send
                  payload:
                    recipientId: user_xyz789
                    proposalId: proposal_abc123
                    message: Is the listing still available?
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/MessageResponse'
                  - $ref: '#/components/schemas/MessagesThreadResponse'
              examples:
                message_sent:
                  summary: Message sent
                  value:
                    success: true
                    data:
                      id: msg_uuid
                      threadId: thread_uuid
                      senderId: user_abc123
                      recipientId: user_xyz789
                      message: Is the listing still available?
                      createdAt: '2026-01-29T10:00:00Z'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - BearerAuth: []

components:
  schemas:
    AuthSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            accessToken:
              type: string
              description: Supabase Auth access token
              example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
            refreshToken:
              type: string
              description: Supabase Auth refresh token
              example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
            userId:
              type: string
              description: User ID
              example: user_abc123
            supabaseUserId:
              type: string
              description: Supabase Auth user ID
              example: auth_xyz789
            userType:
              type: string
              enum: [Host, Guest]
              example: Guest
            hostAccountId:
              type: string
              description: Host account ID
              example: host_123
            guestAccountId:
              type: string
              description: Guest account ID
              example: guest_456
            expiresIn:
              type: integer
              description: Token expiration time in seconds
              example: 3600

    UserDataResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            userId:
              type: string
              example: user_abc123
            firstName:
              type: string
              nullable: true
              example: John
            fullName:
              type: string
              nullable: true
              example: John Doe
            email:
              type: string
              nullable: true
              example: john@example.com
            profilePhoto:
              type: string
              nullable: true
              example: https://example.com/photo.jpg
            userType:
              type: string
              nullable: true
              enum: [Host, Guest]
              example: Guest
            accountHostId:
              type: string
              nullable: true
              example: host_123
            aboutMe:
              type: string
              nullable: true
              example: Software engineer
            needForSpace:
              type: string
              nullable: true
              example: Quiet place to work
            specialNeeds:
              type: string
              nullable: true
              example: None
            proposalCount:
              type: integer
              example: 5
            hasSubmittedRentalApp:
              type: boolean
              example: true
            isUsabilityTester:
              type: boolean
              example: false
            phoneNumber:
              type: string
              nullable: true
              example: '+1234567890'

    ProposalResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            proposalId:
              type: string
              example: proposal_abc123
            listingId:
              type: string
              example: listing_abc123
            status:
              type: string
              enum: [pending, accepted, rejected, expired, cancelled, counteroffered]
              example: pending
            pricing:
              type: object
              properties:
                nightlyRate:
                  type: number
                  example: 150
                weeklyRate:
                  type: number
                  example: 900
                fourWeekRate:
                  type: number
                  example: 3600
                totalRent:
                  type: number
                  example: 3600
                serviceFee:
                  type: number
                  example: 360
                total:
                  type: number
                  example: 3960
            dates:
              type: object
              properties:
                checkIn:
                  type: string
                  format: date
                  example: '2026-02-01'
                checkOut:
                  type: string
                  format: date
                  example: '2026-02-28'
                selectedDays:
                  type: array
                  items:
                    type: integer
                    minimum: 0
                    maximum: 6
                  example: [1, 2, 3, 4, 5]

    ListingResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            _id:
              type: string
              example: listing_abc123
            title:
              type: string
              example: Beautiful Brooklyn Apartment
            description:
              type: string
              example: Spacious 2BR in prime location
            baseNightlyRate:
              type: number
              example: 150
            baseWeeklyRate:
              type: number
              example: 900
            baseFourWeekRate:
              type: number
              example: 3600
            availableDays:
              type: array
              items:
                type: integer
                minimum: 0
                maximum: 6
              example: [1, 2, 3, 4, 5]
            photos:
              type: array
              items:
                type: string
              example: [photo1.jpg, photo2.jpg]
            status:
              type: string
              example: active

    MessageResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              example: msg_uuid
            threadId:
              type: string
              format: uuid
              example: thread_uuid
            senderId:
              type: string
              example: user_abc123
            recipientId:
              type: string
              example: user_xyz789
            message:
              type: string
              example: Is the listing still available?
            createdAt:
              type: string
              format: date-time
              example: '2026-01-29T10:00:00Z'

    MessagesThreadResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            threadId:
              type: string
              format: uuid
              example: thread_uuid
            messages:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  senderId:
                    type: string
                  message:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  readAt:
                    type: string
                    format: date-time
                    nullable: true

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          additionalProperties: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Human-readable error message
          example: Invalid email or password

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey
      description: |
        Supabase anonymous key for public access.

        Get your anon key from: https://supabase.com/dashboard/project/_/settings/api

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Supabase Auth JWT token for authenticated access.

        Include in Authorization header: `Bearer YOUR_ACCESS_TOKEN`
