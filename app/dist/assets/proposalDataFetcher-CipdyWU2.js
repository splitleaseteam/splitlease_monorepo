import{r as i,j as e}from"./client-BJVKzfAi.js";import{s as v}from"./supabase-BoCLEw6R.js";import{u as Ve,T as Ke}from"./Toast-BQk6Nzgd.js";import{i as Ie,D as Je,E as Ze,F as Qe,G as Xe,H as et,I as tt,J as st,K as nt,L as ot,v as at,s as rt}from"./auth-QZ4BJadW.js";const it=["Proposal Submitted for guest by Split Lease - Awaiting Rental Application","Proposal Submitted for guest by Split Lease - Pending Confirmation"],Ee={HOST:"A Host (I have a space available to rent)",TRIAL_HOST:"Trial Host",SPLIT_LEASE:"Split Lease"},F={GUEST:"GUEST",HOST:"HOST",TRIAL_HOST:"TRIAL_HOST"};function lt(s){return s?s==="Host"?F.HOST:s==="Guest"?F.GUEST:s===Ee.HOST||s.includes("Host")&&!s.includes("Trial")?F.HOST:s===Ee.TRIAL_HOST||s.includes("Trial")?F.TRIAL_HOST:s===Ee.SPLIT_LEASE?F.HOST:F.GUEST:F.GUEST}function ct(s,a=null){const[r,c]=i.useState({userType:F.GUEST,proposalsCount:0,visitsCount:0,houseManualsCount:0,listingsCount:0,firstListingId:null,virtualMeetingsCount:0,leasesCount:0,favoritesCount:0,unreadMessagesCount:0,suggestedProposalsCount:0,lastSuggestedProposalId:null,threadsCount:0}),[u,p]=i.useState(!0),[_,b]=i.useState(null),x=i.useCallback(async()=>{var m,g,f,j,o;if(!s){p(!1);return}p(!0),b(null);try{console.log("[useLoggedInAvatarData] Fetching data for user:",s);const[d,w,k,I,O,R,Y,D,h,y,E]=await Promise.all([v.from("user").select(`
            _id,
            "Type - User Current",
            "Favorited Listings"
          `).eq("_id",s).single(),v.rpc("get_host_listings",{host_user_id:s}),v.from("visit").select("_id",{count:"exact",head:!0}).eq("Guest",s),v.from("virtualmeetingschedulesandlinks").select("_id",{count:"exact",head:!0}).or(`Guest.eq.${s},Host.eq.${s}`),v.from("bookings_leases").select("_id",{count:"exact",head:!0}).or(`Guest.eq.${s},"Created By".eq.${s}`),v.from("_message").select("_id",{count:"exact",head:!0}).filter('"Unread Users"',"cs",JSON.stringify([s])),v.from("proposal").select('_id, "Created Date"').eq("Guest",s).in("Status",it).or('"Deleted".is.null,"Deleted".eq.false').order("Created Date",{ascending:!1}).limit(10),v.rpc("get_user_junction_counts",{p_user_id:s}),v.from("proposal").select("_id",{count:"exact",head:!0}).eq("Guest",s).or('"Deleted".is.null,"Deleted".eq.false').neq("Status","Proposal Cancelled by Guest"),v.from("proposal").select("_id",{count:"exact",head:!0}).eq("Host User",s).or('"Deleted".is.null,"Deleted".eq.false').neq("Status","Proposal Cancelled by Guest"),v.rpc("count_user_threads",{user_id:s})]),z=d.data;d.error&&console.error("[useLoggedInAvatarData] Error fetching user:",d.error);let B=(z==null?void 0:z["Type - User Current"])||"";if(!B)try{const{data:{session:J}}=await v.auth.getSession();(g=(m=J==null?void 0:J.user)==null?void 0:m.user_metadata)!=null&&g.user_type&&(B=J.user.user_metadata.user_type,console.log("[useLoggedInAvatarData] Got user type from Supabase Auth metadata:",B))}catch(J){console.log("[useLoggedInAvatarData] Could not get Supabase Auth session:",J.message)}let L;B?L=lt(B):a&&Object.values(F).includes(a)?(L=a,console.log("[useLoggedInAvatarData] Using fallback user type from props:",a)):(L=F.GUEST,console.warn("[useLoggedInAvatarData] No user type found, defaulting to GUEST"));const V=h.count||0,se=y.count||0,ne=L===F.GUEST?V:se;h.error&&console.warn("[useLoggedInAvatarData] Guest proposals count failed:",h.error),y.error&&console.warn("[useLoggedInAvatarData] Host proposals count failed:",y.error);const ge=((f=D.data)==null?void 0:f[0])||{};D.error&&console.warn("[useLoggedInAvatarData] Junction counts RPC failed:",D.error);const de=(z==null?void 0:z["Favorited Listings"])||[],me=Array.isArray(de)?de.length:0;let re=0;if(L===F.HOST||L===F.TRIAL_HOST){const J=z==null?void 0:z["House manuals"];re=Array.isArray(J)?J.length:0}const Q=w.data||[];w.error&&console.warn("[useLoggedInAvatarData] Listings query error:",w.error);const U=[...new Set(Q.map(J=>J._id||J.id))].length,X=U===1?((j=Q[0])==null?void 0:j._id)||((o=Q[0])==null?void 0:o.id):null;console.log("[useLoggedInAvatarData] Listings count:",U,"raw:",Q.length),console.log("[useLoggedInAvatarData] Proposals counts:",{userType:L,guestProposals:V,hostProposals:se,effectiveCount:ne}),console.log("[useLoggedInAvatarData] Unread messages result:",{count:R.count,error:R.error,userId:s}),console.log("[useLoggedInAvatarData] Threads result:",{count:E.data,error:E.error,userId:s}),E.error&&console.error("[useLoggedInAvatarData] Error fetching threads:",E.error);const $=Y.data||[],pe=$.length,fe=$.length>0?$[0]._id:null;Y.error&&console.warn("[useLoggedInAvatarData] Suggested proposals query failed:",Y.error);const ie={userType:L,proposalsCount:ne,visitsCount:k.count||0,houseManualsCount:re,listingsCount:U,firstListingId:X,virtualMeetingsCount:I.count||0,leasesCount:O.count||0,favoritesCount:me,unreadMessagesCount:R.count||0,suggestedProposalsCount:pe,lastSuggestedProposalId:fe,threadsCount:E.data||0};console.log("[useLoggedInAvatarData] Data fetched:",ie),c(ie)}catch(d){console.error("[useLoggedInAvatarData] Error:",d),b(d.message)}finally{p(!1)}},[s,a]);return i.useEffect(()=>{x()},[x]),i.useEffect(()=>{if(!s)return;console.log("[useLoggedInAvatarData] Setting up realtime subscription for messages");const m=async()=>{const{count:f,error:j}=await v.from("_message").select("_id",{count:"exact",head:!0}).filter('"Unread Users"',"cs",JSON.stringify([s]));!j&&f!==null&&c(o=>o.unreadMessagesCount!==f?(console.log("[useLoggedInAvatarData] Unread count updated:",o.unreadMessagesCount,"->",f),{...o,unreadMessagesCount:f}):o)},g=v.channel("header-unread-messages").on("postgres_changes",{event:"*",schema:"public",table:"_message"},f=>{console.log("[useLoggedInAvatarData] Message change detected:",f.eventType),m()}).subscribe(f=>{console.log("[useLoggedInAvatarData] Realtime subscription status:",f)});return()=>{console.log("[useLoggedInAvatarData] Cleaning up realtime subscription"),v.removeChannel(g)}},[s]),{data:r,loading:u,error:_,refetch:x}}function dt(s,a=""){const{userType:r,proposalsCount:c,visitsCount:u,houseManualsCount:p,favoritesCount:_,leasesCount:b,suggestedProposalsCount:x}=s,m=r===F.GUEST,g=r===F.HOST,f=r===F.TRIAL_HOST,j=g||f;return{myProfile:!0,myProposals:c>0,myProposalsSuggested:m&&x>0,myListings:j,virtualMeetings:c>0,houseManualsAndVisits:m?u<1:p===0,myLeases:b>0,myFavoriteListings:m&&_>0,messages:!0,rentalApplication:m,reviewsManager:!0,referral:!0}}const ut={fill_out_rental_application:{actionType:"navigate",destination:"/account-profile?section=rental-application&openRentalApp=true"},view_proposal_guest:{actionType:"navigate",destination:"/guest-proposals?proposalId={{proposal_id}}"},host_accepted_proposal_guest_view:{actionType:"navigate",destination:"/guest-proposals?proposalId={{proposal_id}}"},respond_to_counter_offer:{actionType:"navigate",destination:"/guest-proposals?proposalId={{proposal_id}}&respondCounter=true"},view_proposal_host:{actionType:"navigate",destination:"/host-proposals?proposalId={{proposal_id}}"},view_rental_application:{actionType:"navigate",destination:"/host-proposals?proposalId={{proposal_id}}&showApplication=true"},host_accepted_proposal_host_view:{actionType:"navigate",destination:"/host-proposals?proposalId={{proposal_id}}"},review_documents_guest:{actionType:"navigate",destination:"/documents-review?proposalId={{proposal_id}}"},review_documents_host:{actionType:"navigate",destination:"/documents-review?proposalId={{proposal_id}}"},sign_lease_documents_guest:{actionType:"navigate",destination:"/sign-lease?proposalId={{proposal_id}}"},sign_lease_documents_host:{actionType:"navigate",destination:"/sign-lease?proposalId={{proposal_id}}"},lease_docs_signed_guest_view:{actionType:"navigate",destination:"/guest-proposals?proposalId={{proposal_id}}&showPayment=true"},lease_docs_signed_host_view:{actionType:"navigate",destination:"/host-proposals?proposalId={{proposal_id}}"},lease_activated_guest_view:{actionType:"navigate",destination:"/guest-leases?leaseId={{lease_id}}"},lease_activated_host_view:{actionType:"navigate",destination:"/host-leases?leaseId={{lease_id}}"},view_virtual_meeting_guest:{actionType:"modal",destination:"VirtualMeetingModal"},see_virtual_meeting_host:{actionType:"modal",destination:"VirtualMeetingModal"},see_date_change_request:{actionType:"modal",destination:"DateChangeRequestModal"},accept_date_change_request:{actionType:"modal",destination:"DateChangeRequestModal"},decline_date_change_request:{actionType:"modal",destination:"DateChangeRequestModal"},see_house_manual_guest:{actionType:"navigate",destination:"/house-manual?leaseId={{lease_id}}"},see_visit_guest_1:{actionType:"navigate",destination:"/house-manual?leaseId={{lease_id}}"},see_visit_guest_2:{actionType:"navigate",destination:"/house-manual?leaseId={{lease_id}}"},see_visit_guest_3:{actionType:"navigate",destination:"/house-manual?leaseId={{lease_id}}"},fill_out_review_guest:{actionType:"navigate",destination:"/guest-leases?leaseId={{lease_id}}&showReview=true"},fill_out_review_host:{actionType:"navigate",destination:"/host-leases?leaseId={{lease_id}}&showReview=true"},see_review_guest:{actionType:"navigate",destination:"/guest-leases?leaseId={{lease_id}}&viewReview=true"},see_review_host:{actionType:"navigate",destination:"/host-leases?leaseId={{lease_id}}&viewReview=true"},message_split_lease_agent_guest:{actionType:"external",destination:"crisp_chat"},message_split_lease_agent_host:{actionType:"external",destination:"crisp_chat"},acknowledge_reminder_host:{actionType:"none",destination:null},acknowledge_reminder_guest:{actionType:"none",destination:null},see_message:{actionType:"none",destination:null},see_house_manual_host:{actionType:"none",destination:null}};let Ne=null,Pe=null;const gt=5*60*1e3;async function pt(){if(Ne&&Pe&&Date.now()-Pe<gt)return Ne;try{const{data:s,error:a}=await v.schema("reference_table").from("os_messaging_cta").select("*");if(a)return console.error("[ctaConfig] Failed to fetch CTA config:",a),new Map;const r=new Map;for(const c of s){const u=ut[c.name]||{actionType:"none",destination:null},p={...c,...u};r.set(c.display,p),r.set(c.name,p)}return Ne=r,Pe=Date.now(),r}catch(s){return console.error("[ctaConfig] Error fetching CTA config:",s),new Map}}function ht(s,a){if(!s)return null;let r=s;for(const[c,u]of Object.entries(a))u&&(r=r.replace(new RegExp(`\\{\\{${c}\\}\\}`,"g"),u));return r=r.replace(/\{\{[^}]+\}\}/g,""),r=r.replace(/[?&][^=]+=(?=&|$)/g,""),r=r.replace(/\?$/,""),r}function mt({user:s,selectedThread:a,threadInfo:r,onOpenModal:c}){const[u,p]=i.useState(new Map),[_,b]=i.useState(!0);i.useEffect(()=>{async function o(){try{const d=await pt();p(d)}catch(d){console.error("[useCTAHandler] Failed to load CTA config:",d)}finally{b(!1)}}o()},[]);const x=i.useCallback(()=>!a||!(s!=null&&s.bubbleId)?!1:a["-Host User"]===s.bubbleId,[a,s==null?void 0:s.bubbleId]),m=i.useCallback(()=>x()?"host":"guest",[x]),g=i.useCallback(o=>{switch(o){case"crisp_chat":window.$crisp?window.$crisp.push(["do","chat:open"]):console.warn("[useCTAHandler] Crisp chat not available");break;default:console.warn("[useCTAHandler] Unknown external action:",o)}},[]),f=i.useCallback((o,d={})=>{if(!o){console.warn("[useCTAHandler] No CTA type provided");return}const w=u.get(o);if(!w){console.warn("[useCTAHandler] Unknown CTA type:",o);return}const{actionType:k,destination:I}=w;if(!k||k==="none"||!I)return;const O={proposal_id:d.proposalId||(r==null?void 0:r.proposal_id),listing_id:d.listingId||(r==null?void 0:r.listing_id),lease_id:d.leaseId||(r==null?void 0:r.lease_id),date_change_request_id:d.dateChangeRequestId,...d};switch(k){case"navigate":{const R=ht(I,O);R&&(window.location.href=R);break}case"modal":return c&&c(I,O),{modal:I,context:O};case"external":{g(I);break}default:console.warn("[useCTAHandler] Unknown action type:",k)}},[u,r,c,g]),j=i.useCallback(o=>{if(!o)return{text:"View Details",hidden:!1,disabled:!1};const d=u.get(o);if(!d)return{text:"View Details",hidden:!1,disabled:!1};const w=m();if(d.visible_to_guest_only&&w!=="guest")return{hidden:!0};if(d.visible_to_host_only&&w!=="host")return{hidden:!0};if(!d.button_text)return{hidden:!0};const k=d.actionType&&d.actionType!=="none"&&d.destination;return{text:d.button_text,hidden:!1,disabled:!k,actionType:d.actionType}},[u,m]);return{handleCTAClick:f,getCTAButtonConfig:j,isLoadingConfig:_,isUserHost:x,getUserRole:m}}function ft({isOpen:s,userBubbleId:a,userName:r,userAvatar:c,onClose:u}){const[p,_]=i.useState([]),[b,x]=i.useState(null),[m,g]=i.useState([]),[f,j]=i.useState(null),[o,d]=i.useState("list"),[w,k]=i.useState(!0),[I,O]=i.useState(!1),[R,Y]=i.useState(null),[D,h]=i.useState(""),[y,E]=i.useState(!1),[z,B]=i.useState(!1),[L,V]=i.useState(null),se=i.useRef(null),ne=i.useRef(null),ge=i.useRef(!1),de={bubbleId:a},{handleCTAClick:me,getCTAButtonConfig:re}=mt({user:de,selectedThread:b,threadInfo:f,onOpenModal:(C,S)=>{u==null||u()}});i.useEffect(()=>{s&&a&&!ge.current&&l()},[s,a]),i.useEffect(()=>{s||(d("list"),x(null),g([]),h(""),B(!1),V(null))},[s]),i.useEffect(()=>{if(!b||!a||!s)return;const C=`panel-messages-${b._id}`;console.log("[Panel Realtime] Subscribing to:",C);const S=v.channel(C);return S.on("postgres_changes",{event:"INSERT",schema:"public",table:"_message"},A=>{const M=A.new;if(!M||M["Associated Thread/Conversation"]!==b._id)return;const H=M["-Originator User"]===a;g(te=>{if(te.some(be=>be._id===M._id))return te;const xe={_id:M._id,message_body:M["Message Body"],sender_name:M["is Split Bot"]?"Split Bot":H?"You":b.contact_name||"User",sender_avatar:H?c:void 0,sender_type:M["is Split Bot"]?"splitbot":M["-Originator User"]===M["-Host User"]?"host":"guest",is_outgoing:H,timestamp:new Date(M["Created Date"]).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}),call_to_action:M["Call to Action"]?{type:M["Call to Action"],message:"View Details"}:void 0,split_bot_warning:M["Split Bot Warning"]};return[...te,xe]}),H||(B(!1),V(null))}),S.on("presence",{event:"sync"},()=>{const A=S.presenceState(),M=Object.values(A).flat().filter(H=>H.typing&&H.user_id!==a);M.length>0?(B(!0),V(M[0].user_name)):(B(!1),V(null))}),S.subscribe(async A=>{A==="SUBSCRIBED"&&await S.track({user_id:a,user_name:r||"User",typing:!1,online_at:new Date().toISOString()})}),se.current=S,()=>{S.unsubscribe(),se.current=null}},[b==null?void 0:b._id,a,s]);const Q=i.useCallback(async C=>{if(!(!se.current||!a))try{await se.current.track({user_id:a,user_name:r||"User",typing:C,typing_at:C?new Date().toISOString():null,online_at:new Date().toISOString()})}catch(S){console.error("[Panel Realtime] Failed to track typing:",S)}},[a,r]);async function l(){try{k(!0),Y(null);const C=a||Ie();if(!C)throw new Error("User ID not available");const{data:S,error:A}=await v.rpc("get_user_threads",{user_id:C});if(A)throw new Error(`Failed to fetch threads: ${A.message}`);if(!S||S.length===0){_([]),ge.current=!0;return}const M=new Set,H=new Set;S.forEach(P=>{const K=P["-Host User"],Z=P["-Guest User"],oe=K===C?Z:K;oe&&M.add(oe),P.Listing&&H.add(P.Listing)});let te={};if(M.size>0){const{data:P}=await v.from("user").select('_id, "Name - First", "Name - Last", "Profile Photo"').in("_id",Array.from(M));P&&(te=P.reduce((K,Z)=>{const oe=Z["Name - First"]||"",ue=Z["Name - Last"]||"",n=ue?` ${ue.charAt(0)}.`:"",T=oe?`${oe}${n}`:"Unknown User";return K[Z._id]={name:T,avatar:Z["Profile Photo"]},K},{}))}let xe={};if(H.size>0){const{data:P}=await v.from("listing").select("_id, Name").in("_id",Array.from(H));P&&(xe=P.reduce((K,Z)=>(K[Z._id]=Z.Name||"Unnamed Property",K),{}))}const be=S.map(P=>P._id);let Le={};if(be.length>0){const{data:P}=await v.from("_message").select('"Associated Thread/Conversation"').in('"Associated Thread/Conversation"',be).filter('"Unread Users"',"cs",JSON.stringify([C]));P&&(Le=P.reduce((K,Z)=>{const oe=Z["Associated Thread/Conversation"];return K[oe]=(K[oe]||0)+1,K},{}))}const Me=S.map(P=>{const K=P["-Host User"],Z=P["-Guest User"],oe=K===C?Z:K,ue=oe?te[oe]:null,n=P["Modified Date"]?new Date(P["Modified Date"]):new Date,G=new Date().getTime()-n.getTime(),W=Math.floor(G/(1e3*60*60*24));let q;return W===0?q=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):W===1?q="Yesterday":W<7?q=n.toLocaleDateString("en-US",{weekday:"short"}):q=n.toLocaleDateString("en-US",{month:"short",day:"numeric"}),{_id:P._id,"-Host User":K,"-Guest User":Z,contact_name:(ue==null?void 0:ue.name)||"Split Lease",contact_avatar:ue==null?void 0:ue.avatar,property_name:P.Listing?xe[P.Listing]:void 0,last_message_preview:P["~Last Message"]||"No messages yet",last_message_time:q,unread_count:Le[P._id]||0,is_with_splitbot:!1}});_(Me),ge.current=!0}catch(C){console.error("[Panel] Error fetching threads:",C),Y(C.message||"Failed to load conversations")}finally{k(!1)}}async function U(C){try{O(!0);const S=a||Ie(),{data:A,error:M}=await v.functions.invoke("messages",{body:{action:"get_messages",payload:{thread_id:C,user_id:S}}});if(M)throw new Error(M.message||"Failed to fetch messages");if(A!=null&&A.success)g(A.data.messages||[]),j(A.data.thread_info||null);else throw new Error((A==null?void 0:A.error)||"Failed to fetch messages")}catch(S){console.error("[Panel] Error fetching messages:",S)}finally{O(!1)}}async function X(){if(!(!D.trim()||!b||y))try{E(!0),Q(!1),ne.current&&clearTimeout(ne.current);const C=a||Ie(),{data:S,error:A}=await v.functions.invoke("messages",{body:{action:"send_message",payload:{thread_id:b._id,message_body:D.trim(),user_id:C}}});if(A)throw new Error(A.message||"Failed to send message");if(S!=null&&S.success){h("");const M={_id:S.data.message_id,message_body:D.trim(),sender_name:"You",sender_type:"guest",is_outgoing:!0,timestamp:new Date().toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})};g(H=>H.some(te=>te._id===M._id)?H:[...H,M]),_(H=>H.map(te=>te._id===b._id?{...te,last_message_preview:D.trim(),last_message_time:"Just now"}:te))}else throw new Error((S==null?void 0:S.error)||"Failed to send message")}catch(C){console.error("[Panel] Error sending message:",C),Y(C.message||"Failed to send message")}finally{E(!1)}}const $=i.useCallback(C=>{console.log("[Panel] Thread selected:",C._id,C.contact_name),x(C),g([]),j(null),d("thread"),B(!1),V(null),U(C._id),C.unread_count>0&&_(S=>S.map(A=>A._id===C._id?{...A,unread_count:0}:A))},[]),pe=i.useCallback(()=>{d("list"),x(null),g([]),h(""),B(!1),V(null)},[]),fe=i.useCallback(C=>{C.length<=1e3&&(h(C),Q(!0),ne.current&&clearTimeout(ne.current),ne.current=setTimeout(()=>{Q(!1)},2e3))},[Q]),ie=i.useCallback(()=>{X()},[D,b,y]),J=i.useCallback(()=>{Y(null),ge.current=!1,l()},[]),Te=i.useCallback(()=>{ge.current=!1,l()},[]);return{threads:p,selectedThread:b,messages:m,threadInfo:f,viewState:o,isLoading:w,isLoadingMessages:I,error:R,messageInput:D,isSending:y,isOtherUserTyping:z,typingUserName:L,handleThreadSelect:$,handleBackToList:pe,handleMessageInputChange:fe,handleSendMessage:ie,handleRetry:J,refreshThreads:Te,handleCTAClick:me,getCTAButtonConfig:re}}function yt(s){if(!s)return"??";const a=s.trim().split(" ").filter(Boolean);return a.length>=2?(a[0][0]+a[a.length-1][0]).toUpperCase():s.slice(0,2).toUpperCase()}function xt({thread:s,isSelected:a,onClick:r}){const c=yt(s.contact_name),u=s.contact_role,p=s.last_message_is_mine?`You: ${s.last_message_preview||""}`:s.last_message_preview||"No messages yet";return e.jsxs("div",{className:`thread-card ${a?"thread-card--selected":""} ${s.unread_count>0?"thread-card--unread":""}`,onClick:r,role:"button",tabIndex:0,onKeyDown:_=>{(_.key==="Enter"||_.key===" ")&&(_.preventDefault(),r())},"aria-selected":a,children:[e.jsxs("div",{className:"thread-card__avatar-container",children:[s.contact_avatar?e.jsx("img",{src:s.contact_avatar,alt:s.contact_name||"Contact",className:"thread-card__avatar",onError:_=>{_.target.style.display="none",_.target.nextElementSibling.style.display="flex"}}):null,e.jsx("div",{className:"thread-card__avatar-placeholder",style:{display:s.contact_avatar?"none":"flex"},children:c}),s.is_online&&e.jsx("span",{className:"thread-card__online-dot"})]}),e.jsxs("div",{className:"thread-card__content",children:[e.jsxs("div",{className:"thread-card__name-row",children:[e.jsx("span",{className:"thread-card__name",children:s.contact_name||"Unknown Contact"}),u&&e.jsx("span",{className:`thread-card__role-badge thread-card__role-badge--${u}`,children:u})]}),s.property_name&&e.jsx("span",{className:"thread-card__property",children:s.property_name}),e.jsx("p",{className:"thread-card__preview",children:p})]}),e.jsxs("div",{className:"thread-card__meta",children:[e.jsx("span",{className:"thread-card__time",children:s.last_message_time||""}),s.unread_count>0&&e.jsx("span",{className:"thread-card__unread","aria-label":`${s.unread_count} unread messages`,children:s.unread_count>99?"99+":s.unread_count})]})]})}function bt(s){const a=s.trim().split(" ").filter(Boolean);return a.length===0?"?":a.length===1?a[0][0].toUpperCase():(a[0][0]+a[a.length-1][0]).toUpperCase()}function vt({message:s,onCTAClick:a,getCTAButtonConfig:r,messageContext:c}){var f;const u=s.is_outgoing,p=s.sender_type==="splitbot",_=(f=s.call_to_action)==null?void 0:f.type,b=_&&r?r(_):null,x=()=>{if(a&&_){const j={...c,dateChangeRequestId:s.date_change_request_id,reviewId:s.review_id};a(_,j)}},m=s.call_to_action&&b&&!b.hidden,g=p?"Split Bot":s.sender_name||"Unknown";return e.jsxs("div",{className:`message-row ${u?"outgoing":""} ${p?"message-row--splitbot":""}`,children:[e.jsx("div",{className:"msg-avatar",children:e.jsx("div",{className:`msg-avatar-placeholder ${u?"me":""}`,children:p?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"16",height:"16",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})}):bt(g)})}),e.jsxs("div",{className:"msg-content",children:[e.jsxs("div",{className:"msg-header",children:[e.jsx("span",{className:"msg-sender",children:u?"You":g}),e.jsx("span",{className:"msg-time",children:s.timestamp||""})]}),e.jsxs("div",{className:"msg-bubble",children:[e.jsx("p",{className:"msg-text",children:s.message_body}),m&&e.jsx("button",{className:`message-bubble__cta ${b.disabled?"message-bubble__cta--disabled":""}`,onClick:x,disabled:b.disabled,children:b.text}),s.split_bot_warning&&e.jsxs("div",{className:"message-bubble__warning",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),e.jsx("span",{children:s.split_bot_warning})]})]})]})]})}function _t({value:s,onChange:a,onSend:r,disabled:c,isSending:u}){const p=i.useRef(null);i.useEffect(()=>{const g=p.current;if(g){g.style.height="auto";const d=21*5+24,w=Math.min(g.scrollHeight,d);g.style.height=`${w}px`,g.style.overflowY=g.scrollHeight>d?"auto":"hidden"}},[s]);const _=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),!c&&s.trim()&&r())},b=s.length,x=1e3,m=b>x*.9;return e.jsx("div",{className:"message-input",children:e.jsxs("div",{className:"message-input__wrapper",children:[e.jsxs("div",{className:"message-input__container",children:[e.jsx("textarea",{ref:p,className:"message-input__field",placeholder:c?"Select a conversation to send a message":"Type a message...",value:s,onChange:g=>a(g.target.value),onKeyDown:_,disabled:c,maxLength:x,"aria-label":"Message input",rows:1}),e.jsxs("div",{className:"message-input__toolbar",children:[e.jsx("button",{type:"button",className:"message-input__toolbar-btn","aria-label":"Format text",title:"Format text",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),e.jsx("button",{type:"button",className:"message-input__toolbar-btn","aria-label":"Attach file",title:"Attach file",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"})})}),e.jsx("button",{type:"button",className:"message-input__toolbar-btn","aria-label":"Add image",title:"Add image",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),e.jsx("div",{className:"message-input__toolbar-divider"}),e.jsx("button",{type:"button",className:"message-input__toolbar-btn","aria-label":"Add emoji",title:"Add emoji",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M8 14s1.5 2 4 2 4-2 4-2"}),e.jsx("line",{x1:"9",y1:"9",x2:"9.01",y2:"9"}),e.jsx("line",{x1:"15",y1:"9",x2:"15.01",y2:"9"})]})}),e.jsx("div",{className:"message-input__toolbar-spacer"}),m&&e.jsxs("span",{className:`message-input__count ${b>=x?"message-input__count--limit":""}`,children:[b,"/",x]})]})]}),e.jsx("button",{className:"message-input__send",onClick:r,disabled:c||!s.trim()||u,"aria-label":"Send message",children:u?e.jsx("div",{className:"message-input__sending-spinner"}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M2 21l21-9L2 3v7l15 2-15 2v7z",fill:"currentColor"})})})]})})}function jt({userName:s}){return s?e.jsxs("div",{className:"typing-indicator",children:[e.jsxs("span",{className:"typing-dots",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}),e.jsxs("span",{className:"typing-text",children:[s," is typing..."]})]}):null}function wt({isOpen:s,onClose:a,userBubbleId:r,userName:c,userAvatar:u}){const p=i.useRef(null),_=i.useRef(null),{threads:b,selectedThread:x,messages:m,threadInfo:g,viewState:f,isLoading:j,isLoadingMessages:o,error:d,messageInput:w,isSending:k,isOtherUserTyping:I,typingUserName:O,handleThreadSelect:R,handleBackToList:Y,handleMessageInputChange:D,handleSendMessage:h,handleRetry:y,handleCTAClick:E,getCTAButtonConfig:z}=ft({isOpen:s,userBubbleId:r,userName:c,userAvatar:u,onClose:a});if(i.useEffect(()=>{if(!s)return;const L=V=>{if(p.current&&!p.current.contains(V.target)){if(V.target.closest(".header-messages-icon"))return;a==null||a()}};return requestAnimationFrame(()=>{document.addEventListener("click",L)}),()=>document.removeEventListener("click",L)},[s,a]),i.useEffect(()=>{if(!s)return;const L=V=>{V.key==="Escape"&&(a==null||a())};return document.addEventListener("keydown",L),()=>document.removeEventListener("keydown",L)},[s,a]),i.useEffect(()=>{_.current&&m.length>0&&_.current.scrollIntoView({behavior:"smooth"})},[m]),!s)return null;const B={proposalId:g==null?void 0:g.proposal_id,listingId:g==null?void 0:g.listing_id,leaseId:g==null?void 0:g.lease_id};return e.jsxs("div",{className:"header-messaging-panel",ref:p,role:"dialog","aria-label":"Messages","aria-modal":"true",onClick:L=>{L.stopPropagation()},children:[e.jsxs("div",{className:"header-messaging-panel__header",children:[f==="thread"&&x?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"header-messaging-panel__back",onClick:Y,"aria-label":"Back to thread list",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})})}),e.jsxs("div",{className:"header-messaging-panel__contact",children:[e.jsx("img",{src:x.contact_avatar||"/assets/images/default-avatar.jpg",alt:"",className:"header-messaging-panel__contact-avatar",onError:L=>{L.target.src="/assets/images/default-avatar.jpg"}}),e.jsxs("div",{className:"header-messaging-panel__contact-info",children:[e.jsx("span",{className:"header-messaging-panel__contact-name",children:x.contact_name}),x.property_name&&e.jsx("span",{className:"header-messaging-panel__property",children:x.property_name})]})]})]}):e.jsx("h2",{className:"header-messaging-panel__title",children:"Messages"}),e.jsx("button",{className:"header-messaging-panel__close",onClick:a,"aria-label":"Close messages",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"header-messaging-panel__content",children:[d&&e.jsxs("div",{className:"header-messaging-panel__error",children:[e.jsx("p",{children:d}),e.jsx("button",{onClick:y,children:"Try Again"})]}),j&&!d&&e.jsxs("div",{className:"header-messaging-panel__loading",children:[e.jsx("div",{className:"header-messaging-panel__spinner"}),e.jsx("p",{children:"Loading conversations..."})]}),!j&&!d&&f==="list"&&e.jsx("div",{className:"header-messaging-panel__thread-list",children:b.length===0?e.jsxs("div",{className:"header-messaging-panel__empty",children:[e.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})}),e.jsx("p",{children:"No messages yet"}),e.jsx("span",{children:"Start a conversation by contacting a host or guest"})]}):b.map(L=>e.jsx(xt,{thread:L,isSelected:!1,onClick:()=>R(L)},L._id))}),!j&&!d&&f==="thread"&&x&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"header-messaging-panel__messages",children:[o?e.jsx("div",{className:"header-messaging-panel__loading-messages",children:e.jsx("div",{className:"header-messaging-panel__spinner"})}):m.length===0?e.jsxs("div",{className:"header-messaging-panel__no-messages",children:[e.jsx("p",{children:"No messages in this conversation"}),e.jsx("span",{children:"Send a message to start the conversation"})]}):e.jsxs(e.Fragment,{children:[m.map(L=>e.jsx(vt,{message:L,onCTAClick:E,getCTAButtonConfig:z,messageContext:B},L._id)),e.jsx("div",{ref:_})]}),I&&e.jsx(jt,{userName:O})]}),e.jsx("div",{className:"header-messaging-panel__input",children:e.jsx(_t,{value:w,onChange:D,onSend:h,disabled:o,isSending:k})})]})]}),e.jsx("div",{className:"header-messaging-panel__footer",children:e.jsxs("a",{href:"/messages",className:"header-messaging-panel__view-all",children:["View all messages",e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M5 12h14M12 5l7 7-7 7"})})]})})]})}function Ft({user:s,currentPath:a,onNavigate:r,onLogout:c}){const[u,p]=i.useState(!1),[_,b]=i.useState(!1),[x,m]=i.useState(!1),[g,f]=i.useState(typeof window<"u"?window.innerWidth<900:!1),j=i.useRef(null),{data:o,loading:d}=ct(s.id,s.userType),w=dt(o,a),k=d?s.userType:o.userType,I=d?s.proposalsCount||0:o.proposalsCount,O=d?s.listingsCount||0:o.listingsCount,R=d?s.virtualMeetingsCount||0:o.virtualMeetingsCount,Y=d?s.houseManualsCount||0:o.houseManualsCount,D=d?s.leasesCount||0:o.leasesCount,h=d?s.favoritesCount||0:o.favoritesCount,y=d?s.unreadMessagesCount||0:o.unreadMessagesCount,E=d?null:o.firstListingId,z=d?0:o.threadsCount||0,B=d?null:o.lastSuggestedProposalId;i.useEffect(()=>{const l=()=>{const U=window.innerWidth<900;f(U),U&&x&&m(!1)};return window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[x]),i.useEffect(()=>{const l=Math.random().toString(36).substring(7);console.log("ðŸŽ­ LoggedInAvatar mounted with user:",s,"Instance ID:",l);let U=0;const X=$=>{const pe=$.timeStamp,fe=pe-U;$.target.closest(".logged-in-avatar")&&console.log("ðŸŒ Global click on avatar:",{timeSinceLastClick:fe.toFixed(2)+"ms",target:$.target.tagName,className:$.target.className}),U=pe};return document.addEventListener("click",X,!0),()=>{document.removeEventListener("click",X,!0)}},[]),i.useEffect(()=>{if(document.querySelector('script[src*="lottie-player"]'))return;const l=document.createElement("script");l.src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js",l.async=!0,document.body.appendChild(l)},[]),i.useEffect(()=>{console.log("ðŸ”„ LoggedInAvatar dropdown state changed:",u),u&&setTimeout(()=>{const l=document.querySelector(".logged-in-avatar .dropdown-menu");console.log("ðŸ” Dropdown DOM check:",{exists:!!l,visible:l?window.getComputedStyle(l).display:"N/A",position:l?window.getComputedStyle(l).position:"N/A",zIndex:l?window.getComputedStyle(l).zIndex:"N/A"})},10)},[u]),i.useEffect(()=>{d||console.log("ðŸ“‹ Menu visibility based on Supabase data:",{userType:o.userType,proposalsCount:o.proposalsCount,visitsCount:o.visitsCount,houseManualsCount:o.houseManualsCount,visibility:w})},[d,o,w]),i.useEffect(()=>{const l=U=>{const X=U.target,$=X.closest(".logged-in-avatar");console.log("ðŸ” Click detected:",{target:X.tagName,className:X.className,foundAvatarContainer:!!$}),$?console.log("âœ… Clicked inside avatar - keeping dropdown open"):(console.log("ðŸš« Clicked outside - closing dropdown"),p(!1))};return u?(requestAnimationFrame(()=>{requestAnimationFrame(()=>{document.addEventListener("click",l)})}),()=>{document.removeEventListener("click",l)}):()=>{document.removeEventListener("click",l)}},[u]);const L=()=>{const l=[];if(w.myProfile&&l.push({id:"profile",label:"My Profile",icon:"/assets/icons/user-bubble-purple.svg",path:`/account-profile/${s.id}`}),w.myProposals&&l.push({id:"proposals",label:"My Proposals",icon:"/assets/icons/file-text-purple.svg",path:k===F.GUEST?"/guest-proposals":"/host-proposals",badgeCount:I,badgeColor:"purple"}),w.myProposalsSuggested){const U=B?`/guest-proposals?proposal=${B}`:"/guest-proposals";l.push({id:"proposals-suggested",label:"Proposals Suggested",lottieUrl:"/assets/lotties/proposals-suggested.json",path:U})}if(w.myListings){let U="/host-overview";O===1&&E&&(U=`/listing-dashboard?id=${E}`),l.push({id:"listings",label:"My Listings",icon:"/assets/icons/list-purple.svg",path:U,badgeCount:O,badgeColor:"purple"})}return w.virtualMeetings&&l.push({id:"virtual-meetings",label:"Virtual Meetings",icon:"/assets/icons/video-purple.svg",path:k===F.GUEST?"/guest-dashboard":"/host-overview",badgeCount:R,badgeColor:"purple"}),w.houseManualsAndVisits&&l.push({id:"house-manuals",label:"House manuals & Visits",icon:"/assets/icons/book-open-purple.svg",path:k===F.GUEST?"/guest-house-manual":Y===1?"/host-house-manual":"/host-overview"}),w.myLeases&&l.push({id:"leases",label:"My Leases",icon:"/assets/icons/key-purple.svg",path:k===F.GUEST?"/guest-leases":"/host-leases",badgeCount:D,badgeColor:"purple"}),w.myFavoriteListings&&l.push({id:"favorites",label:"My Favorite Listings",icon:"/assets/icons/heart-purple.svg",path:"/favorite-listings",badgeCount:h,badgeColor:"purple"}),w.messages&&l.push({id:"messages",label:"Messages",icon:"/assets/icons/message-circle-purple.svg",path:"/messages",badgeCount:y,badgeColor:"red"}),w.rentalApplication&&l.push({id:"rental-application",label:"Rental Application",icon:"/assets/icons/clipboard-purple.svg",path:k===F.HOST?"/account":"/account-profile?section=rental-application"}),w.reviewsManager&&l.push({id:"reviews",label:"Reviews Manager",icon:"/assets/icons/star-purple.png",path:"/reviews-overview"}),w.referral&&l.push({id:"referral",label:"Referral",icon:"/assets/icons/gift-purple.svg",path:"/referral"}),l},V=l=>{p(!1),r(l.path)},se=async()=>{p(!1),await c()},ne=l=>{if(!l)return!1;const U=a.split("?")[0].split("#")[0],X=l.split("?")[0].split("#")[0];return U===X||U.startsWith(X+"/")},ge=L(),de=s.name.split(" ")[0],me=a.includes("search"),re=a.includes("favorite-listings")||a.includes("listing-dashboard"),Q=a.includes("/messages");return e.jsxs("div",{className:`logged-in-avatar ${me?"on-search-page":""} ${re?"on-light-header":""}`,ref:j,children:[z>0&&!Q&&e.jsxs("div",{className:"header-messages-wrapper",children:[e.jsxs("button",{className:"header-messages-icon","aria-label":`Messages${y>0?` (${y} unread)`:""}`,"aria-expanded":x,onClick:l=>{l.preventDefault(),l.stopPropagation(),g?r("/messages"):(m(!x),u&&p(!1))},children:[e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"2",y:"4",width:"20",height:"16",rx:"2"}),e.jsx("path",{d:"M22 6L12 13L2 6"})]}),y>0&&e.jsx("span",{className:"messages-badge",children:y>9?"9+":y})]}),x&&!g&&e.jsx(wt,{isOpen:x,onClose:()=>m(!1),userBubbleId:s.id,userName:de,userAvatar:s.avatarUrl})]}),e.jsxs("button",{className:"avatar-button",onClick:l=>{l.preventDefault(),l.stopPropagation(),console.log("ðŸ‘† Avatar button clicked!",{currentState:u,newState:!u,eventType:l.type,isTrusted:l.isTrusted,timeStamp:l.timeStamp,target:l.target.tagName,currentTarget:l.currentTarget.tagName,eventPhase:l.eventPhase}),x&&m(!1),p(!u)},"aria-label":"Toggle user menu","aria-expanded":u,children:[e.jsx("img",{src:s.avatarUrl||"/assets/images/default-avatar.jpg",alt:s.name,className:"avatar-image",onError:l=>{l.target.src="/assets/images/default-avatar.jpg"}}),e.jsxs("span",{className:"user-name-wrapper",children:[de,e.jsx("svg",{className:"dropdown-arrow",width:"12",height:"8",viewBox:"0 0 12 8",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M1 1.5L6 6.5L11 1.5",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})]})]}),u&&e.jsxs("div",{className:"dropdown-menu",children:[console.log("âœ¨ Dropdown menu is rendering! Menu items count:",ge.length),e.jsxs("div",{className:"menu-container",children:[d&&e.jsx("div",{className:"menu-loading",style:{padding:"8px 15px",fontSize:"14px",color:"#6b7280"},children:"Loading menu..."}),ge.map(l=>e.jsxs("button",{className:`menu-item ${ne(l.path)?"active":""}`,onClick:()=>V(l),children:[l.lottieUrl?e.jsx("lottie-player",{src:l.lottieUrl,background:"transparent",speed:"1",style:{width:"20px",height:"20px"},loop:!0,autoplay:!0,className:"menu-icon"}):e.jsx("img",{src:l.icon,alt:"",className:"menu-icon"}),e.jsx("span",{className:"menu-label",children:l.label}),l.badgeCount!==void 0&&l.badgeCount>0&&e.jsx("span",{className:`notification-badge ${l.badgeColor}`,children:l.badgeCount})]},l.id)),e.jsxs("button",{className:"menu-item sign-out",onClick:se,children:[e.jsx("img",{src:"/assets/icons/log-out-purple.svg",alt:"",className:"menu-icon"}),e.jsx("span",{className:"menu-label",children:"Sign Out"})]})]})]})]})}const N={ENTRY:"entry",USER_TYPE:"user-type",IDENTITY:"identity",PASSWORD:"password",LOGIN:"login",PASSWORD_RESET:"password-reset",RESET_SENT:"reset-sent",MAGIC_LINK:"magic-link",MAGIC_LINK_SENT:"magic-link-sent",SUCCESS:"success",INITIAL:"entry",SIGNUP_STEP1:"user-type",SIGNUP_STEP2:"identity"},he={HOST:"Host",GUEST:"Guest"},t={overlay:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.45)",display:"flex",alignItems:"center",justifyContent:"center",padding:"16px",zIndex:1e4},modal:{backgroundColor:"#ffffff",borderRadius:"12px",padding:"24px",maxWidth:"400px",width:"100%",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 40px rgba(0, 0, 0, 0.15)",position:"relative"},closeBtn:{position:"absolute",top:"16px",right:"16px",width:"32px",height:"32px",border:"none",background:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#9ca3af",transition:"color 0.2s ease",zIndex:10},logoContainer:{display:"flex",alignItems:"center",justifyContent:"center",marginBottom:"12px"},logo:{width:"36px",height:"36px",objectFit:"contain"},header:{textAlign:"center",marginBottom:"24px"},title:{fontSize:"20px",fontWeight:"700",color:"#1a1a1a",margin:"0 0 8px 0"},subtitle:{fontSize:"14px",color:"#6b7280",lineHeight:1.5,margin:0},userTypeCard:{border:"1px solid #e5e7eb",borderRadius:"10px",padding:"16px",marginBottom:"12px",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:"14px",backgroundColor:"#f9fafb"},userTypeCardSelected:{borderColor:"#6366F1",backgroundColor:"#EEF2FF",boxShadow:"0 8px 30px rgba(99, 102, 241, 0.15)"},userTypeIcon:{width:"48px",height:"48px",borderRadius:"10px",backgroundColor:"white",display:"flex",alignItems:"center",justifyContent:"center",color:"#6366F1",flexShrink:0,boxShadow:"0 2px 8px rgba(0, 0, 0, 0.06)"},userTypeContent:{flex:1},userTypeTitle:{fontSize:"14px",fontWeight:"600",color:"#1a1a1a",marginBottom:"2px"},userTypeDesc:{fontSize:"13px",color:"#6b7280",margin:0,lineHeight:1.4},oauthButtonsRow:{display:"flex",gap:"12px",marginBottom:"4px"},linkedinBtn:{flex:1,padding:"12px 16px",border:"1px solid #0a66c2",backgroundColor:"#0a66c2",borderRadius:"10px",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},linkedinIcon:{width:"20px",height:"20px",backgroundColor:"white",borderRadius:"4px",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"700",color:"#0a66c2",fontSize:"12px",flexShrink:0},linkedinPrimary:{fontSize:"14px",fontWeight:"600",color:"white"},googleBtn:{flex:1,padding:"12px 16px",backgroundColor:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:"10px",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",fontSize:"14px",fontWeight:"500",color:"#1a1a1a"},divider:{display:"flex",alignItems:"center",gap:"16px",margin:"20px 0"},dividerLine:{flex:1,height:"1px",backgroundColor:"#e5e7eb"},dividerText:{fontSize:"13px",color:"#9ca3af",fontWeight:"500"},formRow:{display:"flex",gap:"12px",marginBottom:"16px"},formGroup:{flex:1,marginBottom:"16px"},formGroupInRow:{flex:1,marginBottom:0},label:{display:"block",fontSize:"13px",fontWeight:"500",color:"#9ca3af",marginBottom:"6px"},input:{width:"100%",padding:"10px 12px",border:"1px solid #e5e7eb",borderRadius:"10px",fontSize:"14px",color:"#1a1a1a",transition:"border-color 0.2s ease, background-color 0.2s ease",outline:"none",boxSizing:"border-box",backgroundColor:"#f9fafb",fontFamily:"inherit"},helperText:{fontSize:"12px",color:"#6b7280",marginTop:"6px",lineHeight:1.4},passwordWrapper:{position:"relative"},inputWithIcon:{paddingRight:"44px"},togglePasswordBtn:{position:"absolute",right:"12px",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#6b7280",display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",transition:"color 0.2s ease"},passwordRequirements:{marginTop:"12px",padding:"12px",backgroundColor:"#f9fafb",borderRadius:"10px"},requirement:{display:"flex",alignItems:"center",gap:"8px",fontSize:"13px",color:"#6b7280",marginBottom:"6px"},requirementLast:{marginBottom:0},requirementMet:{color:"#10B981"},requirementIcon:{width:"16px",height:"16px",display:"flex",alignItems:"center",justifyContent:"center"},buttonPrimary:{width:"100%",padding:"12px",backgroundColor:"#6366F1",color:"white",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"background 0.2s ease, box-shadow 0.2s ease",marginTop:"8px",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"inherit"},buttonDisabled:{backgroundColor:"#e5e7eb",cursor:"not-allowed",boxShadow:"none"},buttonSecondary:{width:"100%",padding:"12px",backgroundColor:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:"10px",fontSize:"14px",fontWeight:"500",color:"#1a1a1a",cursor:"pointer",transition:"all 0.2s ease",fontFamily:"inherit",display:"flex",alignItems:"center",justifyContent:"center"},backBtn:{display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",width:"100%",background:"none",border:"none",color:"#6366F1",cursor:"pointer",fontSize:"13px",fontWeight:"500",padding:"12px",marginTop:"8px",fontFamily:"inherit",transition:"opacity 0.2s ease"},footerLink:{textAlign:"center",marginTop:"20px",paddingTop:"16px",borderTop:"1px solid #e5e7eb",fontSize:"13px",color:"#6b7280"},link:{color:"#6366F1",textDecoration:"none",cursor:"pointer",background:"none",border:"none",fontSize:"inherit",fontWeight:"500",fontFamily:"inherit",transition:"opacity 0.2s ease"},linkText:{textAlign:"center",marginTop:"1rem"},termsText:{fontSize:"12px",color:"#6b7280",textAlign:"center",marginTop:"16px",lineHeight:1.5},errorBox:{padding:"12px",backgroundColor:"#fee2e2",border:"1px solid #fecaca",borderRadius:"10px",marginBottom:"16px"},errorText:{fontSize:"13px",color:"#dc2626",margin:0},dateInputsRow:{display:"flex",gap:"8px"},dateSelect:{flex:1,padding:"10px 12px",border:"1px solid #e5e7eb",borderRadius:"10px",fontSize:"14px",outline:"none",backgroundColor:"#f9fafb",cursor:"pointer",fontFamily:"inherit"}},Be=({open:s})=>e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:s?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}):e.jsxs(e.Fragment,{children:[e.jsx("path",{d:"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"}),e.jsx("line",{x1:"1",y1:"1",x2:"23",y2:"23"})]})}),ke=()=>e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"}),e.jsx("polyline",{points:"12 19 5 12 12 5"})]}),He=({size:s=18})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",style:{animation:"spin 1s linear infinite",marginRight:"8px",verticalAlign:"middle"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeOpacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor"})]}),Ae=({size:s=20})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),Ct=({size:s=24})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"8.5",cy:"7",r:"4"}),e.jsx("line",{x1:"20",y1:"8",x2:"20",y2:"14"}),e.jsx("line",{x1:"23",y1:"11",x2:"17",y2:"11"})]}),kt=({size:s=24})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"}),e.jsx("polyline",{points:"10 17 15 12 10 7"}),e.jsx("line",{x1:"15",y1:"12",x2:"3",y2:"12"})]}),St=({size:s=24})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"20",x2:"18",y2:"10"}),e.jsx("line",{x1:"12",y1:"20",x2:"12",y2:"4"}),e.jsx("line",{x1:"6",y1:"20",x2:"6",y2:"14"})]}),Tt=({size:s=24})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),e.jsx("polyline",{points:"9 22 9 12 15 12 15 22"})]}),Ge=({size:s=24})=>e.jsx("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"})}),We=({size:s=40})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"}),e.jsx("polyline",{points:"22,6 12,13 2,6"})]}),Se=({size:s=16})=>e.jsxs("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),e.jsx("polyline",{points:"22 4 12 14.01 9 11.01"})]}),qe=({size:s=16})=>e.jsx("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("circle",{cx:"12",cy:"12",r:"10"})}),Oe=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),ce="https://d1muf25xaso8hp.cloudfront.net/https%3A%2F%2F50bf0464e4735aabad1cc8848a0e8b8a.cdn.bubble.io%2Ff1587601671931x294112149689599100%2Fsplit%2520lease%2520purple%2520circle.png?w=48&h=&auto=enhance&dpr=1&q=100&fit=max",Lt=["January","February","March","April","May","June","July","August","September","October","November","December"],Mt=new Date().getFullYear(),It=Array.from({length:100},(s,a)=>Mt-a),Et=(s,a)=>!s||!a?Array.from({length:31},(r,c)=>c+1):Array.from({length:new Date(a,s,0).getDate()},(r,c)=>c+1),Nt=(s,a,r)=>{if(!s||!a||!r)return!1;const c=new Date,u=new Date(r,s-1,a);let p=c.getFullYear()-u.getFullYear();const _=c.getMonth()-u.getMonth();return(_<0||_===0&&c.getDate()<u.getDate())&&p--,p>=18};function Bt({isOpen:s,onClose:a,initialView:r="initial",onAuthSuccess:c,disableClose:u=!1,defaultUserType:p=null,skipReload:_=!1,prefillEmail:b=null}){const{toasts:x,showToast:m,removeToast:g}=Ve(),[f,j]=i.useState(N.ENTRY),[o,d]=i.useState({firstName:"",lastName:"",email:"",userType:p==="host"?he.HOST:he.GUEST,birthMonth:"",birthDay:"",birthYear:"",phoneNumber:"",password:"",confirmPassword:""}),[w,k]=i.useState(null),[I,O]=i.useState({email:"",password:""}),[R,Y]=i.useState(""),[D,h]=i.useState(""),[y,E]=i.useState(!1),[z,B]=i.useState(!1),[L,V]=i.useState(!1),[se,ne]=i.useState(!1),[ge,de]=i.useState(!1),[me,re]=i.useState({email:"",showModal:!1}),[Q,l]=i.useState({email:"",showModal:!1});i.useEffect(()=>{s&&(j(r==="login"?N.LOGIN:r==="signup"||r==="signup-step1"?p?N.IDENTITY:N.USER_TYPE:r==="signup-step2"||r==="identity"?N.IDENTITY:N.ENTRY),h(""),k(null),p&&d(n=>({...n,userType:p==="host"?he.HOST:he.GUEST})),b&&d(n=>({...n,email:b})))},[s,r,p,b]),i.useEffect(()=>{o.confirmPassword&&o.password!==o.confirmPassword?de(!0):de(!1)},[o.password,o.confirmPassword]),i.useEffect(()=>{const n=Je(),T=Ze();if(!n&&!T)return;const W=new URLSearchParams(window.location.hash.substring(1)).get("access_token"),le=new URLSearchParams(window.location.search).get("code");if(!W&&!le)return;const ve=!!T,_e=ve?"Google":"LinkedIn";(async()=>{E(!0),m({title:"Signing up...",content:`Connecting your ${_e} account`,type:"info",duration:3e3});const ee=ve?await Qe():await Xe();E(!1),ee.success?(m({title:"Welcome to Split Lease!",content:"Your account has been created successfully.",type:"success",duration:4e3}),c&&c(ee),setTimeout(()=>{var je;const ye=(je=ee.data)==null?void 0:je.user_id;if(console.log("[SignUpModal] Redirecting to profile with user_id:",ye),console.log("[SignUpModal] Full result:",JSON.stringify(ee,null,2)),console.log("[SignUpModal] result.data:",JSON.stringify(ee.data,null,2)),console.log("[SignUpModal] userId is undefined?",ye===void 0),console.log("[SignUpModal] userId type:",typeof ye),!ye){console.error("[SignUpModal] ERROR: user_id is missing from result.data!"),console.error("[SignUpModal] This will cause a redirect to wrong page");return}window.location.href="/account-profile"},1500)):ee.isDuplicate?re({email:ee.existingEmail,showModal:!0}):(m({title:"Signup Failed",content:ee.error||"Please try again.",type:"error",duration:5e3}),h(ee.error||"OAuth signup failed. Please try again."))})()},[]),i.useEffect(()=>{const n=T=>{T.key==="Escape"&&s&&!u&&a()};return s&&(document.addEventListener("keydown",n),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",n),document.body.style.overflow=""}},[s,u,a]);const U=n=>{n.target===n.currentTarget&&!u&&a()};i.useCallback(()=>{d({firstName:"",lastName:"",email:"",userType:p==="host"?he.HOST:he.GUEST,birthMonth:"",birthDay:"",birthYear:"",phoneNumber:"",password:"",confirmPassword:""}),O({email:"",password:""}),Y(""),h(""),B(!1),V(!1),ne(!1),de(!1)},[p]);const X=()=>{j(N.ENTRY),h(""),k(null)},$=()=>{j(N.USER_TYPE),h(""),k(null)},pe=()=>{j(N.IDENTITY),h("")},fe=()=>{j(N.PASSWORD),h("")},ie=()=>{j(N.LOGIN),h(""),o.email&&O(n=>({...n,email:o.email}))},J=()=>{j(N.PASSWORD_RESET),Y(I.email),h("")},Te=()=>{j(N.MAGIC_LINK),Y(I.email),h("")},C=n=>{if(n.preventDefault(),h(""),!o.firstName.trim()){h("First name is required.");return}if(!o.lastName.trim()){h("Last name is required.");return}if(!o.email.trim()){h("Email is required.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o.email)){h("Please enter a valid email address.");return}if(!o.birthMonth||!o.birthDay||!o.birthYear){h("Please enter your date of birth.");return}if(!Nt(parseInt(o.birthMonth),parseInt(o.birthDay),parseInt(o.birthYear))){h("You must be at least 18 years old to use Split Lease.");return}fe()},S=async n=>{if(n.preventDefault(),h(""),!o.password){h("Password is required.");return}if(o.password.length<8){h("Password must be at least 8 characters.");return}const T=/[a-zA-Z]/.test(o.password),G=/[0-9]/.test(o.password);if(!T||!G){h("Password must contain both letters and numbers.");return}E(!0),m({title:"Thank you!",content:"Creating your account...",type:"info",duration:3e3});const W=setTimeout(()=>{m({title:"Almost there!",content:"Our robots are still working...",type:"info",duration:3e3})},1500),q=await rt(o.email,o.password,o.password,{firstName:o.firstName,lastName:o.lastName,userType:o.userType,birthDate:`${o.birthYear}-${String(o.birthMonth).padStart(2,"0")}-${String(o.birthDay).padStart(2,"0")}`,phoneNumber:o.phoneNumber||""});clearTimeout(W),E(!1),q.success?(m({title:"Welcome to Split Lease!",content:"Your account has been created successfully.",type:"success",duration:4e3}),c&&c(q),setTimeout(()=>{a(),_||setTimeout(()=>{window.location.reload()},300)},1500)):(m({title:"Signup Failed",content:q.error||"Please try again.",type:"error",duration:5e3}),h(q.error||"Signup failed. Please try again."))},A=async n=>{n.preventDefault(),h(""),E(!0),m({title:"Welcome back!",content:"Logging you in...",type:"info",duration:3e3});const T=setTimeout(()=>{m({title:"Almost there!",content:"Our robots are still working...",type:"info",duration:3e3})},1500),G=await ot(I.email,I.password);if(console.log("[SignUpLoginModal] loginUser result:",G),G.success){console.log("[SignUpLoginModal] Login successful, proceeding with post-login flow...");try{console.log("[SignUpLoginModal] Fetching user data..."),await at({clearOnFailure:!1}),console.log("[SignUpLoginModal] User data fetched successfully")}catch(W){console.warn("[SignUpLoginModal] User data fetch failed, continuing with login:",W)}clearTimeout(T),E(!1),m({title:"Login Successful!",content:"Welcome back to Split Lease.",type:"success",duration:4e3}),console.log("[SignUpLoginModal] Calling onAuthSuccess and onClose..."),c&&c(G),setTimeout(()=>{a(),console.log("[SignUpLoginModal] skipReload:",_),_||(console.log("[SignUpLoginModal] Scheduling page reload in 1.5s..."),setTimeout(()=>{console.log("[SignUpLoginModal] Triggering page reload..."),window.location.reload()},1500))},500)}else clearTimeout(T),E(!1),m({title:"Login Failed",content:G.error||"Please check your credentials.",type:"error",duration:5e3}),h(G.error||"Login failed. Please check your credentials.")},M=async n=>{if(n.preventDefault(),h(""),!R.trim()){h("Please enter your email address.");return}E(!0);try{const T=window.location.pathname+window.location.search,G=encodeURIComponent(T),{data:W,error:q}=await v.functions.invoke("auth-user",{body:{action:"request_password_reset",payload:{email:R,redirectTo:`${window.location.origin}/reset-password?returnTo=${G}`}}});q&&console.error("Password reset error:",q),j(N.RESET_SENT)}catch(T){console.error("Password reset error:",T),j(N.RESET_SENT)}E(!1)},H=async n=>{n&&n.preventDefault();const T=f===N.PASSWORD_RESET||f===N.MAGIC_LINK?R:I.email;if(!T.trim()){h("Please enter your email address first.");return}E(!0),h("");const G=()=>{j(N.MAGIC_LINK_SENT)};try{const{data:W,error:q}=await v.from("user").select('_id, "Name - First", email, "Phone Number (as text)"').eq("email",T.toLowerCase().trim()).maybeSingle();if(q){console.error("[handleMagicLink] Error checking user:",q),G(),E(!1);return}if(!W){console.log("[handleMagicLink] No user found for email"),G(),E(!1);return}console.log("[handleMagicLink] Fetching BCC email addresses from os_slack_channels");const{data:le,error:ve}=await v.schema("reference_table").from("os_slack_channels").select("email_address").in("name",["bots_log","customer_activation"]);let _e=[];!ve&&le?(_e=le.map(ae=>ae.email_address).filter(ae=>ae&&ae.trim()&&ae.includes("@")),console.log("[handleMagicLink] BCC emails:",_e)):ve&&console.warn("[handleMagicLink] Error fetching BCC channels:",ve),console.log("[handleMagicLink] User found, generating magic link");const De=`${window.location.origin}/account-profile`,{data:ee,error:ye}=await v.functions.invoke("auth-user",{body:{action:"generate_magic_link",payload:{email:T.toLowerCase().trim(),redirectTo:De}}});if(ye||!(ee!=null&&ee.success)){console.error("[handleMagicLink] Error generating magic link:",ye||ee),G(),E(!1);return}const je=ee.data.action_link,ze=W["Name - First"]||"there";console.log("[handleMagicLink] Sending magic link email");const $e=`Hi ${ze}. Please use the link below to log in to your Split Lease account. Once logged in, you can update your password from the profile page. Please feel free to text (937) 673-7470 with any queries.`,{data:Pt,error:Re}=await v.functions.invoke("send-email",{body:{action:"send",payload:{template_id:"1757433099447x202755280527849400",to_email:T.toLowerCase().trim(),variables:{toemail:T.toLowerCase().trim(),fromemail:"tech@leasesplit.com",fromname:"Split Lease",subject:"Your Split Lease Magic Login Link",preheadertext:"Click the link to log in without a password",title:"Magic Login Link",bodytext:$e,buttonurl:je,buttontext:"Log In Now",bannertext1:"SECURITY NOTICE",bannertext2:"This link expires in 1 hour",bannertext3:"If you didn't request this, please ignore this email",footermessage:"For your security, never share this link with anyone.",cc:"",bcc:""},..._e.length>0&&{bcc_emails:_e}}}});Re?console.error("[handleMagicLink] Error sending email:",Re):console.log("[handleMagicLink] Magic link email sent successfully");const we=W["Phone Number (as text)"];if(we&&we.trim()){console.log("[handleMagicLink] User has phone number, sending SMS");const ae=we.replace(/\D/g,"");let Ce=null;if(ae.length===10?Ce=`+1${ae}`:ae.length===11&&ae.startsWith("1")?Ce=`+${ae}`:we.startsWith("+")&&ae.length>=10&&(Ce=`+${ae}`),Ce){const Ye=`Passwords are tricky. Please use this magic link and you can update your password right from the profile page: ${je}`;try{const{data:Ue,error:Fe}=await v.functions.invoke("send-sms",{body:{action:"send",payload:{from:"+14155692985",to:Ce,body:Ye}}});Fe?console.error("[handleMagicLink] Error sending SMS:",Fe):console.log("[handleMagicLink] Magic link SMS sent successfully")}catch(Ue){console.error("[handleMagicLink] SMS exception:",Ue)}}else console.log("[handleMagicLink] Could not format phone number:",we)}G()}catch(W){console.error("[handleMagicLink] Unexpected error:",W),G()}E(!1)};if(i.useEffect(()=>{const n="signup-modal-spinner-styles";if(!document.getElementById(n)){const T=document.createElement("style");T.id=n,T.textContent=`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `,document.head.appendChild(T)}},[]),!s)return null;const te=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"Welcome to Split Lease"}),e.jsx("p",{style:t.subtitle,children:"How can we help you today?"})]}),e.jsxs("div",{style:{...t.userTypeCard,...w==="new"?t.userTypeCardSelected:{}},onClick:$,onMouseEnter:()=>k("new"),onMouseLeave:()=>k(null),children:[e.jsx("div",{style:t.userTypeIcon,children:e.jsx(Ct,{size:24})}),e.jsxs("div",{style:t.userTypeContent,children:[e.jsx("div",{style:t.userTypeTitle,children:"I'm new around here"}),e.jsx("p",{style:t.userTypeDesc,children:"Create an account to get started"})]})]}),e.jsxs("div",{style:{...t.userTypeCard,...w==="login"?t.userTypeCardSelected:{}},onClick:ie,onMouseEnter:()=>k("login"),onMouseLeave:()=>k(null),children:[e.jsx("div",{style:t.userTypeIcon,children:e.jsx(kt,{size:24})}),e.jsxs("div",{style:t.userTypeContent,children:[e.jsx("div",{style:t.userTypeTitle,children:"Log into my account"}),e.jsx("p",{style:t.userTypeDesc,children:"Welcome back! Sign in to continue"})]})]}),e.jsxs("div",{style:{...t.userTypeCard,...w==="market"?t.userTypeCardSelected:{}},onClick:$,onMouseEnter:()=>k("market"),onMouseLeave:()=>k(null),children:[e.jsx("div",{style:t.userTypeIcon,children:e.jsx(St,{size:24})}),e.jsxs("div",{style:t.userTypeContent,children:[e.jsx("div",{style:t.userTypeTitle,children:"Sign Up with Market Report"}),e.jsx("p",{style:t.userTypeDesc,children:"Get NYC rental insights and create an account"})]})]})]}),xe=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"What brings you here?"}),e.jsx("p",{style:t.subtitle,children:"I'm here to..."})]}),e.jsxs("div",{style:{...t.userTypeCard,...w==="guest"||o.userType===he.GUEST?t.userTypeCardSelected:{}},onClick:()=>{d({...o,userType:he.GUEST}),setTimeout(pe,200)},onMouseEnter:()=>k("guest"),onMouseLeave:()=>k(null),children:[e.jsx("div",{style:t.userTypeIcon,children:e.jsx(Tt,{size:24})}),e.jsxs("div",{style:t.userTypeContent,children:[e.jsx("div",{style:t.userTypeTitle,children:"Find a place to stay"}),e.jsx("p",{style:t.userTypeDesc,children:"Browse flexible rentals across NYC"})]})]}),e.jsxs("div",{style:{...t.userTypeCard,...w==="host"||o.userType===he.HOST?t.userTypeCardSelected:{}},onClick:()=>{d({...o,userType:he.HOST}),setTimeout(pe,200)},onMouseEnter:()=>k("host"),onMouseLeave:()=>k(null),children:[e.jsx("div",{style:t.userTypeIcon,children:e.jsx(Ge,{size:24})}),e.jsxs("div",{style:t.userTypeContent,children:[e.jsx("div",{style:t.userTypeTitle,children:"Share my space"}),e.jsx("p",{style:t.userTypeDesc,children:"List your place for nightly, weekly, or monthly stays"})]})]}),e.jsxs("button",{style:t.backBtn,onClick:X,children:[e.jsx(ke,{})," Back"]})]}),be=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"Welcome back!"}),e.jsx("p",{style:t.subtitle,children:"Log in to your Split Lease account"})]}),e.jsxs("div",{style:t.oauthButtonsRow,children:[e.jsxs("button",{type:"button",style:t.linkedinBtn,onClick:async()=>{const n=await et();n.success||h(n.error||"Failed to start LinkedIn login")},disabled:y,children:[e.jsx("div",{style:t.linkedinIcon,children:"in"}),e.jsx("span",{style:t.linkedinPrimary,children:"LinkedIn"})]}),e.jsxs("button",{type:"button",style:t.googleBtn,onClick:async()=>{const n=await tt();n.success||h(n.error||"Failed to start Google login")},disabled:y,children:[e.jsx(Oe,{}),e.jsx("span",{children:"Google"})]})]}),e.jsxs("div",{style:t.divider,children:[e.jsx("div",{style:t.dividerLine}),e.jsx("span",{style:t.dividerText,children:"or"}),e.jsx("div",{style:t.dividerLine})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Email"}),e.jsx("input",{type:"email",value:I.email,onChange:n=>O({...I,email:n.target.value}),required:!0,placeholder:"john@example.com",style:t.input,onFocus:n=>{n.target.style.borderColor="#6366F1",n.target.style.backgroundColor="white"},onBlur:n=>{n.target.style.borderColor="#e5e7eb",n.target.style.backgroundColor="#f9fafb"}})]}),e.jsxs("div",{style:{...t.formGroup,marginBottom:"8px"},children:[e.jsx("label",{style:t.label,children:"Password"}),e.jsxs("div",{style:t.passwordWrapper,children:[e.jsx("input",{type:se?"text":"password",value:I.password,onChange:n=>O({...I,password:n.target.value}),required:!0,placeholder:"Enter your password",style:{...t.input,...t.inputWithIcon},onFocus:n=>{n.target.style.borderColor="#6366F1",n.target.style.backgroundColor="white"},onBlur:n=>{n.target.style.borderColor="#e5e7eb",n.target.style.backgroundColor="#f9fafb"}}),e.jsx("button",{type:"button",onClick:()=>ne(!se),style:t.togglePasswordBtn,children:e.jsx(Be,{open:se})})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"16px"},children:[e.jsx("button",{type:"button",onClick:Te,style:{...t.link,fontSize:"13px"},children:"Log in without password"}),e.jsx("button",{type:"button",onClick:J,style:{...t.link,fontSize:"13px"},children:"Forgot password?"})]}),D&&e.jsx("div",{style:t.errorBox,children:e.jsx("p",{style:t.errorText,children:D})}),e.jsx("button",{type:"submit",disabled:y||!I.email||!I.password,style:{...t.buttonPrimary,...y||!I.email||!I.password?t.buttonDisabled:{}},children:y?e.jsxs(e.Fragment,{children:[e.jsx(He,{size:18}),"Logging in..."]}):"Log In"}),e.jsxs("div",{style:t.footerLink,children:["Don't have an account?"," ",e.jsx("button",{type:"button",onClick:$,style:t.link,children:"Sign up"})]})]})]}),Le=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"Nice to meet you!"}),e.jsx("p",{style:t.subtitle,children:"Tell us a bit about yourself"})]}),e.jsxs("div",{style:t.oauthButtonsRow,children:[e.jsxs("button",{type:"button",style:t.linkedinBtn,onClick:async()=>{const n=await st(o.userType);n.success||h(n.error||"Failed to start LinkedIn signup")},disabled:y,children:[e.jsx("div",{style:t.linkedinIcon,children:"in"}),e.jsx("span",{style:t.linkedinPrimary,children:"LinkedIn"})]}),e.jsxs("button",{type:"button",style:t.googleBtn,onClick:async()=>{const n=await nt(o.userType);n.success||h(n.error||"Failed to start Google signup")},disabled:y,children:[e.jsx(Oe,{}),e.jsx("span",{children:"Google"})]})]}),e.jsxs("div",{style:t.divider,children:[e.jsx("div",{style:t.dividerLine}),e.jsx("span",{style:t.dividerText,children:"or enter manually"}),e.jsx("div",{style:t.dividerLine})]}),e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{style:t.formRow,children:[e.jsxs("div",{style:t.formGroupInRow,children:[e.jsx("label",{style:t.label,children:"First Name"}),e.jsx("input",{type:"text",value:o.firstName,onChange:n=>d({...o,firstName:n.target.value}),required:!0,placeholder:"John",style:t.input,onFocus:n=>{n.target.style.borderColor="#6366F1",n.target.style.backgroundColor="white"},onBlur:n=>{n.target.style.borderColor="#e5e7eb",n.target.style.backgroundColor="#f9fafb"}})]}),e.jsxs("div",{style:t.formGroupInRow,children:[e.jsx("label",{style:t.label,children:"Last Name"}),e.jsx("input",{type:"text",value:o.lastName,onChange:n=>d({...o,lastName:n.target.value}),required:!0,placeholder:"Smith",style:t.input,onFocus:n=>{n.target.style.borderColor="#6366F1",n.target.style.backgroundColor="white"},onBlur:n=>{n.target.style.borderColor="#e5e7eb",n.target.style.backgroundColor="#f9fafb"}})]})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Email"}),e.jsx("input",{type:"email",value:o.email,onChange:n=>d({...o,email:n.target.value}),required:!0,placeholder:"john@example.com",style:t.input,onFocus:n=>{n.target.style.borderColor="#6366F1",n.target.style.backgroundColor="white"},onBlur:n=>{n.target.style.borderColor="#e5e7eb",n.target.style.backgroundColor="#f9fafb"}}),e.jsx("p",{style:t.helperText,children:"We'll use this for login and important updates"})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Birthday"}),e.jsxs("div",{style:t.dateInputsRow,children:[e.jsxs("select",{value:o.birthMonth,onChange:n=>d({...o,birthMonth:n.target.value}),style:t.dateSelect,children:[e.jsx("option",{value:"",children:"Month"}),Lt.map((n,T)=>e.jsx("option",{value:T+1,children:n},n))]}),e.jsxs("select",{value:o.birthDay,onChange:n=>d({...o,birthDay:n.target.value}),style:t.dateSelect,children:[e.jsx("option",{value:"",children:"Day"}),Et(parseInt(o.birthMonth),parseInt(o.birthYear)).map(n=>e.jsx("option",{value:n,children:n},n))]}),e.jsxs("select",{value:o.birthYear,onChange:n=>d({...o,birthYear:n.target.value}),style:t.dateSelect,children:[e.jsx("option",{value:"",children:"Year"}),It.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsx("p",{style:t.helperText,children:"Required for age verification"})]}),D&&e.jsx("div",{style:t.errorBox,children:e.jsx("p",{style:t.errorText,children:D})}),e.jsx("button",{type:"submit",disabled:y,style:{...t.buttonPrimary,...y?t.buttonDisabled:{}},children:"Continue"}),e.jsxs("button",{type:"button",style:t.backBtn,onClick:$,children:[e.jsx(ke,{})," Back"]})]})]}),Me=()=>{const n=o.password.length>=8,T=/[a-zA-Z]/.test(o.password),G=/[0-9]/.test(o.password),W=T&&G,q=n&&W;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsxs("h1",{style:t.title,children:["Almost there, ",o.firstName||"there","!"]}),e.jsx("p",{style:t.subtitle,children:"Create a password to secure your account"})]}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Password"}),e.jsxs("div",{style:t.passwordWrapper,children:[e.jsx("input",{type:z?"text":"password",value:o.password,onChange:le=>d({...o,password:le.target.value}),required:!0,placeholder:"Create a password",style:{...t.input,...t.inputWithIcon},onFocus:le=>{le.target.style.borderColor="#6366F1",le.target.style.backgroundColor="white"},onBlur:le=>{le.target.style.borderColor="#e5e7eb",le.target.style.backgroundColor="#f9fafb"}}),e.jsx("button",{type:"button",onClick:()=>B(!z),style:t.togglePasswordBtn,children:e.jsx(Be,{open:z})})]}),e.jsxs("div",{style:t.passwordRequirements,children:[e.jsxs("div",{style:{...t.requirement,...n?t.requirementMet:{}},children:[e.jsx("span",{style:t.requirementIcon,children:n?e.jsx(Se,{size:16}):e.jsx(qe,{size:16})}),e.jsx("span",{children:"At least 8 characters"})]}),e.jsxs("div",{style:{...t.requirement,...t.requirementLast,...W?t.requirementMet:{}},children:[e.jsx("span",{style:t.requirementIcon,children:W?e.jsx(Se,{size:16}):e.jsx(qe,{size:16})}),e.jsx("span",{children:"Mix of letters and numbers"})]})]})]}),D&&e.jsx("div",{style:t.errorBox,children:e.jsx("p",{style:t.errorText,children:D})}),e.jsx("button",{type:"submit",disabled:y||!q,style:{...t.buttonPrimary,...y||!q?t.buttonDisabled:{}},children:y?e.jsxs(e.Fragment,{children:[e.jsx(He,{size:18}),"Creating Account..."]}):"Create Account"}),e.jsxs("p",{style:t.termsText,children:["By creating an account, you agree to our"," ",e.jsx("a",{href:"/terms",target:"_blank",style:{color:"#6366F1"},children:"Terms of Service"})," and"," ",e.jsx("a",{href:"/privacy",target:"_blank",style:{color:"#6366F1"},children:"Privacy Policy"})]}),e.jsxs("button",{type:"button",style:t.backBtn,onClick:pe,children:[e.jsx(ke,{})," Back"]})]})]})},P=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logoImage})}),e.jsxs("div",{style:t.header,children:[e.jsx("div",{style:t.headerIcon,children:e.jsx(Ge,{})}),e.jsx("h2",{style:t.title,children:"Reset your password"}),e.jsx("p",{style:t.subtitle,children:"Enter your email address and we'll send you a link to reset your password."})]}),e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Email address"}),e.jsx("input",{type:"email",value:R,onChange:n=>Y(n.target.value),required:!0,placeholder:"you@example.com",style:t.input,onFocus:n=>n.target.style.borderColor=t.colors.primary,onBlur:n=>n.target.style.borderColor="#E5E7EB"})]}),D&&e.jsx("div",{style:t.errorBox,children:e.jsx("p",{style:t.errorText,children:D})}),e.jsx("button",{type:"submit",disabled:y||!R,style:{...t.buttonPrimary,...y||!R?t.buttonDisabled:{}},children:y?"Sending reset link...":"Send reset link"}),e.jsxs("button",{type:"button",onClick:Te,disabled:y,style:{...t.buttonSecondary,marginTop:"12px"},children:[e.jsx(We,{})," Send me a magic login link instead"]}),e.jsxs("button",{type:"button",style:t.backBtn,onClick:ie,children:[e.jsx(ke,{})," Back to login"]})]})]}),K=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logoImage})}),e.jsxs("div",{style:t.header,children:[e.jsx("div",{style:t.headerIcon,children:e.jsx(We,{})}),e.jsx("h2",{style:t.title,children:"Magic link login"}),e.jsx("p",{style:t.subtitle,children:"Enter your email and we'll send you a link to sign in instantlyâ€”no password needed."})]}),e.jsxs("form",{onSubmit:H,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Email address"}),e.jsx("input",{type:"email",value:R,onChange:n=>Y(n.target.value),required:!0,placeholder:"you@example.com",style:t.input,onFocus:n=>n.target.style.borderColor=t.colors.primary,onBlur:n=>n.target.style.borderColor="#E5E7EB"})]}),D&&e.jsx("div",{style:t.errorBox,children:e.jsx("p",{style:t.errorText,children:D})}),e.jsx("button",{type:"submit",disabled:y||!R,style:{...t.buttonPrimary,...y||!R?t.buttonDisabled:{}},children:y?"Sending magic link...":"Send magic link"}),e.jsxs("button",{type:"button",style:t.backBtn,onClick:ie,children:[e.jsx(ke,{})," Back to login"]})]})]}),Z=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logoImage})}),e.jsxs("div",{style:t.header,children:[e.jsx("div",{style:{...t.headerIcon,backgroundColor:"rgba(16, 185, 129, 0.1)"},children:e.jsx(Se,{})}),e.jsx("h2",{style:t.title,children:"Check your email"}),e.jsxs("p",{style:t.subtitle,children:["We've sent a password reset link to ",e.jsx("strong",{children:R}),". Click the link in the email to reset your password."]})]}),e.jsx("button",{type:"button",onClick:ie,style:t.buttonPrimary,children:"Return to login"}),e.jsxs("p",{style:{...t.linkText,marginTop:"16px"},children:["Didn't receive the email?"," ",e.jsx("button",{type:"button",onClick:M,style:t.link,disabled:y,children:y?"Resending...":"Resend"})]})]}),oe=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logoImage})}),e.jsxs("div",{style:t.header,children:[e.jsx("div",{style:{...t.headerIcon,backgroundColor:"rgba(16, 185, 129, 0.1)"},children:e.jsx(Se,{})}),e.jsx("h2",{style:t.title,children:"Magic link sent!"}),e.jsxs("p",{style:t.subtitle,children:["We've sent a magic login link to ",e.jsx("strong",{children:R}),". Click the link in the email to sign in instantly."]})]}),e.jsx("button",{type:"button",onClick:ie,style:t.buttonPrimary,children:"Return to login"}),e.jsxs("p",{style:{...t.linkText,marginTop:"16px"},children:["Didn't receive the email?"," ",e.jsx("button",{type:"button",onClick:H,style:t.link,disabled:y,children:y?"Resending...":"Resend"})]})]}),ue=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logoImage})}),e.jsxs("div",{style:t.header,children:[e.jsx("div",{style:{...t.headerIcon,backgroundColor:"rgba(16, 185, 129, 0.1)"},children:e.jsx(Se,{})}),e.jsx("h2",{style:t.title,children:"You're all set!"}),e.jsx("p",{style:t.subtitle,children:"Your account has been created successfully. Welcome to Split Lease!"})]}),e.jsx("button",{type:"button",onClick:a,style:t.buttonPrimary,children:"Get started"})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:t.overlay,onClick:U,children:e.jsxs("div",{style:t.modal,onClick:n=>n.stopPropagation(),children:[!u&&e.jsx("button",{style:t.closeBtn,onClick:a,"aria-label":"Close",children:e.jsx(Ae,{})}),f===N.ENTRY&&te(),f===N.USER_TYPE&&xe(),f===N.IDENTITY&&Le(),f===N.PASSWORD&&Me(),f===N.LOGIN&&be(),f===N.PASSWORD_RESET&&P(),f===N.MAGIC_LINK&&K(),f===N.RESET_SENT&&Z(),f===N.MAGIC_LINK_SENT&&oe(),f===N.SUCCESS&&ue()]})}),x&&x.length>0&&e.jsx(Ke,{toasts:x,onRemove:g}),me.showModal&&e.jsx("div",{style:t.overlay,onClick:()=>re({email:"",showModal:!1}),children:e.jsxs("div",{style:t.modal,onClick:n=>n.stopPropagation(),children:[e.jsx("button",{style:t.closeBtn,onClick:()=>re({email:"",showModal:!1}),"aria-label":"Close",children:e.jsx(Ae,{})}),e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"Account Already Exists"}),e.jsxs("p",{style:t.subtitle,children:["An account with ",e.jsx("strong",{children:me.email})," already exists."]})]}),e.jsx("p",{style:{...t.helperText,textAlign:"center",marginBottom:"20px"},children:"Would you like to log in to your existing account instead?"}),e.jsx("button",{type:"button",style:t.buttonPrimary,onClick:()=>{re({email:"",showModal:!1}),O({...I,email:me.email}),ie()},children:"Log in instead"}),e.jsx("button",{type:"button",style:{...t.buttonSecondary,marginTop:"12px"},onClick:()=>re({email:"",showModal:!1}),children:"Try a different email"})]})}),Q.showModal&&e.jsx("div",{style:t.overlay,onClick:()=>l({email:"",showModal:!1}),children:e.jsxs("div",{style:t.modal,onClick:n=>n.stopPropagation(),children:[e.jsx("button",{style:t.closeBtn,onClick:()=>l({email:"",showModal:!1}),"aria-label":"Close",children:e.jsx(Ae,{})}),e.jsx("div",{style:t.logoContainer,children:e.jsx("img",{src:ce,alt:"Split Lease",style:t.logo})}),e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"No Account Found"}),e.jsxs("p",{style:t.subtitle,children:["We couldn't find an account with ",e.jsx("strong",{children:Q.email}),"."]})]}),e.jsx("p",{style:{...t.helperText,textAlign:"center",marginBottom:"20px"},children:"Would you like to create a new account instead?"}),e.jsx("button",{type:"button",style:t.buttonPrimary,onClick:()=>{l({email:"",showModal:!1}),d({...o,email:Q.email}),$()},children:"Sign up instead"}),e.jsx("button",{type:"button",style:{...t.buttonSecondary,marginTop:"12px"},onClick:()=>{l({email:"",showModal:!1}),ie()},children:"Try a different login method"})]})})]})}async function Ht(s){try{const{data:a,error:r}=await v.from("user").select('"Proposals List"').eq("_id",s).single();if(r)return console.error("Error fetching user:",r),[];const c=a==null?void 0:a["Proposals List"];if(!c||!Array.isArray(c)||c.length===0)return console.log("No proposals found in user's Proposals List"),[];console.log(`ðŸ“‹ Found ${c.length} proposal IDs in user's Proposals List`);const{data:u,error:p}=await v.from("proposal").select("*").in("_id",c).or("Deleted.is.null,Deleted.eq.false").order("Created Date",{ascending:!1});return p?(console.error("Error fetching proposals:",p),[]):(console.log(`âœ… Successfully fetched ${(u==null?void 0:u.length)||0} proposals from ${c.length} IDs`),u||[])}catch(a){return console.error("Exception fetching proposals:",a),[]}}async function Gt(s){if(!s)return console.log("fetchLastProposalDefaults: No userId provided"),null;try{const{data:a,error:r}=await v.from("proposal").select('"Move in range start", "Reservation Span (Weeks)"').eq("Guest",s).or("Deleted.is.null,Deleted.eq.false").order("Created Date",{ascending:!1}).limit(1).single();return r||!a?(console.log("No previous proposal found for pre-population"),null):(console.log("Found last proposal defaults:",{moveInDate:a["Move in range start"],reservationSpanWeeks:a["Reservation Span (Weeks)"]}),{moveInDate:a["Move in range start"]||null,reservationSpanWeeks:a["Reservation Span (Weeks)"]||null})}catch(a){return console.warn("Error fetching last proposal defaults:",a),null}}async function Wt(s){var a;try{const r={...s};if(s.Listing){const{data:c,error:u}=await v.from("listing").select("*").eq("_id",s.Listing).single();!u&&c&&(r._listing=c)}if(s.Guest){const{data:c,error:u}=await v.from("user").select(`
          _id,
          "Name - First",
          "Name - Full",
          "Profile Photo",
          "About Me / Bio",
          "email as text",
          "Phone Number (as text)",
          "Verify - Linked In ID",
          "Verify - Phone",
          "is email confirmed",
          "user verified?"
        `).eq("_id",s.Guest).single();!u&&c&&(r._guest=c)}if((a=r._listing)!=null&&a["Created By"]){const{data:c,error:u}=await v.from("user").select(`
          _id,
          "Name - First",
          "Name - Full",
          "Profile Photo",
          "About Me / Bio",
          "email as text",
          "Phone Number (as text)",
          "Verify - Linked In ID",
          "Verify - Phone",
          "is email confirmed",
          "user verified?"
        `).eq("_id",r._listing["Created By"]).single();!u&&c&&(r._host=c)}if(s["House Rules"]&&Array.isArray(s["House Rules"])&&s["House Rules"].length>0){const{data:c,error:u}=await v.schema("reference_table").from("zat_features_houserule").select("_id, Name, Icon").in("_id",s["House Rules"]);!u&&c&&(r._houseRules=c)}if(s["virtual meeting"]){const{data:c,error:u}=await v.from("virtualmeetingschedulesandlinks").select("*").eq("_id",s["virtual meeting"]).single();!u&&c&&(r._virtualMeeting=c)}return r}catch(r){return console.error("Error loading proposal details:",r),s}}export{Ft as L,vt as M,F as N,Bt as S,xt as T,Ht as a,jt as b,_t as c,Gt as f,Wt as l,lt as n,mt as u};
