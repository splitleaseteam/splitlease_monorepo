import{r as t,j as e,c as O,R as U}from"./client-BJVKzfAi.js";import{s as Q}from"./supabase-BoCLEw6R.js";import{H as T}from"./Header-BJKWma2V.js";import{F as H}from"./Footer-Bzf1rLKh.js";import{E as G}from"./ErrorBoundary-9_HbXv1y.js";/* empty css             */import"./config-QPKPRtag.js";import"./auth-QZ4BJadW.js";import"./constants-CPVJY5eo.js";import"./Toast-BQk6Nzgd.js";import"./proposalDataFetcher-CipdyWU2.js";import"./proposalStatuses-1Bj0NYR4.js";function V(){const[l,r]=t.useState(null),[i,s]=t.useState(null),[d,o]=t.useState([]),[h,a]=t.useState(null),[n,c]=t.useState({borough:"",maxPrice:null,minScore:0}),[m,f]=t.useState(!1),[p,N]=t.useState(!1),[g,b]=t.useState(!1),[k,q]=t.useState(null),[y,j]=t.useState(!1),[S,v]=t.useState(!1),C=t.useCallback(async(u,x)=>{const{data:M,error:P}=await Q.functions.invoke("quick-match",{body:{action:u,payload:x}});if(P)throw console.error("[useQuickMatchPageLogic] Edge Function error:",P),new Error(P.message||"Edge Function call failed");return M},[]);t.useEffect(()=>{const x=new URLSearchParams(window.location.search).get("proposal_id");x&&r(x)},[]),t.useEffect(()=>{l&&L(l)},[l]);const L=t.useCallback(async u=>{f(!0),q(null);try{const x=await C("get_proposal",{proposal_id:u});if(x.proposal)s(x.proposal);else throw new Error("No proposal data returned")}catch(x){console.error("[useQuickMatchPageLogic] fetchProposal error:",x),q(`Failed to load proposal: ${x.message}`)}finally{f(!1)}},[C]),w=t.useCallback(async()=>{if(!l){q("No proposal selected. Add proposal_id to the URL.");return}N(!0),q(null);try{const u=await C("search_candidates",{proposal_id:l,filters:{borough:n.borough||void 0,max_price:n.maxPrice||void 0,min_score:n.minScore||void 0},limit:20});u.candidates?o(u.candidates):o([])}catch(u){console.error("[useQuickMatchPageLogic] searchCandidates error:",u),q(`Failed to search candidates: ${u.message}`)}finally{N(!1)}},[l,n,C]),F=t.useCallback(async u=>{if(!h||!l){q("No candidate selected");return}b(!0),q(null);try{await C("save_choice",{proposal_id:l,matched_listing_id:h.listing.id,match_score:h.score,match_reason:u||null}),j(!1),v(!0),a(null)}catch(x){console.error("[useQuickMatchPageLogic] saveChoice error:",x),q(`Failed to save match: ${x.message}`)}finally{b(!1)}},[l,h,C]),$=t.useCallback((u,x)=>{c(M=>({...M,[u]:x}))},[]),R=t.useCallback(()=>{w()},[w]),E=t.useCallback(()=>{c({borough:"",maxPrice:null,minScore:0})},[]),_=t.useCallback(u=>{a(u),j(!0)},[]),I=t.useCallback(()=>{j(!1),a(null)},[]),B=t.useCallback(u=>{const x=typeof u=="object"?u.notes:u;F(x)},[F]),A=t.useCallback(()=>{s(null),o([]),a(null),c({borough:"",maxPrice:null,minScore:0}),q(null),v(!1),j(!1)},[]),D=t.useCallback(()=>{v(!1)},[]);return{proposalId:l,proposal:i,candidates:d,selectedCandidate:h,filters:n,isLoadingProposal:m,isLoadingCandidates:p,isSubmitting:g,error:k,isModalOpen:y,matchSaved:S,handleFilterChange:$,handleApplyFilters:R,handleResetFilters:E,handleSelectCandidate:_,handleCloseModal:I,handleConfirmChoice:B,searchCandidates:w,handleReset:A,handleDismissSuccess:D}}function W({proposal:l,isLoading:r}){if(r)return e.jsxs("div",{className:"qm-proposal-card qm-proposal-card--loading",children:[e.jsx("div",{className:"qm-skeleton qm-skeleton--title"}),e.jsx("div",{className:"qm-skeleton qm-skeleton--text"}),e.jsx("div",{className:"qm-skeleton qm-skeleton--text"}),e.jsx("div",{className:"qm-skeleton qm-skeleton--text qm-skeleton--short"})]});if(!l)return e.jsx("div",{className:"qm-proposal-card qm-proposal-card--empty",children:e.jsx("p",{children:"No proposal selected. Add a proposal_id to the URL."})});const{guest:i,listing:s,daysSelected:d,nightsPerWeek:o,nightlyPrice:h,status:a,moveInStart:n,moveInEnd:c}=l,m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],f=d&&d.length>0?d.map(N=>m[N]||N).join(", "):"Not specified",p=N=>N?new Date(N).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"Not specified";return e.jsxs("div",{className:"qm-proposal-card",children:[e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Guest"}),e.jsxs("div",{className:"qm-proposal-guest",children:[e.jsx("span",{className:"qm-guest-name",children:(i==null?void 0:i.fullName)||(i==null?void 0:i.email)||"Unknown Guest"}),(i==null?void 0:i.email)&&e.jsx("span",{className:"qm-guest-email",children:i.email})]})]}),e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Original Listing"}),e.jsxs("div",{className:"qm-proposal-listing",children:[e.jsx("span",{className:"qm-listing-title",children:(s==null?void 0:s.title)||"Unknown Listing"}),(s==null?void 0:s.hoodName)&&e.jsxs("span",{className:"qm-listing-location",children:[s.hoodName,s.boroughName&&`, ${s.boroughName}`]})]})]}),e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Status"}),e.jsx("span",{className:`qm-status-badge qm-status-badge--${(a||"pending").toLowerCase()}`,children:a||"Pending"})]}),e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Requested Schedule"}),e.jsxs("div",{className:"qm-proposal-details",children:[e.jsxs("div",{className:"qm-detail-row",children:[e.jsx("span",{className:"qm-detail-label",children:"Days:"}),e.jsx("span",{className:"qm-detail-value",children:f})]}),e.jsxs("div",{className:"qm-detail-row",children:[e.jsx("span",{className:"qm-detail-label",children:"Nights/Week:"}),e.jsx("span",{className:"qm-detail-value",children:o||"Not specified"})]})]})]}),e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Move-in Range"}),e.jsxs("div",{className:"qm-proposal-details",children:[e.jsxs("div",{className:"qm-detail-row",children:[e.jsx("span",{className:"qm-detail-label",children:"From:"}),e.jsx("span",{className:"qm-detail-value",children:p(n)})]}),e.jsxs("div",{className:"qm-detail-row",children:[e.jsx("span",{className:"qm-detail-label",children:"To:"}),e.jsx("span",{className:"qm-detail-value",children:p(c)})]})]})]}),e.jsxs("div",{className:"qm-proposal-section",children:[e.jsx("h4",{className:"qm-proposal-section-title",children:"Pricing"}),e.jsxs("div",{className:"qm-proposal-pricing",children:[e.jsxs("span",{className:"qm-price-value",children:["$",h?h.toFixed(0):"0"]}),e.jsx("span",{className:"qm-price-unit",children:"/night"})]})]})]})}function K({candidate:l,onSelect:r,isSelected:i}){if(!l)return null;const{listing:s,host:d,score:o,tier:h}=l,a=m=>{switch(m){case"excellent":return"qm-tier--excellent";case"good":return"qm-tier--good";case"fair":return"qm-tier--fair";default:return"qm-tier--poor"}},c=(()=>{const m=s==null?void 0:s.nightlyRates;return m&&(m.rate4||m.rate3||m.rate5||m.rate2||m.rate7)||null})();return e.jsxs("div",{className:`qm-candidate-card ${i?"qm-candidate-card--selected":""}`,onClick:r,role:"button",tabIndex:0,onKeyDown:m=>m.key==="Enter"&&r(),children:[e.jsxs("div",{className:`qm-score-badge ${a(h)}`,children:[e.jsx("span",{className:"qm-score-value",children:Math.round(o)}),e.jsx("span",{className:"qm-score-tier",children:h})]}),e.jsxs("div",{className:"qm-candidate-content",children:[e.jsx("h4",{className:"qm-candidate-title",children:(s==null?void 0:s.title)||"Unnamed Listing"}),e.jsxs("div",{className:"qm-candidate-location",children:[(s==null?void 0:s.hoodName)&&e.jsx("span",{children:s.hoodName}),(s==null?void 0:s.boroughName)&&e.jsx("span",{className:"qm-candidate-borough",children:s.boroughName})]}),d&&(d.fullName||d.firstName)&&e.jsxs("div",{className:"qm-candidate-host",children:[e.jsx("span",{className:"qm-host-label",children:"Host:"}),e.jsx("span",{className:"qm-host-name",children:d.fullName||d.firstName}),d.userVerified&&e.jsx("span",{className:"qm-verified-badge",title:"Verified Host",children:"Verified"})]}),c!==null&&e.jsxs("div",{className:"qm-candidate-price",children:[e.jsxs("span",{className:"qm-price-amount",children:["$",c]}),e.jsx("span",{className:"qm-price-per",children:"/night"})]}),(s==null?void 0:s.daysAvailable)&&s.daysAvailable.length>0&&e.jsxs("div",{className:"qm-candidate-days",children:[s.daysAvailable.length," days available"]})]}),e.jsx("div",{className:"qm-candidate-select",children:e.jsx("span",{className:"qm-select-label",children:i?"Selected":"Select"})})]})}const z=[{value:"",label:"All Boroughs"},{value:"Manhattan",label:"Manhattan"},{value:"Brooklyn",label:"Brooklyn"},{value:"Queens",label:"Queens"},{value:"Bronx",label:"Bronx"},{value:"Staten Island",label:"Staten Island"}],J=[{value:0,label:"Any Score"},{value:50,label:"50+ (Fair)"},{value:60,label:"60+ (Good)"},{value:75,label:"75+ (Excellent)"}];function X({filters:l,onFilterChange:r,onApply:i,onReset:s}){const d=a=>{r("borough",a.target.value)},o=a=>{const n=a.target.value;r("maxPrice",n?parseInt(n,10):null)},h=a=>{const n=a.target.value;r("minScore",parseInt(n,10)||0)};return e.jsxs("div",{className:"qm-filters",children:[e.jsxs("div",{className:"qm-filter-group",children:[e.jsx("label",{htmlFor:"qm-borough-filter",className:"qm-filter-label",children:"Borough"}),e.jsx("select",{id:"qm-borough-filter",className:"qm-filter-select",value:l.borough||"",onChange:d,children:z.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"qm-filter-group",children:[e.jsx("label",{htmlFor:"qm-price-filter",className:"qm-filter-label",children:"Max Price/Night"}),e.jsx("input",{id:"qm-price-filter",type:"number",className:"qm-filter-input",placeholder:"e.g., 150",min:"0",step:"10",value:l.maxPrice||"",onChange:o})]}),e.jsxs("div",{className:"qm-filter-group",children:[e.jsx("label",{htmlFor:"qm-score-filter",className:"qm-filter-label",children:"Minimum Score"}),e.jsx("select",{id:"qm-score-filter",className:"qm-filter-select",value:l.minScore||0,onChange:h,children:J.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsx("div",{className:"qm-filter-actions",children:e.jsx("button",{type:"button",className:"qm-filter-btn qm-filter-btn--reset",onClick:s,children:"Reset"})})]})}function Y({breakdown:l,totalScore:r,maxPossibleScore:i=95,compact:s=!1}){if(!l)return null;const d=(n,c)=>!c||c===0?0:Math.round(n/c*100),o=n=>n>=80?"qm-score-bar--excellent":n>=60?"qm-score-bar--good":n>=40?"qm-score-bar--fair":"qm-score-bar--poor",h=["borough","price","schedule","weeklyStay","duration","host"],a=d(r,i);return e.jsxs("div",{className:`qm-score-breakdown ${s?"qm-score-breakdown--compact":""}`,children:[e.jsxs("div",{className:"qm-score-overall",children:[e.jsxs("div",{className:"qm-score-overall-header",children:[e.jsx("span",{className:"qm-score-overall-label",children:"Match Score"}),e.jsxs("span",{className:"qm-score-overall-value",children:[Math.round(r),"/",i]})]}),e.jsx("div",{className:"qm-score-bar qm-score-bar--overall",children:e.jsx("div",{className:`qm-score-bar-fill ${o(a)}`,style:{width:`${a}%`},role:"progressbar","aria-valuenow":r,"aria-valuemin":0,"aria-valuemax":i,"aria-label":`Overall score: ${r} out of ${i}`})}),e.jsxs("span",{className:"qm-score-overall-percent",children:[a,"%"]})]}),!s&&e.jsx("div",{className:"qm-score-criteria",children:h.map(n=>{const c=l[n];if(!c)return null;const m=d(c.score,c.max);return e.jsxs("div",{className:"qm-score-criterion",children:[e.jsxs("div",{className:"qm-criterion-header",children:[e.jsx("span",{className:"qm-criterion-label",children:c.label}),e.jsxs("span",{className:"qm-criterion-score",children:[c.score,"/",c.max]})]}),e.jsx("div",{className:"qm-score-bar",children:e.jsx("div",{className:`qm-score-bar-fill ${o(m)}`,style:{width:`${m}%`},role:"progressbar","aria-valuenow":c.score,"aria-valuemin":0,"aria-valuemax":c.max,"aria-label":`${c.label}: ${c.score} out of ${c.max}`})}),c.description&&e.jsx("span",{className:"qm-criterion-desc",children:c.description})]},n)})})]})}function Z({isOpen:l,onClose:r,candidate:i,proposal:s,onConfirm:d,isSubmitting:o=!1}){var y,j,S;const[h,a]=t.useState("");if(!l)return null;const n=v=>{v.target===v.currentTarget&&r()},c=v=>{v.key==="Escape"&&!o&&r()},m=()=>{d&&d({notes:h.trim()})},f=v=>{switch(v){case"excellent":return"qm-tier--excellent";case"good":return"qm-tier--good";case"fair":return"qm-tier--fair";default:return"qm-tier--poor"}},{listing:p,host:N,score:g,tier:b,breakdown:k,maxPossibleScore:q}=i||{};return e.jsx("div",{className:"qm-modal-overlay",onClick:n,onKeyDown:c,role:"dialog","aria-modal":"true","aria-labelledby":"qm-modal-title",children:e.jsxs("div",{className:"qm-modal",children:[e.jsxs("div",{className:"qm-modal-header",children:[e.jsx("h3",{id:"qm-modal-title",className:"qm-modal-title",children:"Confirm Match Selection"}),e.jsx("button",{className:"qm-modal-close",onClick:r,disabled:o,"aria-label":"Close modal",children:e.jsx("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",width:"24",height:"24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"qm-modal-body",children:[e.jsxs("div",{className:"qm-modal-section",children:[e.jsx("h4",{className:"qm-modal-section-title",children:"Proposal"}),e.jsxs("div",{className:"qm-modal-proposal-info",children:[e.jsx("span",{className:"qm-modal-guest",children:((y=s==null?void 0:s.guest)==null?void 0:y.fullName)||((j=s==null?void 0:s.guest)==null?void 0:j.email)||"Guest"}),e.jsxs("span",{className:"qm-modal-original",children:["Original: ",((S=s==null?void 0:s.listing)==null?void 0:S.title)||"Unknown listing"]})]})]}),e.jsxs("div",{className:"qm-modal-section",children:[e.jsx("h4",{className:"qm-modal-section-title",children:"Selected Match"}),e.jsxs("div",{className:"qm-modal-listing",children:[e.jsxs("div",{className:"qm-modal-listing-header",children:[e.jsx("span",{className:"qm-modal-listing-title",children:(p==null?void 0:p.title)||"Unnamed Listing"}),e.jsxs("span",{className:`qm-modal-tier ${f(b)}`,children:[b," (",Math.round(g),")"]})]}),e.jsxs("span",{className:"qm-modal-listing-location",children:[(p==null?void 0:p.hoodName)&&p.hoodName,(p==null?void 0:p.boroughName)&&`, ${p.boroughName}`]}),N&&e.jsxs("span",{className:"qm-modal-host",children:["Host: ",N.fullName||N.firstName||"Unknown",N.userVerified&&e.jsx("span",{className:"qm-verified-badge",children:"Verified"})]})]})]}),k&&e.jsxs("div",{className:"qm-modal-section",children:[e.jsx("h4",{className:"qm-modal-section-title",children:"Score Breakdown"}),e.jsx(Y,{breakdown:k,totalScore:g,maxPossibleScore:q||95,compact:!1})]}),e.jsxs("div",{className:"qm-modal-section",children:[e.jsxs("h4",{className:"qm-modal-section-title",children:["Notes ",e.jsx("span",{className:"qm-optional",children:"(optional)"})]}),e.jsx("textarea",{className:"qm-modal-notes",value:h,onChange:v=>a(v.target.value),placeholder:"Add any notes about why this match was selected...",rows:3,disabled:o})]})]}),e.jsxs("div",{className:"qm-modal-footer",children:[e.jsx("button",{type:"button",className:"qm-modal-btn qm-modal-btn--cancel",onClick:r,disabled:o,children:"Cancel"}),e.jsx("button",{type:"button",className:"qm-modal-btn qm-modal-btn--confirm",onClick:m,disabled:o,children:o?"Saving...":"Confirm Match"})]})]})})}function ee(){const{proposal:l,candidates:r,selectedCandidate:i,filters:s,isLoadingProposal:d,isLoadingCandidates:o,isSubmitting:h,error:a,isModalOpen:n,matchSaved:c,handleFilterChange:m,handleApplyFilters:f,handleResetFilters:p,handleSelectCandidate:N,handleCloseModal:g,handleConfirmChoice:b,searchCandidates:k,handleReset:q,handleDismissSuccess:y}=V();return e.jsxs("div",{className:"quick-match-page",children:[e.jsx(T,{}),e.jsx("main",{className:"quick-match-main",children:e.jsxs("div",{className:"quick-match-container",children:[e.jsxs("section",{className:"quick-match-hero",children:[e.jsx("h1",{children:"Quick Match"}),e.jsx("p",{children:"Find alternative listings for guest proposals"})]}),c&&e.jsxs("div",{className:"quick-match-success",children:[e.jsx("p",{children:"Match saved successfully!"}),e.jsx("button",{type:"button",className:"qm-success-dismiss",onClick:y,children:"Dismiss"})]}),a&&e.jsxs("div",{className:"quick-match-error",children:[e.jsx("p",{children:a}),e.jsx("button",{onClick:q,children:"Try Again"})]}),e.jsxs("div",{className:"quick-match-content",children:[e.jsxs("section",{className:"quick-match-proposal-panel",children:[e.jsx("h2",{className:"qm-panel-title",children:"Proposal Details"}),e.jsx(W,{proposal:l,isLoading:d}),l&&e.jsxs("div",{className:"qm-filters-section",children:[e.jsx("h3",{className:"qm-section-title",children:"Search Filters"}),e.jsx(X,{filters:s,onFilterChange:m,onApply:f,onReset:p}),e.jsx("button",{type:"button",className:"qm-search-button",onClick:k,disabled:o,children:o?"Searching...":"Find Matches"})]})]}),e.jsxs("section",{className:"quick-match-results-panel",children:[e.jsxs("h2",{className:"qm-panel-title",children:["Matching Listings",r.length>0&&e.jsxs("span",{className:"qm-results-count",children:["(",r.length,")"]})]}),o&&e.jsxs("div",{className:"quick-match-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Searching for matches..."})]}),!o&&r.length===0&&e.jsxs("div",{className:"qm-empty-state",children:[e.jsx("p",{children:"No matches found."}),e.jsx("p",{className:"qm-empty-hint",children:l?'Try adjusting your filters or click "Find Matches" to search.':"Load a proposal to search for matching listings."})]}),!o&&r.length>0&&e.jsx("div",{className:"qm-candidates-grid",children:r.map(j=>e.jsx(K,{candidate:j,onSelect:()=>N(j),isSelected:(i==null?void 0:i.listing.id)===j.listing.id},j.listing.id))})]})]}),e.jsx(Z,{isOpen:n,onClose:g,candidate:i,proposal:l,onConfirm:b,isSubmitting:h})]})}),e.jsx(H,{})]})}O(document.getElementById("root")).render(e.jsx(U.StrictMode,{children:e.jsx(G,{children:e.jsx(ee,{})})}));
