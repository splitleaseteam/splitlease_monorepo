import{s as b}from"./supabase-BoCLEw6R.js";const W={DEBUG:0,INFO:1,WARN:2},z=W.WARN,s={debug:(...e)=>z<=W.DEBUG,info:(...e)=>z<=W.INFO,warn:(...e)=>console.warn("[WARN]",...e),error:(...e)=>console.error("[ERROR]",...e)},Y=e=>new Promise(t=>setTimeout(t,e)),T={AUTH_TOKEN:"__sl_at__",SESSION_ID:"__sl_sid__",REFRESH_DATA:"__sl_rd__"},_={IS_AUTHENTICATED:"sl_auth_state",USER_ID:"sl_user_id",USER_TYPE:"sl_user_type",SESSION_VALID:"sl_session_valid",FIRST_NAME:"sl_first_name",AVATAR_URL:"sl_avatar_url",LINKEDIN_OAUTH_USER_TYPE:"sl_linkedin_oauth_user_type",LINKEDIN_OAUTH_LOGIN_FLOW:"sl_linkedin_oauth_login_flow",GOOGLE_OAUTH_USER_TYPE:"sl_google_oauth_user_type",GOOGLE_OAUTH_LOGIN_FLOW:"sl_google_oauth_login_flow"};function R(e){e&&localStorage.setItem(T.AUTH_TOKEN,e)}function j(){return localStorage.getItem(T.AUTH_TOKEN)}function P(e){e&&localStorage.setItem(T.SESSION_ID,e)}function x(){return localStorage.getItem(T.SESSION_ID)}function M(){localStorage.removeItem(T.AUTH_TOKEN),localStorage.removeItem(T.SESSION_ID),localStorage.removeItem(T.REFRESH_DATA)}function k(e,t=null){localStorage.setItem(_.IS_AUTHENTICATED,e?"true":"false"),t&&localStorage.setItem(_.USER_ID,t)}function $(){return localStorage.getItem(_.IS_AUTHENTICATED)==="true"}function V(){return localStorage.getItem(_.USER_ID)}function C(e){e&&localStorage.setItem(_.USER_TYPE,e)}function X(){return localStorage.getItem(_.USER_TYPE)}function K(e){e&&localStorage.setItem(_.FIRST_NAME,e)}function Z(){return localStorage.getItem(_.FIRST_NAME)}function B(e){e&&localStorage.setItem(_.AVATAR_URL,e)}function Q(){return localStorage.getItem(_.AVATAR_URL)}function q(){M(),localStorage.removeItem(_.IS_AUTHENTICATED),localStorage.removeItem(_.USER_ID),localStorage.removeItem(_.USER_TYPE),localStorage.removeItem(_.SESSION_VALID),localStorage.removeItem(_.FIRST_NAME),localStorage.removeItem(_.AVATAR_URL),localStorage.removeItem("sl_last_activity"),localStorage.removeItem("splitlease_auth_token"),localStorage.removeItem("splitlease_session_id"),localStorage.removeItem("splitlease_last_auth"),localStorage.removeItem("splitlease_user_type"),localStorage.removeItem("userEmail"),localStorage.removeItem("splitlease_supabase_user_id");const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);r&&(r.startsWith("sb-")||r.startsWith("supabase."))&&e.push(r)}e.forEach(t=>localStorage.removeItem(t)),document.cookie="loggedIn=false; path=/; max-age=0",document.cookie="username=; path=/; max-age=0",document.cookie="splitlease_auth=; path=/; max-age=0",document.cookie="loggedIn=false; path=/; max-age=0; domain=.split.lease",document.cookie="username=; path=/; max-age=0; domain=.split.lease",document.cookie="splitlease_auth=; path=/; max-age=0; domain=.split.lease"}function ee(){const e=j(),t=x();return!!(e&&t)}function se(){const e=localStorage.getItem("splitlease_auth_token"),t=localStorage.getItem("splitlease_session_id");if(e&&t){console.log("üîÑ Migrating legacy keys to new format..."),R(e),P(t),k(!0,t);const r=localStorage.getItem("splitlease_user_type");return r&&C(r),localStorage.removeItem("splitlease_auth_token"),localStorage.removeItem("splitlease_session_id"),localStorage.removeItem("splitlease_last_auth"),console.log("‚úÖ Migration complete"),!0}return!1}function te(e){e&&localStorage.setItem(_.LINKEDIN_OAUTH_USER_TYPE,e)}function re(){return localStorage.getItem(_.LINKEDIN_OAUTH_USER_TYPE)}function w(){localStorage.removeItem(_.LINKEDIN_OAUTH_USER_TYPE)}function oe(e){localStorage.setItem(_.LINKEDIN_OAUTH_LOGIN_FLOW,"true")}function ae(){return localStorage.getItem(_.LINKEDIN_OAUTH_LOGIN_FLOW)==="true"}function U(){localStorage.removeItem(_.LINKEDIN_OAUTH_LOGIN_FLOW)}function ne(e){e&&localStorage.setItem(_.GOOGLE_OAUTH_USER_TYPE,e)}function ie(){return localStorage.getItem(_.GOOGLE_OAUTH_USER_TYPE)}function O(){localStorage.removeItem(_.GOOGLE_OAUTH_USER_TYPE)}function ue(e){localStorage.setItem(_.GOOGLE_OAUTH_LOGIN_FLOW,"true")}function ce(){return localStorage.getItem(_.GOOGLE_OAUTH_LOGIN_FLOW)==="true"}function L(){localStorage.removeItem(_.GOOGLE_OAUTH_LOGIN_FLOW)}let y=!1;function le(){const t=document.cookie.split("; ").find(r=>r.startsWith("username="));if(t){let r=decodeURIComponent(t.split("=")[1]);return r=r.replace(/^["']|["']$/g,""),r}return null}function de(){const e=document.cookie.split("; "),t=e.find(u=>u.startsWith("loggedIn="));e.find(u=>u.startsWith("username="));const r=t?t.split("=")[1]==="true":!1,h=le();return{isLoggedIn:r,username:h}}async function me(){var r,h,u,m,c,I,d,g;if(await se(),de().isLoggedIn)return y=!0,k(!0),!0;try{let{data:{session:o},error:a}=await b.auth.getSession();if(!o&&!a){s.debug("üîÑ No immediate Supabase session, waiting briefly for initialization..."),await Y(200);const n=await b.auth.getSession();o=(r=n.data)==null?void 0:r.session,a=n.error,o&&s.debug("‚úÖ Found Supabase session after brief wait")}if(o&&!a){s.debug("‚úÖ User authenticated via Supabase Auth session"),s.debug("   User ID:",(h=o.user)==null?void 0:h.id),s.debug("   Email:",(u=o.user)==null?void 0:u.email);const n=((c=(m=o.user)==null?void 0:m.user_metadata)==null?void 0:c.user_id)||((I=o.user)==null?void 0:I.id),l=(g=(d=o.user)==null?void 0:d.user_metadata)==null?void 0:g.user_type;return R(o.access_token),n&&(P(n),k(!0,n)),l&&C(l),y=!0,!0}}catch(o){s.debug("‚ö†Ô∏è Supabase session check failed:",o.message)}return $()&&await ee()?(y=!0,!0):(y=!1,k(!1),!1)}function v(){q(),y=!1}function H(){return j()}function F(e){R(e)}function ge(){return x()}function G(e){P(e)}function he(){return V()}function fe(){return X()}function E(e){e&&C(e)}function _e(){return Z()}function Ie(){return Q()}async function be(e,t){var r;try{s.debug("üîÑ Using direct fetch to bypass Supabase client session handling...");try{const i=`sb-${(r="https://qcfifybkaddcoimjroca.supabase.co".split("//")[1])==null?void 0:r.split(".")[0]}-auth-token`;i&&i!=="sb-undefined-auth-token"&&(localStorage.removeItem(i),s.debug("‚úÖ Cleared auth token from localStorage"))}catch(i){s.warn("‚ö†Ô∏è Could not clear localStorage:",i)}const h="https://qcfifybkaddcoimjroca.supabase.co",u="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8";s.debug("üì° Calling auth-user edge function via direct fetch...");const m=await fetch(`${h}/functions/v1/auth-user`,{method:"POST",headers:{"Content-Type":"application/json",apikey:u,Authorization:`Bearer ${u}`},body:JSON.stringify({action:"login",payload:{email:e,password:t}})}),c=await m.json();if(s.debug("üì° Response status:",m.status),s.debug("üì° Response data:",c),!m.ok)return s.error("‚ùå Edge Function HTTP error:",m.status),{success:!1,error:(c==null?void 0:c.error)||`HTTP ${m.status}: Failed to authenticate`};if(!c.success)return s.error("‚ùå Login failed:",c.error),{success:!1,error:c.error||"Login failed. Please try again."};const{access_token:I,refresh_token:d,expires_in:g,user_id:o,host_account_id:a,guest_account_id:n,supabase_user_id:l,user_type:f}=c.data;if(I&&d){const{error:i}=await b.auth.setSession({access_token:I,refresh_token:d});i?s.error("‚ùå Failed to set Supabase session:",i.message):s.debug("‚úÖ Supabase session set successfully");let p=0;const A=5;for(;p<A;){const{data:{session:N}}=await b.auth.getSession();if(N&&N.access_token===I){s.debug("‚úÖ Session verified and persisted");break}p++,s.debug(`‚è≥ Waiting for session to persist (attempt ${p}/${A})...`),await Y(100)}p>=A&&s.warn("‚ö†Ô∏è Session may not be fully persisted, but continuing...")}return F(I),G(o),k(!0,o),f&&E(f),y=!0,s.debug("‚úÖ Login successful (Supabase Auth)"),s.debug("   User ID (_id):",o),s.debug("   Supabase Auth ID:",l),s.debug("   User Type:",f),s.debug("   Session expires in:",g,"seconds"),l&&localStorage.setItem("splitlease_supabase_user_id",l),{success:!0,user_id:o,host_account_id:a,guest_account_id:n,supabase_user_id:l,user_type:f,expires_in:g}}catch(h){return s.error("‚ùå Login error:",h),{success:!1,error:"Network error. Please check your connection and try again."}}}async function Se(e,t,r,h=null){var m;if(!e||!t||!r)return{success:!1,error:"All fields are required."};if(t.length<4)return{success:!1,error:"Password must be at least 4 characters long."};if(t!==r)return{success:!1,error:"The two passwords do not match!"};const u={email:e,password:t,retype:r};h&&(u.additionalData=h);try{s.debug("üîÑ Using direct fetch to bypass Supabase client session handling...");try{const S=`sb-${(m="https://qcfifybkaddcoimjroca.supabase.co".split("//")[1])==null?void 0:m.split(".")[0]}-auth-token`;S&&S!=="sb-undefined-auth-token"&&(localStorage.removeItem(S),s.debug("‚úÖ Cleared auth token from localStorage"))}catch(S){s.warn("‚ö†Ô∏è Could not clear localStorage:",S)}const c="https://qcfifybkaddcoimjroca.supabase.co",I="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8";s.debug("üì° Calling auth-user edge function via direct fetch...");const d=await fetch(`${c}/functions/v1/auth-user`,{method:"POST",headers:{"Content-Type":"application/json",apikey:I,Authorization:`Bearer ${I}`},body:JSON.stringify({action:"signup",payload:u})}),g=await d.json();if(s.debug("üì° Response status:",d.status),s.debug("üì° Response data:",g),!d.ok)return s.error("‚ùå Edge Function HTTP error:",d.status),{success:!1,error:(g==null?void 0:g.error)||`HTTP ${d.status}: Failed to create account`};if(!g.success)return s.error("‚ùå Signup failed:",g.error),{success:!1,error:g.error||"Signup failed. Please try again."};s.debug("‚úÖ Edge Function returned successfully");const{access_token:o,refresh_token:a,expires_in:n,user_id:l,host_account_id:f,guest_account_id:i,supabase_user_id:p,user_type:A}=g.data;s.debug("üìã Extracted session data:"),s.debug("   access_token:",o?`${o.substring(0,20)}...`:"MISSING"),s.debug("   refresh_token:",a?`${a.substring(0,20)}...`:"MISSING"),s.debug("   user_id:",l),s.debug("   user_type:",A),s.debug("üîê About to call setSession...");let N=null;try{N=(await b.auth.setSession({access_token:o,refresh_token:a})).error,s.debug("üîê setSession completed, error:",N)}catch(S){s.error("üîê setSession threw an exception:",S),N=S}N?s.error("‚ùå Failed to set Supabase session:",N.message):s.debug("‚úÖ Supabase session set successfully");let J=0;const D=5;for(;J<D;){const{data:{session:S}}=await b.auth.getSession();if(S&&S.access_token===o){s.debug("‚úÖ Session verified and persisted");break}J++,s.debug(`‚è≥ Waiting for session to persist (attempt ${J}/${D})...`),await Y(100)}return J>=D&&s.warn("‚ö†Ô∏è Session may not be fully persisted, but continuing..."),F(o),G(l),k(!0,l),A&&E(A),y=!0,s.debug("‚úÖ Signup successful (Supabase Auth)"),s.debug("   User ID (_id):",l),s.debug("   Supabase Auth ID:",p),s.debug("   Host Account ID:",f),s.debug("   Guest Account ID:",i),s.debug("   User Type:",A),s.debug("   Session expires in:",n,"seconds"),p&&localStorage.setItem("splitlease_supabase_user_id",p),{success:!0,user_id:l,host_account_id:f,guest_account_id:i,supabase_user_id:p,user_type:A,expires_in:n}}catch(c){return s.error("‚ùå Signup error:",c),{success:!1,error:"Network error. Please check your connection and try again."}}}async function ye({clearOnFailure:e=!0}={}){var h,u,m,c,I,d,g;let t=H(),r=ge();if(!t||!r)try{let{data:{session:o},error:a}=await b.auth.getSession();if(!o&&!a){s.debug("[Auth] üîÑ No immediate session, waiting briefly for Supabase initialization..."),await Y(200);const n=await b.auth.getSession();o=(h=n.data)==null?void 0:h.session,a=n.error,o&&s.debug("[Auth] ‚úÖ Found Supabase session after brief wait")}if(o&&!a){s.debug("[Auth] ‚úÖ Found Supabase Auth session, syncing to secure storage"),t=o.access_token,r=((m=(u=o.user)==null?void 0:u.user_metadata)==null?void 0:m.user_id)||((c=o.user)==null?void 0:c.id),R(t),r&&(P(r),k(!0,r));const n=(d=(I=o.user)==null?void 0:I.user_metadata)==null?void 0:d.user_type;n&&C(n)}}catch(o){s.debug("[Auth] Error checking Supabase session:",o.message)}if(!t||!r)return null;try{const{data:o,error:a}=await b.functions.invoke("auth-user",{body:{action:"validate",payload:{token:t,user_id:r}}});if(a){if(s.error("‚ùå Edge Function error:",a),s.error("   Error context:",a.context),a.context&&typeof a.context.json=="function")try{const i=await a.context.json();s.error("   Error body from Response:",i),i!=null&&i.error&&s.error("   Detailed error from response:",i.error)}catch{}else if((g=a.context)!=null&&g.body)try{const i=typeof a.context.body=="string"?JSON.parse(a.context.body):a.context.body;i!=null&&i.error&&s.error("   Detailed error from response:",i.error)}catch{}return e&&v(),y=!1,null}if(!o.success)return s.debug("‚ùå Token validation failed"),s.debug("   Reason:",o.error||"Unknown"),e?(s.debug("   Clearing auth data..."),v()):s.debug("   Preserving session (clearOnFailure=false)"),y=!1,null;const n=o.data;let l=fe();!l||l===""?(l=n.userType||null,l&&(E(l),s.debug("‚úÖ User type fetched and cached:",l))):s.debug("‚úÖ User type loaded from cache:",l);const f={userId:n.userId,firstName:n.firstName||null,fullName:n.fullName||null,email:n.email||null,profilePhoto:n.profilePhoto||null,userType:l,accountHostId:n.accountHostId||n._id||null,aboutMe:n.aboutMe||null,needForSpace:n.needForSpace||null,specialNeeds:n.specialNeeds||null,proposalCount:n.proposalCount??0,hasSubmittedRentalApp:n.hasSubmittedRentalApp??!1,isUsabilityTester:n.isUsabilityTester??!1,phoneNumber:n.phoneNumber||null};return f.firstName&&K(f.firstName),f.profilePhoto&&B(f.profilePhoto),s.debug("‚úÖ User data validated:",f.firstName,"- Type:",f.userType),s.debug("üìä User proposalCount from Edge Function:",n.proposalCount,"‚Üí stored as:",f.proposalCount),y=!0,f}catch(o){return s.error("‚ùå Token validation error:",o),e&&v(),y=!1,null}}function ke(){const e=["/guest-proposals","/host-proposals","/account-profile","/host-dashboard","/self-listing","/listing-dashboard","/host-overview","/favorite-listings","/rental-application","/preview-split-lease"],t=window.location.pathname.replace(/\.html$/,"");return e.some(r=>t===r||t.startsWith(r+"/"))}async function Ae(){const e=H();if(!e)return v(),{success:!0,message:"No active session to logout"};try{await b.auth.signOut(),s.debug("‚úÖ Signed out from Supabase Auth client")}catch(t){s.warn("‚ö†Ô∏è Error signing out from Supabase Auth client:",t)}try{const{data:t,error:r}=await b.functions.invoke("auth-user",{body:{action:"logout",payload:{token:e}}});return v(),r||!t.success?(s.debug("‚ö†Ô∏è Logout API returned error, but local data cleared"),{success:!0,message:"Logged out locally"}):(s.debug("‚úÖ Logout successful"),{success:!0,message:t.data.message||"Logout successful"})}catch(t){return s.error("‚ùå Logout error:",t),v(),{success:!0,message:"Logged out locally (network error)"}}}function Ne(){const e=window.location.hash;if(!e)return null;const t=new URLSearchParams(e.substring(1)),r=t.get("error"),h=t.get("error_code"),u=t.get("error_description");return r||h?{error:r,errorCode:h,errorDescription:u?decodeURIComponent(u.replace(/\+/g," ")):null}:null}function we(){window.location.hash&&window.history.replaceState(null,"",window.location.pathname+window.location.search)}async function Oe(e){var h,u,m,c,I,d,g;if(!e)return{success:!1,error:"New password is required."};if(e.length<4)return{success:!1,error:"Password must be at least 4 characters long."};const{data:{session:t},error:r}=await b.auth.getSession();if(r||!t)return s.error("‚ùå No active session for password update"),{success:!1,error:"Invalid or expired reset link. Please request a new password reset."};try{const{data:o,error:a}=await b.functions.invoke("auth-user",{body:{action:"update_password",payload:{password:e,access_token:t.access_token}}});if(a){s.error("‚ùå Password update failed:",a);let f="Failed to update password. Please try again.";if(a.context&&typeof a.context.json=="function")try{const i=await a.context.json();s.error("   Error body from Response:",i),i!=null&&i.error&&(f=i.error)}catch{}else if((h=a.context)!=null&&h.body)try{const i=typeof a.context.body=="string"?JSON.parse(a.context.body):a.context.body;i!=null&&i.error&&(f=i.error)}catch{}return{success:!1,error:f}}if(!o.success&&o.error)return{success:!1,error:o.error};s.debug("‚úÖ Password updated successfully");const n=((m=(u=t.user)==null?void 0:u.user_metadata)==null?void 0:m.user_id)||((c=t.user)==null?void 0:c.id),l=(d=(I=t.user)==null?void 0:I.user_metadata)==null?void 0:d.user_type;return R(t.access_token),n&&(P(n),k(!0,n)),l&&C(l),y=!0,s.debug("‚úÖ User session preserved after password update"),s.debug("   User ID:",n),s.debug("   User Type:",l),{success:!0,message:((g=o==null?void 0:o.data)==null?void 0:g.message)||"Password updated successfully."}}catch(o){return s.error("‚ùå Password update error:",o),{success:!1,error:"Network error. Please check your connection and try again."}}}async function Te(e){te(e);try{const{data:t,error:r}=await b.auth.signInWithOAuth({provider:"linkedin_oidc",options:{redirectTo:`${window.location.origin}/account-profile`,scopes:"openid profile email"}});return r?(w(),{success:!1,error:r.message}):{success:!0,data:t}}catch(t){return w(),{success:!1,error:t.message}}}async function Ee(){var c,I,d,g,o,a,n,l,f;const{data:{session:e},error:t}=await b.auth.getSession();if(t||!e)return w(),{success:!1,error:(t==null?void 0:t.message)||"No session found after OAuth"};const r=e.user;if(!(((c=r==null?void 0:r.app_metadata)==null?void 0:c.provider)==="linkedin_oidc"||((d=(I=r==null?void 0:r.app_metadata)==null?void 0:I.providers)==null?void 0:d.includes("linkedin_oidc"))))return{success:!1,error:"Not a LinkedIn OAuth session"};const u=re()||"Guest",m={email:r.email,firstName:((g=r.user_metadata)==null?void 0:g.given_name)||((o=r.user_metadata)==null?void 0:o.first_name)||"",lastName:((a=r.user_metadata)==null?void 0:a.family_name)||((n=r.user_metadata)==null?void 0:n.last_name)||"",profilePhoto:((l=r.user_metadata)==null?void 0:l.picture)||((f=r.user_metadata)==null?void 0:f.avatar_url)||null,supabaseUserId:r.id};try{const i=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/auth-user",{method:"POST",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({action:"oauth_signup",payload:{...m,userType:u,provider:"linkedin_oidc",access_token:e.access_token,refresh_token:e.refresh_token}})}),p=await i.json();return!i.ok||!p.success?(w(),{success:!1,error:p.error||"Failed to create user record",isDuplicate:p.isDuplicate||!1,existingEmail:p.existingEmail||null}):(w(),F(e.access_token),G(p.data.user_id),k(!0,p.data.user_id),u&&E(u),{success:!0,data:p.data,isNewUser:p.data.isNewUser})}catch(i){return w(),{success:!1,error:i.message}}}async function Ue(){w(),oe();try{const{data:e,error:t}=await b.auth.signInWithOAuth({provider:"linkedin_oidc",options:{redirectTo:window.location.href,scopes:"openid profile email"}});return t?(U(),{success:!1,error:t.message}):{success:!0,data:e}}catch(e){return U(),{success:!1,error:e.message}}}async function Le(){var e,t,r,h;if(!ae())return{success:!1,error:"Not a login flow"};try{const{data:{session:u},error:m}=await b.auth.getSession();if(m||!u)return U(),{success:!1,error:(m==null?void 0:m.message)||"No session found after OAuth"};const c=u.user;if(!(((e=c==null?void 0:c.app_metadata)==null?void 0:e.provider)==="linkedin_oidc"||((r=(t=c==null?void 0:c.app_metadata)==null?void 0:t.providers)==null?void 0:r.includes("linkedin_oidc"))))return U(),{success:!1,error:"Not a LinkedIn OAuth session"};const d=c.email,g=c.id;s.debug("[Auth] LinkedIn OAuth login data:",{email:d,supabaseUserId:g});const o=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/auth-user",{method:"POST",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8",Authorization:`Bearer ${u.access_token}`},body:JSON.stringify({action:"oauth_login",payload:{email:d,supabaseUserId:g,access_token:u.access_token,refresh_token:u.refresh_token}})}),a=await o.json();if(U(),!o.ok||!a.success)return(h=a.data)!=null&&h.userNotFound?(s.debug("[Auth] User not found for OAuth login:",d),{success:!1,userNotFound:!0,email:d,error:"No account found with this email"}):{success:!1,error:a.error||"Failed to login"};const{user_id:n,user_type:l,supabase_user_id:f,access_token:i,refresh_token:p}=a.data;return F(u.access_token),G(n),k(!0,n),l&&E(l),f&&localStorage.setItem("splitlease_supabase_user_id",f),s.debug("[Auth] LinkedIn OAuth login successful"),{success:!0,data:a.data}}catch(u){return U(),s.error("[Auth] LinkedIn OAuth login callback error:",u),{success:!1,error:u.message}}}async function ve(e){ne(e);try{const{data:t,error:r}=await b.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/account-profile`,scopes:"openid profile email"}});return r?(O(),{success:!1,error:r.message}):{success:!0,data:t}}catch(t){return O(),{success:!1,error:t.message}}}async function Fe(){var c,I,d,g,o,a,n,l,f;const{data:{session:e},error:t}=await b.auth.getSession();if(t||!e)return O(),{success:!1,error:(t==null?void 0:t.message)||"No session found after OAuth"};const r=e.user;if(!(((c=r==null?void 0:r.app_metadata)==null?void 0:c.provider)==="google"||((d=(I=r==null?void 0:r.app_metadata)==null?void 0:I.providers)==null?void 0:d.includes("google"))))return{success:!1,error:"Not a Google OAuth session"};const u=ie()||"Guest",m={email:r.email,firstName:((g=r.user_metadata)==null?void 0:g.given_name)||((o=r.user_metadata)==null?void 0:o.first_name)||"",lastName:((a=r.user_metadata)==null?void 0:a.family_name)||((n=r.user_metadata)==null?void 0:n.last_name)||"",profilePhoto:((l=r.user_metadata)==null?void 0:l.picture)||((f=r.user_metadata)==null?void 0:f.avatar_url)||null,supabaseUserId:r.id};try{const i=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/auth-user",{method:"POST",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8",Authorization:`Bearer ${e.access_token}`},body:JSON.stringify({action:"oauth_signup",payload:{...m,userType:u,provider:"google",access_token:e.access_token,refresh_token:e.refresh_token}})}),p=await i.json();return!i.ok||!p.success?(O(),{success:!1,error:p.error||"Failed to create user record",isDuplicate:p.isDuplicate||!1,existingEmail:p.existingEmail||null}):(O(),s.debug("[Auth] Edge Function response:",JSON.stringify(p.data,null,2)),s.debug("[Auth] user_id from Edge Function:",p.data.user_id),s.debug("[Auth] supabase_user_id:",p.data.supabase_user_id),s.debug("[Auth] Supabase session user.id:",e.user.id),F(e.access_token),G(p.data.user_id),k(!0,p.data.user_id),u&&E(u),{success:!0,data:p.data,isNewUser:p.data.isNewUser})}catch(i){return O(),{success:!1,error:i.message}}}async function Ge(){O(),ue();try{const{data:e,error:t}=await b.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.href,scopes:"openid profile email"}});return t?(L(),{success:!1,error:t.message}):{success:!0,data:e}}catch(e){return L(),{success:!1,error:e.message}}}async function Re(){var e,t,r,h;if(!ce())return{success:!1,error:"Not a login flow"};try{const{data:{session:u},error:m}=await b.auth.getSession();if(m||!u)return L(),{success:!1,error:(m==null?void 0:m.message)||"No session found after OAuth"};const c=u.user;if(!(((e=c==null?void 0:c.app_metadata)==null?void 0:e.provider)==="google"||((r=(t=c==null?void 0:c.app_metadata)==null?void 0:t.providers)==null?void 0:r.includes("google"))))return L(),{success:!1,error:"Not a Google OAuth session"};const d=c.email,g=c.id;s.debug("[Auth] Google OAuth login data:",{email:d,supabaseUserId:g});const o=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/auth-user",{method:"POST",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8",Authorization:`Bearer ${u.access_token}`},body:JSON.stringify({action:"oauth_login",payload:{email:d,supabaseUserId:g,access_token:u.access_token,refresh_token:u.refresh_token}})}),a=await o.json();if(L(),!o.ok||!a.success)return(h=a.data)!=null&&h.userNotFound?(s.debug("[Auth] User not found for OAuth login:",d),{success:!1,userNotFound:!0,email:d,error:"No account found with this email"}):{success:!1,error:a.error||"Failed to login"};const{user_id:n,user_type:l,supabase_user_id:f,access_token:i,refresh_token:p}=a.data;return F(u.access_token),G(n),k(!0,n),l&&E(l),f&&localStorage.setItem("splitlease_supabase_user_id",f),s.debug("[Auth] Google OAuth login successful"),{success:!0,data:a.data}}catch(u){return L(),s.error("[Auth] Google OAuth login callback error:",u),{success:!1,error:u.message}}}export{j as A,H as B,ke as C,re as D,ie as E,Fe as F,Ee as G,Ue as H,Ge as I,Te as J,ve as K,be as L,Oe as M,ae as N,ce as O,Re as P,Le as Q,L as R,U as S,Ie as a,X as b,me as c,$ as d,he as e,Ae as f,_e as g,ge as h,V as i,x as j,fe as k,s as l,Ne as m,we as n,Z as o,q as p,se as q,k as r,Se as s,R as t,P as u,ye as v,C as w,ee as x,K as y,B as z};
