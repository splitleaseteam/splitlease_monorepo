import{r as d,j as e,c as U,R as J}from"./client-BJVKzfAi.js";import{s as H}from"./supabase-BoCLEw6R.js";import{E as Y}from"./ErrorBoundary-9_HbXv1y.js";/* empty css             */import"./config-QPKPRtag.js";const M="tech@leasesplit.com",I=["$$to$$","$$cc$$","$$bcc$$"],B=["$$cc$$","$$bcc$$","$$reply_to$$"];function Z(){const[l,x]=d.useState([]),[i,o]=d.useState(null),[m,n]=d.useState({}),[c,f]=d.useState({}),[E,b]=d.useState(""),[N,v]=d.useState(!0),[T,w]=d.useState(null),[C,S]=d.useState(!1),[_,$]=d.useState(null);d.useEffect(()=>{document.title="Email Unit Test | Admin"},[]),d.useEffect(()=>{s()},[]);const p=d.useMemo(()=>i&&l.find(t=>t._id===i)||null,[l,i]),P=d.useMemo(()=>R(p==null?void 0:p.Placeholder).filter(a=>!I.includes(a.key)),[p]),k=d.useMemo(()=>p?(c.$$to$$||[]).some(a=>a&&a.trim().length>0):!1,[p,c]);async function s(){try{v(!0),w(null);const{data:t,error:a}=await H.schema("reference_table").from("zat_email_html_template_eg_sendbasicemailwf_").select('_id, Name, Description, Placeholder, "Email Template JSON", Logo, "Created Date"').order("Created Date",{ascending:!1});if(a)throw a;x(t||[])}catch{w("Unable to load email templates. Please try again later.")}finally{v(!1)}}function g(t){if(o(t||null),b(""),$(null),!t){n({}),f({});return}const a=l.find(r=>r._id===t),u=R(a==null?void 0:a.Placeholder),h={};u.forEach(r=>{I.includes(r.key)||(h[r.key]=r.key.replace(/^\$\$/,"").replace(/\$\$$/,""))});const z=I.reduce((r,D)=>(r[D]=[""],r),{});n(h),f(z)}function j(t,a){n(u=>({...u,[t]:a}))}function y(t,a,u){f(h=>{const z=[...h[t]||[""]];return z[a]=u,{...h,[t]:z}})}function L(t){f(a=>{const u=[...a[t]||[""]];return u.push(""),{...a,[t]:u}})}function F(t,a){f(u=>{const h=[...u[t]||[""]];return h.length>1?h.splice(a,1):h[0]="",{...u,[t]:h}})}function A(){if(!p){b("");return}const t=W(p["Email Template JSON"],m);b(t)}async function O(){if(!(!k||!p)){S(!0),$(null);try{const t=(c.$$to$$||[]).filter(r=>r&&r.trim()),a=(c.$$cc$$||[]).filter(r=>r&&r.trim()),u=(c.$$bcc$$||[]).filter(r=>r&&r.trim()),h=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/send-email",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8"},body:JSON.stringify({action:"send",payload:{template_id:p._id,to_email:t[0],from_email:M,from_name:"Split Lease",subject:m.$$subject$$||"Test Email",variables:{...m},...a.length>0&&{cc_emails:a},...u.length>0&&{bcc_emails:u},...t.length>1&&{additional_to:t.slice(1)}}})}),z=await h.json();h.ok&&z.success?$({success:!0,message:"Email sent successfully."}):$({success:!1,message:z.error||"Failed to send email."})}catch(t){$({success:!1,message:t.message||"Failed to send email."})}finally{S(!1)}}}function V(){$(null)}return{templates:l,selectedTemplateId:i,selectedTemplate:p,placeholders:P,placeholderValues:m,multiEmailValues:c,previewHtml:E,loading:N,error:T,canSendEmail:k,sending:C,sendResult:_,fromEmail:M,handleTemplateChange:g,handlePlaceholderChange:j,handleMultiEmailChange:y,addMultiEmail:L,removeMultiEmail:F,updatePreview:A,sendEmail:O,clearSendResult:V}}function R(l){return!l||!Array.isArray(l)?[]:l.map(x=>({key:x,label:x,defaultValue:""}))}function W(l,x){if(!l)return"";try{const i=l.match(/"type"\s*:\s*"text\/html"\s*,\s*"value"\s*:\s*"((?:[^"\\]|\\.)*)"/);let o="";if(i&&i[1])o=i[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\");else{const n=l.match(/"value"\s*:\s*"((?:[^"\\]|\\.)*)"\s*,\s*"type"\s*:\s*"text\/html"/);n&&n[1]&&(o=n[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\"))}if(!o){const n=l.match(/"type"\s*:\s*"text\/plain"\s*,\s*"value"\s*:\s*"((?:[^"\\]|\\.)*)"/);n&&n[1]&&(o=`<pre style="white-space: pre-wrap; font-family: inherit;">${n[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\")}</pre>`)}if(!o)return'<p style="color: #dc2626; padding: 20px;">No HTML content found in this template.</p>';let m=o;return Object.entries(x).forEach(([n,c])=>{if(B.includes(n))return;const f=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),E=new RegExp(f,"g");m=m.replace(E,c||n)}),m}catch{return'<p style="color: #dc2626; padding: 20px;">Error extracting template preview.</p>'}}const X=[{key:"$$to$$",label:"To"},{key:"$$cc$$",label:"CC"},{key:"$$bcc$$",label:"BCC"}];function G({label:l,emails:x,onChange:i,onAdd:o,onRemove:m}){return e.jsxs("div",{className:"zeu-multi-field",children:[e.jsx("span",{className:"zeu-label",children:l}),e.jsx("div",{className:"zeu-multi-list",children:x.map((n,c)=>e.jsxs("div",{className:"zeu-multi-row",children:[e.jsx("input",{type:"email",value:n,onChange:f=>i(c,f.target.value),className:"zeu-input zeu-input--multi",placeholder:"name@example.com"}),x.length>1&&e.jsx("button",{type:"button",className:"zeu-icon-button zeu-icon-button--remove",onClick:()=>m(c),"aria-label":`Remove ${l} email`,children:"-"}),c===x.length-1&&e.jsx("button",{type:"button",className:"zeu-icon-button zeu-icon-button--add",onClick:o,"aria-label":`Add ${l} email`,children:"+"})]},`${l}-${c}`))})]})}function K(){const{templates:l,selectedTemplateId:x,selectedTemplate:i,placeholders:o,placeholderValues:m,multiEmailValues:n,previewHtml:c,loading:f,error:E,canSendEmail:b,sending:N,sendResult:v,fromEmail:T,handleTemplateChange:w,handlePlaceholderChange:C,handleMultiEmailChange:S,addMultiEmail:_,removeMultiEmail:$,updatePreview:p,sendEmail:P,clearSendResult:k}=Z();return f?e.jsx("div",{className:"zeu-state",children:e.jsx("div",{className:"zeu-state-card",children:e.jsx("p",{children:"Loading email templates..."})})}):E?e.jsx("div",{className:"zeu-state",children:e.jsx("div",{className:"zeu-state-card zeu-state-card--error",children:e.jsx("p",{children:E})})}):e.jsxs("div",{className:"zeu-page",children:[e.jsxs("header",{className:"zeu-header",children:[e.jsx("h1",{children:"Email Unit Test | Admin"}),e.jsx("p",{children:"Review templates, preview output, and send test emails."})]}),e.jsxs("div",{className:"zeu-container",children:[e.jsxs("section",{className:"zeu-panel",children:[e.jsxs("div",{className:"zeu-section",children:[e.jsx("span",{className:"zeu-section-title",children:"Email Template"}),e.jsx("label",{className:"zeu-label",htmlFor:"zeu-template-select",children:"Email Type"}),e.jsxs("select",{id:"zeu-template-select",className:"zeu-select",value:x||"",onChange:s=>w(s.target.value),children:[e.jsx("option",{value:"",children:"Select a template"}),l.map(s=>e.jsx("option",{value:s._id,children:s.Name||s.Description||s._id},s._id))]}),i&&e.jsx("p",{className:"zeu-description",children:i.Description||"No description available."})]}),i&&e.jsxs("div",{className:"zeu-section",children:[e.jsx("span",{className:"zeu-section-title",children:"Recipients"}),X.map(s=>e.jsx(G,{label:s.label,emails:n[s.key]||[""],onChange:(g,j)=>S(s.key,g,j),onAdd:()=>_(s.key),onRemove:g=>$(s.key,g)},s.key))]}),i&&e.jsxs("div",{className:"zeu-section",children:[e.jsx("span",{className:"zeu-section-title",children:"Sender"}),e.jsx("label",{className:"zeu-label",htmlFor:"zeu-from-email",children:"From Email"}),e.jsx("input",{id:"zeu-from-email",type:"text",className:"zeu-input zeu-input--disabled",value:T,disabled:!0})]}),i&&o.length>0&&e.jsxs("div",{className:"zeu-section",children:[e.jsx("span",{className:"zeu-section-title",children:"Template Placeholders"}),o.map((s,g)=>{const j=`zeu-placeholder-${g}`;return e.jsxs("div",{className:"zeu-field",children:[e.jsx("label",{className:"zeu-label",htmlFor:j,children:s.label}),s.key.toLowerCase().includes("body")||s.key.toLowerCase().includes("text")?e.jsx("textarea",{id:j,className:"zeu-textarea",rows:3,value:m[s.key]||"",onChange:y=>C(s.key,y.target.value),placeholder:`Enter ${s.label}`}):e.jsx("input",{id:j,className:"zeu-input",type:"text",value:m[s.key]||"",onChange:y=>C(s.key,y.target.value),placeholder:`Enter ${s.label}`})]},s.key)})]}),i&&o.length===0&&e.jsx("div",{className:"zeu-empty",children:e.jsx("p",{children:"No placeholders available for this template."})}),i&&e.jsxs("div",{className:"zeu-actions",children:[v&&e.jsxs("button",{type:"button",className:`zeu-result ${v.success?"zeu-result--success":"zeu-result--error"}`,onClick:k,children:[v.message,e.jsx("span",{children:"Click to dismiss"})]}),e.jsxs("div",{className:"zeu-actions-row",children:[e.jsx("button",{type:"button",className:"zeu-button zeu-button--secondary",onClick:p,children:"Update Preview"}),e.jsx("button",{type:"button",className:`zeu-button zeu-button--primary ${!b||N?"zeu-button--disabled":""}`,onClick:P,disabled:!b||N,children:N?"Sending...":"Send Test Email"})]})]})]}),e.jsxs("section",{className:"zeu-preview",children:[e.jsxs("div",{className:"zeu-preview-header",children:[e.jsx("h2",{children:"Email Preview"}),e.jsx("p",{children:"Preview renders with the placeholder values you provide."})]}),e.jsx("div",{className:"zeu-preview-frame",children:c?e.jsx("iframe",{title:"Email Preview",srcDoc:c,sandbox:"allow-same-origin"}):e.jsx("div",{className:"zeu-preview-empty",children:e.jsx("p",{children:i?'Click "Update Preview" to render the template.':"Select an email template to start."})})})]})]})]})}U(document.getElementById("root")).render(e.jsx(J.StrictMode,{children:e.jsx(Y,{children:e.jsx(K,{})})}));
