import{r as l,j as e,c as $,R as L}from"./client-BJVKzfAi.js";import{s as R}from"./supabase-BoCLEw6R.js";import{u as E,a as U}from"./Toast-BQk6Nzgd.js";import{A as P}from"./AdminHeader-tCInZd3n.js";/* empty css             */import"./auth-QZ4BJadW.js";import"./star-OtPMgcH9.js";import"./createLucideIcon-CgZZH2OU.js";import"./file-text-Bqp_Hw0X.js";import"./triangle-alert-Bp6DQQmR.js";import"./users-d0RSvnp4.js";import"./pen-line-Duo49k9O.js";import"./calendar-CDI4qHEX.js";import"./mail-CRbL90NL.js";import"./user-check-CoCGzn5Y.js";import"./dollar-sign-Dn2-KjNW.js";import"./send-C4mziT0-.js";import"./x-CrJVeoCh.js";function O(a){var n;const t={};return a.selectedPolicyId||(t.selectedPolicyId="Please select a policy document"),(n=a.documentTitle)!=null&&n.trim()?a.documentTitle.trim().length>255?t.documentTitle="Document title must be 255 characters or less":a.documentTitle.trim().length<3&&(t.documentTitle="Document title must be at least 3 characters"):t.documentTitle="Document title is required",a.selectedHostId||(t.selectedHostId="Please select a host"),t}const A="https://qcfifybkaddcoimjroca.supabase.co/functions/v1/document";async function N(a,t={}){const{data:{session:n}}=await R.auth.getSession(),o=localStorage.getItem("sl_auth_token")||sessionStorage.getItem("sl_auth_token"),p=(n==null?void 0:n.access_token)||o,m={"Content-Type":"application/json"};p&&(m.Authorization=`Bearer ${p}`);const u=await fetch(A,{method:"POST",headers:m,body:JSON.stringify({action:a,payload:t})}),h=await u.json();if(!u.ok||!h.success)throw new Error(h.error||"Request failed");return h.data}const C={selectedPolicyId:"",documentTitle:"",selectedHostId:""};function M({showToast:a}){const[t,n]=l.useState([]),[o,p]=l.useState([]),[m,u]=l.useState(!1),[h,_]=l.useState(null),[r,f]=l.useState(C),[g,j]=l.useState({}),[s,I]=l.useState(!1),[x,b]=l.useState(null);l.useEffect(()=>{(async()=>{try{await y()}catch(d){console.error("[CreateDocumentPage] Init failed:",d),_(d.message)}})()},[]),l.useEffect(()=>{var c;(c=window.$crisp)!=null&&c.push&&window.$crisp.push(["do","chat:hide"])},[]);const y=l.useCallback(async()=>{u(!0),_(null);try{const[c,d]=await Promise.all([N("list_policies"),N("list_hosts")]);n(c||[]),p(d||[])}catch(c){console.error("[CreateDocumentPage] Failed to load data:",c),_(c.message||"Failed to load data. Please try again.")}finally{u(!1)}},[]);l.useEffect(()=>{if(r.selectedPolicyId&&!r.documentTitle){const c=t.find(d=>d.id===r.selectedPolicyId);c&&f(d=>({...d,documentTitle:c.Name||c.name||""}))}},[r.selectedPolicyId,t]);const D=l.useCallback((c,d)=>{f(i=>({...i,[c]:d})),g[c]&&j(i=>({...i,[c]:null})),x&&b(null)},[g,x]),H=l.useCallback(async c=>{c.preventDefault();const d=O(r);if(Object.keys(d).length>0){j(d);return}I(!0),j({});try{const i=o.find(S=>S._id===r.selectedHostId);if(!i)throw new Error("Selected host not found");const v=i.Name||i["Name - Full"]||i.name||"",w=v?`${v} Full`:"",F=await N("create",{document_on_policies:r.selectedPolicyId,document_sent_title:r.documentTitle.trim(),host_user:r.selectedHostId,host_email:i.email||"",host_name:w});b(F),a({title:"Document Created",content:`Document "${r.documentTitle}" has been assigned to ${i.Name||i.email}`,type:"success"}),f(C)}catch(i){console.error("[CreateDocumentPage] Failed to create document:",i),a({title:"Error",content:i.message||"Failed to create document. Please try again.",type:"error"})}finally{I(!1)}},[r,o,a]),k=l.useCallback(()=>{y()},[y]);return{policyDocuments:t,hostUsers:o,isLoading:m,error:h,formState:r,formErrors:g,isSubmitting:s,lastCreatedDocument:x,handleFieldChange:D,handleSubmit:H,handleRetry:k}}function q({policyDocuments:a,hostUsers:t,formState:n,formErrors:o,isLoading:p,isSubmitting:m,onFieldChange:u,onSubmit:h}){const _=a.map(s=>({value:s.id||s._id,label:s.Name||s.name||"Unnamed Policy"})),r=t.map(s=>({value:s._id,label:s.Name?`${s.Name} (${s.email})`:s.email})),f=s=>{u("selectedPolicyId",s.target.value)},g=s=>{u("documentTitle",s.target.value)},j=s=>{u("selectedHostId",s.target.value)};return p?e.jsx("div",{className:"create-document-form__loading",children:e.jsx("p",{children:"Loading form data..."})}):e.jsxs("form",{onSubmit:h,className:"create-document-form",children:[e.jsxs("div",{className:"create-document-form__field",children:[e.jsx("label",{htmlFor:"selectedPolicyId",className:"create-document-form__label",children:"Choose document to send"}),e.jsxs("div",{className:"create-document-form__select-wrapper",children:[e.jsxs("select",{id:"selectedPolicyId",name:"selectedPolicyId",value:n.selectedPolicyId,onChange:f,disabled:m,className:`create-document-form__select${o.selectedPolicyId?" is-error":""}${n.selectedPolicyId===""?" is-placeholder":""}`,children:[e.jsx("option",{value:"",disabled:!0,children:"Choose document to send"}),_.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx(T,{})]}),o.selectedPolicyId&&e.jsx("p",{className:"create-document-form__error",children:o.selectedPolicyId})]}),e.jsxs("div",{className:"create-document-form__field",children:[e.jsx("label",{htmlFor:"documentTitle",className:"create-document-form__label",children:"Enter Document name"}),e.jsx("input",{id:"documentTitle",name:"documentTitle",type:"text",value:n.documentTitle,onChange:g,placeholder:"Title",disabled:m,maxLength:255,className:`create-document-form__input${o.documentTitle?" is-error":""}`}),o.documentTitle&&e.jsx("p",{className:"create-document-form__error",children:o.documentTitle})]}),e.jsxs("div",{className:"create-document-form__field",children:[e.jsx("label",{htmlFor:"selectedHostId",className:"create-document-form__label",children:"Choose Host"}),e.jsxs("div",{className:"create-document-form__select-wrapper",children:[e.jsxs("select",{id:"selectedHostId",name:"selectedHostId",value:n.selectedHostId,onChange:j,disabled:m,className:`create-document-form__select${o.selectedHostId?" is-error":""}${n.selectedHostId===""?" is-placeholder":""}`,children:[e.jsx("option",{value:"",disabled:!0,children:"Choose Host"}),r.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx(T,{})]}),o.selectedHostId&&e.jsx("p",{className:"create-document-form__error",children:o.selectedHostId})]}),e.jsx("div",{className:"create-document-form__actions",children:e.jsx("button",{type:"submit",disabled:m,className:`create-document-form__submit${m?" is-disabled":""}`,children:m?"Creating...":"Create Document"})})]})}function T(){return e.jsx("svg",{className:"create-document-form__chevron",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}function z(){const{showToast:a}=E(),t=M({showToast:a});return t.isLoading&&!t.policyDocuments.length&&!t.hostUsers.length?e.jsxs("div",{className:"create-document-page",children:[e.jsx(P,{}),e.jsxs("div",{className:"create-document-page__loading",children:[e.jsx("div",{className:"create-document-page__spinner"}),e.jsx("p",{children:"Loading..."})]})]}):e.jsxs("div",{className:"create-document-page",children:[e.jsx(P,{}),e.jsxs("header",{className:"create-document-page__header",children:[e.jsx("h1",{className:"create-document-page__title",children:"Create Document"}),e.jsx("p",{className:"create-document-page__subtitle",children:"Select a policy document and assign it to a host user"})]}),e.jsxs("main",{className:"create-document-page__main",children:[t.error&&e.jsxs("div",{className:"create-document-page__error",children:[e.jsx("span",{children:t.error}),e.jsx("button",{onClick:t.handleRetry,className:"create-document-page__retry",children:"Retry"})]}),e.jsx(q,{policyDocuments:t.policyDocuments,hostUsers:t.hostUsers,formState:t.formState,formErrors:t.formErrors,isLoading:t.isLoading,isSubmitting:t.isSubmitting,onFieldChange:t.handleFieldChange,onSubmit:t.handleSubmit}),t.lastCreatedDocument&&e.jsxs("div",{className:"create-document-page__success",children:[e.jsx("span",{className:"create-document-page__success-icon",children:"âœ“"}),e.jsx("span",{children:"Document successfully created and assigned!"})]})]})]})}const B=document.getElementById("root"),J=$(B);J.render(e.jsx(L.StrictMode,{children:e.jsx(U,{children:e.jsx(z,{})})}));
