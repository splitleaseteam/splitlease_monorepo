import{r as n,j as e,c as G}from"./client-BJVKzfAi.js";import{s as z}from"./supabase-BoCLEw6R.js";import{u as H,a as J}from"./Toast-BQk6Nzgd.js";import{A as T}from"./AdminHeader-tCInZd3n.js";import"./auth-QZ4BJadW.js";import"./star-OtPMgcH9.js";import"./createLucideIcon-CgZZH2OU.js";import"./file-text-Bqp_Hw0X.js";import"./triangle-alert-Bp6DQQmR.js";import"./users-d0RSvnp4.js";import"./pen-line-Duo49k9O.js";import"./calendar-CDI4qHEX.js";import"./mail-CRbL90NL.js";import"./user-check-CoCGzn5Y.js";import"./dollar-sign-Dn2-KjNW.js";import"./send-C4mziT0-.js";import"./x-CrJVeoCh.js";const V="https://qcfifybkaddcoimjroca.supabase.co";function K(){const{showToast:s}=H(),[a,r]=n.useState(!0),[u,i]=n.useState(1),[o,U]=n.useState(""),[I,j]=n.useState([]),[l,S]=n.useState(null),[A,N]=n.useState(!1),[v,k]=n.useState(""),[w,O]=n.useState([]),[d,f]=n.useState(null),[_,m]=n.useState(null),[h,b]=n.useState({}),[E,y]=n.useState(!1),[D,C]=n.useState(""),[M,L]=n.useState(!1);n.useEffect(()=>{(async()=>{r(!1),await $()})()},[]),n.useEffect(()=>{const t=setTimeout(()=>{R()},300);return()=>clearTimeout(t)},[o]);const p=async(t,c)=>{const{data:{session:g}}=await z.auth.getSession(),P=(g==null?void 0:g.access_token)||localStorage.getItem("sl_auth_token")||sessionStorage.getItem("sl_auth_token");if(!P)throw new Error("Not authenticated");const x=await fetch(`${V}/functions/v1/magic-login-links`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`},body:JSON.stringify({action:t,payload:c})});if(!x.ok){const F=await x.json();throw new Error(F.error||"Request failed")}return(await x.json()).data},R=async()=>{N(!0);try{const t=await p("list_users",{searchText:o,limit:50});j(t.users||[])}catch(t){s(`Failed to load users: ${t.message}`,"error"),j([])}finally{N(!1)}},$=async()=>{try{const t=await p("get_destination_pages",{});O(t.pages||[])}catch(t){s(`Failed to load destination pages: ${t.message}`,"error")}},q=async t=>{y(!0);try{const c=await p("get_user_data",{userId:t});m(c)}catch(c){s(`Failed to load user data: ${c.message}`,"error"),m(null)}finally{y(!1)}},B=async()=>{if(!l||!d){s("Please select a user and destination page","error");return}L(!0);try{let t=d.path;d.path.includes(":userId")&&(t=d.path.replace(":userId",l.id)),d.path.includes(":id")&&h.id&&(t=d.path.replace(":id",h.id));const c=await p("send_magic_link",{userId:l.id,destinationPage:t,phoneOverride:v||void 0,attachedData:Object.keys(h).length>0?h:void 0});C(c.link),s(c.sentViaSms?"Magic link generated and sent via SMS!":"Magic link generated successfully!","success"),i(5)}catch(t){s(`Failed to send magic link: ${t.message}`,"error")}finally{L(!1)}};return{isLoading:a,currentStep:u,setCurrentStep:i,searchText:o,setSearchText:U,users:I,selectedUser:l,loadingUsers:A,handleSelectUser:t=>{S(t),i(2)},phoneOverride:v,setPhoneOverride:k,handleContinueToPageSelection:()=>{i(3)},destinationPages:w,selectedPage:d,handleSelectPage:t=>{f(t),t.requiresData&&l&&q(l.id),i(4)},userData:_,attachedData:h,setAttachedData:b,loadingUserData:E,handleContinueToSend:()=>{B()},generatedLink:D,sending:M,handleCopyLink:()=>{navigator.clipboard.writeText(D),s("Link copied to clipboard!","success")},handleReset:()=>{i(1),S(null),k(""),f(null),b({}),C(""),m(null)}}}function Q(){const s=K();return s.isLoading?e.jsxs("div",{className:"send-magic-login-links-page",children:[e.jsx(T,{}),e.jsx("div",{className:"loading",children:"Loading..."})]}):e.jsxs("div",{className:"send-magic-login-links-page",children:[e.jsx(T,{}),e.jsxs("header",{className:"page-header",children:[e.jsx("h1",{children:"Send Magic Login Links"}),e.jsx("p",{className:"subtitle",children:"Admin Tool - Generate and send magic login links to users"})]}),e.jsx("div",{className:"step-indicator",children:[1,2,3,4,5].map(a=>e.jsxs("div",{className:`step ${s.currentStep===a?"active":""} ${s.currentStep>a?"completed":""}`,children:[e.jsx("div",{className:"step-number",children:a}),e.jsxs("div",{className:"step-label",children:[a===1&&"Select User",a===2&&"Phone Override",a===3&&"Choose Page",a===4&&"Attach Data",a===5&&"Send"]})]},a))}),s.currentStep===1&&e.jsxs("div",{className:"step-content",children:[e.jsx("h2",{children:"Step 1: Select User"}),e.jsx("input",{type:"text",className:"search-input",placeholder:"Search users by email, name, or phone...",value:s.searchText,onChange:a=>s.setSearchText(a.target.value)}),s.loadingUsers?e.jsx("div",{className:"loading-users",children:"Loading users..."}):e.jsx("div",{className:"user-list",children:s.users.length===0?e.jsx("div",{className:"no-results",children:"No users found. Try searching."}):s.users.map(a=>e.jsxs("div",{className:"user-item",onClick:()=>s.handleSelectUser(a),children:[a.profilePhoto&&e.jsx("img",{src:a.profilePhoto,alt:"",className:"user-avatar"}),e.jsxs("div",{className:"user-info",children:[e.jsxs("div",{className:"user-name",children:[a.firstName," ",a.lastName]}),e.jsx("div",{className:"user-email",children:a.email}),a.phone&&e.jsx("div",{className:"user-phone",children:a.phone})]}),e.jsx("div",{className:"user-type-badge",children:a.userType})]},a.id))})]}),s.currentStep===2&&e.jsxs("div",{className:"step-content",children:[e.jsx("h2",{children:"Step 2: Phone Override (Optional)"}),e.jsxs("p",{className:"step-description",children:["Selected user: ",e.jsxs("strong",{children:[s.selectedUser.firstName," ",s.selectedUser.lastName]}),s.selectedUser.phone&&e.jsxs("span",{children:[" (Default: ",s.selectedUser.phone,")"]})]}),e.jsx("input",{type:"tel",className:"phone-input",placeholder:"+15551234567 (E.164 format)",value:s.phoneOverride,onChange:a=>s.setPhoneOverride(a.target.value)}),e.jsx("p",{className:"help-text",children:"Leave empty to use user's phone number, or enter an override in E.164 format"}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{onClick:()=>s.setCurrentStep(1),className:"btn-secondary",children:"Back"}),e.jsx("button",{onClick:s.handleContinueToPageSelection,className:"btn-primary",children:"Continue"})]})]}),s.currentStep===3&&e.jsxs("div",{className:"step-content",children:[e.jsx("h2",{children:"Step 3: Choose Destination Page"}),e.jsx("div",{className:"page-list",children:s.destinationPages.map(a=>e.jsxs("div",{className:"page-item",onClick:()=>s.handleSelectPage(a),children:[e.jsx("div",{className:"page-label",children:a.label}),e.jsx("div",{className:"page-path",children:a.path}),e.jsx("div",{className:"page-description",children:a.description}),a.requiresData&&e.jsx("span",{className:"requires-data-badge",children:"Requires data"})]},a.id))}),e.jsx("div",{className:"step-actions",children:e.jsx("button",{onClick:()=>s.setCurrentStep(2),className:"btn-secondary",children:"Back"})})]}),s.currentStep===4&&e.jsxs("div",{className:"step-content",children:[e.jsx("h2",{children:"Step 4: Attach Data (Optional)"}),e.jsxs("p",{className:"step-description",children:["Destination: ",e.jsx("strong",{children:s.selectedPage.label})]}),s.loadingUserData?e.jsx("div",{className:"loading-user-data",children:"Loading user data..."}):s.userData?e.jsxs("div",{className:"user-data-sections",children:[s.userData.listings&&s.userData.listings.length>0&&e.jsxs("div",{className:"data-section",children:[e.jsx("h3",{children:"Listings"}),s.userData.listings.map(a=>e.jsxs("label",{className:"data-checkbox",children:[e.jsx("input",{type:"checkbox",checked:s.attachedData.listingId===a.id,onChange:r=>{if(r.target.checked)s.setAttachedData({...s.attachedData,listingId:a.id,id:a.id});else{const{listingId:u,id:i,...o}=s.attachedData;s.setAttachedData(o)}}}),e.jsxs("span",{children:[a.title," - ",a.address]})]},a.id))]}),s.userData.proposals&&s.userData.proposals.length>0&&e.jsxs("div",{className:"data-section",children:[e.jsx("h3",{children:"Proposals"}),s.userData.proposals.map(a=>e.jsxs("label",{className:"data-checkbox",children:[e.jsx("input",{type:"checkbox",checked:s.attachedData.proposalId===a.id,onChange:r=>{if(r.target.checked)s.setAttachedData({...s.attachedData,proposalId:a.id});else{const{proposalId:u,...i}=s.attachedData;s.setAttachedData(i)}}}),e.jsxs("span",{children:[a.listingTitle," (",a.status,")"]})]},a.id))]}),s.userData.threads&&s.userData.threads.length>0&&e.jsxs("div",{className:"data-section",children:[e.jsx("h3",{children:"Message Threads"}),s.userData.threads.map(a=>e.jsxs("label",{className:"data-checkbox",children:[e.jsx("input",{type:"checkbox",checked:s.attachedData.threadId===a.id,onChange:r=>{if(r.target.checked)s.setAttachedData({...s.attachedData,threadId:a.id});else{const{threadId:u,...i}=s.attachedData;s.setAttachedData(i)}}}),e.jsx("span",{children:a.subject})]},a.id))]})]}):e.jsx("div",{className:"no-data",children:"No data available to attach for this user."}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{onClick:()=>s.setCurrentStep(3),className:"btn-secondary",children:"Back"}),e.jsx("button",{onClick:s.handleContinueToSend,className:"btn-primary",disabled:s.sending,children:s.sending?"Generating...":"Generate & Send Link"})]})]}),s.currentStep===5&&e.jsxs("div",{className:"step-content",children:[e.jsx("h2",{children:"âœ“ Magic Link Generated!"}),e.jsx("div",{className:"success-message",children:e.jsxs("p",{children:["Magic login link has been generated",s.phoneOverride||s.selectedUser.phone?" and sent via SMS":"","."]})}),e.jsxs("div",{className:"generated-link-container",children:[e.jsx("input",{type:"text",className:"generated-link-input",value:s.generatedLink,readOnly:!0}),e.jsx("button",{onClick:s.handleCopyLink,className:"btn-copy",children:"Copy Link"})]}),e.jsx("div",{className:"step-actions",children:e.jsx("button",{onClick:s.handleReset,className:"btn-primary",children:"Send Another Link"})})]})]})}const W=document.getElementById("root"),X=G(W);X.render(e.jsx(J,{children:e.jsx(Q,{})}));
