import{r as i,j as e,c as Ne,R as ke}from"./client-BJVKzfAi.js";import{H as oe}from"./Header-BJKWma2V.js";import{c as Se,v as Ce,k as Me,a as Te,g as Re,i as K}from"./auth-QZ4BJadW.js";import{s as z}from"./supabase-BoCLEw6R.js";import{u as Pe,T as Be,M as Le,b as Ee,c as Ue}from"./proposalDataFetcher-CipdyWU2.js";import{E as We}from"./ErrorBoundary-9_HbXv1y.js";/* empty css             */import"./constants-CPVJY5eo.js";import"./Toast-BQk6Nzgd.js";import"./proposalStatuses-1Bj0NYR4.js";function He(){const[n,s]=i.useState({isChecking:!0,shouldRedirect:!1}),[a,u]=i.useState(null),[d,g]=i.useState([]),[l,k]=i.useState(null),[b,p]=i.useState([]),[o,y]=i.useState(null),[M,v]=i.useState(!0),[Y,L]=i.useState(!1),[G,T]=i.useState(null),[N,U]=i.useState(""),[R,P]=i.useState(!1),[W,H]=i.useState(null),[B,E]=i.useState(null),[F,X]=i.useState(!1),[Z,O]=i.useState(!1),[A,$]=i.useState(null),q=i.useRef(null),D=i.useRef(null),[se,ee]=i.useState(null),[te,S]=i.useState(null),J=i.useRef(!1),V=i.useCallback((r,t)=>{ee(r),S(t)},[]),he=i.useCallback(()=>{ee(null),S(null)},[]),{handleCTAClick:ue,getCTAButtonConfig:me}=Pe({user:a,selectedThread:l,threadInfo:o,onOpenModal:V});i.useEffect(()=>{async function r(){var t,c,h,_,w,C;try{if(!await Se()){console.log("[Messaging] User not authenticated, redirecting to home"),s({isChecking:!1,shouldRedirect:!0}),setTimeout(()=>{window.location.href="/?login=true"},100);return}const m=await Ce({clearOnFailure:!1});if(m)u({id:m.userId,email:m.email,bubbleId:m.userId,firstName:m.firstName,lastName:((t=m.fullName)==null?void 0:t.split(" ").slice(1).join(" "))||"",profilePhoto:m.profilePhoto,userType:m.userType||null}),console.log("[Messaging] User data loaded:",m.firstName,"- Type:",m.userType);else{const{data:{session:x}}=await z.auth.getSession();if(x!=null&&x.user){const f={id:x.user.id,email:x.user.email,bubbleId:((c=x.user.user_metadata)==null?void 0:c.user_id)||K()||x.user.id,firstName:((h=x.user.user_metadata)==null?void 0:h.first_name)||Re()||((_=x.user.email)==null?void 0:_.split("@")[0])||"User",lastName:((w=x.user.user_metadata)==null?void 0:w.last_name)||"",profilePhoto:Te()||null,userType:((C=x.user.user_metadata)==null?void 0:C.user_type)||Me()||null};u(f),console.log("[Messaging] Using fallback user data from session:",f.firstName,"- Type:",f.userType)}else{console.log("[Messaging] No valid session, redirecting"),s({isChecking:!1,shouldRedirect:!0}),setTimeout(()=>{window.location.href="/?login=true"},100);return}}s({isChecking:!1,shouldRedirect:!1}),await ie(),J.current=!0}catch(j){console.error("[Messaging] Auth check failed:",j),T("Failed to check authentication. Please refresh the page."),v(!1)}}r()},[]);const ae=i.useRef(!1);i.useEffect(()=>{o!=null&&o.proposal_id||o!=null&&o.listing_id?xe(o.proposal_id,o.listing_id):(H(null),E(null))},[o==null?void 0:o.proposal_id,o==null?void 0:o.listing_id]),i.useEffect(()=>{if(!J.current||d.length===0||ae.current)return;const t=new URLSearchParams(window.location.search).get("thread");if(t){const c=d.find(h=>h._id===t);c&&(ae.current=!0,le(c))}else d.length>0&&(ae.current=!0,le(d[0]))},[d]),i.useEffect(()=>{if(!l||n.isChecking||!(a!=null&&a.bubbleId))return;const r=`messages-${l._id}`;console.log("[Realtime] Subscribing to postgres_changes for thread:",l._id);const t=z.channel(r);return t.on("postgres_changes",{event:"INSERT",schema:"public",table:"_message"},c=>{console.log("[Realtime] postgres_changes event received:",c);const h=c.new;if(!h)return;if(h["Associated Thread/Conversation"]!==l._id){console.log("[Realtime] Message is for different thread, ignoring");return}console.log("[Realtime] Message is for this thread, processing...");const _=h["-Originator User"]===(a==null?void 0:a.bubbleId);p(w=>{if(w.some(j=>j._id===h._id))return w;const C={_id:h._id,message_body:h["Message Body"],sender_name:h["is Split Bot"]?"Split Bot":_?"You":l.contact_name||"User",sender_avatar:_?a==null?void 0:a.profilePhoto:void 0,sender_type:h["is Split Bot"]?"splitbot":h["-Originator User"]===h["-Host User"]?"host":"guest",is_outgoing:_,timestamp:new Date(h["Created Date"]).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}),call_to_action:h["Call to Action"]?{type:h["Call to Action"],message:"View Details"}:void 0,split_bot_warning:h["Split Bot Warning"]};return[...w,C]}),_||(O(!1),$(null))}),t.on("presence",{event:"sync"},()=>{const c=t.presenceState(),h=Object.values(c).flat().filter(_=>_.typing&&_.user_id!==(a==null?void 0:a.bubbleId));h.length>0?(O(!0),$(h[0].user_name)):(O(!1),$(null))}),t.subscribe(async c=>{console.log("[Realtime] Subscription status:",c),c==="SUBSCRIBED"?(console.log("[Realtime] Successfully subscribed to channel:",r),await t.track({user_id:a==null?void 0:a.bubbleId,user_name:(a==null?void 0:a.firstName)||"User",typing:!1,online_at:new Date().toISOString()})):c==="CHANNEL_ERROR"?console.error("[Realtime] Channel error - check RLS policies on _message table"):c==="TIMED_OUT"&&console.error("[Realtime] Subscription timed out")}),q.current=t,()=>{console.log("[Realtime] Unsubscribing from channel:",r),t.unsubscribe(),q.current=null}},[l==null?void 0:l._id,n.isChecking,a==null?void 0:a.bubbleId]);const I=i.useCallback(async r=>{if(!(!q.current||!a))try{await q.current.track({user_id:a.bubbleId,user_name:a.firstName||"User",typing:r,typing_at:r?new Date().toISOString():null,online_at:new Date().toISOString()})}catch(t){console.error("[Realtime] Failed to track typing:",t)}},[a]);async function ie(){var r,t,c,h;console.log("[fetchThreads] Starting thread fetch via Edge Function...");try{v(!0),T(null);const{data:_}=await z.auth.getSession(),w=(r=_==null?void 0:_.session)==null?void 0:r.access_token;console.log("[fetchThreads] Auth state:",{hasSupabaseSession:!!w,hasLegacyUserId:!!K()});const C={"Content-Type":"application/json"};w&&(C.Authorization=`Bearer ${w}`);const j={};if(!w){const Q=K();if(Q)j.user_id=Q,console.log("[fetchThreads] Using legacy auth with user_id:",Q);else throw new Error("Not authenticated. Please log in again.")}const x=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/messages",{method:"POST",headers:C,body:JSON.stringify({action:"get_threads",payload:j})});if(console.log("[fetchThreads] Response status:",x.status),!x.ok){const Q=await x.text();throw console.error("[fetchThreads] Error response:",Q),new Error(`Failed to fetch threads: ${x.status}`)}const f=await x.json();if(console.log("[fetchThreads] Edge Function response:",{success:f==null?void 0:f.success,threadCount:((c=(t=f==null?void 0:f.data)==null?void 0:t.threads)==null?void 0:c.length)||0,error:f==null?void 0:f.error}),!(f!=null&&f.success))throw new Error((f==null?void 0:f.error)||"Failed to fetch threads");const ce=((h=f.data)==null?void 0:h.threads)||[];console.log("[fetchThreads] Found",ce.length,"threads"),g(ce)}catch(_){console.error("[fetchThreads] Error:",_),T(_.message||"Failed to load conversations")}finally{v(!1)}}async function re(r){var t;try{L(!0);const{data:c}=await z.auth.getSession(),h=(t=c==null?void 0:c.session)==null?void 0:t.access_token;console.log("[fetchMessages] Auth state:",{hasSupabaseSession:!!h,hasLegacyUserId:!!K()});const _={"Content-Type":"application/json"};h&&(_.Authorization=`Bearer ${h}`);const w={thread_id:r};if(!h){const x=K();if(x)w.user_id=x,console.log("[fetchMessages] Using legacy auth with user_id:",x);else throw new Error("Not authenticated. Please log in again.")}const j=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/messages",{method:"POST",headers:_,body:JSON.stringify({action:"get_messages",payload:w})});if(console.log("[fetchMessages] Response status:",j.status),!j.ok){const x=await j.text();throw console.error("[fetchMessages] Error response:",x),new Error(`Failed to fetch messages: ${j.status}`)}const m=await j.json();if(m!=null&&m.success)p(m.data.messages||[]),y(m.data.thread_info||null);else throw new Error((m==null?void 0:m.error)||"Failed to fetch messages")}catch(c){console.error("Error fetching messages:",c)}finally{L(!1)}}async function ge(){var r;if(!(!N.trim()||!l||R))try{P(!0),I(!1),D.current&&clearTimeout(D.current);const{data:t}=await z.auth.getSession(),c=(r=t==null?void 0:t.session)==null?void 0:r.access_token,h={"Content-Type":"application/json"};c&&(h.Authorization=`Bearer ${c}`);const _={thread_id:l._id,message_body:N.trim()};if(!c){const m=K();if(m)_.user_id=m,console.log("[sendMessage] Using legacy auth with user_id:",m);else throw new Error("No access token available. Please log in again.")}const C=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/messages",{method:"POST",headers:h,body:JSON.stringify({action:"send_message",payload:_})});if(!C.ok){const m=await C.text();throw console.error("[sendMessage] Error response:",m),new Error(`Failed to send message: ${C.status}`)}const j=await C.json();if(j!=null&&j.success){U("");const m={_id:j.data.message_id,message_body:N.trim(),sender_name:"You",sender_type:"guest",is_outgoing:!0,timestamp:new Date().toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})};p(x=>x.some(f=>f._id===m._id)?x:[...x,m])}else throw new Error((j==null?void 0:j.error)||"Failed to send message")}catch(t){console.error("Error sending message:",t),T(t.message||"Failed to send message")}finally{P(!1)}}async function xe(r,t){if(!r&&!t){H(null),E(null);return}try{X(!0);const[c,h]=await Promise.all([r?pe(r):Promise.resolve(null),t?_e(t):Promise.resolve(null)]);H(c),E(h)}catch(c){console.error("[RightPanel] Error fetching panel data:",c)}finally{X(!1)}}async function pe(r){try{const{data:t,error:c}=await z.from("proposal").select(`
          _id,
          "Status",
          "Created Date",
          "Start Date",
          "End Date",
          "Days per Week",
          "Total Monthly Price",
          "Modified Date"
        `).eq("_id",r).single();return c?(console.error("[RightPanel] Error fetching proposal:",c),null):{id:t._id,status:t.Status||"pending",createdAt:t["Created Date"],startDate:t["Start Date"],endDate:t["End Date"],daysPerWeek:t["Days per Week"],totalMonthlyPrice:t["Total Monthly Price"],modifiedDate:t["Modified Date"]}}catch(t){return console.error("[RightPanel] Error fetching proposal:",t),null}}async function _e(r){try{const{data:t,error:c}=await z.from("listing").select(`
          _id,
          "Name",
          "Primary Photo",
          "Neighborhood",
          "City",
          "Street Address",
          "State",
          "Monthly Rate",
          "Listing Type"
        `).eq("_id",r).single();if(c)return console.error("[RightPanel] Error fetching listing:",c),null;const h=[t.Neighborhood,t.City,t.State].filter(Boolean);return{id:t._id,name:t.Name||"Unnamed Listing",primaryImage:t["Primary Photo"],address:h.join(", ")||"Location not specified",monthlyRate:t["Monthly Rate"],listingType:t["Listing Type"]||"Flexible"}}catch(t){return console.error("[RightPanel] Error fetching listing:",t),null}}const fe=i.useCallback(r=>{switch(console.log("[MessagingPage] Action clicked:",r),r){case"accept":V("accept_proposal",{proposalId:o==null?void 0:o.proposal_id,proposalData:W});break;case"counter":V("counter_proposal",{proposalId:o==null?void 0:o.proposal_id,proposalData:W});break;case"decline":V("decline_proposal",{proposalId:o==null?void 0:o.proposal_id,proposalData:W});break;case"video":V("schedule_video",{threadId:l==null?void 0:l._id,contactName:o==null?void 0:o.contact_name});break;case"phone":console.log("[ThreadHeader] Phone call clicked - functionality coming soon");break;case"schedule":V("schedule_meeting",{threadId:l==null?void 0:l._id,contactName:o==null?void 0:o.contact_name});break;case"view_profile":console.log("[RightPanel] View profile clicked");break;case"view_listing":B!=null&&B.id&&(window.location.href=`/listing?id=${B.id}`);break;case"new":console.log("[Sidebar] New message clicked - functionality coming soon");break;case"more":console.log("[MessagingPage] More options clicked - functionality coming soon");break;default:console.warn("[MessagingPage] Unknown action:",r)}},[o,W,B,l,V]);function le(r){k(r),p([]),y(null),H(null),E(null),O(!1),$(null),g(t=>t.map(c=>c._id===r._id?{...c,unread_count:0}:c)),re(r._id)}const je=i.useCallback(r=>{k(r),p([]),y(null),H(null),E(null),O(!1),$(null),g(c=>c.map(h=>h._id===r._id?{...h,unread_count:0}:h));const t=new URLSearchParams(window.location.search);t.set("thread",r._id),window.history.replaceState({},"",`?${t.toString()}`),re(r._id)},[]),be=i.useCallback(r=>{U(r),I(!0)},[I]),ye=i.useCallback(r=>{r.length<=1e3&&(U(r),I(!0),D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{I(!1)},2e3))},[I]),ve=i.useCallback(()=>{ge()},[N,l,R]),we=i.useCallback(()=>{T(null),v(!0),ie()},[]);return{authState:n,user:a,threads:d,selectedThread:l,messages:b,threadInfo:o,proposalData:W,listingData:B,isLoadingPanelData:F,isLoading:M,isLoadingMessages:Y,error:G,messageInput:N,isSending:R,isOtherUserTyping:Z,typingUserName:A,activeModal:se,modalContext:te,handleThreadSelect:je,handleMessageInputChange:ye,handleSendMessage:ve,handleRetry:we,insertSuggestion:be,handlePanelAction:fe,handleCTAClick:ue,getCTAButtonConfig:me,handleCloseModal:he}}function Fe({threads:n,selectedThreadId:s,onThreadSelect:a,onAction:u,className:d=""}){const[g,l]=i.useState(""),k=g.trim()?n.filter(b=>{var o,y,M;const p=g.toLowerCase();return((o=b.contact_name)==null?void 0:o.toLowerCase().includes(p))||((y=b.property_name)==null?void 0:y.toLowerCase().includes(p))||((M=b.last_message_preview)==null?void 0:M.toLowerCase().includes(p))}):n;return e.jsxs("aside",{className:`thread-sidebar ${d}`.trim(),children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h1",{className:"sidebar-title",children:"Messages"}),e.jsxs("div",{className:"sidebar-header__actions",children:[e.jsx("button",{className:"sidebar-header__btn",onClick:()=>u==null?void 0:u("new"),"aria-label":"New message",title:"New message",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),e.jsx("button",{className:"sidebar-header__btn",onClick:()=>u==null?void 0:u("more"),"aria-label":"More options",title:"More options",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"19",cy:"12",r:"1"}),e.jsx("circle",{cx:"5",cy:"12",r:"1"})]})})]})]}),e.jsxs("div",{className:"sidebar-search",children:[e.jsxs("div",{className:"sidebar-search__input-wrapper",children:[e.jsxs("svg",{className:"sidebar-search__icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"sidebar-search__input",placeholder:"Search messages...",value:g,onChange:b=>l(b.target.value)})]}),e.jsx("button",{className:"sidebar-search__filter-btn","aria-label":"Filter conversations",title:"Filter",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M22 3H2l8 9.46V19l4 2v-8.54L22 3z"})})})]}),e.jsx("div",{className:"thread-list",children:k.length===0?e.jsx("div",{className:"sidebar-empty-state",children:g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sidebar-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]})}),e.jsx("h3",{className:"sidebar-empty-title",children:"No results"}),e.jsxs("p",{className:"sidebar-empty-desc",children:['No conversations match "',g,'"']}),e.jsx("button",{className:"sidebar-empty-btn",onClick:()=>l(""),children:"Clear search"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sidebar-empty-icon",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),e.jsx("h3",{className:"sidebar-empty-title",children:"No messages yet"}),e.jsx("p",{className:"sidebar-empty-desc",children:"Start a conversation by browsing listings"}),e.jsxs("a",{href:"/search",className:"sidebar-empty-btn",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),"Browse listings"]})]})}):k.map(b=>e.jsx(Be,{thread:b,isSelected:b._id===s,onClick:()=>a(b)},b._id))})]})}function Oe({info:n,onBack:s,isMobile:a,showRightPanel:u,isRightPanelCollapsed:d,onToggleRightPanel:g,onAction:l}){return n?e.jsxs("div",{className:"thread-header",children:[a&&s&&e.jsx("button",{className:"thread-header__back",onClick:s,"aria-label":"Back to messages",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15 18L9 12L15 6"})})}),e.jsxs("div",{className:"thread-header__left",children:[e.jsx("img",{src:n.contact_avatar||"/assets/images/default-avatar.jpg",alt:n.contact_name||"Contact",className:"thread-header__avatar",onError:k=>{k.target.src="/assets/images/default-avatar.jpg"}}),e.jsxs("div",{className:"thread-header__info",children:[e.jsxs("div",{className:"thread-header__name-row",children:[e.jsx("h3",{className:"thread-header__name",children:n.contact_name||"Unknown Contact"}),n.contact_type&&e.jsx("span",{className:`thread-header__badge thread-header__badge--${n.contact_type.toLowerCase()}`,children:n.contact_type})]}),e.jsxs("span",{className:"thread-header__status-text",children:[e.jsx("span",{className:"thread-header__online-dot"}),"Online now"]})]})]}),e.jsxs("div",{className:"thread-header__actions",children:[e.jsx("button",{className:"thread-header__action-btn",onClick:()=>l==null?void 0:l("video"),"aria-label":"Start video call",title:"Video call",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polygon",{points:"23 7 16 12 23 17 23 7"}),e.jsx("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})]})}),e.jsx("button",{className:"thread-header__action-btn",onClick:()=>l==null?void 0:l("phone"),"aria-label":"Start phone call",title:"Phone call",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"})})}),e.jsx("button",{className:"thread-header__action-btn",onClick:()=>l==null?void 0:l("schedule"),"aria-label":"Schedule meeting",title:"Schedule meeting",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),u&&e.jsx("button",{className:`thread-header__action-btn ${d?"":"thread-header__action-btn--active"}`,onClick:g,"aria-label":d?"Show details panel":"Hide details panel",title:d?"Show details":"Hide details",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"})]})}),e.jsx("button",{className:"thread-header__action-btn",onClick:()=>l==null?void 0:l("more"),"aria-label":"More options",title:"More options",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"19",cy:"12",r:"1"}),e.jsx("circle",{cx:"5",cy:"12",r:"1"})]})})]})]}):null}function $e(n){if(!n)return"";try{const s=new Date(n),a=new Date,u=new Date(a);return u.setDate(u.getDate()-1),s.toDateString()===a.toDateString()?"Today":s.toDateString()===u.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})}catch{return""}}function qe(n){if(!n)return"";try{return new Date(n).toDateString()}catch{return""}}function De({messages:n,threadInfo:s,isLoading:a,onBack:u,isMobile:d,isOtherUserTyping:g,typingUserName:l,onCTAClick:k,getCTAButtonConfig:b,onSuggestionClick:p,onFocusInput:o,showRightPanel:y,isRightPanelCollapsed:M,onToggleRightPanel:v,onHeaderAction:Y}){const L=i.useRef(null),G={proposalId:s==null?void 0:s.proposal_id,listingId:s==null?void 0:s.listing_id,leaseId:s==null?void 0:s.lease_id};i.useEffect(()=>{L.current&&L.current.scrollIntoView({behavior:"smooth"})},[n,g]);let T="";return e.jsxs("div",{className:"message-thread",children:[s&&e.jsx(Oe,{info:s,onBack:u,isMobile:d,showRightPanel:y,isRightPanelCollapsed:M,onToggleRightPanel:v,onAction:Y}),e.jsx("div",{className:"messages-scroll",children:a?e.jsxs("div",{className:"message-thread__loading",children:[e.jsx("div",{className:"message-thread__loading-spinner"}),e.jsx("p",{children:"Loading messages..."})]}):n.length===0?e.jsxs("div",{className:"conversation-empty-state",children:[e.jsx("div",{className:"conversation-empty-icon",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),e.jsx("h3",{className:"conversation-empty-title",children:"Start the conversation"}),e.jsxs("p",{className:"conversation-empty-desc",children:["Send a message to begin chatting with ",(s==null?void 0:s.contact_name)||"your contact","."]}),e.jsxs("button",{className:"conversation-empty-btn",type:"button",onClick:()=>o==null?void 0:o(),children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"18",height:"18",children:e.jsx("path",{d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"})}),"Write a message"]}),e.jsxs("div",{className:"suggestion-chips",children:[e.jsx("button",{className:"suggestion-chip",type:"button",onClick:()=>p==null?void 0:p("Hi! I wanted to reach out about the listing."),children:"Say hello"}),e.jsx("button",{className:"suggestion-chip",type:"button",onClick:()=>p==null?void 0:p("Hi! I wanted to check on availability for the dates I'm interested in."),children:"Ask about availability"}),e.jsx("button",{className:"suggestion-chip",type:"button",onClick:()=>p==null?void 0:p("Hi! I have a quick question about the listing."),children:"Ask a question"})]})]}):e.jsxs(e.Fragment,{children:[n.map((N,U)=>{const R=qe(N.created_at||N.timestamp),P=R&&R!==T;return P&&(T=R),e.jsxs("div",{children:[P&&e.jsx("div",{className:"date-separator",children:$e(N.created_at||N.timestamp)}),e.jsx(Le,{message:N,onCTAClick:k,getCTAButtonConfig:b,messageContext:G})]},N._id||U)}),g&&e.jsx(Ee,{userName:l}),e.jsx("div",{ref:L})]})})]})}function Ve(n){if(!n)return"?";const s=n.trim().split(" ").filter(Boolean);return s.length===0?"?":s.length===1?s[0][0].toUpperCase():(s[0][0]+s[s.length-1][0]).toUpperCase()}function ne(n){if(!n)return"";try{return new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric"})}catch{return""}}function ze(n){const s=[{key:"submitted",label:"Submitted"},{key:"under_review",label:"Under Review"},{key:"negotiation",label:"Negotiation"},{key:"accepted",label:"Accepted"}],u={submitted:0,pending:1,under_review:1,negotiation:2,counter:2,accepted:3,approved:3,declined:-1,rejected:-1}[n==null?void 0:n.toLowerCase()]??1;return s.map((d,g)=>({...d,status:g<u?"completed":g===u?"current":"pending"}))}function Ie({status:n,label:s,date:a}){return e.jsxs("div",{className:`timeline-item timeline-item--${n}`,children:[e.jsx("div",{className:"timeline-item__dot"}),e.jsx("div",{className:"timeline-item__label",children:s}),a&&e.jsx("div",{className:"timeline-item__date",children:a})]})}function Ke(){return e.jsx("div",{className:"right-panel__loading",children:e.jsx("div",{className:"right-panel__loading-spinner"})})}function Ye({threadInfo:n,proposalData:s,listingData:a,userType:u,onAction:d,isLoading:g}){var M;const[l,k]=i.useState(!0),b=u==="Host"?"Guest":"Host",p=ze(s==null?void 0:s.status),o=s!=null&&s.startDate&&(s!=null&&s.endDate)?`${ne(s.startDate)} - ${ne(s.endDate)}`:"Not set",y=["pending","submitted","under_review"].includes((M=s==null?void 0:s.status)==null?void 0:M.toLowerCase());return e.jsxs("div",{className:"right-panel",children:[g&&e.jsx(Ke,{}),!g&&e.jsxs("div",{className:"panel-profile",children:[e.jsx("div",{className:"panel-profile__avatar",children:n!=null&&n.contact_avatar?e.jsx("img",{src:n.contact_avatar,alt:""}):e.jsx("span",{className:"panel-profile__avatar-initials",children:Ve(n==null?void 0:n.contact_name)})}),e.jsx("h3",{className:"panel-profile__name",children:(n==null?void 0:n.contact_name)||"Unknown"}),e.jsx("span",{className:`panel-profile__badge panel-profile__badge--${b.toLowerCase()}`,children:b}),e.jsxs("div",{className:"panel-profile__stats",children:[e.jsxs("div",{className:"panel-profile__stat",children:[e.jsx("span",{className:"panel-profile__stat-label",children:"Response Rate"}),e.jsx("span",{className:"panel-profile__stat-value",children:"98%"})]}),e.jsxs("div",{className:"panel-profile__stat",children:[e.jsx("span",{className:"panel-profile__stat-label",children:"Response Time"}),e.jsx("span",{className:"panel-profile__stat-value",children:"<1 hour"})]}),e.jsxs("div",{className:"panel-profile__stat",children:[e.jsx("span",{className:"panel-profile__stat-label",children:"Member Since"}),e.jsx("span",{className:"panel-profile__stat-value",children:"2024"})]})]}),e.jsxs("button",{className:"panel-profile__btn",onClick:()=>d==null?void 0:d("view_profile"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"12",cy:"7",r:"4"})]}),"View Profile"]})]}),!g&&s&&e.jsxs("div",{className:"panel-section",children:[e.jsxs("button",{className:"panel-section__header",onClick:()=>k(!l),type:"button",children:["Proposal Progress",e.jsx("svg",{className:`panel-section__chevron ${l?"panel-section__chevron--open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})})]}),l&&e.jsx("div",{className:"panel-section__content",children:e.jsx("div",{className:"proposal-timeline",children:p.map(v=>e.jsx(Ie,{status:v.status,label:v.label,date:v.status==="completed"?ne(s.modifiedDate):null},v.key))})})]}),!g&&a&&e.jsxs("div",{className:"panel-listing-card",children:[e.jsxs("div",{className:"panel-listing-card__image",children:[a.primaryImage?e.jsx("img",{src:a.primaryImage,alt:""}):e.jsx("div",{style:{background:"#E0E0E0",width:"100%",height:"100%"}}),e.jsx("span",{className:"panel-listing-card__badge",children:a.listingType||"Flexible"})]}),e.jsx("h4",{className:"panel-listing-card__name",children:a.name}),e.jsx("p",{className:"panel-listing-card__location",children:a.address}),e.jsxs("div",{className:"panel-listing-card__info-grid",children:[e.jsxs("div",{className:"panel-listing-card__info-item",children:[e.jsx("span",{className:"panel-listing-card__info-label",children:"Dates"}),e.jsx("span",{className:"panel-listing-card__info-value",children:o})]}),e.jsxs("div",{className:"panel-listing-card__info-item",children:[e.jsx("span",{className:"panel-listing-card__info-label",children:"Days/Week"}),e.jsx("span",{className:"panel-listing-card__info-value",children:(s==null?void 0:s.daysPerWeek)??"-"})]}),e.jsxs("div",{className:"panel-listing-card__info-item",children:[e.jsx("span",{className:"panel-listing-card__info-label",children:"Price"}),e.jsxs("span",{className:"panel-listing-card__info-value",children:["$",(s==null?void 0:s.totalMonthlyPrice)??a.monthlyRate??"-","/mo"]})]})]}),e.jsxs("a",{href:`/listing?id=${a.id}`,className:"panel-listing-card__link",onClick:v=>{v.preventDefault(),d==null||d("view_listing")},children:["View Listing",e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"}),e.jsx("polyline",{points:"15 3 21 3 21 9"}),e.jsx("line",{x1:"10",y1:"14",x2:"21",y2:"3"})]})]})]}),!g&&e.jsxs("div",{className:"quick-actions",children:[u==="Host"&&y&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"quick-actions__btn quick-actions__btn--primary",onClick:()=>d==null?void 0:d("accept"),type:"button",children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}),"Accept Proposal"]}),e.jsxs("button",{className:"quick-actions__btn quick-actions__btn--secondary",onClick:()=>d==null?void 0:d("counter"),type:"button",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),"Counter Proposal"]})]}),e.jsxs("button",{className:"quick-actions__btn quick-actions__btn--secondary",onClick:()=>d==null?void 0:d("video"),type:"button",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polygon",{points:"23 7 16 12 23 17 23 7"}),e.jsx("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})]}),"Schedule Video Call"]}),u==="Host"&&y&&e.jsxs("button",{className:"quick-actions__btn quick-actions__btn--danger",onClick:()=>d==null?void 0:d("decline"),type:"button",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),"Decline"]})]})]})}const Ge=900,Je=1200;function de(){return e.jsxs("div",{className:"messaging-loading-state",children:[e.jsx("div",{className:"messaging-spinner"}),e.jsx("p",{children:"Loading your conversations..."})]})}function Qe({error:n,onRetry:s}){return e.jsxs("div",{className:"messaging-error-state",children:[e.jsx("div",{className:"messaging-error-icon",children:"!"}),e.jsx("h2",{children:"Something went wrong"}),e.jsx("p",{className:"messaging-error-message",children:n}),e.jsx("button",{className:"messaging-retry-button",onClick:s,children:"Try Again"})]})}function Xe({userType:n}){const s=n==="Host",a=s?{description:"Connect with guests interested in your space. Review proposals, answer questions, and coordinate flexible rental arrangements.",primaryBtn:{href:"/host-overview",label:"View Your Listings"},secondaryBtn:{href:"/list-with-us",label:"List Another Space"},tips:[{href:"/host-overview",text:"Manage your listings",icon:"home"},{href:"/host-proposals",text:"Review proposals",icon:"document"},{href:"/faq",text:"Hosting tips",icon:"help"}]}:{description:"Connect with hosts to discuss proposals, schedule viewings, and coordinate your flexible rental experience.",primaryBtn:{href:"/search",label:"Find a Listing"},secondaryBtn:{href:"/list-with-us",label:"List Your Space"},tips:[{href:"/search",text:"Browse available spaces",icon:"search"},{href:"/faq",text:"Submit a proposal",icon:"document"},{href:"/faq",text:"Learn how it works",icon:"help"}]},u={search:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),home:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),e.jsx("polyline",{points:"9 22 9 12 15 12 15 22"})]}),document:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),help:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})};return e.jsxs("div",{className:"messaging-welcome-state",children:[e.jsxs("div",{className:"welcome-illustration",children:[e.jsx("div",{className:"bubble-1",children:e.jsxs("div",{className:"bubble-lines",children:[e.jsx("div",{className:"bubble-line",style:{width:"70px"}}),e.jsx("div",{className:"bubble-line",style:{width:"50px"}})]})}),e.jsx("div",{className:"bubble-2",children:e.jsxs("div",{className:"bubble-lines",children:[e.jsx("div",{className:"bubble-line",style:{width:"60px"}}),e.jsx("div",{className:"bubble-line",style:{width:"80px"}})]})})]}),e.jsx("h2",{className:"welcome-title",children:"Welcome to Messages"}),e.jsx("p",{className:"welcome-desc",children:a.description}),e.jsxs("div",{className:"welcome-actions",children:[e.jsxs("a",{href:a.primaryBtn.href,className:"welcome-btn welcome-btn-primary",children:[s?u.home:u.search,a.primaryBtn.label]}),e.jsxs("a",{href:a.secondaryBtn.href,className:"welcome-btn welcome-btn-secondary",children:[u.home,a.secondaryBtn.label]})]}),e.jsxs("div",{className:"welcome-tips",children:[e.jsx("div",{className:"welcome-tips-title",children:"Getting Started"}),e.jsx("div",{className:"welcome-tip-cards",children:a.tips.map((d,g)=>e.jsxs("a",{href:d.href,className:"welcome-tip-card",children:[e.jsx("div",{className:"welcome-tip-icon",children:u[d.icon]}),e.jsx("span",{className:"welcome-tip-text",children:d.text})]},g))})]})]})}function Ze(){return e.jsxs("div",{className:"no-thread-selected",children:[e.jsx("div",{className:"no-thread-selected__emoji",children:"ðŸ’¬"}),e.jsx("h3",{className:"no-thread-selected__title",children:"Select a Conversation"}),e.jsx("p",{className:"no-thread-selected__subtitle",children:"Send and receive messages."})]})}function Ae(){const{authState:n,user:s,threads:a,selectedThread:u,messages:d,threadInfo:g,proposalData:l,listingData:k,isLoadingPanelData:b,isLoading:p,isLoadingMessages:o,error:y,messageInput:M,isSending:v,isOtherUserTyping:Y,typingUserName:L,handleThreadSelect:G,handleMessageInputChange:T,handleSendMessage:N,handleRetry:U,insertSuggestion:R,handlePanelAction:P,handleCTAClick:W,getCTAButtonConfig:H}=He(),[B,E]=i.useState("list"),[F,X]=i.useState(!1),[Z,O]=i.useState(!1),[A,$]=i.useState(!1),q=i.useRef(null),D=i.useCallback(()=>{var S;(S=q.current)==null||S.focus()},[]);i.useEffect(()=>{const S=()=>{const J=window.innerWidth;X(J<=Ge),O(J>Je)};return S(),window.addEventListener("resize",S),()=>window.removeEventListener("resize",S)},[]);const se=S=>{G(S),F&&E("conversation")},ee=()=>{E("list")},te=i.useCallback(()=>{$(S=>!S)},[]);return n.shouldRedirect?e.jsxs(e.Fragment,{children:[e.jsx(oe,{}),e.jsx("main",{className:"main-content",children:e.jsx("div",{className:"messaging-page",children:e.jsx(de,{})})})]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{}),e.jsx("main",{className:"main-content",children:e.jsxs("div",{className:"messaging-page",children:[p&&e.jsx(de,{}),!p&&y&&e.jsx(Qe,{error:y,onRetry:U}),!p&&!y&&a.length===0&&e.jsx(Xe,{userType:s==null?void 0:s.userType}),!p&&!y&&a.length>0&&e.jsxs("div",{className:`messaging-layout ${F?"messaging-layout--mobile":""}`,children:[e.jsx(Fe,{threads:a,selectedThreadId:u==null?void 0:u._id,onThreadSelect:se,onAction:P,className:F&&B==="conversation"?"thread-sidebar--hidden":""}),e.jsx("div",{className:`message-content ${F&&B==="list"?"message-content--hidden":""}`,children:u?e.jsxs(e.Fragment,{children:[e.jsx(De,{messages:d,threadInfo:g,isLoading:o,onBack:ee,isMobile:F,isOtherUserTyping:Y,typingUserName:L,onCTAClick:W,getCTAButtonConfig:H,onSuggestionClick:R,onFocusInput:D,showRightPanel:Z,isRightPanelCollapsed:A,onToggleRightPanel:te,onHeaderAction:P}),e.jsx(Ue,{ref:q,value:M,onChange:T,onSend:N,disabled:!u||v,isSending:v})]}):e.jsx(Ze,{})}),Z&&u&&!A&&e.jsx(Ye,{threadInfo:g,proposalData:l,listingData:k,userType:s==null?void 0:s.userType,onAction:P,isLoading:b})]})]})})]})}const es=Ne(document.getElementById("root"));es.render(e.jsx(ke.StrictMode,{children:e.jsx(We,{children:e.jsx(Ae,{})})}));
