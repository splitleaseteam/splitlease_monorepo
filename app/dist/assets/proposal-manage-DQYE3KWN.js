import{r as h,j as e,c as te}from"./client-BJVKzfAi.js";import{s as A}from"./supabase-BoCLEw6R.js";import{f as le}from"./format-AibE8BX3.js";import{A as Z}from"./AdminHeader-tCInZd3n.js";import"./auth-QZ4BJadW.js";import"./star-OtPMgcH9.js";import"./createLucideIcon-CgZZH2OU.js";import"./file-text-Bqp_Hw0X.js";import"./triangle-alert-Bp6DQQmR.js";import"./users-d0RSvnp4.js";import"./pen-line-Duo49k9O.js";import"./calendar-CDI4qHEX.js";import"./mail-CRbL90NL.js";import"./user-check-CoCGzn5Y.js";import"./dollar-sign-Dn2-KjNW.js";import"./send-C4mziT0-.js";import"./x-CrJVeoCh.js";const ie=["Proposal Submitted for guest by Split Lease - Awaiting Rental Application","Proposal Submitted by guest - Awaiting Rental Application","Proposal Submitted for guest by Split Lease - Pending Confirmation","Host Review","Host Counteroffer Submitted / Awaiting Guest Review","Proposal or Counteroffer Accepted / Drafting Lease Documents","Lease Documents Sent for Review","Lease Documents Sent for Signatures","Lease Documents Signed / Awaiting Initial payment","Initial Payment Submitted / Lease activated","Proposal Cancelled by Guest","Proposal Rejected by Host","Proposal Cancelled by Split Lease","Guest Ignored Suggestion"];function re(s){return s?{_id:s._id,firstName:s["Name - First"]||s.firstName||"",lastName:s["Name - Last"]||s.lastName||"",fullName:s["Name - Full"]||s.fullName||"",email:s.email||"",phoneNumber:s["Phone Number"]||s.phoneNumber||"",profilePhoto:s["Profile Photo"]||s.profilePhoto||null,aboutMe:s["About Me / Bio"]||s.aboutMe||"",isUsabilityTester:s["is usability tester"]||s.isUsabilityTester||!1,isVerified:s["user verified?"]||!1}:null}function ne(s){return s?{_id:s._id,firstName:s["Name - First"]||s.firstName||"",lastName:s["Name - Last"]||s.lastName||"",fullName:s["Name - Full"]||s.fullName||"",email:s.email||"",phoneNumber:s["Phone Number"]||s.phoneNumber||"",profilePhoto:s["Profile Photo"]||s.profilePhoto||null,isUsabilityTester:s["is usability tester"]||s.isUsabilityTester||!1}:null}function ce(s){return s?{_id:s._id,name:s.Name||s.name||"Unnamed Listing",address:s["Full Address"]||s.address||"",rentalType:s["rental type"]||s.rentalType||"",coverPhoto:s["Cover Photo"]||s.coverPhoto||null,damageDeposit:s["Damage Deposit"]||s.damageDeposit||0,cleaningCost:s["Cleaning Cost / Maintenance Fee"]||s.cleaningCost||0,houseRules:s["House Rules"]||s.houseRules||[]}:null}function oe(s,u,r,n){if(!s)return null;let o=s["Days Selected"]||s.daysSelected||[];if(typeof o=="string")try{o=JSON.parse(o)}catch{o=[]}const t=[!1,!1,!1,!1,!1,!1,!1];return Array.isArray(o)&&o.forEach(d=>{typeof d=="number"&&d>=0&&d<=6&&(t[d]=!0)}),{_id:s._id,status:s.Status||s.status||"",createdDate:s["Created Date"]||s.createdDate||null,modifiedDate:s["Modified Date"]||s.modifiedDate||null,guest:u,host:r,listing:n,pricing:{nightlyPrice:s["proposal nightly price"]||s.nightlyPrice||0,totalReservationPrice:s["Total Price for Reservation (guest)"]||s.totalReservationPrice||0,hostCompensation:s["host compensation"]||s.hostCompensation||0,totalCompensation:s["Total Compensation (proposal - host)"]||s.totalCompensation||0,pricePerFourWeeks:s["4 week rent"]||s.pricePerFourWeeks||0,fourWeekCompensation:s["4 week compensation"]||s.fourWeekCompensation||0},reservation:{moveInDate:s["Move in range start"]||s.moveInDate||null,checkInDate:s["check in day"]||s.checkInDate||null,checkOutDate:s["check out day"]||s.checkOutDate||null,reservationSpanWeeks:s["Reservation Span (Weeks)"]||s.reservationSpanWeeks||0,weeklySchedule:t,daysSelected:o},guestAbout:s.about_yourself||"",guestNeedForSpace:s["need for space"]||"",comment:s.Comment||""}}function me(){const[s,u]=h.useState({isChecking:!0,isAuthenticated:!1,isAdmin:!1,shouldRedirect:!1}),[r,n]=h.useState({guestSearch:"",hostSearch:"",status:"",proposalId:"",listingSearch:"",startDate:null,endDate:null,sortDirection:"desc"}),[o,t]=h.useState([]),[d,v]=h.useState(!0),[S,b]=h.useState(null),[I,F]=h.useState(0),[i,x]=h.useState(!1);h.useEffect(()=>{u({isChecking:!1,isAuthenticated:!0,isAdmin:!0,shouldRedirect:!1})},[]),h.useEffect(()=>{s.isAdmin&&!s.isChecking&&P()},[r,s.isAdmin,s.isChecking]),h.useEffect(()=>{const p=new URLSearchParams(window.location.search).get("proposal");p&&p!==r.proposalId&&n(f=>({...f,proposalId:p}))},[]);const P=h.useCallback(async()=>{v(!0),b(null);try{let c=A.from("proposal").select(`
          _id,
          "Status",
          "Guest",
          "Host User",
          "Listing",
          "Move in range start",
          "Move in range end",
          "Move-out",
          "Reservation Span",
          "Reservation Span (Weeks)",
          "nights per week (num)",
          "Nights Selected (Nights list)",
          "Days Selected",
          "check in day",
          "check out day",
          "proposal nightly price",
          "4 week rent",
          "Total Price for Reservation (guest)",
          "Total Compensation (proposal - host)",
          "host compensation",
          "4 week compensation",
          "cleaning fee",
          "damage deposit",
          "need for space",
          "about_yourself",
          "Comment",
          "Created Date",
          "Modified Date"
        `,{count:"exact"}).or('"Deleted".is.null,"Deleted".eq.false');if(r.proposalId&&(c=c.ilike("_id",`%${r.proposalId}%`)),r.status&&(c=c.eq("Status",r.status)),r.startDate){const m=r.startDate instanceof Date?r.startDate.toISOString():r.startDate;c=c.gte('"Modified Date"',m)}if(r.endDate){const m=r.endDate instanceof Date?r.endDate.toISOString():r.endDate;c=c.lte('"Modified Date"',m)}c=c.order("Modified Date",{ascending:r.sortDirection==="asc"}),c=c.limit(100);const{data:p,error:f,count:g}=await c;if(f)throw console.error("[ProposalManage] Error fetching proposals:",f),f;const a=[...new Set(p==null?void 0:p.map(m=>m.Guest).filter(Boolean))],l=[...new Set(p==null?void 0:p.map(m=>m["Host User"]).filter(Boolean))],y=[...new Set(p==null?void 0:p.map(m=>m.Listing).filter(Boolean))],w={};if(a.length>0){const{data:m}=await A.from("user").select('_id, "Name - Full", "Name - First", "Name - Last", email, "Phone Number", "Profile Photo", "About Me / Bio", "user verified?", "is usability tester"').in("_id",a);m==null||m.forEach(N=>{w[N._id]=re(N)})}const j={};if(l.length>0){const{data:m}=await A.from("user").select('_id, "Name - Full", "Name - First", "Name - Last", email, "Phone Number", "Profile Photo", "is usability tester"').in("_id",l);m==null||m.forEach(N=>{j[N._id]=ne(N)})}const H={};if(y.length>0){const{data:m}=await A.from("listing").select('_id, Name, "Full Address", "rental type", "Cover Photo", "Damage Deposit", "Cleaning Cost / Maintenance Fee"').in("_id",y);m==null||m.forEach(N=>{H[N._id]=ce(N)})}let k=(p==null?void 0:p.map(m=>{const N=w[m.Guest]||null,D=j[m["Host User"]]||null,L=H[m.Listing]||null;return oe(m,N,D,L)}))||[];if(r.guestSearch){const m=r.guestSearch.toLowerCase();k=k.filter(N=>{var D,L,_,T,M,G,$,E,O,B;return((L=(D=N.guest)==null?void 0:D.fullName)==null?void 0:L.toLowerCase().includes(m))||((T=(_=N.guest)==null?void 0:_.firstName)==null?void 0:T.toLowerCase().includes(m))||((G=(M=N.guest)==null?void 0:M.lastName)==null?void 0:G.toLowerCase().includes(m))||((E=($=N.guest)==null?void 0:$.email)==null?void 0:E.toLowerCase().includes(m))||((B=(O=N.guest)==null?void 0:O.phoneNumber)==null?void 0:B.includes(r.guestSearch))})}if(r.hostSearch){const m=r.hostSearch.toLowerCase();k=k.filter(N=>{var D,L,_,T,M,G,$,E,O,B;return((L=(D=N.host)==null?void 0:D.fullName)==null?void 0:L.toLowerCase().includes(m))||((T=(_=N.host)==null?void 0:_.firstName)==null?void 0:T.toLowerCase().includes(m))||((G=(M=N.host)==null?void 0:M.lastName)==null?void 0:G.toLowerCase().includes(m))||((E=($=N.host)==null?void 0:$.email)==null?void 0:E.toLowerCase().includes(m))||((B=(O=N.host)==null?void 0:O.phoneNumber)==null?void 0:B.includes(r.hostSearch))})}if(r.listingSearch){const m=r.listingSearch.toLowerCase();k=k.filter(N=>{var D,L,_,T,M,G;return((L=(D=N.listing)==null?void 0:D.name)==null?void 0:L.toLowerCase().includes(m))||((T=(_=N.listing)==null?void 0:_._id)==null?void 0:T.toLowerCase().includes(m))||((G=(M=N.listing)==null?void 0:M.rentalType)==null?void 0:G.toLowerCase().includes(m))})}t(k),F(k.length)}catch(c){console.error("[ProposalManage] Failed to load proposals:",c),b("Failed to load proposals. Please try again.")}finally{v(!1)}},[r]),z=h.useCallback((c,p)=>{n(f=>({...f,[c]:p}))},[]),Q=h.useCallback(()=>{n({guestSearch:"",hostSearch:"",status:"",proposalId:"",listingSearch:"",startDate:null,endDate:null,sortDirection:"desc"})},[]),U=h.useCallback(async(c,p)=>{try{t(g=>g.map(a=>a._id===c?{...a,status:p,modifiedDate:new Date().toISOString()}:a));const{error:f}=await A.functions.invoke("proposal",{body:{action:"update",payload:{proposal_id:c,status:p}}});if(f)throw f;console.log("[ProposalManage] Status updated:",c,p)}catch(f){console.error("[ProposalManage] Failed to update status:",f),alert("Failed to update status. Please try again."),P()}},[P]),V=h.useCallback(async(c,p)=>{var f,g,a;switch(c){case"viewListing":window.open(`/view-split-lease?id=${(f=p.listing)==null?void 0:f._id}`,"_blank");break;case"modifyAsHost":alert("Host modification feature coming soon");break;case"modifyAsGuest":alert("Guest modification feature coming soon");break;case"sendReminderGuest":try{alert(`Reminder sent to ${((g=p.guest)==null?void 0:g.firstName)||"Guest"}`)}catch{alert("Failed to send reminder")}break;case"sendReminderHost":try{alert(`Reminder sent to ${((a=p.host)==null?void 0:a.firstName)||"Host"}`)}catch{alert("Failed to send reminder")}break;case"cancelProposal":if(window.confirm(`Are you sure you want to cancel proposal ${p._id}?`))try{await U(p._id,"Proposal Cancelled by Split Lease")}catch{alert("Failed to cancel proposal")}break;default:console.log("[ProposalManage] Unknown action:",c)}},[U]),J=h.useCallback(()=>{P()},[P]),X=h.useCallback(()=>{x(c=>!c)},[]),R=h.useCallback(async c=>{var p,f;try{const{data:g,error:a}=await A.functions.invoke("proposal",{body:{action:"create_suggested",payload:{guestId:c.selectedGuest._id,listingId:c.selectedListing._id,moveInStartRange:c.moveInDate,daysSelected:c.weeklySchedule.map((l,y)=>l?y:null).filter(l=>l!==null),reservationSpanWeeks:c.reservationSpanWeeks,aboutMe:c.guestAbout,needForSpace:c.guestNeedForSpace,specialNeeds:c.guestSpecialNeeds,status:c.proposalStatus}}});if(a)throw a;return await P(),{success:!0,proposalId:(p=g==null?void 0:g.data)==null?void 0:p.proposalId,threadId:(f=g==null?void 0:g.data)==null?void 0:f.threadId}}catch(g){return console.error("[ProposalManage] Failed to create proposal:",g),{success:!1,error:g.message}}},[P]),K=h.useMemo(()=>ie.map(c=>({value:c,label:c||"(empty)"})),[]);return{authState:s,proposals:o,filters:r,totalCount:I,statusOptions:K,isLoading:d,error:S,isCreationFormOpen:i,handleFilterChange:z,handleClearFilters:Q,handleStatusChange:U,handleAction:V,handleRetry:J,handleToggleCreationForm:X,handleCreateProposal:R}}const q=["Proposal Submitted for guest by Split Lease - Awaiting Rental Application","Proposal Submitted by guest - Awaiting Rental Application","Proposal Submitted for guest by Split Lease - Pending Confirmation","Host Review","Host Counteroffer Submitted / Awaiting Guest Review","Guest Counteroffer Submitted / Awaiting Host Review","Proposal or Counteroffer Accepted / Drafting Lease Documents","Lease Documents Sent for Review","Lease Documents Sent for Signatures","Lease Documents Signed / Awaiting Initial payment","Initial Payment Submitted / Lease activated","Proposal Cancelled by Guest","Proposal Rejected by Host","Proposal Cancelled by Split Lease","Guest Ignored Suggestion"],ae=["S","M","T","W","T","F","S"],ee="Proposal Submitted for guest by Split Lease - Awaiting Rental Application";function de({filters:s,onFilterChange:u,onClearAll:r}){const n=t=>t?(t instanceof Date?t:new Date(t)).toISOString().split("T")[0]:"",o=(t,d)=>{d?u(t,new Date(d)):u(t,null)};return e.jsxs("div",{className:"pm-filter-section",children:[e.jsxs("div",{className:"pm-filter-row pm-filter-row-1",children:[e.jsx("div",{className:"pm-filter-item",children:e.jsxs("div",{className:"pm-input-wrapper",children:[e.jsx("input",{type:"text",className:"pm-searchbox",placeholder:"Search Guest Name, email, phone number",value:s.guestSearch||"",onChange:t=>u("guestSearch",t.target.value)}),s.guestSearch&&e.jsx("button",{className:"pm-clear-btn",onClick:()=>u("guestSearch",""),"aria-label":"Clear guest search",children:"×"})]})}),e.jsx("div",{className:"pm-filter-item",children:e.jsxs("div",{className:"pm-input-wrapper",children:[e.jsx("input",{type:"text",className:"pm-searchbox",placeholder:"Search Host Name, email, phone number",value:s.hostSearch||"",onChange:t=>u("hostSearch",t.target.value)}),s.hostSearch&&e.jsx("button",{className:"pm-clear-btn",onClick:()=>u("hostSearch",""),"aria-label":"Clear host search",children:"×"})]})}),e.jsx("div",{className:"pm-filter-item",children:e.jsxs("select",{className:"pm-select",value:s.status||"",onChange:t=>u("status",t.target.value),children:[e.jsx("option",{value:"",children:"All Statuses"}),q.map((t,d)=>e.jsx("option",{value:t,children:t||"(empty)"},d))]})}),e.jsxs("div",{className:"pm-filter-item pm-sort-section",children:[e.jsx("label",{className:"pm-filter-label",children:"Sort by Modified Date"}),e.jsxs("div",{className:"pm-sort-controls",children:[e.jsx("button",{className:`pm-sort-btn ${s.sortDirection==="asc"?"active":""}`,onClick:()=>u("sortDirection","asc"),title:"Ascending (oldest first)",children:"↑"}),e.jsx("button",{className:`pm-sort-btn ${s.sortDirection==="desc"?"active":""}`,onClick:()=>u("sortDirection","desc"),title:"Descending (newest first)",children:"↓"})]})]})]}),e.jsxs("div",{className:"pm-filter-row pm-filter-row-2",children:[e.jsxs("div",{className:"pm-filter-item",children:[e.jsx("label",{className:"pm-filter-label",children:"Filter by Proposal ID"}),e.jsx("input",{type:"text",className:"pm-textbox",placeholder:"Search by ID",value:s.proposalId||"",onChange:t=>u("proposalId",t.target.value)})]}),e.jsxs("div",{className:"pm-filter-item",children:[e.jsx("label",{className:"pm-filter-label",children:"Filter by Listing (name, type, ID)"}),e.jsxs("div",{className:"pm-input-wrapper",children:[e.jsx("input",{type:"text",className:"pm-searchbox",placeholder:"Search Listing by name, unique id, rental type",value:s.listingSearch||"",onChange:t=>u("listingSearch",t.target.value)}),s.listingSearch&&e.jsx("button",{className:"pm-clear-btn",onClick:()=>u("listingSearch",""),"aria-label":"Clear listing search",children:"×"})]})]})]}),e.jsxs("div",{className:"pm-filter-row pm-filter-row-3",children:[e.jsxs("div",{className:"pm-filter-item pm-date-range",children:[e.jsx("label",{className:"pm-filter-label",children:"Display Proposals Modified Between:"}),e.jsxs("div",{className:"pm-date-range-inputs",children:[e.jsx("input",{type:"date",className:"pm-date-picker",value:n(s.startDate),onChange:t=>o("startDate",t.target.value),placeholder:"Start date"}),e.jsx("span",{className:"pm-date-separator",children:"-"}),e.jsx("input",{type:"date",className:"pm-date-picker",value:n(s.endDate),onChange:t=>o("endDate",t.target.value),placeholder:"End date"})]})]}),e.jsx("div",{className:"pm-filter-item",children:e.jsx("button",{className:"pm-clear-all-btn",onClick:r,children:"Clear all"})})]})]})}function W(s){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(s||0)}function Y(s){if(!s)return"N/A";try{return le(new Date(s),"M/d/yyyy")}catch{return"N/A"}}function pe({proposal:s,onStatusChange:u,onAction:r}){const{guest:n,host:o,listing:t,pricing:d,reservation:v}=s;return e.jsxs("div",{className:"pm-proposal-item",children:[e.jsxs("div",{className:"pm-proposal-grid",children:[e.jsxs("div",{className:"pm-section pm-guest-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Guest Information"}),e.jsxs("div",{className:"pm-user-info",children:[(n==null?void 0:n.profilePhoto)&&e.jsx("img",{src:n.profilePhoto,alt:n.fullName||"Guest",className:"pm-profile-photo"}),e.jsxs("div",{className:"pm-user-details",children:[e.jsxs("p",{className:"pm-user-name",children:[n==null?void 0:n.firstName," ",n==null?void 0:n.lastName,(n==null?void 0:n.isUsabilityTester)&&e.jsx("span",{className:"pm-badge pm-usability-tester",children:"Usability Tester"}),(n==null?void 0:n.isVerified)&&e.jsx("span",{className:"pm-badge pm-verified",children:"Verified"})]}),e.jsx("p",{className:"pm-user-contact",children:(n==null?void 0:n.email)||"No email"}),e.jsx("p",{className:"pm-user-contact",children:(n==null?void 0:n.phoneNumber)||"No phone"})]})]}),(n==null?void 0:n.aboutMe)&&e.jsxs("div",{className:"pm-guest-bio",children:[e.jsx("p",{className:"pm-bio-label",children:"About:"}),e.jsx("p",{className:"pm-bio-text",children:n.aboutMe})]}),s.guestNeedForSpace&&e.jsxs("div",{className:"pm-guest-bio",children:[e.jsx("p",{className:"pm-bio-label",children:"Need for Space:"}),e.jsx("p",{className:"pm-bio-text",children:s.guestNeedForSpace})]})]}),e.jsxs("div",{className:"pm-section pm-listing-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Listing Information"}),e.jsxs("div",{className:"pm-listing-info",children:[e.jsx("p",{className:"pm-listing-name",children:(t==null?void 0:t.name)||"Unknown Listing"}),e.jsx("p",{className:"pm-listing-address",children:(t==null?void 0:t.address)||"No address"}),e.jsxs("p",{className:"pm-listing-id",children:["ID: ",(t==null?void 0:t._id)||"N/A"]}),e.jsxs("p",{className:"pm-listing-type",children:["Type: ",(t==null?void 0:t.rentalType)||"N/A"]}),(t==null?void 0:t.coverPhoto)&&e.jsx("div",{className:"pm-listing-photos",children:e.jsx("img",{src:t.coverPhoto,alt:t.name||"Listing",className:"pm-listing-photo"})})]})]}),e.jsxs("div",{className:"pm-section pm-host-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Host Information"}),e.jsxs("div",{className:"pm-user-info",children:[(o==null?void 0:o.profilePhoto)&&e.jsx("img",{src:o.profilePhoto,alt:o.fullName||"Host",className:"pm-profile-photo"}),e.jsxs("div",{className:"pm-user-details",children:[e.jsxs("p",{className:"pm-user-name",children:[(o==null?void 0:o.firstName)||"Unknown"," ",(o==null?void 0:o.lastName)||"Host",(o==null?void 0:o.isUsabilityTester)&&e.jsx("span",{className:"pm-badge pm-usability-tester",children:"Usability Tester"})]}),e.jsx("p",{className:"pm-user-contact",children:(o==null?void 0:o.email)||"No email"}),e.jsx("p",{className:"pm-user-contact",children:(o==null?void 0:o.phoneNumber)||"No phone"})]})]})]}),e.jsxs("div",{className:"pm-section pm-pricing-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Pricing"}),e.jsxs("div",{className:"pm-pricing-grid",children:[e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Nightly Price:"}),e.jsx("span",{className:"pm-pricing-value",children:W(d==null?void 0:d.nightlyPrice)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Total Reservation:"}),e.jsx("span",{className:"pm-pricing-value",children:W(d==null?void 0:d.totalReservationPrice)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"4-Week Rent:"}),e.jsx("span",{className:"pm-pricing-value",children:W(d==null?void 0:d.pricePerFourWeeks)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Host Compensation:"}),e.jsx("span",{className:"pm-pricing-value",children:W(d==null?void 0:d.hostCompensation)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Total Compensation:"}),e.jsx("span",{className:"pm-pricing-value",children:W(d==null?void 0:d.totalCompensation)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Damage Deposit:"}),e.jsx("span",{className:"pm-pricing-value",children:W(t==null?void 0:t.damageDeposit)})]}),e.jsxs("div",{className:"pm-pricing-item",children:[e.jsx("span",{className:"pm-pricing-label",children:"Cleaning Cost:"}),e.jsx("span",{className:"pm-pricing-value",children:W(t==null?void 0:t.cleaningCost)})]})]})]}),e.jsxs("div",{className:"pm-section pm-reservation-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Reservation Details"}),e.jsxs("div",{className:"pm-reservation-info",children:[e.jsxs("div",{className:"pm-info-item",children:[e.jsx("span",{className:"pm-info-label",children:"Move-in Date:"}),e.jsx("span",{className:"pm-info-value",children:Y(v==null?void 0:v.moveInDate)})]}),e.jsxs("div",{className:"pm-info-item",children:[e.jsx("span",{className:"pm-info-label",children:"Reservation Span:"}),e.jsxs("span",{className:"pm-info-value",children:[(v==null?void 0:v.reservationSpanWeeks)||0," weeks"]})]}),e.jsxs("div",{className:"pm-weekly-schedule",children:[e.jsx("span",{className:"pm-info-label",children:"Weekly Schedule:"}),e.jsx("div",{className:"pm-days-grid",children:ae.map((S,b)=>{var I;return e.jsx("div",{className:`pm-day-cell ${(I=v==null?void 0:v.weeklySchedule)!=null&&I[b]?"active":""}`,children:S},b)})})]})]})]}),e.jsxs("div",{className:"pm-section pm-status-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Proposal Status"}),e.jsx("select",{className:"pm-status-select",value:s.status,onChange:S=>u(s._id,S.target.value),children:q.map((S,b)=>e.jsx("option",{value:S,children:S||"(empty)"},b))}),e.jsxs("div",{className:"pm-proposal-meta",children:[e.jsxs("p",{className:"pm-meta-item",children:[e.jsx("span",{className:"pm-meta-label",children:"Proposal ID:"}),e.jsx("span",{className:"pm-meta-value pm-id-value",children:s._id})]}),e.jsxs("p",{className:"pm-meta-item",children:[e.jsx("span",{className:"pm-meta-label",children:"Created:"}),e.jsx("span",{className:"pm-meta-value",children:Y(s.createdDate)})]}),e.jsxs("p",{className:"pm-meta-item",children:[e.jsx("span",{className:"pm-meta-label",children:"Modified:"}),e.jsx("span",{className:"pm-meta-value",children:Y(s.modifiedDate)})]})]})]}),s.comment&&e.jsxs("div",{className:"pm-section pm-comment-section",children:[e.jsx("h3",{className:"pm-section-title",children:"Guest Comment"}),e.jsx("p",{className:"pm-comment-text",children:s.comment})]})]}),e.jsxs("div",{className:"pm-action-buttons",children:[e.jsx("button",{className:"pm-btn pm-btn-link",onClick:()=>r("viewListing",s),children:"View listing"}),e.jsx("button",{className:"pm-btn pm-btn-primary",onClick:()=>r("modifyAsHost",s),children:"Modify Terms as Host"}),e.jsx("button",{className:"pm-btn pm-btn-primary",onClick:()=>r("modifyAsGuest",s),children:"Modify Terms as Guest"}),e.jsx("button",{className:"pm-btn pm-btn-secondary",onClick:()=>r("sendReminderGuest",s),children:"Send reminder to guest"}),e.jsx("button",{className:"pm-btn pm-btn-secondary",onClick:()=>r("sendReminderHost",s),children:"Send reminder to host"}),e.jsx("button",{className:"pm-btn pm-btn-danger",onClick:()=>r("cancelProposal",s),children:"Cancel Proposal by SplitLease"})]})]})}function ue({listing:s,onSelect:u}){return e.jsx("div",{className:"pm-search-result-item",onClick:()=>u(s),children:e.jsxs("div",{className:"pm-search-result-content",children:[s.coverPhoto&&e.jsx("img",{src:s.coverPhoto,alt:s.name,className:"pm-search-result-photo"}),e.jsxs("div",{className:"pm-search-result-details",children:[e.jsx("p",{className:"pm-search-result-name",children:s.name}),e.jsx("p",{className:"pm-search-result-secondary",children:s.address}),e.jsxs("p",{className:"pm-search-result-id",children:["ID: ",s._id]}),s.host&&e.jsxs("p",{className:"pm-search-result-host",children:["Host: ",s.host.fullName||s.host.email]})]})]})})}function he({guest:s,onSelect:u}){return e.jsx("div",{className:"pm-search-result-item",onClick:()=>u(s),children:e.jsxs("div",{className:"pm-search-result-content",children:[s.profilePhoto&&e.jsx("img",{src:s.profilePhoto,alt:s.fullName,className:"pm-search-result-photo pm-search-result-avatar"}),e.jsxs("div",{className:"pm-search-result-details",children:[e.jsx("p",{className:"pm-search-result-name",children:s.fullName||`${s.firstName} ${s.lastName}`}),e.jsx("p",{className:"pm-search-result-secondary",children:s.email}),s.phoneNumber&&e.jsx("p",{className:"pm-search-result-id",children:s.phoneNumber})]})]})})}function Ne({onCreateProposal:s,onClose:u}){var p,f,g;const[r,n]=h.useState(1),[o,t]=h.useState(!1),[d,v]=h.useState(!1),[S,b]=h.useState([]),[I,F]=h.useState([]),[i,x]=h.useState({selectedListing:null,listingSearch:"",selectedGuest:null,guestSearch:"",guestAbout:"",guestNeedForSpace:"",guestSpecialNeeds:"",proposalStatus:ee,moveInDate:"",reservationSpanWeeks:13,weeklySchedule:[!1,!1,!1,!1,!1,!1,!1],strictMoveIn:!1,isFullTime:!1,recentlyCreatedProposalId:null,recentlyCreatedThreadId:null}),P=h.useCallback(async a=>{if(!a||a.length<2){b([]);return}t(!0);try{const{data:l,error:y}=await A.from("listing").select(`
          _id,
          Name,
          "Full Address",
          "rental type",
          "Cover Photo",
          "Host User"
        `).or(`Name.ilike.%${a}%,_id.ilike.%${a}%`).limit(20);if(y)throw y;const w=[...new Set(l==null?void 0:l.map(C=>C["Host User"]).filter(Boolean))],j={};if(w.length>0){const{data:C}=await A.from("user").select('_id, "Name - Full", email').in("_id",w);C==null||C.forEach(k=>{j[k._id]={fullName:k["Name - Full"],email:k.email}})}const H=(l==null?void 0:l.map(C=>({_id:C._id,name:C.Name||"Unnamed Listing",address:C["Full Address"]||"",rentalType:C["rental type"]||"",coverPhoto:C["Cover Photo"]||null,host:j[C["Host User"]]||null})))||[];b(H)}catch(l){console.error("[QuickProposalCreation] Listing search error:",l),b([])}finally{t(!1)}},[]),z=h.useCallback(async a=>{if(!a||a.length<2){F([]);return}t(!0);try{const{data:l,error:y}=await A.from("user").select(`
          _id,
          "Name - Full",
          "Name - First",
          "Name - Last",
          email,
          "Phone Number",
          "Profile Photo",
          "About Me / Bio",
          "need for space",
          "Special needs"
        `).or(`"Name - Full".ilike.%${a}%,email.ilike.%${a}%,"Phone Number".ilike.%${a}%`).limit(20);if(y)throw y;const w=(l==null?void 0:l.map(j=>({_id:j._id,fullName:j["Name - Full"]||"",firstName:j["Name - First"]||"",lastName:j["Name - Last"]||"",email:j.email||"",phoneNumber:j["Phone Number"]||"",profilePhoto:j["Profile Photo"]||null,aboutMe:j["About Me / Bio"]||"",needForSpace:j["need for space"]||"",specialNeeds:j["Special needs"]||""})))||[];F(w)}catch(l){console.error("[QuickProposalCreation] Guest search error:",l),F([])}finally{t(!1)}},[]),Q=a=>{x(l=>({...l,selectedListing:a})),b([]),n(2)},U=a=>{x(l=>({...l,selectedGuest:a,guestAbout:a.aboutMe||"",guestNeedForSpace:a.needForSpace||"",guestSpecialNeeds:a.specialNeeds||""})),F([]),n(3)},V=a=>{const l=[...i.weeklySchedule];l[a]=!l[a],x(y=>({...y,weeklySchedule:l,isFullTime:l.every(Boolean)}))},J=()=>{x(a=>({...a,weeklySchedule:[!0,!0,!0,!0,!0,!0,!0],isFullTime:!0}))},R=(()=>{if(!i.selectedListing)return{};const a=i.selectedListing.nightlyPrice||150,l=i.reservationSpanWeeks||0,w=i.weeklySchedule.filter(Boolean).length*l,j=a*w,H=l>0?j/l*4:0;return{nightlyPrice:a,totalNights:w,totalReservationPrice:j,pricePerFourWeeks:H,numberOfWeeks:l}})(),K=async()=>{v(!0);try{const a=await s({selectedListing:i.selectedListing,selectedGuest:i.selectedGuest,guestAbout:i.guestAbout,guestNeedForSpace:i.guestNeedForSpace,guestSpecialNeeds:i.guestSpecialNeeds,proposalStatus:i.proposalStatus,moveInDate:i.moveInDate,reservationSpanWeeks:i.reservationSpanWeeks,weeklySchedule:i.weeklySchedule,strictMoveIn:i.strictMoveIn,isFullTime:i.isFullTime,pricing:R});a.success?(x(l=>({...l,recentlyCreatedProposalId:a.proposalId||"Created",recentlyCreatedThreadId:a.threadId||null})),n(4)):alert(`Failed to create proposal: ${a.error||"Unknown error"}`)}catch(a){console.error("[QuickProposalCreation] Create error:",a),alert("Failed to create proposal. Please try again.")}finally{v(!1)}},c=()=>{x({selectedListing:null,listingSearch:"",selectedGuest:null,guestSearch:"",guestAbout:"",guestNeedForSpace:"",guestSpecialNeeds:"",proposalStatus:ee,moveInDate:"",reservationSpanWeeks:13,weeklySchedule:[!1,!1,!1,!1,!1,!1,!1],strictMoveIn:!1,isFullTime:!1,recentlyCreatedProposalId:null,recentlyCreatedThreadId:null}),b([]),F([]),n(1)};return e.jsxs("div",{className:"pm-quick-creation",children:[e.jsxs("div",{className:"pm-creation-header",children:[e.jsx("h2",{className:"pm-creation-title",children:"Quick Proposal Creation"}),u&&e.jsx("button",{className:"pm-close-btn",onClick:u,"aria-label":"Close",children:"×"})]}),r>=1&&e.jsx("div",{className:`pm-creation-step ${r===1?"active":"completed"}`,children:e.jsxs("div",{className:"pm-step-header",children:[e.jsx("div",{className:"pm-step-badge",children:r>1?"✓":"1"}),e.jsxs("div",{className:"pm-step-content",children:[e.jsx("label",{className:"pm-step-label",children:"Select Listing (search by name, address, or ID)"}),r===1&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",className:"pm-searchbox",placeholder:"Search listing name, address, or ID...",value:i.listingSearch,onChange:a=>{x(l=>({...l,listingSearch:a.target.value})),P(a.target.value)}}),o&&e.jsx("p",{className:"pm-searching-text",children:"Searching..."}),S.length>0&&e.jsx("div",{className:"pm-search-results",children:S.map(a=>e.jsx(ue,{listing:a,onSelect:Q},a._id))})]}),i.selectedListing&&e.jsxs("div",{className:"pm-selected-item",children:[i.selectedListing.coverPhoto&&e.jsx("img",{src:i.selectedListing.coverPhoto,alt:i.selectedListing.name,className:"pm-selected-photo"}),e.jsxs("div",{className:"pm-selected-details",children:[e.jsx("p",{className:"pm-selected-name",children:i.selectedListing.name}),e.jsx("p",{className:"pm-selected-secondary",children:i.selectedListing.address})]})]})]})]})}),r>=2&&e.jsx("div",{className:`pm-creation-step ${r===2?"active":r>2?"completed":""}`,children:e.jsxs("div",{className:"pm-step-header",children:[e.jsx("div",{className:"pm-step-badge",children:r>2?"✓":"2"}),e.jsxs("div",{className:"pm-step-content",children:[e.jsx("label",{className:"pm-step-label",children:"Select Guest"}),r===2&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",className:"pm-searchbox",placeholder:"Search guest name, email, or phone...",value:i.guestSearch,onChange:a=>{x(l=>({...l,guestSearch:a.target.value})),z(a.target.value)}}),o&&e.jsx("p",{className:"pm-searching-text",children:"Searching..."}),I.length>0&&e.jsx("div",{className:"pm-search-results",children:I.map(a=>e.jsx(he,{guest:a,onSelect:U},a._id))})]}),i.selectedGuest&&e.jsxs("div",{className:"pm-selected-item",children:[i.selectedGuest.profilePhoto&&e.jsx("img",{src:i.selectedGuest.profilePhoto,alt:i.selectedGuest.fullName,className:"pm-selected-photo pm-selected-avatar"}),e.jsxs("div",{className:"pm-selected-details",children:[e.jsx("p",{className:"pm-selected-name",children:i.selectedGuest.fullName||`${i.selectedGuest.firstName} ${i.selectedGuest.lastName}`}),e.jsx("p",{className:"pm-selected-secondary",children:i.selectedGuest.email})]})]})]})]})}),r===3&&i.selectedGuest&&e.jsx("div",{className:"pm-creation-step active pm-proposal-details",children:e.jsxs("div",{className:"pm-proposal-form",children:[e.jsxs("div",{className:"pm-form-group",children:[e.jsxs("label",{className:"pm-form-label",children:["Tell us about ",i.selectedGuest.firstName||"the guest",":"]}),e.jsx("textarea",{className:"pm-form-textarea",placeholder:"About Me / Bio",value:i.guestAbout,onChange:a=>x(l=>({...l,guestAbout:a.target.value})),rows:3})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsxs("label",{className:"pm-form-label",children:["Why does ",i.selectedGuest.firstName||"the guest"," want this space?"]}),e.jsx("textarea",{className:"pm-form-textarea",placeholder:"Need for Space",value:i.guestNeedForSpace,onChange:a=>x(l=>({...l,guestNeedForSpace:a.target.value})),rows:3})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsx("label",{className:"pm-form-label",children:"Special requirements"}),e.jsx("textarea",{className:"pm-form-textarea",placeholder:"Special needs",value:i.guestSpecialNeeds,onChange:a=>x(l=>({...l,guestSpecialNeeds:a.target.value})),rows:3})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsx("label",{className:"pm-form-label",children:"Proposal status"}),e.jsx("select",{className:"pm-select",value:i.proposalStatus,onChange:a=>x(l=>({...l,proposalStatus:a.target.value})),children:q.map((a,l)=>e.jsx("option",{value:a,children:a||"(empty)"},l))})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsx("label",{className:"pm-form-label",children:"Move-in From"}),e.jsx("input",{type:"date",className:"pm-date-picker",value:i.moveInDate,onChange:a=>x(l=>({...l,moveInDate:a.target.value}))})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsx("label",{className:"pm-form-label",children:"Reservation Span (# of Weeks)"}),e.jsx("input",{type:"number",className:"pm-form-input",min:"1",max:"52",value:i.reservationSpanWeeks,onChange:a=>x(l=>({...l,reservationSpanWeeks:parseInt(a.target.value)||0}))})]}),e.jsxs("div",{className:"pm-form-group",children:[e.jsx("label",{className:"pm-form-label",children:"Weekly Schedule"}),e.jsx("div",{className:"pm-days-selector",children:ae.map((a,l)=>e.jsx("button",{type:"button",className:`pm-day-btn ${i.weeklySchedule[l]?"active":""}`,onClick:()=>V(l),children:a},l))}),e.jsx("button",{type:"button",className:"pm-btn pm-btn-full-time",onClick:J,children:"Select Full Time"})]}),e.jsx("div",{className:"pm-form-group",children:e.jsxs("label",{className:"pm-checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:i.strictMoveIn,onChange:a=>x(l=>({...l,strictMoveIn:a.target.checked}))}),"Strict (no negotiation on exact move in)"]})}),i.reservationSpanWeeks>0&&e.jsxs("div",{className:"pm-pricing-summary",children:[e.jsx("h3",{className:"pm-pricing-title",children:"Pricing Estimate"}),e.jsxs("div",{className:"pm-pricing-details",children:[e.jsxs("div",{className:"pm-pricing-row",children:[e.jsx("span",{children:"Price per night:"}),e.jsxs("span",{className:"pm-price-value",children:["$",(p=R.nightlyPrice)==null?void 0:p.toFixed(2)]})]}),e.jsxs("div",{className:"pm-pricing-row",children:[e.jsx("span",{children:"Number of nights:"}),e.jsx("span",{className:"pm-price-value",children:R.totalNights})]}),e.jsxs("div",{className:"pm-pricing-row",children:[e.jsx("span",{children:"Number of weeks:"}),e.jsx("span",{className:"pm-price-value",children:R.numberOfWeeks})]}),e.jsxs("div",{className:"pm-pricing-row",children:[e.jsx("span",{children:"Total Reservation Price:"}),e.jsxs("span",{className:"pm-price-value",children:["$",(f=R.totalReservationPrice)==null?void 0:f.toFixed(2)]})]}),e.jsxs("div",{className:"pm-pricing-row",children:[e.jsx("span",{children:"Price per 4 weeks:"}),e.jsxs("span",{className:"pm-price-value",children:["$",(g=R.pricePerFourWeeks)==null?void 0:g.toFixed(2)]})]})]})]}),e.jsx("div",{className:"pm-form-actions",children:e.jsx("button",{type:"button",className:"pm-btn pm-btn-create",onClick:K,disabled:d||!i.moveInDate||i.reservationSpanWeeks<1,children:d?"Creating...":"Create Proposal"})})]})}),r===4&&e.jsx("div",{className:"pm-creation-step active pm-confirmation",children:e.jsxs("div",{className:"pm-confirmation-content",children:[e.jsx("div",{className:"pm-success-icon",children:"✓"}),e.jsx("h3",{className:"pm-confirmation-title",children:"Proposal Created Successfully!"}),e.jsxs("div",{className:"pm-confirmation-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Proposal ID:"})," ",i.recentlyCreatedProposalId]}),i.recentlyCreatedThreadId&&e.jsxs("p",{children:[e.jsx("strong",{children:"Thread ID:"})," ",i.recentlyCreatedThreadId]})]}),e.jsx("button",{type:"button",className:"pm-btn pm-btn-create-another",onClick:c,children:"Go To Create Another Proposal"})]})})]})}function se(){return e.jsxs("div",{className:"pm-loading-state",children:[e.jsx("div",{className:"pm-spinner"}),e.jsx("p",{children:"Loading proposals..."})]})}function fe({error:s,onRetry:u}){return e.jsxs("div",{className:"pm-error-state",children:[e.jsx("div",{className:"pm-error-icon",children:"!"}),e.jsx("h2",{className:"pm-error-title",children:"Something went wrong"}),e.jsx("p",{className:"pm-error-text",children:s}),e.jsx("button",{className:"pm-btn pm-btn-primary",onClick:u,children:"Try Again"})]})}function xe({onClearFilters:s}){return e.jsxs("div",{className:"pm-empty-state",children:[e.jsx("p",{children:"No proposals found matching your filters."}),e.jsx("button",{className:"pm-btn pm-btn-secondary",onClick:s,children:"Clear Filters"})]})}function je(){const{authState:s,proposals:u,filters:r,totalCount:n,isLoading:o,error:t,isCreationFormOpen:d,handleFilterChange:v,handleClearFilters:S,handleStatusChange:b,handleAction:I,handleRetry:F,handleToggleCreationForm:i,handleCreateProposal:x}=me();return s.shouldRedirect?e.jsxs(e.Fragment,{children:[e.jsx(Z,{}),e.jsx("main",{className:"pm-main-content",children:e.jsx("div",{className:"pm-page",children:e.jsx(se,{})})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{}),e.jsx("main",{className:"pm-main-content",children:e.jsxs("div",{className:"pm-page",children:[e.jsx("div",{className:"pm-page-header",children:e.jsxs("div",{className:"pm-header-content",children:[e.jsxs("h1",{className:"pm-page-title",children:["Proposals: ",n," results"]}),e.jsxs("div",{className:"pm-header-actions",children:[e.jsx("button",{className:"pm-btn pm-btn-create",onClick:i,children:d?"Hide":"Create Suggested Proposal"}),e.jsx("button",{className:"pm-btn pm-btn-secondary",onClick:()=>window.location.href="/_internal/guest-relationships",children:"Go to relationships"}),e.jsx("button",{className:"pm-btn pm-btn-secondary",onClick:()=>window.location.href="/_internal/quick-price",children:"Change Prices"})]})]})}),e.jsxs("div",{className:"pm-container",children:[d&&e.jsx(Ne,{onCreateProposal:x,onClose:i}),e.jsx(de,{filters:r,onFilterChange:v,onClearAll:S}),e.jsxs("div",{id:"proposals-list",className:"pm-proposals-section",children:[o&&e.jsx(se,{}),!o&&t&&e.jsx(fe,{error:t,onRetry:F}),!o&&!t&&u.length===0&&e.jsx(xe,{onClearFilters:S}),!o&&!t&&u.length>0&&e.jsx("div",{className:"pm-proposals-list",children:u.map(P=>e.jsx(pe,{proposal:P,onStatusChange:b,onAction:I},P._id))})]})]})]})})]})}const ge=te(document.getElementById("root"));ge.render(e.jsx(je,{}));
