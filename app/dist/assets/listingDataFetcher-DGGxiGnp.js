import{s as c}from"./supabase-BoCLEw6R.js";import{g as D,a as I,b as U,j as y,k,l as C,m as A,n as _,o as R}from"./dataLookups-zG18yzis.js";function g(i){if(!i)return[];if(Array.isArray(i))return i;if(typeof i=="string")try{const e=JSON.parse(i);return Array.isArray(e)?e:[]}catch(e){return console.error("Failed to parse JSONB field:",i,e),[]}return console.warn("Unexpected JSONB field type:",typeof i,i),[]}async function T(i){try{console.log("üîç fetchListingComplete: Fetching listing with _id="+i);const{data:e,error:l}=await c.from("listing").select(`
        _id,
        Name,
        Description,
        "Description - Neighborhood",
        "Features - Qty Bedrooms",
        "Features - Qty Bathrooms",
        "Features - Qty Beds",
        "Features - Qty Guests",
        "Features - SQFT Area",
        "Kitchen Type",
        "Features - Type of Space",
        "Features - Amenities In-Unit",
        "Features - Amenities In-Building",
        "Features - Safety",
        "Features - House Rules",
        "Features - Parking type",
        "Features - Secure Storage Option",
        "Features - Trial Periods Allowed",
        "Features - Photos",
        "Location - Address",
        "Location - slightly different address",
        "Location - City",
        "Location - State",
        "Location - Zip Code",
        "Location - Hood",
        "Location - Borough",
        "neighborhood (manual input by user)",
        "Time to Station (commute)",
        "Map HTML Web",
        "üí∞Nightly Host Rate for 1 night",
        "üí∞Nightly Host Rate for 2 nights",
        "üí∞Nightly Host Rate for 3 nights",
        "üí∞Nightly Host Rate for 4 nights",
        "üí∞Nightly Host Rate for 5 nights",
        "üí∞Nightly Host Rate for 7 nights",
        "üí∞Weekly Host Rate",
        "üí∞Monthly Host Rate",
        "üí∞Damage Deposit",
        "üí∞Cleaning Cost / Maintenance Fee",
        "üí∞Price Override",
        "Days Available (List of Days)",
        "Nights Available (List of Nights) ",
        "Days Not Available",
        "Nights Not Available",
        "Dates - Blocked",
        " First Available",
        "Last Available",
        "Minimum Nights",
        "Maximum Nights",
        "Minimum Weeks",
        "Maximum Weeks",
        "Minimum Months",
        "Maximum Months",
        "Weeks offered",
        "rental type",
        "üí∞Unit Markup",
        "NEW Date Check-in Time",
        "NEW Date Check-out Time",
        "Host User",
        "host name",
        "host restrictions",
        "Cancellation Policy",
        "video tour",
        "Reviews",
        Active,
        Complete,
        Deleted,
        "Preferred Gender",
        "allow alternating roommates?"
      `).eq("_id",i).single();if(l)throw l;if(!e)throw new Error("Listing not found");if(e.Deleted===!0)throw new Error("Listing has been deleted");console.log("‚úÖ Found listing:",e._id);let n=[];const o=g(e["Features - Photos"]);console.log("üì∑ Raw Features - Photos:",e["Features - Photos"]),console.log("üì∑ Parsed embeddedPhotos:",o),console.log("üì∑ embeddedPhotos.length:",o.length),console.log("üì∑ embeddedPhotos[0] type:",typeof o[0]);const h=o.length>0&&typeof o[0]=="object"&&o[0]!==null;if(console.log("üì∑ hasEmbeddedObjects:",h),h)n=o.map((t,r)=>({_id:t.id||`embedded_${r}`,Photo:t.Photo||t.url||"","Photo (thumbnail)":t["Photo (thumbnail)"]||t.Photo||t.url||"",toggleMainPhoto:t.toggleMainPhoto??t.isCover??r===0,SortOrder:t.SortOrder??t.sortOrder??t.displayOrder??r,Caption:t.caption||t.Caption||""})),console.log("üì∑ Embedded photos from Features - Photos:",n.length);else if(o.length>0&&typeof o[0]=="string")n=o.map((t,r)=>({_id:`string_${r}`,Photo:t,"Photo (thumbnail)":t,toggleMainPhoto:r===0,SortOrder:r,Caption:""})),console.log("üì∑ Embedded string URLs from Features - Photos:",n.length);else{const{data:t,error:r}=await c.from("listing_photo").select('_id, Photo, "Photo (thumbnail)", SortOrder, toggleMainPhoto, Caption').eq("Listing",i).order("SortOrder",{ascending:!0,nullsLast:!0});r&&console.error("Photos fetch error:",r),n=t||[],console.log("üì∑ Photos from listing_photo table:",n.length)}n=n.sort((t,r)=>t.toggleMainPhoto?-1:r.toggleMainPhoto?1:t.SortOrder!==null&&r.SortOrder===null?-1:t.SortOrder===null&&r.SortOrder!==null?1:t.SortOrder!==null&&r.SortOrder!==null?t.SortOrder-r.SortOrder:(t._id||"").localeCompare(r._id||""));const P=e["Location - Hood"]?D(e["Location - Hood"]):null,F=e["Location - Borough"]?I(e["Location - Borough"]):null,w=e["Features - Type of Space"]?U(e["Features - Type of Space"]):null,L=e["Features - Amenities In-Unit"]?y(g(e["Features - Amenities In-Unit"])):[],S=e["Features - Amenities In-Building"]?y(g(e["Features - Amenities In-Building"])):[],N=e["Features - Safety"]?k(g(e["Features - Safety"])):[],v=e["Features - House Rules"]?C(g(e["Features - House Rules"])):[],M=e["Features - Parking type"]?A(e["Features - Parking type"]):null,O=e["Cancellation Policy"]?_(e["Cancellation Policy"]):null,b=e["Features - Secure Storage Option"]?R(e["Features - Secure Storage Option"]):null;let m=null;if(e["Host User"]){const{data:t,error:r}=await c.from("user").select('_id, "Name - First", "Name - Last", "Profile Photo", "email as text"').eq("_id",e["Host User"]).maybeSingle();r&&console.error("User fetch error (by _id):",r),t&&(m={_id:t._id,userId:t._id,"Name - First":t["Name - First"],"Name - Last":t["Name - Last"],"Profile Photo":t["Profile Photo"],Email:t["email as text"]},console.log("üìç Host found via user._id lookup"))}let f=[];const p=g(e.Reviews);if(p.length>0){const{data:t,error:r}=await c.from("mainreview").select('_id, Comment, "Overall Score", Reviewer, "Created Date", "Is Published?"').in("_id",p).eq("Is Published?",!0).order('"Created Date"',{ascending:!1});r?console.error("Reviews fetch error:",r):f=t||[]}let u=null,a=e["Location - slightly different address"],s=e["Location - Address"];if(typeof a=="string")try{a=JSON.parse(a)}catch(t){console.error("Failed to parse Location - slightly different address:",t),a=null}if(typeof s=="string")try{s=JSON.parse(s)}catch(t){console.error("Failed to parse Location - Address:",t),s=null}if(a!=null&&a.lat&&(a!=null&&a.lng))u={lat:a.lat,lng:a.lng,address:a.address||null},console.log('üìç Using "Location - slightly different address" for coordinates:',u);else if(s!=null&&s.lat&&(s!=null&&s.lng)){const t=(Math.random()-.5)*.001,r=(Math.random()-.5)*.001;u={lat:s.lat+t,lng:s.lng+r,address:s.address||null,isGenerated:!0},console.log('üìç Generated slightly different coordinates from "Location - Address":',{original:{lat:s.lat,lng:s.lng},offset:{lat:t,lng:r},generated:u})}else console.warn("‚ö†Ô∏è No valid coordinates found in listing data");return{...e,photos:n,resolvedNeighborhood:P,resolvedBorough:F,resolvedTypeOfSpace:w,amenitiesInUnit:L,amenitiesInBuilding:S,safetyFeatures:N,houseRules:v,parkingOption:M,cancellationPolicy:O,storageOption:b,host:m,reviews:f,coordinates:u}}catch(e){throw console.error("Error fetching listing data:",e),e}}function B(){console.log("üîç [getListingIdFromUrl] Current URL:",window.location.href),console.log("üîç [getListingIdFromUrl] Pathname:",window.location.pathname),console.log("üîç [getListingIdFromUrl] Search:",window.location.search);const e=new URLSearchParams(window.location.search).get("id");if(e)return console.log("‚úÖ [getListingIdFromUrl] Found ID in query string:",e),e;const l=window.location.pathname.split("/").filter(o=>o);console.log("üîç [getListingIdFromUrl] Path segments:",l);const n=l.findIndex(o=>o==="view-split-lease"||o==="view-split-lease.html"||o==="view-split-lease-1"||o==="preview-split-lease"||o==="preview-split-lease.html");if(console.log("üîç [getListingIdFromUrl] View segment index:",n),n!==-1&&l[n+1]){const o=l[n+1];if(console.log("üîç [getListingIdFromUrl] Next segment after view-split-lease:",o),!o.includes("."))return console.log("‚úÖ [getListingIdFromUrl] Found ID in path:",o),o}if(l.length>0){const o=l[0];if(/^\d+x\d+$/.test(o))return console.log("‚úÖ [getListingIdFromUrl] Found ID as first segment:",o),o}return console.error("‚ùå [getListingIdFromUrl] No listing ID found in URL"),null}let d=null;async function x(){if(d)return d;try{const{data:i,error:e}=await c.schema("reference_table").from("zat_priceconfiguration").select(`
        "Overall Site Markup",
        "Weekly Markup",
        "full time (7 nights) Discount",
        "Unused Nights Discount Multiplier",
        "Avg days per month",
        "Min Price per night",
        "Max Price per night"
      `).limit(1).single();if(e)throw e;if(!i)throw new Error("ZAT price configuration not found");return d={overallSiteMarkup:parseFloat(i["Overall Site Markup"])||0,weeklyMarkup:parseFloat(i["Weekly Markup"])||0,fullTimeDiscount:parseFloat(i["full time (7 nights) Discount"])||0,unusedNightsDiscountMultiplier:parseFloat(i["Unused Nights Discount Multiplier"])||0,avgDaysPerMonth:parseInt(i["Avg days per month"])||31,minPricePerNight:parseFloat(i["Min Price per night"])||0,maxPricePerNight:parseFloat(i["Max Price per night"])||0},d}catch(i){return console.error("Error fetching ZAT price configuration:",i),{overallSiteMarkup:.17,weeklyMarkup:0,fullTimeDiscount:.13,unusedNightsDiscountMultiplier:.03,avgDaysPerMonth:31,minPricePerNight:100,maxPricePerNight:1e3}}}export{T as a,x as f,B as g};
