import{s as h}from"./supabase-BoCLEw6R.js";const g="listing-photos";function f(o){const[a,r]=o.split(","),t=a.match(/data:([^;]+)/),e=t?t[1]:"image/jpeg",l=atob(r),p=[];for(let s=0;s<l.length;s+=512){const c=l.slice(s,s+512),i=new Array(c.length);for(let n=0;n<c.length;n++)i[n]=c.charCodeAt(n);p.push(new Uint8Array(i))}return new Blob(p,{type:e})}function d(o){return{"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/heic":"heic","image/heif":"heif"}[o]||"jpg"}function m(o){const a=o.match(/data:([^;]+)/);return a?a[1]:"image/jpeg"}async function b(o,a,r){console.log(`[PhotoUpload] Uploading photo ${r+1} for listing ${a}`);let t,e;if(o.file instanceof File)t=o.file,e=o.file.name.split(".").pop().toLowerCase()||"jpg";else if(o.url&&o.url.startsWith("data:")){const u=m(o.url);t=f(o.url),e=d(u)}else if(o.url&&o.url.startsWith("blob:")){console.log(`[PhotoUpload] Converting blob URL to blob for photo ${r+1}`);try{t=await(await fetch(o.url)).blob(),e=d(t.type)||"jpg"}catch(u){throw console.error(`[PhotoUpload] Failed to fetch blob URL for photo ${r+1}:`,u),new Error(`Failed to process photo ${r+1}: Could not read blob URL`)}}else{if(o.url&&(o.url.startsWith("http://")||o.url.startsWith("https://")))return console.log(`[PhotoUpload] Photo ${r+1} already has a URL, skipping upload`),{url:o.url,path:o.storagePath||null,isExisting:!0};throw new Error(`Invalid photo format for photo ${r+1}`)}const l=Date.now(),p=`${r}_${l}.${e}`,s=`listings/${a}/${p}`,{data:c,error:i}=await h.storage.from(g).upload(s,t,{cacheControl:"3600",upsert:!1,contentType:t.type||`image/${e}`});if(i)throw console.error(`[PhotoUpload] Error uploading photo ${r+1}:`,i),new Error(`Failed to upload photo ${r+1}: ${i.message}`);const{data:n}=h.storage.from(g).getPublicUrl(s);return console.log(`[PhotoUpload] Successfully uploaded photo ${r+1}: ${n.publicUrl}`),{url:n.publicUrl,path:s,isExisting:!1}}async function y(o,a){if(!o||o.length===0)return console.log("[PhotoUpload] No photos to upload"),[];console.log(`[PhotoUpload] Starting upload of ${o.length} photos for listing ${a}`);const r=[];for(let t=0;t<o.length;t++){const e=o[t];try{const l=await b(e,a,t);r.push({id:e.id||`photo_${t}_${Date.now()}`,url:l.url,Photo:l.url,"Photo (thumbnail)":l.url,storagePath:l.path,caption:e.caption||"",displayOrder:e.displayOrder??t,SortOrder:e.displayOrder??t,toggleMainPhoto:t===0})}catch(l){console.error(`[PhotoUpload] Failed to upload photo ${t+1}:`,l),r.push({id:e.id||`photo_${t}_${Date.now()}`,url:e.url,Photo:e.url,"Photo (thumbnail)":e.url,caption:e.caption||"",displayOrder:e.displayOrder??t,SortOrder:e.displayOrder??t,toggleMainPhoto:t===0,uploadError:l.message})}}return console.log(`[PhotoUpload] Completed uploading ${r.length} photos`),r}async function P(o){if(!o)return!0;const{error:a}=await h.storage.from(g).remove([o]);return a?(console.error("[PhotoUpload] Error deleting photo:",a),!1):!0}export{y as a,P as d,b as u};
