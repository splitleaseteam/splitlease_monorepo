import{r as S,j as U}from"./client-BJVKzfAi.js";import{S as v}from"./SearchScheduleSelector-KBnRs4ik.js";import{h as T,v as _,e as E,g as O}from"./auth-QZ4BJadW.js";import{s as I}from"./supabase-BoCLEw6R.js";import{d as N}from"./dayUtils-C3_GW2W5.js";const b={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6},k=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function x(e){if(!e)return null;if(Array.isArray(e))return e.length>0?e:null;if(typeof e=="string")try{const r=JSON.parse(e);if(Array.isArray(r)&&r.length>0)return r}catch(r){console.warn("ðŸ“… Failed to parse day names string:",e,r)}return null}function F(e){const r=x(e);if(!r)return null;const s=r.map(a=>b[a]).filter(a=>a!==void 0);return s.length>0?s:null}function C(e){return Array.isArray(e)?e.filter(r=>r>=0&&r<=6).map(r=>k[r]):[]}function j({onSelectionChange:e,updateUrl:r=!0,debounceMs:s=1e3,...a}){console.log("ðŸ“… AuthAwareSearchScheduleSelector: Component rendering");const[y,c]=S.useState(null),[h,o]=S.useState(!0),[l,A]=S.useState(null),m=S.useRef(null);S.useEffect(()=>((async()=>{const u=T();console.log("ðŸ“… AuthAwareSearchScheduleSelector: getSessionId() returned:",u),A(u);const g=new URLSearchParams(window.location.search).get("days-selected");if(g){console.log("ðŸ“… AuthAwareSearchScheduleSelector: URL has days-selected parameter, prioritizing URL over DB:",g),o(!1);return}if(!u){console.log("ðŸ“… AuthAwareSearchScheduleSelector: No session, using default behavior"),o(!1);return}try{console.log("ðŸ“… AuthAwareSearchScheduleSelector: Fetching user days for:",u);const{data:t,error:p}=await I.from("user").select('"Recent Days Selected"').eq("_id",u).maybeSingle();if(console.log("ðŸ“… AuthAwareSearchScheduleSelector: Supabase response:",{data:t,error:p}),p){console.error("ðŸ“… AuthAwareSearchScheduleSelector: Supabase error:",p),o(!1);return}const n=t==null?void 0:t["Recent Days Selected"];if(console.log("ðŸ“… AuthAwareSearchScheduleSelector: Recent Days Selected raw value:",n,"type:",typeof n),n){const d=F(n);d&&d.length>0?(console.log("ðŸ“… AuthAwareSearchScheduleSelector: Loaded user days:",{fromDB:n,asIndices:d}),c(d)):console.log("ðŸ“… AuthAwareSearchScheduleSelector: No valid days in DB, using default")}else console.log("ðŸ“… AuthAwareSearchScheduleSelector: No saved days in DB, using default")}catch(t){console.error("ðŸ“… AuthAwareSearchScheduleSelector: Failed to load user days:",t)}finally{o(!1)}})(),()=>{m.current&&clearTimeout(m.current)}),[]);const D=f=>{l&&(m.current&&clearTimeout(m.current),m.current=setTimeout(async()=>{const u=C(f);try{console.log("ðŸ“… AuthAwareSearchScheduleSelector: Saving user days:",u);const{error:i}=await I.from("user").update({"Recent Days Selected":u}).eq("_id",l);if(i){console.error("ðŸ“… AuthAwareSearchScheduleSelector: Failed to save:",i);return}console.log("ðŸ“… AuthAwareSearchScheduleSelector: Saved successfully")}catch(i){console.error("ðŸ“… AuthAwareSearchScheduleSelector: Save error:",i)}},s))},w=f=>{const u=f.map(i=>i.index);l&&D(u),e&&e(f)};return h?null:U.jsx(v,{initialSelection:y,onSelectionChange:w,updateUrl:r,...a})}function q({selectedDayIndices:e,minDate:r}){if(!Array.isArray(e)||e.length===0)throw new Error("calculateNextAvailableCheckIn: selectedDayIndices must be a non-empty array");for(const l of e)if(typeof l!="number"||isNaN(l)||l<0||l>6)throw new Error(`calculateNextAvailableCheckIn: Invalid day index ${l}, must be 0-6`);const s=new Date(r);if(isNaN(s.getTime()))throw new Error(`calculateNextAvailableCheckIn: minDate is not a valid date: ${r}`);const y=[...e].sort((l,A)=>l-A)[0],c=s.getDay(),h=N(c,y);if(h===0)return s.toISOString().split("T")[0];const o=new Date(s);return o.setDate(s.getDate()+h),o.toISOString().split("T")[0]}function G({previousMoveInDate:e,minDate:r}){if(!e)return null;const s=new Date(e),a=new Date(r);if(s.setHours(0,0,0,0),a.setHours(0,0,0,0),s>=a)return e.split("T")[0];const y=s.getDay(),c=a.getDay(),h=N(c,y);if(h===0)return a.toISOString().split("T")[0];const o=new Date(a);return o.setDate(a.getDate()+h),o.toISOString().split("T")[0]}function H({requireGuest:e=!1,requireHost:r=!1}={}){const[s,a]=S.useState(null),[y,c]=S.useState(null),[h,o]=S.useState(!0),[l,A]=S.useState(null);return S.useEffect(()=>{(async()=>{var D,w,f,u,i,g;try{const t=await _({clearOnFailure:!1}),p=T();if(t){const d=p||t.userId||t._id;a({id:d,name:t.fullName||t.firstName||"",email:t.email||"",userType:t.userType||"GUEST",avatarUrl:t.profilePhoto||null,proposalCount:t.proposalCount??0}),c(d),o(!1);return}const{data:{session:n}}=await I.auth.getSession();if(n!=null&&n.user){const d=((D=n.user.user_metadata)==null?void 0:D.user_id)||E()||n.user.id;a({id:d,name:((w=n.user.user_metadata)==null?void 0:w.full_name)||((f=n.user.user_metadata)==null?void 0:f.first_name)||O()||((u=n.user.email)==null?void 0:u.split("@")[0])||"User",email:n.user.email||"",userType:((i=n.user.user_metadata)==null?void 0:i.user_type)||"GUEST",avatarUrl:((g=n.user.user_metadata)==null?void 0:g.avatar_url)||null,proposalCount:0}),c(d),o(!1);return}a(null),c(null),o(!1)}catch(t){console.error("[useAuthenticatedUser] Authentication error:",t),A(t),a(null),c(null),o(!1)}})()},[]),{user:s,userId:y,loading:h,error:l,isAuthenticated:!!s}}export{j as A,q as c,G as s,H as u};
