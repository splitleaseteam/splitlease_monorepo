import{s as h}from"./supabase-BoCLEw6R.js";import{i as ue,l as n}from"./auth-QZ4BJadW.js";import{a as de}from"./photoUpload-vf9LU0fY.js";async function ce(e){if(!e)return null;const t=String(e).trim().substring(0,5);if(!/^\d{5}$/.test(t))return null;try{const{data:s,error:i}=await h.schema("reference_table").from("zat_geo_borough_toplevel").select('_id, "Display Borough"').contains("Zip Codes",[t]).limit(1).maybeSingle();return i||!s?(n.debug("[ListingService] No borough found for zip:",t),null):(n.debug("[ListingService] âœ… Found borough:",s["Display Borough"],"for zip:",t),s._id)}catch(s){return n.error("[ListingService] Error looking up borough:",s),null}}async function he(e){if(!e)return null;const t=String(e).trim().substring(0,5);if(!/^\d{5}$/.test(t))return null;try{const{data:s,error:i}=await h.schema("reference_table").from("zat_geo_hood_mediumlevel").select('_id, "Display"').contains("Zips",[t]).limit(1).maybeSingle();return i||!s?(n.debug("[ListingService] No hood found for zip:",t),null):(n.debug("[ListingService] âœ… Found hood:",s.Display,"for zip:",t),s._id)}catch(s){return n.error("[ListingService] Error looking up hood:",s),null}}async function ge(e){const[t,s]=await Promise.all([ce(e),he(e)]);return{boroughId:t,hoodId:s}}async function ke(e){var w,L,N,k,F;const t=ue();let s=t;if(t&&t.includes("-")){const{data:{session:g}}=await h.auth.getSession();if((w=g==null?void 0:g.user)!=null&&w.email){const{data:a,error:f}=await h.from("user").select("_id").or(`email.eq.${g.user.email},email as text.eq.${g.user.email}`).maybeSingle();a!=null&&a._id?s=a._id:n.warn("[ListingService] âš ï¸ Could not resolve user data, using stored ID:",t)}}const{data:r,error:u}=await h.rpc("generate_bubble_id");if(u||!r)throw n.error("[ListingService] âŒ Failed to generate listing ID:",u),new Error("Failed to generate listing ID");let d=[];if(((N=(L=e.photos)==null?void 0:L.photos)==null?void 0:N.length)>0)if(e.photos.photos.every(a=>a.url&&(a.url.startsWith("http://")||a.url.startsWith("https://"))))d=e.photos.photos.map((a,f)=>({id:a.id,url:a.url,Photo:a.url,"Photo (thumbnail)":a.url,storagePath:a.storagePath||null,caption:a.caption||"",displayOrder:a.displayOrder??f,SortOrder:a.displayOrder??f,toggleMainPhoto:f===0}));else try{d=await de(e.photos.photos,r),n.debug("[ListingService] âœ… Photos uploaded:",d.length)}catch(a){throw n.error("[ListingService] âŒ Photo upload failed:",a),new Error("Failed to upload photos: "+a.message)}const o={...e,photos:{...e.photos,photos:d}},c=(F=(k=e.spaceSnapshot)==null?void 0:k.address)==null?void 0:F.zip;let y=null,S=null;if(c){const g=await ge(c);y=g.boroughId,S=g.hoodId}const l=Se(o,s,r,s,y,S);n.debug("[ListingService] Cancellation Policy value to insert:",l["Cancellation Policy"]),n.debug("[ListingService] Rules from form:",o.rules);const{data:v,error:b}=await h.from("listing").insert(l).select().single();if(b)throw n.error("[ListingService] âŒ Error creating listing in Supabase:",b),n.error("[ListingService] âŒ Full listing data that failed:",JSON.stringify(l,null,2)),new Error(b.message||"Failed to create listing");if(n.debug("[ListingService] âœ… Listing created in listing table with _id:",v._id),!s)throw n.error("[ListingService] âŒ No userId provided - cannot link listing to user"),new Error("User ID is required to create a listing");return await pe(s,v._id),ye(s,v._id).catch(g=>{n.warn("[ListingService] âš ï¸ Mockup proposal creation failed (non-blocking):",g.message)}),v}async function pe(e,t){var o;let s=null,i=null;if(e&&e.includes("-")){const{data:{session:c}}=await h.auth.getSession();if(!((o=c==null?void 0:c.user)!=null&&o.email))throw n.error("[ListingService] âŒ No email found in auth session"),new Error("Could not retrieve user email from session");const y=c.user.email,S=await h.from("user").select("_id, Listings").or(`email.eq.${y},email as text.eq.${y}`).maybeSingle();s=S.data,i=S.error}else{const c=await h.from("user").select("_id, Listings").eq("_id",e).maybeSingle();s=c.data,i=c.error}if(i)throw n.error("[ListingService] âŒ Error fetching user:",i),i;if(!s)throw n.error("[ListingService] âŒ No user found for userId:",e),new Error(`User not found: ${e}`);n.debug("[ListingService] âœ… Found user with Bubble _id:",s._id);const u=s.Listings||[];u.includes(t)||u.push(t);const{error:d}=await h.from("user").update({Listings:u}).eq("_id",s._id);if(d)throw n.error("[ListingService] âŒ Error updating user Listings:",d),d}async function ye(e,t){var S;let s=null,i=null;const r=e&&e.includes("-");if(r){const{data:{session:l}}=await h.auth.getSession();if(!((S=l==null?void 0:l.user)!=null&&S.email)){n.warn("[ListingService] âš ï¸ No email found in auth session for mockup proposal check");return}const v=l.user.email,b=await h.from("user").select("_id, email, Listings").eq("email",v).maybeSingle();s=b.data,i=b.error}else{const l=await h.from("user").select("_id, email, Listings").eq("_id",e).maybeSingle();s=l.data,i=l.error}let u=s==null?void 0:s._id,d=s==null?void 0:s.email,o=(s==null?void 0:s.Listings)||[];if(!s&&r){const{data:{session:l}}=await h.auth.getSession();if(l!=null&&l.user)u=l.user.id,d=l.user.email,o=[t];else{n.warn("[ListingService] âš ï¸ No Supabase Auth session found for mockup proposal");return}}else if(i||!s){n.warn("[ListingService] âš ï¸ Could not fetch user for mockup proposal check:",i==null?void 0:i.message);return}else n.debug("[ListingService] âœ… Found user for mockup check with Bubble _id:",s._id);if(o.length!==1){n.debug(`[ListingService] â­ï¸ Skipping mockup proposal - not first listing (count: ${o.length})`);return}if(!d){n.warn("[ListingService] âš ï¸ Missing email for mockup proposal");return}const y=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/proposal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create_mockup",payload:{listingId:t,hostUserId:u,hostEmail:d}})});if(!y.ok){const l=await y.text();throw new Error(`Edge function returned ${y.status}: ${l}`)}await y.json()}function se(e){const t={Standard:"1665431440883x653177548350901500","Additional Host Restrictions":"1665431684611x656977293321267800","Prior to First-Time Arrival":"1599791792265x281203802121463780","After First-Time Arrival":"1599791785559x603327510287017500"};return e&&t[e]||t.Standard}function te(e){const t={"Street Parking":"1642428637379x970678957586007000","No Parking":"1642428658755x946399373738815900","Off-Street Parking":"1642428710705x523449235750343100","Attached Garage":"1642428740411x489476808574605760","Detached Garage":"1642428749714x405527148800546750","Nearby Parking Structure":"1642428759346x972313924643388700"};return e&&t[e]||null}function ne(e){const t={"Private Room":"1569530159044x216130979074711000","Entire Place":"1569530331984x152755544104023800","Shared Room":"1585742011301x719941865479153400","All Spaces":"1588063597111x228486447854442800"};return e&&t[e]||null}function re(e){return e?e.length>2?e:{AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia"}[e.toUpperCase()]||e:null}function Se(e,t,s,i=null,r=null,u=null){var y,S,l,v,b,w,L,N,k,F,g,a,f,A,m,M,O,C,T,I,_,E,U,R,x,H,W,B,q,G,K,$,z,Q,Z,j,V,J,Y,X,D,ee,ie;const d=new Date().toISOString(),o=(y=e.leaseStyles)!=null&&y.availableNights?ae(e.leaseStyles.availableNights):[],c=(S=e.leaseStyles)!=null&&S.availableNights?oe(e.leaseStyles.availableNights):[];return{_id:s,"Created By":t||null,"Host User":i||null,"Created Date":d,"Modified Date":d,Name:((l=e.spaceSnapshot)==null?void 0:l.listingName)||null,"Features - Type of Space":ne((v=e.spaceSnapshot)==null?void 0:v.typeOfSpace),"Features - Qty Bedrooms":((b=e.spaceSnapshot)==null?void 0:b.bedrooms)||null,"Features - Qty Beds":((w=e.spaceSnapshot)==null?void 0:w.beds)||null,"Features - Qty Bathrooms":(L=e.spaceSnapshot)!=null&&L.bathrooms?Number(e.spaceSnapshot.bathrooms):null,"Kitchen Type":((N=e.spaceSnapshot)==null?void 0:N.typeOfKitchen)||null,"Features - Parking type":te((k=e.spaceSnapshot)==null?void 0:k.typeOfParking),"Location - Address":(F=e.spaceSnapshot)!=null&&F.address?{address:e.spaceSnapshot.address.fullAddress,number:e.spaceSnapshot.address.number,street:e.spaceSnapshot.address.street,lat:e.spaceSnapshot.address.latitude,lng:e.spaceSnapshot.address.longitude,validated:e.spaceSnapshot.address.validated||!1}:null,"Location - City":null,"Location - State":re((a=(g=e.spaceSnapshot)==null?void 0:g.address)==null?void 0:a.state),"Location - Zip Code":((A=(f=e.spaceSnapshot)==null?void 0:f.address)==null?void 0:A.zip)||null,"neighborhood (manual input by user)":((M=(m=e.spaceSnapshot)==null?void 0:m.address)==null?void 0:M.neighborhood)||null,"Location - Borough":r||null,"Location - Hood":u||null,"Features - Amenities In-Unit":((O=e.features)==null?void 0:O.amenitiesInsideUnit)||[],"Features - Amenities In-Building":((C=e.features)==null?void 0:C.amenitiesOutsideUnit)||[],Description:((T=e.features)==null?void 0:T.descriptionOfLodging)||null,"Description - Neighborhood":((I=e.features)==null?void 0:I.neighborhoodDescription)||null,"rental type":((_=e.leaseStyles)==null?void 0:_.rentalType)||"Monthly","Days Available (List of Days)":o,"Nights Available (List of Nights) ":c,"Weeks offered":((E=e.leaseStyles)==null?void 0:E.weeklyPattern)||"Every week","ðŸ’°Damage Deposit":((U=e.pricing)==null?void 0:U.damageDeposit)||0,"ðŸ’°Cleaning Cost / Maintenance Fee":((R=e.pricing)==null?void 0:R.maintenanceFee)||0,"ðŸ’°Extra Charges":((x=e.pricing)==null?void 0:x.extraCharges)||null,"ðŸ’°Weekly Host Rate":((H=e.pricing)==null?void 0:H.weeklyCompensation)||null,"ðŸ’°Monthly Host Rate":((W=e.pricing)==null?void 0:W.monthlyCompensation)||null,...le((B=e.pricing)==null?void 0:B.nightlyPricing),"Cancellation Policy":se((q=e.rules)==null?void 0:q.cancellationPolicy),"Preferred Gender":((G=e.rules)==null?void 0:G.preferredGender)||"No Preference","Features - Qty Guests":((K=e.rules)==null?void 0:K.numberOfGuests)||2,"NEW Date Check-in Time":(($=e.rules)==null?void 0:$.checkInTime)||"2:00 PM","NEW Date Check-out Time":((z=e.rules)==null?void 0:z.checkOutTime)||"11:00 AM","Minimum Months":((Q=e.rules)==null?void 0:Q.idealMinDuration)||null,"Maximum Months":((Z=e.rules)==null?void 0:Z.idealMaxDuration)||null,"Features - House Rules":((j=e.rules)==null?void 0:j.houseRules)||[],"Dates - Blocked":((V=e.rules)==null?void 0:V.blockedDates)||[],"Features - Photos":((Y=(J=e.photos)==null?void 0:J.photos)==null?void 0:Y.map((p,P)=>({id:p.id,url:p.url||p.Photo,Photo:p.url||p.Photo,"Photo (thumbnail)":p["Photo (thumbnail)"]||p.url||p.Photo,caption:p.caption||"",displayOrder:p.displayOrder??P,SortOrder:p.SortOrder??p.displayOrder??P,toggleMainPhoto:p.toggleMainPhoto??P===0,storagePath:p.storagePath||null})))||[],"Features - Safety":((X=e.review)==null?void 0:X.safetyFeatures)||[],"Features - SQFT Area":((D=e.review)==null?void 0:D.squareFootage)||null," First Available":((ee=e.review)==null?void 0:ee.firstDayAvailable)||null,"Source Link":((ie=e.review)==null?void 0:ie.previousReviewsLink)||null,host_type:e.hostType||null,market_strategy:e.marketStrategy||"private",Active:!1,Approved:!1,Complete:e.isSubmitted||!1,"Features - Trial Periods Allowed":!1,"Maximum Weeks":52,"Minimum Nights":1}}function oe(e){const t={sunday:"Sunday",monday:"Monday",tuesday:"Tuesday",wednesday:"Wednesday",thursday:"Thursday",friday:"Friday",saturday:"Saturday"},s=[],i=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];for(const r of i)e[r]&&t[r]&&s.push(t[r]);return s}async function Fe(e,t){if(!e)throw new Error("Listing ID is required for update");const s=be(t);let i;s?i=fe(t):i=ve(t),i["Modified Date"]=new Date().toISOString();const{data:r,error:u}=await h.from("listing").update(i).eq("_id",e).select().single();if(u)throw n.error("[ListingService] âŒ Error updating listing:",u),new Error(u.message||"Failed to update listing");return n.debug("[ListingService] âœ… Listing updated:",r._id),r}function ve(e){var r,u,d;const t=(r=e.leaseStyles)!=null&&r.availableNights?ae(e.leaseStyles.availableNights):void 0,s=(u=e.leaseStyles)!=null&&u.availableNights?oe(e.leaseStyles.availableNights):void 0,i={};return e.spaceSnapshot&&(e.spaceSnapshot.listingName!==void 0&&(i.Name=e.spaceSnapshot.listingName),e.spaceSnapshot.typeOfSpace!==void 0&&(i["Features - Type of Space"]=ne(e.spaceSnapshot.typeOfSpace)),e.spaceSnapshot.bedrooms!==void 0&&(i["Features - Qty Bedrooms"]=e.spaceSnapshot.bedrooms),e.spaceSnapshot.beds!==void 0&&(i["Features - Qty Beds"]=e.spaceSnapshot.beds),e.spaceSnapshot.bathrooms!==void 0&&(i["Features - Qty Bathrooms"]=Number(e.spaceSnapshot.bathrooms)),e.spaceSnapshot.typeOfKitchen!==void 0&&(i["Kitchen Type"]=e.spaceSnapshot.typeOfKitchen),e.spaceSnapshot.typeOfParking!==void 0&&(i["Features - Parking type"]=te(e.spaceSnapshot.typeOfParking)),e.spaceSnapshot.address&&(i["Location - Address"]={address:e.spaceSnapshot.address.fullAddress,number:e.spaceSnapshot.address.number,street:e.spaceSnapshot.address.street,lat:e.spaceSnapshot.address.latitude,lng:e.spaceSnapshot.address.longitude,validated:e.spaceSnapshot.address.validated||!1},i["Location - State"]=re(e.spaceSnapshot.address.state),i["Location - Zip Code"]=e.spaceSnapshot.address.zip,i["neighborhood (manual input by user)"]=e.spaceSnapshot.address.neighborhood)),e.features&&(e.features.amenitiesInsideUnit!==void 0&&(i["Features - Amenities In-Unit"]=e.features.amenitiesInsideUnit),e.features.amenitiesOutsideUnit!==void 0&&(i["Features - Amenities In-Building"]=e.features.amenitiesOutsideUnit),e.features.descriptionOfLodging!==void 0&&(i.Description=e.features.descriptionOfLodging),e.features.neighborhoodDescription!==void 0&&(i["Description - Neighborhood"]=e.features.neighborhoodDescription)),e.leaseStyles&&(e.leaseStyles.rentalType!==void 0&&(i["rental type"]=e.leaseStyles.rentalType),t!==void 0&&(i["Days Available (List of Days)"]=t),s!==void 0&&(i["Nights Available (List of Nights) "]=s),e.leaseStyles.weeklyPattern!==void 0&&(i["Weeks offered"]=e.leaseStyles.weeklyPattern)),e.pricing&&(e.pricing.damageDeposit!==void 0&&(i["ðŸ’°Damage Deposit"]=e.pricing.damageDeposit),e.pricing.maintenanceFee!==void 0&&(i["ðŸ’°Cleaning Cost / Maintenance Fee"]=e.pricing.maintenanceFee),e.pricing.extraCharges!==void 0&&(i["ðŸ’°Extra Charges"]=e.pricing.extraCharges),e.pricing.weeklyCompensation!==void 0&&(i["ðŸ’°Weekly Host Rate"]=e.pricing.weeklyCompensation),e.pricing.monthlyCompensation!==void 0&&(i["ðŸ’°Monthly Host Rate"]=e.pricing.monthlyCompensation),e.pricing.nightlyPricing&&Object.assign(i,le(e.pricing.nightlyPricing))),e.rules&&(e.rules.cancellationPolicy!==void 0&&(i["Cancellation Policy"]=se(e.rules.cancellationPolicy)),e.rules.preferredGender!==void 0&&(i["Preferred Gender"]=e.rules.preferredGender),e.rules.numberOfGuests!==void 0&&(i["Features - Qty Guests"]=e.rules.numberOfGuests),e.rules.checkInTime!==void 0&&(i["NEW Date Check-in Time"]=e.rules.checkInTime),e.rules.checkOutTime!==void 0&&(i["NEW Date Check-out Time"]=e.rules.checkOutTime),e.rules.idealMinDuration!==void 0&&(i["Minimum Months"]=e.rules.idealMinDuration),e.rules.idealMaxDuration!==void 0&&(i["Maximum Months"]=e.rules.idealMaxDuration),e.rules.houseRules!==void 0&&(i["Features - House Rules"]=e.rules.houseRules),e.rules.blockedDates!==void 0&&(i["Dates - Blocked"]=e.rules.blockedDates)),(d=e.photos)!=null&&d.photos&&(i["Features - Photos"]=e.photos.photos.map((o,c)=>({id:o.id,url:o.url||o.Photo,Photo:o.url||o.Photo,"Photo (thumbnail)":o["Photo (thumbnail)"]||o.url||o.Photo,caption:o.caption||"",displayOrder:o.displayOrder??c,SortOrder:o.SortOrder??o.displayOrder??c,toggleMainPhoto:o.toggleMainPhoto??c===0,storagePath:o.storagePath||null}))),e.review&&(e.review.safetyFeatures!==void 0&&(i["Features - Safety"]=e.review.safetyFeatures),e.review.squareFootage!==void 0&&(i["Features - SQFT Area"]=e.review.squareFootage),e.review.firstDayAvailable!==void 0&&(i[" First Available"]=e.review.firstDayAvailable),e.review.previousReviewsLink!==void 0&&(i["Source Link"]=e.review.previousReviewsLink)),i}function be(e){const t=["Name","Description","Features - ","Location - ","Description - ","Kitchen Type","Cancellation Policy","First Available"];return Object.keys(e).some(i=>t.some(r=>i===r||i.startsWith(r)))}function fe(e){const t={"First Available":" First Available","Nights Available (List of Nights)":"Nights Available (List of Nights) ","Not Found - Location - Address":"Not Found - Location - Address "},s={};for(const[i,r]of Object.entries(e))t[i]?s[t[i]]=r:s[i]=r;return s}async function Pe(e){if(!e)throw new Error("Listing ID is required");const{data:t,error:s}=await h.from("listing").select("*").eq("_id",e).single();if(s){if(s.code==="PGRST116")return null;throw n.error("[ListingService] âŒ Error fetching listing:",s),new Error(s.message||"Failed to fetch listing")}return t&&t.Deleted===!0?null:(n.debug("[ListingService] âœ… Listing fetched:",t._id),t)}function ae(e){const t={sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6},s=[];for(const[i,r]of Object.entries(e))r&&t[i]!==void 0&&s.push(t[i]);return s.sort((i,r)=>i-r)}function le(e){if(!(e!=null&&e.calculatedRates))return{};const t=e.calculatedRates;return{"ðŸ’°Nightly Host Rate for 1 night":t.night1||null,"ðŸ’°Nightly Host Rate for 2 nights":t.night2||null,"ðŸ’°Nightly Host Rate for 3 nights":t.night3||null,"ðŸ’°Nightly Host Rate for 4 nights":t.night4||null,"ðŸ’°Nightly Host Rate for 5 nights":t.night5||null,"ðŸ’°Nightly Host Rate for 6 nights":t.night6||null,"ðŸ’°Nightly Host Rate for 7 nights":t.night7||null}}export{ke as c,Pe as g,Fe as u};
