import{r as n,j as e,c as fe,R as xe}from"./client-BJVKzfAi.js";import{s as K}from"./supabase-BoCLEw6R.js";import{A as G}from"./AdminHeader-tCInZd3n.js";import{E as ge}from"./ErrorBoundary-9_HbXv1y.js";/* empty css             */import"./config-QPKPRtag.js";import"./auth-QZ4BJadW.js";import"./star-OtPMgcH9.js";import"./createLucideIcon-CgZZH2OU.js";import"./file-text-Bqp_Hw0X.js";import"./triangle-alert-Bp6DQQmR.js";import"./users-d0RSvnp4.js";import"./pen-line-Duo49k9O.js";import"./calendar-CDI4qHEX.js";import"./mail-CRbL90NL.js";import"./user-check-CoCGzn5Y.js";import"./dollar-sign-Dn2-KjNW.js";import"./send-C4mziT0-.js";import"./x-CrJVeoCh.js";const Q=160,q="tech@leasesplit.com",ee=["$$to$$","$$cc$$","$$bcc$$"];function he(){const[d,b]=n.useState([]),[a,u]=n.useState(null),[x,r]=n.useState({}),[c,h]=n.useState({}),[T,I]=n.useState(""),[M,k]=n.useState(!0),[U,L]=n.useState(null),[B,_]=n.useState(!1),[A,j]=n.useState(null),[J,V]=n.useState([]),[C,Y]=n.useState(""),[E,N]=n.useState(""),[y,R]=n.useState(""),[W,$]=n.useState(!0),[F,P]=n.useState(!1),[D,v]=n.useState(null),m=n.useMemo(()=>a&&d.find(s=>s._id===a)||null,[d,a]),X=n.useMemo(()=>te(m==null?void 0:m.Placeholder),[m]),H=n.useMemo(()=>{if(!m)return!1;const s=c.$$to$$||[],i=s.some(l=>l&&l.trim().length>0);return console.log("[canSendEmail] Check:",{hasTemplate:!!m,toEmails:s,hasValidTo:i,allMultiEmailKeys:Object.keys(c),multiEmailValues:c}),i},[m,c]),O=n.useMemo(()=>{const s=C&&C.trim().length>0,i=E&&E.trim().length===10,l=y&&y.trim().length>0;return s&&i&&l},[C,E,y]);n.useEffect(()=>{o()},[]),n.useEffect(()=>{w()},[]);async function o(){try{k(!0),L(null);const{data:s,error:i}=await K.schema("reference_table").from("zat_email_html_template_eg_sendbasicemailwf_").select('_id, Name, Description, Placeholder, "Email Template JSON", Logo, "Created Date"').order("Created Date",{ascending:!1});if(i)throw i;b(s||[])}catch(s){console.error("[useEmailSmsUnitPageLogic] Error loading templates:",s),L("Unable to load email templates. Please try again later.")}finally{k(!1)}}async function w(){try{$(!0);const{data:s,error:i}=await K.schema("reference_table").from("os_twilio_numbers").select("id, name, display, phone_number, phone_number_international").order("name",{ascending:!0});if(i)throw i;V(s||[])}catch(s){console.error("[useEmailSmsUnitPageLogic] Error loading Twilio numbers:",s)}finally{$(!1)}}function z(s){if(u(s||null),s){const i=d.find(p=>p._id===s),l=te(i==null?void 0:i.Placeholder),f={},g={};l.forEach(p=>{ee.includes(p.key)?g[p.key]=[""]:f[p.key]=p.key.replace(/^\$\$/,"").replace(/\$\$$/,"")}),console.log("[handleTemplateChange] Initialized:",{templateId:s,allPlaceholderKeys:l.map(p=>p.key),multiEmailKeys:Object.keys(g),hasToPlaceholder:l.some(p=>p.key==="$$to$$"),initialMultiEmails:g}),r(f),h(g)}else r({}),h({})}function Z(s,i){r(l=>({...l,[s]:i}))}function se(s,i,l){h(f=>{const g=[...f[s]||[""]];return g[i]=l,{...f,[s]:g}})}function oe(s){h(i=>{const l=[...i[s]||[""]];return l.push(""),{...i,[s]:l}})}function ie(s,i){h(l=>{const f=[...l[s]||[""]];return f.length>1?f.splice(i,1):f[0]="",{...l,[s]:f}})}function le(s){return ee.includes(s)}function ne(){if(!m){I("");return}const s=ye(m["Email Template JSON"],x);I(s)}async function re(){if(!(!H||!m)){_(!0),j(null);try{const s=(c.$$to$$||[]).filter(S=>S&&S.trim()),i=(c.$$cc$$||[]).filter(S=>S&&S.trim()),l=(c.$$bcc$$||[]).filter(S=>S&&S.trim()),f={...x},g=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/send-email",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8"},body:JSON.stringify({action:"send",payload:{template_id:m._id,to_email:s[0],from_email:q,from_name:"Split Lease",subject:x.$$subject$$||"Test Email",variables:f,...i.length>0&&{cc_emails:i},...l.length>0&&{bcc_emails:l},...s.length>1&&{additional_to:s.slice(1)}}})}),p=await g.json();g.ok&&p.success?j({success:!0,message:"Email sent successfully!"}):j({success:!1,message:p.error||"Failed to send email"})}catch(s){console.error("[useEmailUnitPageLogic] Error sending email:",s),j({success:!1,message:s.message||"Failed to send email"})}finally{_(!1)}}}function ae(){j(null)}function de(s){Y(s)}function ce(s){const i=s.replace(/\D/g,"").slice(0,10);N(i)}function me(s){R(s.slice(0,Q))}async function pe(){if(O){P(!0),v(null);try{const s=`+1${E}`,i=await fetch("https://qcfifybkaddcoimjroca.supabase.co/functions/v1/send-sms",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZmlmeWJrYWRkY29pbWpyb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzU0MDUsImV4cCI6MjA3NTA1MTQwNX0.glGwHxds0PzVLF1Y8VBGX0jYz3zrLsgE9KAWWwkYms8"},body:JSON.stringify({action:"send",payload:{to:s,from:C,body:y}})}),l=await i.json();i.ok&&l.success?(v({success:!0,message:"SMS sent successfully!"}),N(""),R("")):v({success:!1,message:l.error||"Failed to send SMS"})}catch(s){console.error("[useEmailSmsUnitPageLogic] Error sending SMS:",s),v({success:!1,message:s.message||"Failed to send SMS"})}finally{P(!1)}}}function ue(){v(null)}return{templates:d,selectedTemplateId:a,selectedTemplate:m,placeholders:X,placeholderValues:x,multiEmailValues:c,previewHtml:T,loading:M,error:U,canSendEmail:H,sending:B,sendResult:A,fromEmail:q,handleTemplateChange:z,handlePlaceholderChange:Z,handleMultiEmailChange:se,addMultiEmail:oe,removeMultiEmail:ie,isMultiEmailPlaceholder:le,updatePreview:ne,sendEmail:re,clearSendResult:ae,twilioNumbers:J,smsFromNumber:C,smsToNumber:E,smsBody:y,smsLoading:W,smsSending:F,smsResult:D,canSendSms:O,smsCharLimit:Q,handleSmsFromChange:de,handleSmsToChange:ce,handleSmsBodyChange:me,sendSms:pe,clearSmsResult:ue}}function te(d){return!d||!Array.isArray(d)?[]:d.map(b=>({key:b,label:b,defaultValue:""}))}const be=["$$cc$$","$$bcc$$","$$reply_to$$"];function ye(d,b){if(!d)return"";try{const a=d.match(/"type"\s*:\s*"text\/html"\s*,\s*"value"\s*:\s*"((?:[^"\\]|\\.)*)"/);let u="";if(a&&a[1])u=a[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\");else{const r=d.match(/"value"\s*:\s*"((?:[^"\\]|\\.)*)"\s*,\s*"type"\s*:\s*"text\/html"/);r&&r[1]&&(u=r[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\"))}if(!u){const r=d.match(/"type"\s*:\s*"text\/plain"\s*,\s*"value"\s*:\s*"((?:[^"\\]|\\.)*)"/);r&&r[1]&&(u=`<pre style="white-space: pre-wrap; font-family: inherit;">${r[1].replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\")}</pre>`,console.warn("[useEmailUnitPageLogic] No text/html content found, using text/plain"))}if(!u)return'<p style="color: #dc2626; padding: 20px;">No HTML content found in template. The template may use a different format.</p>';let x=u;return Object.entries(b).forEach(([r,c])=>{if(be.includes(r))return;const h=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),T=new RegExp(h,"g");x=x.replace(T,c||r)}),x}catch(a){return console.error("[useEmailUnitPageLogic] Failed to extract template HTML:",a),`<p style="color: #dc2626; padding: 20px;">Error extracting template: ${a.message}</p>`}}function Se(){const{templates:d,selectedTemplateId:b,selectedTemplate:a,placeholders:u,placeholderValues:x,multiEmailValues:r,previewHtml:c,loading:h,error:T,canSendEmail:I,sending:M,sendResult:k,fromEmail:U,handleTemplateChange:L,handlePlaceholderChange:B,handleMultiEmailChange:_,addMultiEmail:A,removeMultiEmail:j,isMultiEmailPlaceholder:J,updatePreview:V,sendEmail:C,clearSendResult:Y,twilioNumbers:E,smsFromNumber:N,smsToNumber:y,smsBody:R,smsLoading:W,smsSending:$,smsResult:F,canSendSms:P,smsCharLimit:D,handleSmsFromChange:v,handleSmsToChange:m,handleSmsBodyChange:X,sendSms:H,clearSmsResult:O}=he();return h?e.jsxs(e.Fragment,{children:[e.jsx(G,{}),e.jsx("main",{style:t.loadingContainer,children:e.jsx("p",{children:"Loading templates..."})})]}):T?e.jsxs(e.Fragment,{children:[e.jsx(G,{}),e.jsx("main",{style:t.errorContainer,children:e.jsx("p",{style:t.errorText,children:T})})]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{}),e.jsxs("main",{style:t.container,children:[e.jsxs("section",{style:t.leftPanel,children:[e.jsx("h1",{style:t.pageTitle,children:"Email & SMS Unit"}),e.jsxs("div",{style:t.selectorContainer,children:[e.jsx("label",{htmlFor:"template-select",style:t.label,children:"Select Template"}),e.jsxs("select",{id:"template-select",value:b||"",onChange:o=>L(o.target.value),style:t.select,children:[e.jsx("option",{value:"",children:"-- Select a template --"}),d.map(o=>e.jsx("option",{value:o._id,children:o.Name||o.Description||o._id},o._id))]})]}),a&&e.jsx("p",{style:t.description,children:a.Description||"No description available"}),a&&e.jsxs("div",{style:t.formField,children:[e.jsx("label",{style:t.fieldLabel,children:"From Email"}),e.jsx("input",{type:"text",value:U,disabled:!0,style:t.disabledInput})]}),u.length>0&&e.jsxs("div",{style:t.formContainer,children:[e.jsx("h2",{style:t.formTitle,children:"Placeholder Values"}),u.map(o=>e.jsxs("div",{style:t.formField,children:[e.jsx("label",{style:t.fieldLabel,children:o.label}),J(o.key)?e.jsx("div",{style:t.multiEmailContainer,children:(r[o.key]||[""]).map((w,z)=>e.jsxs("div",{style:t.multiEmailRow,children:[e.jsx("input",{type:"email",value:w,onChange:Z=>_(o.key,z,Z.target.value),style:t.multiEmailInput,placeholder:"Enter email address"}),(r[o.key]||[]).length>1&&e.jsx("button",{type:"button",onClick:()=>j(o.key,z),style:t.removeButton,title:"Remove email",children:"âˆ’"}),z===(r[o.key]||[]).length-1&&e.jsx("button",{type:"button",onClick:()=>A(o.key),style:t.addButton,title:"Add another email",children:"+"})]},z))}):o.key.toLowerCase().includes("body")||o.key.toLowerCase().includes("text")?e.jsx("textarea",{value:x[o.key]||"",onChange:w=>B(o.key,w.target.value),style:t.textarea,rows:3,placeholder:`Enter value for ${o.label}`}):e.jsx("input",{type:"text",value:x[o.key]||"",onChange:w=>B(o.key,w.target.value),style:t.input,placeholder:`Enter value for ${o.label}`})]},o.key))]}),a&&u.length===0&&e.jsx("div",{style:t.emptyPlaceholders,children:e.jsx("p",{children:"This template has no configurable placeholders"})}),a&&e.jsxs("div",{style:t.actionButtons,children:[k&&e.jsxs("div",{style:{...t.resultMessage,...k.success?t.successMessage:t.errorMessage},onClick:Y,children:[k.message,e.jsx("span",{style:t.closeHint,children:"(click to dismiss)"})]}),e.jsxs("div",{style:t.buttonRow,children:[e.jsx("button",{type:"button",onClick:V,style:t.updatePreviewButton,children:"Update Preview"}),e.jsx("button",{type:"button",onClick:C,disabled:!I||M,style:{...t.sendEmailButton,...!I||M?t.disabledButton:{}},children:M?"Sending...":"Send Email"})]})]})]}),e.jsxs("section",{style:t.rightPanel,children:[e.jsx("h2",{style:t.previewTitle,children:"Email Preview"}),e.jsx("div",{style:t.previewContainer,children:c?e.jsx("iframe",{srcDoc:c,style:t.previewFrame,title:"Email Preview",sandbox:"allow-same-origin"}):e.jsx("div",{style:t.emptyPreview,children:e.jsx("p",{children:a?'Click "Update Preview" to see the email':"Select a template to get started"})})})]})]}),e.jsx("section",{style:t.smsSection,children:e.jsxs("div",{style:t.smsContainer,children:[e.jsx("h2",{style:t.smsSectionTitle,children:"Send SMS"}),e.jsxs("div",{style:t.smsFormField,children:[e.jsx("label",{htmlFor:"sms-from",style:t.smsLabel,children:"From Number"}),e.jsxs("select",{id:"sms-from",value:N,onChange:o=>v(o.target.value),style:t.smsSelect,disabled:W,children:[e.jsx("option",{value:"",children:"-- Select a number --"}),E.map(o=>e.jsxs("option",{value:o.phone_number_international,children:[o.display||o.name," (",o.phone_number_international,")"]},o.id))]}),W&&e.jsx("span",{style:t.loadingHint,children:"Loading numbers..."})]}),e.jsxs("div",{style:t.smsFormField,children:[e.jsx("label",{htmlFor:"sms-to",style:t.smsLabel,children:"To Number (10 digits)"}),e.jsxs("div",{style:t.smsToInputContainer,children:[e.jsx("span",{style:t.smsToPrefix,children:"+1"}),e.jsx("input",{id:"sms-to",type:"tel",value:y,onChange:o=>m(o.target.value),style:t.smsToInput,placeholder:"5551234567",maxLength:10})]}),e.jsxs("span",{style:t.smsFieldHint,children:[y.length,"/10 digits"]})]}),e.jsxs("div",{style:t.smsFormField,children:[e.jsx("label",{htmlFor:"sms-body",style:t.smsLabel,children:"Message"}),e.jsx("textarea",{id:"sms-body",value:R,onChange:o=>X(o.target.value),style:t.smsTextarea,placeholder:"Enter your SMS message...",rows:4}),e.jsxs("span",{style:t.smsFieldHint,children:[R.length,"/",D," characters"]})]}),F&&e.jsxs("div",{style:{...t.resultMessage,...F.success?t.successMessage:t.errorMessage},onClick:O,children:[F.message,e.jsx("span",{style:t.closeHint,children:"(click to dismiss)"})]}),e.jsx("button",{type:"button",onClick:H,disabled:!P||$,style:{...t.smsSendButton,...!P||$?t.disabledButton:{}},children:$?"Sending...":"Send SMS"})]})})]})}const t={container:{display:"flex",minHeight:"calc(100vh - 200px)",padding:"20px",gap:"24px",maxWidth:"1600px",margin:"0 auto"},leftPanel:{flex:"0 0 40%",maxWidth:"500px",padding:"24px",paddingBottom:"0",backgroundColor:"#f9fafb",borderRadius:"8px",overflowY:"auto",maxHeight:"calc(100vh - 240px)"},rightPanel:{flex:"1",display:"flex",flexDirection:"column"},pageTitle:{fontSize:"24px",fontWeight:"600",marginBottom:"24px",color:"#111827"},selectorContainer:{marginBottom:"16px"},label:{display:"block",fontSize:"14px",fontWeight:"500",marginBottom:"8px",color:"#374151"},select:{width:"100%",padding:"10px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"#ffffff"},description:{fontSize:"13px",color:"#6b7280",marginBottom:"20px",padding:"12px",backgroundColor:"#ffffff",borderRadius:"6px",border:"1px solid #e5e7eb"},formContainer:{marginTop:"24px"},formTitle:{fontSize:"16px",fontWeight:"600",marginBottom:"16px",color:"#111827"},formField:{marginBottom:"16px"},fieldLabel:{display:"block",fontSize:"13px",fontWeight:"500",marginBottom:"6px",color:"#4b5563",fontFamily:"monospace"},input:{width:"100%",padding:"8px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",boxSizing:"border-box"},textarea:{width:"100%",padding:"8px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical",boxSizing:"border-box"},emptyPlaceholders:{marginTop:"24px",padding:"16px",backgroundColor:"#fff7ed",borderRadius:"6px",border:"1px solid #fed7aa",color:"#9a3412",fontSize:"14px",textAlign:"center"},previewTitle:{fontSize:"18px",fontWeight:"600",marginBottom:"16px",color:"#111827"},previewContainer:{flex:"1",border:"1px solid #e5e7eb",borderRadius:"8px",overflow:"hidden",backgroundColor:"#ffffff"},previewFrame:{width:"100%",height:"100%",minHeight:"600px",border:"none"},emptyPreview:{display:"flex",alignItems:"center",justifyContent:"center",height:"400px",color:"#9ca3af",fontSize:"14px"},loadingContainer:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"calc(100vh - 200px)"},errorContainer:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"calc(100vh - 200px)"},errorText:{color:"#dc2626",fontSize:"16px"},multiEmailContainer:{display:"flex",flexDirection:"column",gap:"8px"},multiEmailRow:{display:"flex",gap:"8px",alignItems:"center"},multiEmailInput:{flex:"1",padding:"8px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",boxSizing:"border-box"},addButton:{width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#10b981",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"18px",fontWeight:"bold",cursor:"pointer"},removeButton:{width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ef4444",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"18px",fontWeight:"bold",cursor:"pointer"},disabledInput:{width:"100%",padding:"8px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",boxSizing:"border-box",backgroundColor:"#f3f4f6",color:"#6b7280",cursor:"not-allowed"},actionButtons:{display:"flex",flexDirection:"column",gap:"12px",paddingTop:"16px",paddingBottom:"24px",borderTop:"1px solid #e5e7eb",position:"sticky",bottom:0,backgroundColor:"#f9fafb",marginLeft:"-24px",marginRight:"-24px",marginBottom:"-24px",paddingLeft:"24px",paddingRight:"24px",zIndex:10},buttonRow:{display:"flex",gap:"12px"},updatePreviewButton:{flex:"1",padding:"12px 16px",fontSize:"14px",fontWeight:"600",backgroundColor:"#3b82f6",color:"#ffffff",border:"none",borderRadius:"6px",cursor:"pointer"},sendEmailButton:{flex:"1",padding:"12px 16px",fontSize:"14px",fontWeight:"600",backgroundColor:"#10b981",color:"#ffffff",border:"none",borderRadius:"6px",cursor:"pointer"},disabledButton:{backgroundColor:"#9ca3af",cursor:"not-allowed"},resultMessage:{padding:"12px 16px",borderRadius:"6px",fontSize:"14px",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"},successMessage:{backgroundColor:"#d1fae5",color:"#065f46",border:"1px solid #6ee7b7"},errorMessage:{backgroundColor:"#fee2e2",color:"#991b1b",border:"1px solid #fca5a5"},closeHint:{fontSize:"12px",opacity:.7},smsSection:{backgroundColor:"#f3f4f6",padding:"24px 20px",borderTop:"1px solid #e5e7eb"},smsContainer:{maxWidth:"500px",margin:"0 auto",backgroundColor:"#ffffff",padding:"24px",borderRadius:"8px",boxShadow:"0 1px 3px rgba(0, 0, 0, 0.1)"},smsSectionTitle:{fontSize:"20px",fontWeight:"600",marginBottom:"20px",color:"#111827"},smsFormField:{marginBottom:"16px"},smsLabel:{display:"block",fontSize:"14px",fontWeight:"500",marginBottom:"6px",color:"#374151"},smsSelect:{width:"100%",padding:"10px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"#ffffff",boxSizing:"border-box"},smsToInputContainer:{display:"flex",alignItems:"center",border:"1px solid #d1d5db",borderRadius:"6px",overflow:"hidden"},smsToPrefix:{padding:"10px 12px",backgroundColor:"#f3f4f6",color:"#6b7280",fontSize:"14px",fontWeight:"500",borderRight:"1px solid #d1d5db"},smsToInput:{flex:"1",padding:"10px 12px",fontSize:"14px",border:"none",outline:"none",boxSizing:"border-box"},smsTextarea:{width:"100%",padding:"10px 12px",fontSize:"14px",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical",boxSizing:"border-box",fontFamily:"inherit"},smsFieldHint:{display:"block",fontSize:"12px",color:"#6b7280",marginTop:"4px"},loadingHint:{display:"block",fontSize:"12px",color:"#6b7280",marginTop:"4px",fontStyle:"italic"},smsSendButton:{width:"100%",padding:"12px 16px",fontSize:"14px",fontWeight:"600",backgroundColor:"#8b5cf6",color:"#ffffff",border:"none",borderRadius:"6px",cursor:"pointer",marginTop:"8px"}};fe(document.getElementById("root")).render(e.jsx(xe.StrictMode,{children:e.jsx(ge,{children:e.jsx(Se,{})})}));
