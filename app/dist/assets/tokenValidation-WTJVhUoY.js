import{s as k}from"./supabase-BoCLEw6R.js";import{q as w,r as y,t as A,u as T,w as b,d as U,x as I,p as S,b as C,y as N,z as _,A as v,j as x}from"./auth-QZ4BJadW.js";function F(){const r=document.cookie.split("; ").find(a=>a.startsWith("username="));if(r){let a=decodeURIComponent(r.split("=")[1]);return a=a.replace(/^["']|["']$/g,""),a}return null}function E(){const u=document.cookie.split("; "),r=u.find(l=>l.startsWith("loggedIn=")),a=u.find(l=>l.startsWith("username=")),c=r?r.split("=")[1]==="true":!1,d=F();return console.log("üîê Split Lease Cookie Auth Check:"),console.log("   Logged In:",c),console.log("   Username:",d||"not set"),console.log("   Raw Cookies:",{loggedInCookie:r,usernameCookie:a}),{isLoggedIn:c,username:d}}let f=!1;function L(){return v()}function R(){return x()}async function j(){var c,d,l,g,p,h,m,s;console.log("üîç Checking authentication status..."),await w()&&console.log("‚úÖ Migrated from legacy storage");const r=E();if(r.isLoggedIn)return console.log("‚úÖ User authenticated via Split Lease cookies"),console.log("   Username:",r.username),f=!0,y(!0),!0;try{let{data:{session:e},error:o}=await k.auth.getSession();if(!e&&!o){console.log("üîÑ No immediate Supabase session, waiting briefly for initialization..."),await new Promise(n=>setTimeout(n,200));const t=await k.auth.getSession();e=(c=t.data)==null?void 0:c.session,o=t.error,e&&console.log("‚úÖ Found Supabase session after brief wait")}if(e&&!o){console.log("‚úÖ User authenticated via Supabase Auth session"),console.log("   User ID:",(d=e.user)==null?void 0:d.id),console.log("   Email:",(l=e.user)==null?void 0:l.email);const t=((p=(g=e.user)==null?void 0:g.user_metadata)==null?void 0:p.user_id)||((h=e.user)==null?void 0:h.id),n=(s=(m=e.user)==null?void 0:m.user_metadata)==null?void 0:s.user_type;return A(e.access_token),t&&(T(t),y(!0,t)),n&&b(n),f=!0,!0}}catch(e){console.log("‚ö†Ô∏è Supabase session check failed:",e.message)}return U()&&await I()?(console.log("‚úÖ User authenticated via secure storage (legacy)"),f=!0,!0):(console.log("‚ùå User not authenticated"),f=!1,y(!1),!1)}async function z({clearOnFailure:u=!0}={}){var c,d,l,g,p,h,m;let r=L(),a=R();if(!r||!a){console.log("[Auth] No legacy token found, checking for Supabase Auth session...");try{let{data:{session:s},error:e}=await k.auth.getSession();if(!s&&!e){console.log("[Auth] üîÑ No immediate session, waiting briefly for Supabase initialization..."),await new Promise(t=>setTimeout(t,200));const o=await k.auth.getSession();s=(c=o.data)==null?void 0:c.session,e=o.error,s&&console.log("[Auth] ‚úÖ Found Supabase session after brief wait")}if(s&&!e){console.log("[Auth] ‚úÖ Found Supabase Auth session, syncing to secure storage"),r=s.access_token,a=((l=(d=s.user)==null?void 0:d.user_metadata)==null?void 0:l.user_id)||((g=s.user)==null?void 0:g.id),A(r),a&&(T(a),y(!0,a));const o=(h=(p=s.user)==null?void 0:p.user_metadata)==null?void 0:h.user_type;o&&b(o)}}catch(s){console.log("[Auth] Error checking Supabase session:",s.message)}}if(!r||!a)return console.log("[Auth] No token or user ID found - user not logged in"),null;console.log("üîç Validating token and fetching user data via Edge Function...");try{const{data:s,error:e}=await k.functions.invoke("auth-user",{body:{action:"validate",payload:{token:r,user_id:a}}});if(e){if(console.error("‚ùå Edge Function error:",e),console.error("   Error context:",e.context),e.context&&typeof e.context.json=="function")try{const i=await e.context.json();console.error("   Error body from Response:",i),i!=null&&i.error&&console.error("   Detailed error from response:",i.error)}catch{}else if((m=e.context)!=null&&m.body)try{const i=typeof e.context.body=="string"?JSON.parse(e.context.body):e.context.body;i!=null&&i.error&&console.error("   Detailed error from response:",i.error)}catch{}return u&&S(),f=!1,null}if(!s.success)return console.log("‚ùå Token validation failed"),console.log("   Reason:",s.error||"Unknown"),u?(console.log("   Clearing auth data..."),S()):console.log("   Preserving session (clearOnFailure=false)"),f=!1,null;const o=s.data;let t=C();!t||t===""?(t=o.userType||null,t&&(b(t),console.log("‚úÖ User type fetched and cached:",t))):console.log("‚úÖ User type loaded from cache:",t);const n={userId:o.userId,firstName:o.firstName||null,fullName:o.fullName||null,email:o.email||null,profilePhoto:o.profilePhoto||null,userType:t,accountHostId:o.accountHostId||o._id||null,aboutMe:o.aboutMe||null,needForSpace:o.needForSpace||null,specialNeeds:o.specialNeeds||null,proposalCount:o.proposalCount??0,hasSubmittedRentalApp:o.hasSubmittedRentalApp??!1};return n.firstName&&N(n.firstName),n.profilePhoto&&_(n.profilePhoto),console.log("‚úÖ User data validated:",n.firstName,"- Type:",n.userType),console.log("üìä User proposalCount from Edge Function:",o.proposalCount,"‚Üí stored as:",n.proposalCount),f=!0,n}catch(s){return console.error("‚ùå Token validation error:",s),u&&S(),f=!1,null}}export{R as a,j as c,L as g,z as v};
