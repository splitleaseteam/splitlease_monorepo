import{r as s,j as t,c as ae}from"./client-BJVKzfAi.js";import{s as oe}from"./supabase-BoCLEw6R.js";import{u as ne,a as ie}from"./Toast-BQk6Nzgd.js";import{A as re}from"./AdminHeader-tCInZd3n.js";import"./auth-QZ4BJadW.js";import"./star-OtPMgcH9.js";import"./createLucideIcon-CgZZH2OU.js";import"./file-text-Bqp_Hw0X.js";import"./triangle-alert-Bp6DQQmR.js";import"./users-d0RSvnp4.js";import"./pen-line-Duo49k9O.js";import"./calendar-CDI4qHEX.js";import"./mail-CRbL90NL.js";import"./user-check-CoCGzn5Y.js";import"./dollar-sign-Dn2-KjNW.js";import"./send-C4mziT0-.js";import"./x-CrJVeoCh.js";const ce="https://qcfifybkaddcoimjroca.supabase.co",w=50;function le(){const{showToast:a}=ne(),[i,d]=s.useState([]),[c,f]=s.useState(0),[n,l]=s.useState(1),[p,g]=s.useState(!0),[b,_]=s.useState(""),[C,j]=s.useState({}),[r,y]=s.useState(null),[m,E]=s.useState(null),[U,T]=s.useState(!1),[F,v]=s.useState(!1),[$,x]=s.useState(!1),[O,D]=s.useState(null);s.useEffect(()=>{A(),S()},[]),s.useEffect(()=>{A()},[b,n]),s.useEffect(()=>{const o=new URLSearchParams(window.location.search).get("tester");if(o&&i.length>0&&!r){const u=i.find(h=>h.id===o);u?y(u):R(o)}},[i]);async function N(e,o={}){const{data:{session:u}}=await oe.auth.getSession(),h=localStorage.getItem("sl_auth_token")||sessionStorage.getItem("sl_auth_token"),P=(u==null?void 0:u.access_token)||h,M={"Content-Type":"application/json"};P&&(M.Authorization=`Bearer ${P}`);const L=await fetch(`${ce}/functions/v1/simulation-admin`,{method:"POST",headers:M,body:JSON.stringify({action:e,payload:o})}),k=await L.json();if(!L.ok||!k.success)throw new Error(k.error||"Request failed");return k.data}const A=s.useCallback(async()=>{try{g(!0),D(null);const e=await N("listTesters",{limit:w,offset:(n-1)*w,search:b||void 0});d(e.testers||[]),f(e.total||0),e.stepConfig&&j(e.stepConfig)}catch(e){console.error("[useSimulationAdminPageLogic] Fetch error:",e),D(e.message),a(e.message||"Failed to fetch testers","error")}finally{g(!1)}},[n,b,a]),S=s.useCallback(async()=>{try{const e=await N("getStatistics");E(e),e.stepConfig&&j(e.stepConfig)}catch(e){console.error("[useSimulationAdminPageLogic] Stats error:",e)}},[]),R=s.useCallback(async e=>{try{const o=await N("getTester",{testerId:e});o.tester&&y(o.tester)}catch(o){console.error("[useSimulationAdminPageLogic] Fetch tester error:",o),a(o.message||"Failed to fetch tester","error")}},[a]),B=s.useCallback(async()=>{if(r)try{x(!0);const o=(await N("resetToDay1",{testerId:r.id})).tester;y(o),d(u=>u.map(h=>h.id===o.id?o:h)),T(!1),S(),a(`${o.firstName||"Tester"} has been reset to Day 1`,"success")}catch(e){console.error("[useSimulationAdminPageLogic] Reset error:",e),a(e.message||"Failed to reset tester","error")}finally{x(!1)}},[r,S,a]),q=s.useCallback(async()=>{if(r)try{x(!0);const o=(await N("advanceToDay2",{testerId:r.id})).tester;y(o),d(u=>u.map(h=>h.id===o.id?o:h)),v(!1),S(),a(`${o.firstName||"Tester"} has been advanced to Day 2`,"success")}catch(e){console.error("[useSimulationAdminPageLogic] Advance error:",e),a(e.message||"Failed to advance tester","error")}finally{x(!1)}},[r,S,a]),z=s.useCallback(e=>{y(e);const o=new URL(window.location.href);e?o.searchParams.set("tester",e.id):o.searchParams.delete("tester"),window.history.replaceState({},"",o.toString())},[]),G=s.useCallback(e=>{_(e),l(1)},[]),H=s.useCallback(e=>{l(e)},[]),J=s.useCallback(()=>{y(null),_("");const e=new URL(window.location.href);e.searchParams.delete("tester"),window.history.replaceState({},"",e.toString())},[]),Z=s.useCallback(()=>{r&&r.canReset&&T(!0)},[r]),K=s.useCallback(()=>{T(!1)},[]),Q=s.useCallback(()=>{r&&r.canAdvance&&v(!0)},[r]),V=s.useCallback(()=>{v(!1)},[]),W=s.useMemo(()=>Math.ceil(c/w),[c]),X=s.useMemo(()=>m!=null&&m.stats?m.stats:[],[m]),Y=s.useCallback(e=>{const o=C[e];return(o==null?void 0:o.label)||`Step ${e}`},[C]),ee=s.useCallback(e=>e===0?"gray":e<=3?"blue":e<=6?"green":"purple",[]),te=s.useCallback(e=>e?new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",[]),se=s.useCallback(e=>e?`${e.firstName||""} ${e.lastName||""}`.trim()||e.email||"Unknown":"",[]);return{testers:i,totalCount:c,currentPage:n,totalPages:W,isLoading:p,searchText:b,selectedTester:r,statistics:m,formattedStats:X,stepConfig:C,isResetModalOpen:U,isAdvanceModalOpen:F,isProcessing:$,error:O,fetchTesters:A,fetchStatistics:S,fetchTesterById:R,resetToDay1:B,advanceToDay2:q,handleTesterSelect:z,handleSearchChange:G,handlePageChange:H,clearSelection:J,openResetModal:Z,closeResetModal:K,openAdvanceModal:Q,closeAdvanceModal:V,getStepLabel:Y,getStepColor:ee,formatDate:te,getTesterDisplayName:se}}function de({testers:a,selectedTester:i,isLoading:d,onSelect:c,getTesterDisplayName:f}){return t.jsxs("div",{className:"tester-selector",children:[t.jsx("label",{className:"tester-selector__label",htmlFor:"tester-select",children:"Select Usability Account"}),t.jsxs("select",{id:"tester-select",className:"tester-selector__select",value:(i==null?void 0:i.id)||"",onChange:n=>{const l=n.target.value,p=a.find(g=>g.id===l)||null;c(p)},disabled:d,required:!0,children:[t.jsx("option",{value:"",children:"Select Usability Account"}),a.map(n=>{const l=f(n),p=n.email?` (${n.email})`:"";return t.jsxs("option",{value:n.id,children:[l||n.id,p]},n.id)})]})]})}function me({tester:a,onResetToDay1:i,onAdvanceToDay2:d,isProcessing:c}){const f=a.aiCredits??a["AI Credits"]??a.ai_credits??"N/A",n=a.firstName||a["Name - First"]||a.nameFirst||"",l=a.typeDisplay||a.userType||a.Type||"N/A",p=a.usabilityStep??a.usability_step??"N/A";return t.jsxs("div",{className:"tester-info-display",children:[t.jsx("p",{className:"tester-info-display__line",children:f}),t.jsxs("p",{className:"tester-info-display__line",children:["Name: ",n||"Unknown"]}),t.jsxs("p",{className:"tester-info-display__line",children:["Tester Type: ",l]}),t.jsxs("p",{className:"tester-info-display__line",children:["Usability Step: ",p]}),t.jsxs("div",{className:"tester-info-display__actions",children:[t.jsx("button",{type:"button",className:"tester-info-display__button",onClick:i,disabled:!a||c,children:"Reset Usability"}),t.jsx("button",{type:"button",className:"tester-info-display__button",onClick:d,disabled:!a||c,children:"Start Day 2"})]})]})}function I({title:a,message:i,confirmLabel:d,onConfirm:c,onCancel:f,isProcessing:n}){return t.jsx("div",{className:"confirmation-modal__backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"confirmation-modal-title",children:t.jsxs("div",{className:"confirmation-modal",children:[t.jsx("div",{className:"confirmation-modal__header",children:t.jsx("h3",{id:"confirmation-modal-title",className:"confirmation-modal__title",children:a})}),t.jsx("div",{className:"confirmation-modal__body",children:t.jsx("p",{className:"confirmation-modal__message",children:i})}),t.jsxs("div",{className:"confirmation-modal__footer",children:[t.jsx("button",{onClick:c,disabled:n,className:"confirmation-modal__button",children:n?"Processing...":d}),t.jsx("button",{onClick:f,disabled:n,className:"confirmation-modal__button",children:"Cancel"})]})]})})}function ue(){const{testers:a,selectedTester:i,isLoading:d,error:c,isResetModalOpen:f,isAdvanceModalOpen:n,isProcessing:l,fetchTesters:p,resetToDay1:g,advanceToDay2:b,handleTesterSelect:_,openResetModal:C,closeResetModal:j,openAdvanceModal:r,closeAdvanceModal:y,getTesterDisplayName:m}=le();return t.jsxs("div",{className:"simulation-admin-page",children:[t.jsx(re,{}),t.jsx("main",{className:"simulation-admin-main",children:t.jsxs("div",{className:"simulation-admin-container",children:[t.jsx("h1",{className:"simulation-admin-title",children:"Simulation Admin"}),c&&t.jsxs("div",{className:"simulation-admin-error",children:[t.jsx("span",{children:c}),t.jsx("button",{onClick:p,className:"simulation-admin-retry",children:"Retry"})]}),t.jsx(de,{testers:a,selectedTester:i,isLoading:d,onSelect:_,getTesterDisplayName:m}),i&&t.jsx(me,{tester:i,onResetToDay1:C,onAdvanceToDay2:r,isProcessing:l})]})}),f&&i&&t.jsx(I,{title:"Reset to Day 1",message:`Are you sure you want to reset ${m(i)} to Day 1? This will set their usability step back to "Not Started".`,confirmLabel:"Reset to Day 1",onConfirm:g,onCancel:j,isProcessing:l}),n&&i&&t.jsx(I,{title:"Advance to Day 2",message:`Are you sure you want to advance ${m(i)} to Day 2? This will set their usability step to "Day 2 - Introduction".`,confirmLabel:"Advance to Day 2",onConfirm:b,onCancel:y,isProcessing:l})]})}const fe=document.getElementById("root"),pe=ae(fe);pe.render(t.jsx(ie,{children:t.jsx(ue,{})}));
