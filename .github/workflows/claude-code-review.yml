name: Claude Commit Review

on:
  push:
    branches: [main]
    paths:
      # Frontend source files
      - 'app/src/**/*.js'
      - 'app/src/**/*.jsx'
      - 'app/src/**/*.ts'
      - 'app/src/**/*.tsx'
      - 'app/src/**/*.css'
      # Supabase Edge Functions
      - 'supabase/functions/**/*.ts'
      # Ignore non-code files
      - '!**/*.md'
      - '!.claude/**'

# Prevent concurrent reviews
concurrency:
  group: claude-commit-review-${{ github.sha }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip if commit message contains [skip-review]
    if: "!contains(github.event.head_commit.message, '[skip-review]')"

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need parent commit for diff

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in this commit
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- '*.js' '*.jsx' '*.ts' '*.tsx' '*.css' 2>/dev/null || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count changed files
          if [ -z "$CHANGED" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "count=$(echo "$CHANGED" | wc -l)" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.count != '0'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}
            COMMIT: ${{ github.sha }}
            COMMIT MESSAGE: ${{ github.event.head_commit.message }}
            AUTHOR: ${{ github.event.head_commit.author.name }}

            ## Changed Files
            ${{ steps.changed-files.outputs.files }}

            ## Instructions

            Review ONLY the files listed above that were changed in this commit.

            For each changed file:
            1. Read the file using the Read tool
            2. Check the git diff for that file: `git diff HEAD~1 HEAD -- <filename>`
            3. Review the changes for:
               - Code quality and adherence to project patterns (see CLAUDE.md)
               - Potential bugs or logic errors
               - Security concerns
               - Performance issues

            Keep your review concise and actionable. Focus on issues that matter.

            After your review, post a commit comment using:
            ```
            gh api repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
              -f body="YOUR_REVIEW_HERE"
            ```

            If no issues found, post a brief "âœ… Commit looks good" message.

          claude_args: |
            --max-turns 10
            --allowedTools "Read,Grep,Glob,Bash(git diff:*),Bash(git show:*),Bash(gh api:*)"

      - name: Skip notification
        if: steps.changed-files.outputs.count == '0'
        run: echo "No code files changed in this commit, skipping review"

