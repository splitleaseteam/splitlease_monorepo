name: Deploy Edge Functions (Development)

on:
  push:
    branches:
      - '**'  # All branches
    paths:
      - 'supabase/functions/**'
      - '.github/workflows/deploy-edge-functions-dev.yml'
      - '.github/scripts/detect-changed-functions.sh'

# Allow concurrent deployments to dev (different branches can deploy simultaneously)
concurrency:
  group: edge-functions-dev-${{ github.ref }}
  cancel-in-progress: true  # Cancel previous runs for same branch

jobs:
  detect-changes:
    name: Detect Changed Functions
    runs-on: ubuntu-latest
    outputs:
      deploy_all: ${{ steps.detect.outputs.deploy_all }}
      changed_functions: ${{ steps.detect.outputs.changed_functions }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Make scripts executable
        run: chmod +x .github/scripts/*.sh

      - name: Detect changed functions
        id: detect
        run: .github/scripts/detect-changed-functions.sh

  deploy-all:
    name: Deploy All Functions (Dev)
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_all == 'true'
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy all Edge Functions (Dev)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_DEV }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_DEV }}
        run: |
          echo "ðŸš€ Deploying ALL Edge Functions to development..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_ID

      - name: Notify Slack
        if: success()
        run: |
          python .github/scripts/send_slack.py \
            "ðŸ”§ Deployed ALL Edge Functions to dev (branch: ${{ github.ref_name }})" \
            --type info
        continue-on-error: true

  deploy-changed:
    name: Deploy Changed Functions (Dev)
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy_all == 'false' && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: development
    strategy:
      matrix:
        function: ${{ fromJson(needs.detect-changes.outputs.changed_functions) }}
      max-parallel: 5
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy ${{ matrix.function }} (Dev)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_DEV }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_DEV }}
        run: |
          echo "ðŸš€ Deploying ${{ matrix.function }} to development..."
          supabase functions deploy ${{ matrix.function }} --project-ref $SUPABASE_PROJECT_ID

      - name: Notify Slack
        if: success()
        run: |
          python .github/scripts/send_slack.py \
            "ðŸ”§ Deployed ${{ matrix.function }} to dev (branch: ${{ github.ref_name }})" \
            --type info
        continue-on-error: true
