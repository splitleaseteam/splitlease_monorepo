name: Deploy to PythonAnywhere (Production)

on:
  push:
    branches:
      - main
    paths:
      - 'pythonAnywhere/**'
      - '.github/workflows/deploy-pythonanywhere.yml'
  workflow_dispatch:  # Allow manual triggering from GitHub UI

# Prevent concurrent PythonAnywhere deployments
concurrency:
  group: pythonanywhere-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Flask Apps to PythonAnywhere
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to PythonAnywhere via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PA_HOST }}
          username: ${{ secrets.PA_USERNAME }}
          key: ${{ secrets.PA_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "======================================"
            echo "ðŸš€ Starting deployment to PythonAnywhere"
            echo "======================================"

            # Check if repository exists, clone if not
            if [ ! -d "/home/${{ secrets.PA_USERNAME }}/pythonanywhere" ]; then
              echo "ðŸ“¦ Repository not found. Cloning from GitHub..."
              cd /home/${{ secrets.PA_USERNAME }}
              git clone https://github.com/splitleaseteam/splitlease.git pythonanywhere
            fi

            # Navigate to repository directory
            cd /home/${{ secrets.PA_USERNAME }}/pythonanywhere

            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git pull origin main

            echo "ðŸ“¦ Installing dependencies for mysite (contracts/Slack)..."
            cd pythonAnywhere/mysite
            pip3 install --user -r requirements.txt

            echo "ðŸ“¦ Installing dependencies for mysite2 (URL shortener/QR)..."
            cd ../mysite2
            pip3 install --user -r requirements.txt

            echo "ðŸ“¦ Installing dependencies for mysite3 (ML/matching)..."
            cd ../mysite3
            pip3 install --user -r requirements.txt

            echo "ðŸ”„ Reloading web app..."
            # Touch WSGI file to trigger automatic reload
            touch /var/www/${{ secrets.PA_USERNAME }}_pythonanywhere_com_wsgi.py

            echo "======================================"
            echo "âœ… Deployment completed successfully!"
            echo "======================================"

      - name: Notify Slack on success
        if: success()
        run: |
          python .github/scripts/send_slack.py \
            "âœ… PythonAnywhere deployment successful (3 Flask apps: mysite, mysite2, mysite3)" \
            --type success
        continue-on-error: true

      - name: Notify Slack on failure
        if: failure()
        run: |
          python .github/scripts/send_slack.py \
            "âŒ PythonAnywhere deployment failed - check GitHub Actions logs" \
            --type error
        continue-on-error: true

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## ðŸ PythonAnywhere Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production (PythonAnywhere)" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://splitlease.pythonanywhere.com" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Applications:**" >> $GITHUB_STEP_SUMMARY
          echo "- **mysite**: Contracts, Slack Events, PDF generation, Google Drive" >> $GITHUB_STEP_SUMMARY
          echo "- **mysite2**: URL shortener, QR generator, campaign analytics" >> $GITHUB_STEP_SUMMARY
          echo "- **mysite3**: TensorFlow matching engine, ML recommendations" >> $GITHUB_STEP_SUMMARY
