# Comet Agent: Bubble IDE Investigation Guide

**Purpose:** Investigate schedule validation logic in Bubble IDE based on discrepancies found by Playwright testing  
**Context:** Playwright tests compared localhost (new implementation) vs Bubble production and found differences

---

## üéØ Your Mission

Use the questions generated by Playwright testing to investigate the **actual source of truth** in the Bubble IDE. Document what you find and compare it to our Golden Rules.

---

## üì• Input You'll Receive

After Playwright tests run, you'll receive question files in this format:

**File:** `test-results/comet-questions/{scenario-id}-questions.md`

**Example Content:**
```markdown
# Bubble Investigation: Full Week (7 days)

## Discrepancies Found
- Nights Count: Localhost=7, Bubble=6 (Expected=7)

## Questions for Comet

1. **Nights Calculation Discrepancy:** Localhost shows 7 nights, 
   Bubble shows 6 nights. In the Bubble IDE, find the workflow or 
   expression that calculates nights from selected days. Does it use 
   `selectedDays.length - 1` or `selectedDays.length`? Is there a 
   special case for 7 days (full week)?

2. **Full Week Logic:** For 7 selected days, we expect 7 nights 
   (full week special case). Does Bubble have special handling for 
   selecting all 7 days? Look for conditions like "If selected days 
   count = 7" or "If full week" in the validation workflow.
```

---

## üîç Investigation Workflow

### Step 1: Access Bubble IDE

```
URL: https://bubble.io/
App: Split Lease
Environment: version-test (or main)
```

### Step 2: Locate Schedule Selector Component

**Page to Check:** `z-schedule-test` page

**Elements to Find:**
- Schedule selector UI element
- Day selection buttons
- Validation display
- Nights count display

### Step 3: Find Validation Workflows

**Common Names to Search:**
- "Validate Schedule"
- "Calculate Nights"
- "Check Contiguity"
- "Schedule Validation"

**Where to Look:**
- Workflows tab
- Custom events on schedule selector element
- Conditional formatting rules
- Dynamic expressions

### Step 4: Document the Logic

For each workflow/expression found, document:

```markdown
## Workflow: [Name]

**Trigger:** [When does this run?]
**Inputs:** [What data does it receive?]
**Logic Steps:**
1. [Step 1]
2. [Step 2]
3. [etc.]

**Outputs:** [What does it return?]

**Code/Expression:**
```
[Copy the actual Bubble expression/formula]
```

**Comparison to Golden Rules:**
- [Does it match Rule 1?]
- [Does it match Rule 2?]
- [Differences found?]
```

### Step 5: Answer Specific Questions

For each question in the input file, provide:

1. **Answer:** [What you found]
2. **Evidence:** [Screenshot or expression copy]
3. **Matches Golden Rule?** [Yes/No + explanation]
4. **Recommendation:** [Should we change our implementation, or is Bubble wrong?]

---

## üìä Investigation Template

Use this template for your response:

```markdown
# Bubble Investigation Report: {Scenario Name}

**Date:** {date}
**Investigated By:** Comet Agent
**Source:** Bubble IDE (version-test environment)

---

## üîç Findings Summary

**Total Questions:** {count}
**Workflows Found:** {count}
**Matches Golden Rules:** {Yes/No/Partial}
**Recommend Changes:** {Yes/No}

---

## Question-by-Question Investigation

### Question 1: {Question Text}

**Answer:**
{What you found in Bubble}

**Bubble Expression/Workflow:**
```
{Copy actual Bubble code}
```

**Comparison to Golden Rule:**
- **Our Implementation:** {what we do}
- **Bubble Implementation:** {what Bubble does}
- **Match?** {Yes/No}

**Evidence:**
![Screenshot](path/to/screenshot.png)

**Recommendation:**
{Should we change our code? Is Bubble wrong? Are both valid?}

---

### Question 2: {Question Text}

[Repeat format]

---

## üéØ Key Findings

### Critical Differences:
1. {Difference 1}
2. {Difference 2}

### Business Logic Clarifications:
1. {Clarification 1}
2. {Clarification 2}

### Recommendations:

#### Option A: Update Our Implementation
{If Bubble is correct, what changes do we need to make?}

#### Option B: Update Bubble
{If our implementation is correct per business rules, what needs to change in Bubble?}

#### Option C: Both Are Valid
{If both approaches are acceptable, document why}

---

## üìù Next Steps

1. [ ] Review findings with team
2. [ ] Decide: Update localhost or update Bubble?
3. [ ] Document final business rules
4. [ ] Update Golden Validator if needed
5. [ ] Sync implementations
```

---

## üéØ Specific Things to Investigate

### 1. Nights Calculation Formula

**What to Find:**
- Where nights are calculated from selected days
- Exact expression/formula used
- Any special cases (7 days, 6 days, etc.)

**Golden Rule to Compare:**
```javascript
if (selectedDays.length === 7) {
  nightsCount = 7;  // Full week
} else {
  nightsCount = Math.max(0, selectedDays.length - 1);  // Partial week
}
```

**Questions to Answer:**
- Does Bubble use `length - 1` or `length`?
- Is there a full week special case?
- Are 6-night bookings allowed or prevented?

---

### 2. Contiguity Validation

**What to Find:**
- Logic that checks if days are consecutive
- How wrap-around cases (Sat-Sun-Mon) are handled
- Error messages for non-contiguous selections

**Golden Rule to Compare:**
- Days must be consecutive
- Wrap-around allowed (using inverse logic)
- 6+ days always contiguous

**Questions to Answer:**
- Does Bubble validate contiguity?
- How does it handle wrap-around?
- What's the exact algorithm?

---

### 3. Min/Max Nights Validation

**What to Find:**
- Absolute minimum (hardcoded)
- Host minimum (from listing data)
- Absolute maximum (hardcoded)
- Host maximum (from listing data)
- Soft vs hard constraints

**Golden Rules to Compare:**
- Absolute min: 2 nights
- Absolute max: 7 nights
- Host constraints are warnings (soft)

**Questions to Answer:**
- What are Bubble's min/max values?
- Are host constraints enforced strictly or as warnings?

---

### 4. Day Availability Check

**What to Find:**
- How available days are stored
- How selection is validated against availability
- Error handling for unavailable days

**Golden Rule to Compare:**
- Days must be in listing's `daysAvailable` array
- Hard constraint (cannot override)

---

## üî¨ Advanced Investigation

### If You Find Major Discrepancies:

1. **Check Version History:**
   - Has the logic changed recently in Bubble?
   - Is version-test different from main?

2. **Check Business Rules Documentation:**
   - Look for any Bubble-side documentation
   - Check for comments in workflows

3. **Test in Bubble UI:**
   - Actually use the Bubble page
   - Try the same scenarios Playwright tested
   - Document the behavior

4. **Compare with Legacy System:**
   - If there's an older version, check that too
   - Document evolution of the logic

---

## üì∏ Evidence Collection

### Screenshots to Capture:

1. **Workflow overview** - Full workflow tree
2. **Nights calculation expression** - Close-up of formula
3. **Validation logic** - Each validation step
4. **Error handling** - What errors can occur
5. **Test results** - Running test scenarios in Bubble

### Export if Possible:
- Workflow JSON/XML
- Expression text
- Validation rules list

---

## üöÄ Example Investigation Output

```markdown
# Investigation Report: Full Week Scenario

## Question: Does Bubble Calculate 7 Days as 7 Nights or 6 Nights?

**Answer:** Bubble calculates 7 days as **6 nights**.

**Found In:** Workflow "Calculate Schedule Nights"

**Bubble Expression:**
```
Schedule Selector's selected days:count - 1
```

**No Special Case for Full Week:** There is no conditional logic checking 
if `count = 7`. It always uses the `count - 1` formula.

**Comparison:**
- **Our Golden Rule:** 7 days = 7 nights (special case)
- **Bubble Current:** 7 days = 6 nights (simple formula)

**Evidence:**
[Screenshot showing the workflow expression]

**Recommendation:** 
**CRITICAL DECISION NEEDED:**

This is a fundamental business logic question:
1. Should full week rentals count as 7 nights or 6 nights?
2. Do 6-night bookings exist in the business model?

**Options:**
A. Update our implementation to match Bubble (7 days = 6 nights)
B. Update Bubble to match our business rule (7 days = 7 nights)
C. Confirm with business stakeholders which is correct

**My Analysis:** Based on the user's previous statement that "6-night 
bookings DO NOT EXIST" and "full week = 7 nights," it appears Bubble's 
current logic is INCORRECT and should be updated.
```

---

## ‚úÖ Deliverables

When your investigation is complete, provide:

1. **Investigation Report** (using template above)
2. **Screenshots** of key Bubble workflows/expressions
3. **Clear Recommendations** on what to do next
4. **Updated Documentation** if business rules need clarification

---

## üéØ Success Criteria

- [ ] All questions from Playwright answered
- [ ] Bubble workflows documented
- [ ] Logic compared to Golden Rules
- [ ] Discrepancies explained
- [ ] Clear recommendations provided
- [ ] Evidence (screenshots) collected
- [ ] Report ready for review

---

**Ready to investigate!** Use the questions from Playwright testing as your starting point. üîç
