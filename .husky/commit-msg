#!/bin/bash
# SYSTEM ENFORCEMENT: Bug fixes should include tests
# This hook warns (doesn't block) when bug fixes lack test coverage

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# ==================================================================
# Check if this is a bug fix commit
# ==================================================================
if echo "$COMMIT_MSG" | grep -qiE "^fix(\([^)]+\))?:"; then
    echo ""
    echo "üîç Detected bug fix commit. Checking for tests..."

    # Get staged test files
    STAGED_TESTS=$(git diff --cached --name-only | grep -E "\.test\.(js|jsx|ts|tsx)$" || true)

    if [ -z "$STAGED_TESTS" ]; then
        echo ""
        echo "‚ö†Ô∏è  ================================================================"
        echo "   WARNING: Bug fix without test"
        echo "   ================================================================"
        echo ""
        echo "   Your commit message suggests this is a bug fix, but no test files"
        echo "   are included. Consider adding a regression test to prevent recurrence."
        echo ""
        echo "   Regression Clusters #7, #13 show check-in/checkout broke 13+ times"
        echo "   because no tests existed to catch regressions."
        echo ""
        echo "   Generate a test template:"
        echo "   node scripts/generate-regression-test.js 'BUG-ID' 'Description'"
        echo ""
        echo "   Example:"
        echo "   node scripts/generate-regression-test.js 'BUG-123' 'Check-out day wrong'"
        echo ""
        echo "   If you're sure no test is needed, continue with:"
        echo "   git commit --no-verify"
        echo ""
        echo "   ‚è∏Ô∏è  Pausing for 3 seconds to let you reconsider..."
        sleep 3
        echo ""
        # Warning only, not blocking
    else
        echo ""
        echo "‚úÖ Test files included with bug fix:"
        echo "$STAGED_TESTS" | sed 's/^/   /'
        echo ""
    fi
fi

# ==================================================================
# Additional commit message quality checks
# ==================================================================

# Check minimum message length
MSG_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c)
if [ "$MSG_LENGTH" -lt 10 ]; then
    echo ""
    echo "‚ùå BLOCK: Commit message too short (< 10 characters)"
    echo "   Write a descriptive commit message."
    exit 1
fi

# Check for WIP commits to main
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" = "main" ] && echo "$COMMIT_MSG" | grep -qiE "^(wip|tmp|test):"; then
    echo ""
    echo "‚ùå BLOCK: WIP/TMP/TEST commits not allowed on main branch"
    echo "   Use a feature branch for work-in-progress commits."
    exit 1
fi

echo "‚úÖ Commit message checks passed"
