#!/bin/bash
# ==================================================================
# SYSTEM ENFORCEMENT: Prevent direct pushes to main
# ==================================================================
# This hook blocks pushes to protected branches
# Forces use of feature branches + pull requests

set -e

CURRENT_BRANCH=$(git branch --show-current)
PROTECTED_BRANCHES=("main" "master" "production" "staging")

# ==================================================================
# Check if pushing to protected branch
# ==================================================================
for branch in "${PROTECTED_BRANCHES[@]}"; do
    if [ "$CURRENT_BRANCH" = "$branch" ]; then
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë  ‚ùå SYSTEM BLOCK: Direct push to '$branch' not allowed   ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "üìã Why this rule exists:"
        echo "   - Regression Cluster #2: Component deleted directly on main"
        echo "   - Regression Cluster #14: Lost functionality from bad merges"
        echo "   - No code review = bugs reach production"
        echo ""
        echo "‚úÖ Correct workflow:"
        echo "   1. Create feature branch:"
        echo "      git checkout -b feature/your-feature-name"
        echo ""
        echo "   2. Commit your changes:"
        echo "      git add ."
        echo "      git commit -m \"feat: your feature description\""
        echo ""
        echo "   3. Push feature branch:"
        echo "      git push origin feature/your-feature-name"
        echo ""
        echo "   4. Create Pull Request on GitHub for review"
        echo ""
        echo "‚ö†Ô∏è  Emergency bypass (not recommended):"
        echo "   git push --no-verify"
        echo ""
        exit 1
    fi
done

# ==================================================================
# Additional pre-push checks
# ==================================================================
echo "üîç Running pre-push checks on branch: $CURRENT_BRANCH"
echo ""

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "‚ö†Ô∏è  Warning: You have uncommitted changes"
    echo "   These will not be pushed. Commit or stash them first."
    echo ""
fi

# Check if branch is ahead of remote
LOCAL_COMMIT=$(git rev-parse @)
REMOTE_COMMIT=$(git rev-parse @{u} 2>/dev/null || echo "")

if [ -z "$REMOTE_COMMIT" ]; then
    echo "üì§ New branch - will be created on remote"
elif [ "$LOCAL_COMMIT" = "$REMOTE_COMMIT" ]; then
    echo "‚úÖ Branch is up to date with remote"
elif ! git merge-base --is-ancestor "$REMOTE_COMMIT" "$LOCAL_COMMIT"; then
    echo "‚ö†Ô∏è  Warning: Branch has diverged from remote"
    echo "   You may need to pull and rebase before pushing."
    echo ""
fi

echo ""
echo "‚úÖ Pre-push checks passed for branch: $CURRENT_BRANCH"
echo "   Pushing to remote..."
echo ""
