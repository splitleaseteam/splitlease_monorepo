#!/bin/bash
# SYSTEM ENFORCEMENT: Pre-commit checks
# Runs before every git commit to catch issues early

set -e

echo "üîç Running pre-commit checks..."

# Check if we're in the repo root
if [ ! -d ".git" ]; then
    echo "‚ùå Not in git repository root"
    exit 1
fi

# ==================================================================
# CHECK 1: Edge Function Registry Sync
# ==================================================================
if [ -d "supabase/functions" ]; then
    echo ""
    echo "üì¶ Checking Edge Function registry..."

    if command -v node >/dev/null 2>&1; then
        node supabase/scripts/sync-edge-functions.js || {
            echo ""
            echo "‚ùå Edge Function registry out of sync"
            echo ""
            echo "   Fix: node supabase/scripts/sync-edge-functions.js --fix"
            echo "   Then: git add supabase/config.toml"
            echo ""
            echo "   Or bypass (not recommended): git commit --no-verify"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  Node.js not found, skipping Edge Function check"
    fi
fi

# ==================================================================
# CHECK 2: Run linting on staged files
# ==================================================================
echo ""
echo "üîç Running linter on staged files..."

if [ -d "app" ]; then
    cd app

    # Get staged JS/JSX/TS/TSX files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)

    if [ -n "$STAGED_FILES" ]; then
        echo "   Linting $(echo "$STAGED_FILES" | wc -l) files..."

        # Run eslint on staged files only
        echo "$STAGED_FILES" | xargs bun run eslint --max-warnings 0 || {
            echo ""
            echo "‚ùå Linting failed"
            echo ""
            echo "   Fix: bun run lint:fix"
            echo "   Or bypass (not recommended): git commit --no-verify"
            exit 1
        }
    fi

    cd ..
fi

echo ""
echo "‚úÖ Pre-commit checks passed"
echo ""
