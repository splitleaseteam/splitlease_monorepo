# Date Change Requests – Email Templates Requirements (Adapted for Split Lease Architecture)

> **DOCUMENT STATUS**: Adapted from original requirements to align with Split Lease's current architecture
> **ORIGINAL DOCUMENT**: Date Change Requests – Email Templates & Placeholders Requirements
> **ADAPTED BY**: Claude (Split Lease Architecture Analysis)
> **DATE**: 2026-01-30

---

## 1. Purpose

Define the standardized email templates for all host/guest communications related to date change requests (add, remove, swap), **adapted to work within Split Lease's existing SendGrid + Bubble email infrastructure**.

---

## 2. Architecture Adaptations

### 2.1 Template Storage (CRITICAL CHANGE)

**Original Requirement**: Templates defined in markdown with fields like `subject`, `warning`, `title`, `body_text_1`, `banner_text_1-5`, etc.

**Current Architecture**:
- Email templates stored in Bubble table: `reference_table.zat_email_html_template_eg_sendbasicemailwf_`
- SendGrid JSON-based templates
- Template variables use format: `$$variable name$$`
- `send-email` Edge Function handles template rendering

**Adaptation Required**:
- Create **16 new SendGrid templates** in Bubble for each email scenario
- Map requirements placeholders to SendGrid template variables
- Use existing `send-email` Edge Function for delivery

### 2.2 Reminder System (NEW COMPONENT)

**Original Requirement**: "Reminder Templates (Expiring in 2 Hours)"

**Current Gap**: No cron job system exists for scheduled reminder emails

**Adaptation Required**:
- Create new Edge Function: `date-change-reminder-cron`
- Trigger via Supabase cron jobs (pg_cron or external scheduler)
- Query requests expiring in ~2 hours
- Send reminder notifications

### 2.3 Template Variable Mapping

**Requirements Template Structure**:
```
subject, warning, title, body_text_1, banner_text_1-5, body_text_2, button_text, button_url
```

**Current SendGrid Template Variables**:
```
toemail, fromemail, fromname, subject, preheadertext, title, bodytext,
buttontext, buttonurl, footermessage, bannertext1-5
```

**Mapping**:
| Requirements Field | SendGrid Variable | Notes |
|-------------------|-------------------|-------|
| subject | subject | Direct mapping |
| warning | preheadertext | Use for expiry notices |
| title | title | Direct mapping |
| body_text_1 | bodytext (first paragraph) | May need HTML <br> for paragraphs |
| banner_text_1-5 | bannertext1-5 | Direct mapping |
| body_text_2 | bodytext (append with <br><br>) | Combine paragraphs |
| button_text | buttontext | Direct mapping |
| button_url | buttonurl | Generated by system |

### 2.4 Notification Category

**Current System**: `notification_preferences` table has `reservation_updates` category

**Adaptation**: Use existing `reservation_updates` category for date change emails
- `reservation_updates_email`: Controls date change email notifications
- `reservation_updates_sms`: Controls date change SMS notifications

**No new category needed** - date changes are reservation updates.

### 2.5 Data Model Gaps

**Requirements Specify**:
- `price_adjustment` (e.g., "No Change", "+$50.00", "-$120.00")
- `additional_cost` (for dates added)
- `refund_amount` (for dates removed)
- `booking_reduction` (total reduction)
- `final_cost_for_night` (confirmed added date)
- `you_saved_amount` and `you_saved_percentage`
- `original_dates` and `proposed_new_dates` (formatted ranges)

**Current Database Schema** (`datechangerequest` table):
- `Price/Rate of the night` (single value)
- `%compared to regular nightly price` (percentage)
- `date added`, `date removed`
- No formatted date ranges
- No calculated price adjustments

**Adaptation Required**:
1. **Calculate price adjustments in Edge Function**:
   - Compare requested date price to original booking price
   - Generate "No Change", "+$X.XX", or "-$X.XX" strings
2. **Format date ranges** using booking/lease check-in/check-out dates
3. **Calculate savings** for add-date scenarios when discount is applied

---

## 3. Email Scenarios (16 Templates)

### 3.1 Reminder Templates (4) – Require Cron Job

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 4.1 | Host requested, waiting for guest, expiring soon | Host | Cron: 2 hours before expiry |
| 4.2 | Guest requested, host must respond, expiring soon | Host | Cron: 2 hours before expiry |
| 4.3 | Host requested, guest must respond, expiring soon | Guest | Cron: 2 hours before expiry |
| 4.4 | Guest requested, waiting for host, expiring soon | Guest | Cron: 2 hours before expiry |

### 3.2 Host-Initiated Add Date (2)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 5.1 | Confirmation of offer sent (add date) | Host | create action (isRequester=true) |
| 5.2 | Offer to add date | Guest | create action (isRequester=false) |

### 3.3 Host-Initiated Remove Date (2)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 6.1 | Confirmation of request sent (remove date) | Host | create action (isRequester=true) |
| 6.2 | Action required to remove date | Guest | create action (isRequester=false) |

### 3.4 Host-Initiated Swap Date (2)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 7.1 | Confirmation of date swap request sent | Host | create action (isRequester=true) |
| 7.2 | Action required on swap request | Guest | create action (isRequester=false) |

### 3.5 Guest-Initiated Requests (5)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 8.1 | Confirmation: request to add date sent | Guest | create action (isRequester=true) |
| 8.2 | Confirmation: request to remove date sent | Guest | create action (isRequester=true) |
| 8.3 | Action required: guest requested date removal | Host | create action (isRequester=false) |
| 8.4 | Action required: guest requested date swap | Host | create action (isRequester=false) |
| 8.5 | Confirmation: date swap request sent | Guest | create action (isRequester=true) |

### 3.6 Acceptance Emails (2)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 9.1 | Guest accepted host's add-date request | Guest | accept action (isRequester=false) |
| 9.2 | Guest accepted host's remove-date request | Host | accept action (isRequester=true) |

### 3.7 Decline Emails (2)

| # | Scenario | Recipient | Trigger |
|---|----------|-----------|---------|
| 10.1 | Host declined guest's add-date request | Guest | decline action (isRequester=true) |
| 10.2 | Host declined guest's add-date request (confirmation) | Host | decline action (isRequester=false) |

---

## 4. Placeholder Mappings

### 4.1 Actor Placeholders

| Placeholder | Database Field | Format |
|-------------|----------------|--------|
| `[Guest Name]` | `user.First Name` | From guest user record |
| `[Host Name]` | `user.First Name` | From host user record |
| `[Host's Name]` | `user.First Name` | From host user record |

### 4.2 Property Placeholders

| Placeholder | Database Field | Calculation |
|-------------|----------------|-------------|
| `[Property Name]` | `listings.Title` or `listings.Display Name` | From listing table via lease |
| `[Property Address/Name]` | `listings.Display Address` or title | Combined display string |
| `[Property Display]` | Computed field | "Address (Name)" or "Name" format |

### 4.3 Date Placeholders

| Placeholder | Database Field | Calculation Required |
|-------------|----------------|---------------------|
| `[Original Dates]` | `bookings_leases.check_in`, `check_out` | Format: "Jan 1-5, 2026" |
| `[Proposed New Dates]` | `datechangerequest.date added/removed` | Format: "Jan 6, 2026" |
| `[Date(s)]` | `datechangerequest.date added/removed` | Format: "Jan 6, 2026" or "Jan 6-8, 2026" |
| `[Date to Add]` | `datechangerequest.date added` | Format: "Jan 6, 2026" |
| `[Date to Remove]` | `datechangerequest.date removed` | Format: "Jan 6, 2026" |
| `[Date Added]` | `datechangerequest.date added` | Format: "Jan 6, 2026" |
| `[Date Removed]` | `datechangerequest.date removed` | Format: "Jan 6, 2026" |

### 4.4 Price Placeholders

| Placeholder | Database Field | Calculation Required |
|-------------|----------------|---------------------|
| `[Price Adjustment]` | **CALCULATED** | "No Change", "+$50.00", "-$120.00" |
| `[Price]` | `datechangerequest.Price/Rate of the night` | Format: "$50.00" |
| `[Additional Cost]` | `datechangerequest.Price/Rate of the night` | Format: "$50.00" |
| `[Refund Amount]` | `datechangerequest.Price/Rate of the night` | Format: "$120.00" |
| `[Booking Reduction]` | **CALCULATED** | Sum of all removed dates |
| `[Final Cost for This Night]` | `datechangerequest.Price/Rate of the night` | Format: "$50.00" |
| `[Amount]` | **CALCULATED** | Savings from discount |
| `[Percentage]` | `datechangerequest.%compared to regular` | Format: "20%" |

### 4.5 Request Metadata Placeholders

| Placeholder | Database Field | Format |
|-------------|----------------|-------|
| `[Time to Expiry]` | **CALCULATED** | "2 hours", "24 hours" |
| `[CTA Button URL]` | **GENERATED** | Magic link to lease page |

### 4.6 Message Placeholders

| Placeholder | Database Field | Conditional |
|-------------|----------------|-------------|
| `[Host's message content]` | `datechangerequest.Message from Requested by` | Only if host sent request |
| `[Guest's message content]` | `datechangerequest.Message from Requested by` | Only if guest sent request |

---

## 5. Implementation Summary

### 5.1 New Components Required

1. **16 SendGrid Templates** in Bubble (one per email scenario)
2. **Date Change Reminder Cron** Edge Function
3. **Price Calculation Utilities** in existing notification system
4. **Date Formatting Utilities** for ranges
5. **Property Display Builder** for address/name combinations

### 5.2 Modifications to Existing Code

1. **`notificationContent.ts`**: Expand to handle 16 scenarios (currently handles ~12)
2. **`notifications.ts`**: Add price/date calculations
3. **`send-email`**: No changes (already handles variable substitution)

### 5.3 Database Changes

**No schema changes required** - all data exists in current tables.
Calculations will be done in Edge Functions.

---

## 6. Template Creation Checklist

For each of the 16 email scenarios, create a SendGrid template in Bubble with:

- [ ] Template ID (Bubble format: `timestampxRandom`)
- [ ] Subject line (dynamic via `$$subject$$`)
- [ ] Preheader text (`$$preheadertext$$` for warnings)
- [ ] Title (`$$title$$`)
- [ ] Body text (`$$bodytext$$`)
- [ ] Banner text 1-5 (`$$bannertext1$$` through `$$bannertext5$$`)
- [ ] Button text (`$$buttontext$$`)
- [ ] Button URL (`$$buttonurl$$`)
- [ ] Footer message (`$$footermessage$$`)

---

## 7. Testing Requirements

1. **Unit Tests**: Price calculation logic
2. **Integration Tests**: Email sending with real templates
3. **E2E Tests**: Full request lifecycle with notifications
4. **Cron Tests**: Reminder job execution

---

## 8. Next Steps

See companion document: `date-change-emails-implementation-plan.md`
