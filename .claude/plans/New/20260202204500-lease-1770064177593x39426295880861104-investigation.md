# Lease Investigation Report: 1770064177593x39426295880861104

**Date**: 2026-02-02
**Project**: splitlease-backend-dev (qzsmhgyojmwvtjmnrdea)
**Status**: Multiple Issues Identified

---

## Executive Summary

Investigation of lease `1770064177593x39426295880861104` revealed **two categories of issues**:

1. **Edge Function Bug**: The `leases-admin` handleGet function fails due to incorrect FK expansion syntax
2. **Incomplete Lease Creation**: The lease was created but payment records, stays, and lease dates were NOT generated

---

## Issue 1: FK Expansion Error in leases-admin

### Symptom
The `handleGet` action in `leases-admin` Edge Function returns HTTP 500 with error:
```
Could not find a relationship between 'bookings_leases' and 'Guest' in the schema cache
```

### Root Cause
The `handleGet` function (lines 347-397 of `leases-admin/index.ts`) attempts to expand FK relationships that **do not exist**:

```typescript
const { data, error } = await _supabase
  .from('bookings_leases')
  .select(`
    *,
    guestData:Guest!inner(...),   // FAILS - No FK constraint exists
    hostData:Host!inner(...),      // FAILS - No FK constraint exists
    listingData:Listing!inner(...) // WORKS - FK exists
  `)
```

### Actual FK Constraints on `bookings_leases`

| Column | Has FK? | References |
|--------|---------|------------|
| `Cancellation Policy` | Yes | `zat_features_cancellationpolicy._id` |
| `Created By` | Yes | `user._id` |
| `Listing` | Yes | `listing._id` |
| `Proposal` | Yes | `proposal._id` |
| **`Guest`** | **NO** | (just stores user _id as text) |
| **`Host`** | **NO** | (just stores user _id as text) |

### Fix Required
The `handleGet` function must be rewritten to fetch related data in separate queries (like `handleList` already does correctly on lines 228-342).

**File**: `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\leases-admin\index.ts`

---

## Issue 2: Missing Related Data on Lease

### Lease Record Data

| Field | Value | Status |
|-------|-------|--------|
| `_id` | `1770064177593x39426295880861104` | OK |
| `Agreement Number` | `20260202-0002` | OK |
| `Proposal` | `1769130751870x21602817865937584` | OK |
| `Guest` | `1767918595624x88062023316464928` | OK |
| `Host` | `1769120384923x84418310030607120` | OK |
| `Listing` | `1769120385890x40357546134144976` | OK |
| `Reservation Period : Start` | `2026-02-09` | OK |
| `Reservation Period : End` | `2026-07-12` | OK |
| `Total Rent` | `32725` | OK |
| `Lease Status` | `Drafting` | OK |
| **`List of Stays`** | `[]` | **MISSING** |
| **`List of Booked Dates`** | `null` | **MISSING** |

### Related Records Check

| Table | Records Found | Expected |
|-------|---------------|----------|
| `paymentrecords` (for this lease) | **0** | Several payment records |
| `bookings_stays` (for this lease) | **0** | Several stays |

### Listing Data
- `_id`: `1769120385890x40357546134144976`
- `Name`: **"1 BR Entire Place - Test"** (NOT missing - frontend display issue)

### Proposal Data Available
The proposal `1769130751870x21602817865937584` has all required data:
- `check in day`: `0` (Sunday)
- `check out day`: `5` (Friday)
- `hc total price`: `32725`
- `hc reservation span (weeks)`: `22`
- `hc move in date`: `2026-02-09`
- `Days Selected`: `[0,1,2,3]`
- `Nights Selected`: `[0,1,2]`

---

## Issue 3: Why Data Was Not Generated

Looking at the `lease/handlers/create.ts` file, the lease creation flow should:

1. **Phase 6**: Call `triggerGuestPaymentRecords` and `triggerHostPaymentRecords`
2. **Phase 6B**: Generate lease dates via `generateLeaseDates`
3. **Phase 7**: Generate stays via `generateStays`

### Likely Causes

1. **Payment Records Edge Functions Not Called/Failed**
   - The Edge Function logs show NO calls to `guest-payment-records` or `host-payment-records`
   - Either the functions weren't invoked, or they failed silently

2. **Date Generation May Have Failed**
   - The `dateResult` could have been empty, causing no dates to be stored
   - The error handler (lines 445-457) catches errors but sets empty arrays

3. **Stays Not Generated**
   - `generateStays` depends on `dateResult` from Phase 6B
   - If dates were empty, no stays would be created

### Investigation Needed
- Check if `lease` Edge Function was called during creation
- The `leases-admin` logs show 500 errors but the creation was via a different path

---

## Recommended Fixes

### Fix 1: Update leases-admin handleGet (CRITICAL)

Replace the FK expansion query with separate queries:

```typescript
async function handleGet(
  payload: { leaseId: string },
  _supabase: SupabaseClient
) {
  const { leaseId } = payload;
  if (!leaseId) throw new Error('leaseId is required');

  // Fetch lease without FK expansion
  const { data: lease, error } = await _supabase
    .from('bookings_leases')
    .select('*')
    .eq('_id', leaseId)
    .single();

  if (error) throw new Error(`Failed to fetch lease: ${error.message}`);

  // Fetch related data separately
  let guestData = null;
  let hostData = null;
  let listingData = null;

  if (lease.Guest) {
    const { data } = await _supabase
      .from('user')
      .select('_id, "Name - Full", "Name - First", "Name - Last", "email as text", "Profile Photo"')
      .eq('_id', lease.Guest)
      .single();
    guestData = data;
  }

  if (lease.Host) {
    const { data } = await _supabase
      .from('user')
      .select('_id, "Name - Full", "Name - First", "Name - Last", "email as text", "Profile Photo"')
      .eq('_id', lease.Host)
      .single();
    hostData = data;
  }

  if (lease.Listing) {
    const { data } = await _supabase
      .from('listing')
      .select('_id, Name')
      .eq('_id', lease.Listing)
      .single();
    listingData = data;
  }

  // Fetch stays
  const { data: stays } = await _supabase
    .from('bookings_stays')
    .select('*')
    .eq('Lease', leaseId);

  return { ...lease, guestData, hostData, listingData, stays: stays || [] };
}
```

### Fix 2: Manual Data Generation for This Lease

Use the `leases-admin` actions to manually create the missing data:

1. **Create Stays**:
   ```json
   { "action": "createStays", "payload": { "leaseId": "1770064177593x39426295880861104" } }
   ```

2. **Update Booked Dates**:
   ```json
   { "action": "updateBookedDates", "payload": { "leaseId": "1770064177593x39426295880861104" } }
   ```

3. **Payment Records**: Need to investigate why `guest-payment-records` and `host-payment-records` weren't called

### Fix 3: Add FK Constraints (Optional - Schema Change)

If desired, add FK constraints for Guest and Host columns:

```sql
ALTER TABLE bookings_leases
ADD CONSTRAINT fk_bookings_leases_guest
FOREIGN KEY ("Guest") REFERENCES "user"(_id);

ALTER TABLE bookings_leases
ADD CONSTRAINT fk_bookings_leases_host
FOREIGN KEY ("Host") REFERENCES "user"(_id);
```

---

## Files Referenced

| File | Purpose |
|------|---------|
| `supabase/functions/leases-admin/index.ts` | Admin CRUD operations - contains the broken handleGet |
| `supabase/functions/lease/handlers/create.ts` | Lease creation workflow |
| `supabase/functions/lease/handlers/paymentRecords.ts` | Payment record generation triggers |
| `supabase/functions/lease/lib/staysGenerator.ts` | Stays generation logic |
| `supabase/functions/lease/lib/dateGenerator.ts` | Date generation logic |

---

## Action Items

- [ ] Fix `handleGet` in `leases-admin/index.ts` to use separate queries
- [ ] Deploy updated `leases-admin` Edge Function
- [ ] Manually create stays for lease using `createStays` action
- [ ] Manually update booked dates using `updateBookedDates` action
- [ ] Investigate why payment records weren't generated during lease creation
- [ ] Consider adding FK constraints for Guest/Host columns

---

## Summary

| Issue | Severity | Fix Complexity |
|-------|----------|----------------|
| FK expansion error in handleGet | HIGH | Low (code change) |
| Missing stays | MEDIUM | Low (use existing action) |
| Missing booked dates | MEDIUM | Low (use existing action) |
| Missing payment records | HIGH | Medium (needs investigation) |
| "Unnamed Listing" display | LOW | Frontend issue - listing name exists |
