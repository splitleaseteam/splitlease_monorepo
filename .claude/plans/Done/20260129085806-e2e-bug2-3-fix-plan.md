# Fix Plan: Bugs #2 and #3 - Database 400 Errors

**Created**: 2026-01-29 08:58:06
**Bugs**: #2 (`visit` table), #3 (`virtualmeetingschedulesandlinks` table)
**Severity**: Low (non-blocking, console clutter only)
**Status**: Planning

---

## Bug Summary

### Bug #2: Database 400 Error - `visit` Table
**Error**: 400 Bad Request when querying `visit` table
**Query**: `https://.../rest/v1/visit?select=_id&Guest=eq.{userId}`
**Impact**: Console errors, no functional impact on user journey

### Bug #3: Database 400 Error - `virtualmeetingschedulesandlinks` Table
**Error**: 400 Bad Request when querying `virtualmeetingschedulesandlinks` table
**Query**: `https://.../rest/v1/virtualmeetingschedulesandlinks?select=_id&or=(Guest.eq.{userId},Host.eq.{userId})`
**Impact**: Console errors, no functional impact on user journey

---

## Root Cause Analysis

### Affected File
**Location**: `app/src/islands/shared/LoggedInAvatar/useLoggedInAvatarData.js`

**Bug #2 - Lines 172-175**:
```javascript
// 3. Count visits for this user (as guest)
supabase
  .from('visit')
  .select('_id', { count: 'exact', head: true })
  .eq('Guest', userId),
```

**Bug #3 - Lines 178-181**:
```javascript
// 4. Count virtual meetings for this user
supabase
  .from('virtualmeetingschedulesandlinks')
  .select('_id', { count: 'exact', head: true })
  .or(`Guest.eq.${userId},Host.eq.${userId}`),
```

### Possible Root Causes

1. **Tables Don't Exist**: These tables may be legacy Bubble.io tables that haven't been migrated to Supabase yet
2. **RLS Policies Too Restrictive**: Row Level Security policies may be blocking the query
3. **Column Names Changed**: The `Guest` and `Host` columns may have been renamed during migration
4. **Authentication Timing**: Query might be executing before user is fully authenticated

### Evidence

- The queries use HEAD requests (`head: true`), only checking for count, not fetching data
- Column names `Guest` and `Host` are used in other queries successfully (e.g., proposal table)
- Other similar files (e.g., `useAiToolsPageLogic.js`) successfully query the `visit` table with the same column names
- Error is 400 (Bad Request), not 403 (Forbidden) - suggests query syntax issue or missing table, not permission issue

### Most Likely Cause

**Tables don't exist in Supabase database** - These are legacy Bubble tables that either:
- Haven't been created in Supabase yet
- Were created but later dropped
- Are in a different schema/project

---

## Fix Strategy

### Option 1: Graceful Error Handling (RECOMMENDED - Quick Fix)

**Approach**: Wrap the queries in try-catch blocks and default to count = 0 on error

**Pros**:
- Quick to implement (< 5 minutes)
- No risk of breaking existing functionality
- Removes console clutter
- Still attempts the query if tables are added later

**Cons**:
- Doesn't fix the underlying issue (tables missing)
- Counts will always be 0 for these features

**Implementation**:
1. Wrap `visit` and `virtualmeetingschedulesandlinks` queries in try-catch
2. Default to `count: 0` on error
3. Log warning (not error) if query fails
4. Continue with rest of data fetching

### Option 2: Table Existence Check (Medium Fix)

**Approach**: Check if tables exist before querying

**Pros**:
- Cleaner than try-catch
- Could provide helpful migration status to developers

**Cons**:
- Requires additional query to check table existence
- More complex implementation

### Option 3: Create Missing Tables (Long-term Fix)

**Approach**: Create the `visit` and `virtualmeetingschedulesandlinks` tables in Supabase

**Pros**:
- Fixes root cause
- Enables features that depend on these tables

**Cons**:
- Requires understanding full schema from Bubble
- Need to migrate data if it exists in Bubble
- Time-consuming (not appropriate for quick bug fix)

---

## Recommended Fix: Option 1 (Graceful Error Handling)

### Step-by-Step Implementation

#### Step 1: Wrap `visit` Table Query (Lines 172-175)

**Before**:
```javascript
// 3. Count visits for this user (as guest)
supabase
  .from('visit')
  .select('_id', { count: 'exact', head: true })
  .eq('Guest', userId),
```

**After**:
```javascript
// 3. Count visits for this user (as guest)
// NOTE: visit table may not exist in Supabase yet (legacy Bubble table)
// Gracefully handle 400 errors by defaulting to count = 0
supabase
  .from('visit')
  .select('_id', { count: 'exact', head: true })
  .eq('Guest', userId)
  .then(result => {
    // If table doesn't exist or query fails, return count = 0
    if (result.error) {
      console.warn('[useLoggedInAvatarData] visit table query failed (table may not exist):', result.error.message);
      return { count: 0, error: null }; // Override error with safe default
    }
    return result;
  }),
```

#### Step 2: Wrap `virtualmeetingschedulesandlinks` Table Query (Lines 178-181)

**Before**:
```javascript
// 4. Count virtual meetings for this user
supabase
  .from('virtualmeetingschedulesandlinks')
  .select('_id', { count: 'exact', head: true })
  .or(`Guest.eq.${userId},Host.eq.${userId}`),
```

**After**:
```javascript
// 4. Count virtual meetings for this user
// NOTE: virtualmeetingschedulesandlinks table may not exist in Supabase yet (legacy Bubble table)
// Gracefully handle 400 errors by defaulting to count = 0
supabase
  .from('virtualmeetingschedulesandlinks')
  .select('_id', { count: 'exact', head: true })
  .or(`Guest.eq.${userId},Host.eq.${userId}`)
  .then(result => {
    // If table doesn't exist or query fails, return count = 0
    if (result.error) {
      console.warn('[useLoggedInAvatarData] virtualmeetingschedulesandlinks table query failed (table may not exist):', result.error.message);
      return { count: 0, error: null }; // Override error with safe default
    }
    return result;
  }),
```

#### Step 3: Update Error Handling in Data Processing (Lines 361-367)

**No changes needed** - The existing code already handles `count || 0`, so if count is undefined or null, it defaults to 0:

```javascript
const newData = {
  // ... other fields
  visitsCount: visitsResult.count || 0,  // Already safe
  virtualMeetingsCount: virtualMeetingsResult.count || 0,  // Already safe
  // ... other fields
};
```

---

## Testing Plan

### Pre-Fix Verification
1. Navigate to http://localhost:3000
2. Open browser console
3. Verify 400 errors appear for `visit` and `virtualmeetingschedulesandlinks` tables

### Post-Fix Verification
1. Apply the fix to `useLoggedInAvatarData.js`
2. Refresh the page (hard refresh: Ctrl+Shift+R)
3. Open browser console
4. Verify:
   - ✅ No 400 errors for `visit` table
   - ✅ No 400 errors for `virtualmeetingschedulesandlinks` table
   - ✅ Warning messages appear instead (console.warn)
   - ✅ User menu loads correctly
   - ✅ No broken functionality

### Regression Testing
1. Verify menu items still show/hide correctly based on user data
2. Check that unread messages count still works
3. Verify proposals count displays correctly
4. Ensure no new errors introduced

---

## Files to Modify

1. **`app/src/islands/shared/LoggedInAvatar/useLoggedInAvatarData.js`**
   - Lines 172-175: Wrap `visit` table query
   - Lines 178-181: Wrap `virtualmeetingschedulesandlinks` table query

---

## Success Criteria

- ✅ No 400 errors in console for `visit` table
- ✅ No 400 errors in console for `virtualmeetingschedulesandlinks` table
- ✅ Console shows warning messages instead (console.warn)
- ✅ `visitsCount` defaults to 0
- ✅ `virtualMeetingsCount` defaults to 0
- ✅ User menu functionality unchanged
- ✅ No regression in other features

---

## Long-Term Recommendations

1. **Create Migration for `visit` Table**: If visits functionality is needed, create proper Supabase table with schema:
   - `_id` (primary key)
   - `Guest` (foreign key to user table)
   - `house manual` (foreign key to house manual)
   - `Created Date` (timestamp)
   - Other fields as needed

2. **Create Migration for `virtualmeetingschedulesandlinks` Table**: If virtual meetings functionality is needed, create proper Supabase table with schema:
   - `_id` (primary key)
   - `Guest` (foreign key to user table)
   - `Host` (foreign key to user table)
   - Other fields as needed

3. **Document Legacy Tables**: Maintain a list of Bubble tables that haven't been migrated yet and their migration status

4. **RLS Policies**: Ensure proper Row Level Security policies are in place when tables are created

---

## Risk Assessment

**Risk Level**: **Very Low**

- Changes are minimal (adding error handling)
- Existing `|| 0` fallback already handles undefined counts
- Warning messages provide visibility without breaking functionality
- Easy to revert if issues arise

---

## Implementation Time Estimate

- **Planning**: ✅ Complete
- **Implementation**: ~5 minutes
- **Testing**: ~5 minutes
- **Total**: ~10 minutes

---

## Related Issues

- Bug #2: Database 400 Error - `visit` table
- Bug #3: Database 400 Error - `virtualmeetingschedulesandlinks` table
- E2E Test Report: `.claude/plans/Documents/20260128165349-e2e-test-report.md`
