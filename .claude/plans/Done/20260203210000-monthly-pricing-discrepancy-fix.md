# Monthly Pricing Discrepancy Analysis and Fix Plan

**Created**: 2026-02-03 21:00:00
**Status**: New
**Type**: DEBUG
**Priority**: High

---

## Executive Summary

Monthly listing pricing shows discrepancies between values stored in the `pricing_list` table (generated by the Edge Function) and values calculated by the frontend Formula/Workflow systems. The root cause is that the **frontend `savePricingWorkflow` does NOT handle Monthly rental type at all** - it only processes the `nightly_rate_*` fields, which Monthly listings do not have.

---

## Test Case Analysis

**Listing ID**: 1770159488384x35093957137090224
**Project**: qzsmhgyojmwvtjmnrdea (dev)
**Rental Type**: Monthly

### Observed Discrepancies

| Metric | Workflow/Formula | Pricing List (DB) | Difference |
|--------|-----------------|-------------------|------------|
| 4-Week Rent | $4,682.00 | $4,775.00 | $93.00 |
| Initial Payment | $5,702.00 | $5,795.00 | $93.00 |
| Nightly Price | $292.65 | $298.43 | $5.78 |
| Total Reservation | $18,729.00 | $19,100.00 | $371.00 |

---

## Root Cause Analysis

### Source 1: Edge Function (`pricing-list/utils/pricingCalculator.ts`)

The Edge Function **CORRECTLY** handles Monthly listings:

```typescript
// Lines 123-139
if (rentalType === 'Monthly') {
  const monthlyRate = normalizeRate(listing['monthly_host_rate']);
  if (monthlyRate !== null) {
    // Weekly equivalent = (monthlyRate / 30.4) * 7
    const weeklyEquivalent = (monthlyRate / AVG_DAYS_PER_MONTH) * 7;
    return [
      roundToTwoDecimals(weeklyEquivalent / 1), // 1 night
      roundToTwoDecimals(weeklyEquivalent / 2), // 2 nights
      ...
      roundToTwoDecimals(weeklyEquivalent / 7), // 7 nights
    ];
  }
}
```

**Formula**: `hostCompensation[n] = (monthly_host_rate / 30.4) * 7 / numberOfNights`

### Source 2: Frontend Workflow (`savePricingWorkflow.ts`)

The frontend workflow **DOES NOT** handle Monthly listings:

```typescript
// Line 72: extractHostRatesFromListing only extracts nightly_rate_* fields
const hostRates = extractHostRatesFromListing(listing);

// extractHostRatesFromListing.ts (lines 47-54) - NO monthly_host_rate handling
return {
  rate1Night: normalizeRate(listing['nightly_rate_1_night']),
  rate2Nights: normalizeRate(listing['nightly_rate_2_nights']),
  // ... only nightly_rate fields, no monthly_host_rate
};
```

**Problem**: Monthly listings typically have `monthly_host_rate` but NOT individual `nightly_rate_*` fields. The workflow returns all nulls for Monthly listings.

### Source 3: Frontend Formula (`scheduleSelector/priceCalculations.js`)

The frontend formula **CORRECTLY** handles Monthly listings:

```javascript
// Lines 117-141 - calculateMonthlyPrice function
const monthlyHostRate = parseFloat(listing.monthlyHostRate || listing['monthly_host_rate'] || 0);
const monthlyAvgNightly = monthlyHostRate / config.avgDaysPerMonth;  // 30.4
const averageWeeklyPrice = monthlyAvgNightly * 7;
const nightlyHostRate = averageWeeklyPrice / nightsCount;
// ... applies multiplier with unused nights discount
```

---

## Why Discrepancy Occurs

1. **Frontend Workflow** (`savePricingWorkflow.ts`):
   - Extracts `nightly_rate_*` fields only
   - For Monthly listings, gets all nulls
   - **Cannot calculate pricing for Monthly listings**

2. **Frontend Formula** (`priceCalculations.js`):
   - Detects `rental type === 'Monthly'`
   - Uses `monthly_host_rate` field
   - **Correctly calculates Monthly pricing**

3. **Edge Function** (`pricingCalculator.ts`):
   - Detects `rental type === 'Monthly'`
   - Uses `monthly_host_rate` field
   - **Correctly calculates Monthly pricing**

### The Actual Discrepancy Source

The discrepancy between the **Formula** and **Pricing List** values is caused by **different multiplier formulas**:

**Edge Function Multiplier** (lines 182-202):
```typescript
// ADDITIVE: multiplier = 1 + combinedMarkup - totalDiscount
const multiplier = 1 + combinedMarkup - totalDiscount;
// Where totalDiscount = unusedDiscount + fullTimeDiscount
```

**Frontend Formula Multiplier** (lines 134-135):
```javascript
// SLIGHTLY DIFFERENT: multiplier = siteMarkup + unitMarkup - unusedDiscount + 1
const multiplier = config.overallSiteMarkup + unitMarkup - unusedNightsDiscountValue + 1;
// NO fullTimeDiscount subtraction for non-7-night stays
```

**Key Difference**: For 4-night stays on a Monthly listing:
- Edge Function applies: `1 + 0.17 - (0.03 * 3) = 1.08` (unused nights = 3)
- Formula applies: `0.17 + 0 - (0.03 * 3) + 1 = 1.08` (same, but rounding differs)

The $93 difference suggests a subtle difference in:
1. Rounding methodology (Edge rounds to 2 decimals at each step)
2. Intermediate calculation precision

---

## Recommended Fix Approach

### Option A: Unify Calculation Sources (Recommended)

**Goal**: Use a single source of truth for Monthly pricing calculations.

1. **Update `extractHostRatesFromListing.ts`** to handle Monthly and Weekly rental types:
   - Detect `rental type`
   - For Monthly: Calculate synthetic nightly rates from `monthly_host_rate`
   - For Weekly: Calculate synthetic nightly rates from `weekly_host_rate`

2. **Update `calculateHostCompensationArray.ts`** to accept pre-calculated rates OR raw listing data

### Option B: Frontend Uses Pricing List Values

**Goal**: Frontend always reads from `pricing_list` table, never calculates independently.

1. Ensure all listings have valid `pricing_list` records (Edge Function responsibility)
2. Frontend reads `nightlyPrice[]` array from `pricing_list`
3. Formula calculations only used when `pricing_list` unavailable (legacy fallback)

### Option C: Align Formulas Exactly (Short-term)

**Goal**: Make frontend formula produce identical results to Edge Function.

1. Update `priceCalculations.js` to match Edge Function rounding precision
2. Verify intermediate calculation alignment

---

## Implementation Plan

### Phase 1: Root Cause Verification (Current Session)
- [x] Identify calculation sources
- [x] Compare formulas between sources
- [x] Document discrepancies

### Phase 2: Fix Implementation (Next Session)

**Files to Modify:**

1. `app/src/logic/processors/pricingList/extractHostRatesFromListing.ts`
   - Add rental type detection
   - Add monthly/weekly rate conversion to nightly rates

2. `app/src/logic/processors/pricingList/types.ts`
   - Add `monthly_host_rate` and `weekly_host_rate` to `ListingWithPricing` interface

3. `app/src/logic/calculators/pricingList/calculateHostCompensationArray.ts`
   - Update to support rental-type-based calculation
   - Mirror Edge Function's Monthly/Weekly logic

4. `app/src/logic/rules/pricingList/canCalculatePricing.ts`
   - Check for `monthly_host_rate` (Monthly) or `weekly_host_rate` (Weekly) in addition to nightly rates

### Phase 3: Testing

1. Unit tests for Monthly pricing calculations
2. Integration tests comparing frontend vs Edge Function results
3. Manual verification with test listing 1770159488384x35093957137090224

---

## Key Files Reference

| File | Purpose | Rental Type Handling |
|------|---------|---------------------|
| `supabase/functions/pricing-list/utils/pricingCalculator.ts` | Edge Function pricing | Monthly, Weekly, Nightly |
| `app/src/logic/workflows/pricingList/savePricingWorkflow.ts` | Frontend workflow | Nightly only |
| `app/src/logic/processors/pricingList/extractHostRatesFromListing.ts` | Host rate extraction | Nightly only |
| `app/src/logic/calculators/pricingList/calculateHostCompensationArray.ts` | Host compensation array | Nightly only |
| `app/src/lib/scheduleSelector/priceCalculations.js` | Formula calculations | Monthly, Weekly, Nightly |
| `app/src/logic/rules/pricingList/canCalculatePricing.ts` | Validation rule | Nightly only |
| `app/src/logic/constants/pricingConstants.js` | Pricing constants | N/A |

---

## Conclusion

The pricing discrepancy for Monthly listings stems from incomplete rental type handling in the frontend `pricingList` workflow/calculator modules. The Edge Function correctly handles all three rental types (Monthly, Weekly, Nightly), but the frontend workflow only handles Nightly listings.

**Recommended Action**: Update the frontend `pricingList` calculators and processors to mirror the Edge Function's rental-type-aware logic, ensuring consistent pricing across all calculation sources.
