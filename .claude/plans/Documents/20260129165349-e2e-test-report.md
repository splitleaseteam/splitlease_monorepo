# E2E Test Report: Pricing List Structure Creation

## Executive Summary

This document provides a comprehensive E2E testing strategy for systematically testing listing creation across all rental types (Nightly, Weekly, Monthly) and debugging the pricing list structure creation using Playwright MCP and Supabase MCP.

---

## Table of Contents

1. [Test Objectives](#test-objectives)
2. [Prerequisites](#prerequisites)
3. [Test Scenarios](#test-scenarios)
4. [Systematic Approach](#systematic-approach)
5. [Agent Orchestration Workflow](#agent-orchestration-workflow)
6. [Playwright MCP Test Scripts](#playwright-mcp-test-scripts)
7. [Supabase MCP Debug Queries](#supabase-mcp-debug-queries)
8. [Pricing List Structure Reference](#pricing-list-structure-reference)
9. [Validation Checklist](#validation-checklist)
10. [File References](#file-references)

---

## Test Objectives

### Primary Goals
1. **Validate listing creation** for all three rental types (Nightly, Weekly, Monthly)
2. **Debug pricing_list table structure** - Ensure correct array generation
3. **Verify host compensation calculations** - 7-element arrays for nights 1-7
4. **Confirm guest-facing nightly prices** - Search page display accuracy
5. **Fix any structural issues** in pricing list creation workflow

### Success Criteria
- [ ] Nightly listing creates correct `pricing_list` with 7-element arrays
- [ ] Weekly listing creates correct prorated nightly rates
- [ ] Monthly listing creates correct monthly-to-nightly conversion
- [ ] All listings appear correctly in search results with accurate prices
- [ ] Host compensation matches expected calculations

---

## Prerequisites

### Environment Setup
```bash
# Ensure dev server is running
bun run dev  # http://localhost:8000

# Supabase Edge Functions (if testing API directly)
supabase functions serve
```

### Test User Credentials
- Use existing test host account OR create new via auth flow
- Ensure user has `user_type: 'host'` in database

### Required MCP Servers
- **Playwright MCP** - Browser automation
- **Supabase MCP** - Database queries (target: `splitlease-backend-dev`)

---

## Test Scenarios

### Scenario 1: Nightly Listing Creation

**Input Data:**
```javascript
{
  rentalType: 'Nightly',
  nightlyPricing: {
    oneNightPrice: 100,    // Host compensation for 1 night
    twoNightPrice: 95,     // Host compensation for 2 nights
    threeNightPrice: 90,
    fourNightPrice: 85,
    fiveNightPrice: 80,
    sixNightPrice: 75,
    sevenNightPrice: 70    // Full-time (7 nights)
  },
  damageDeposit: 500,
  minNights: 2,
  maxNights: 7
}
```

**Expected pricing_list Structure:**
```javascript
{
  "Host Compensation": [null, 100, 95, 90, 85, 80, 75, 70],  // Index 0=unused, 1-7=nights
  "Nightly Price": [null, 117, 111, 105, 100, 94, 88, 82],   // With 17% markup
  "Unused Nights Discount": [0, 0, 0.03, 0.06, 0.09, 0.12, 0.15, 0],
  "rental type": "Nightly",
  "Combined Markup": 0.17,
  "Full Time Discount": 0.13
}
```

### Scenario 2: Weekly Listing Creation

**Input Data:**
```javascript
{
  rentalType: 'Weekly',
  weeklyCompensation: 500,  // Host compensation per week
  damageDeposit: 500,
  minWeeks: 1,
  maxWeeks: 4
}
```

**Expected pricing_list Structure:**
```javascript
{
  "Host Compensation": [null, 71.43, 71.43, 71.43, 71.43, 71.43, 71.43, 71.43], // 500/7 per night
  "Nightly Price": [null, 83.57, 83.57, 83.57, 83.57, 83.57, 83.57, 83.57],     // With markup
  "rental type": "Weekly",
  "Weekly Price Adjust": 0.85,
  "Combined Markup": 0.17
}
```

### Scenario 3: Monthly Listing Creation

**Input Data:**
```javascript
{
  rentalType: 'Monthly',
  monthlyCompensation: 2000,  // Host compensation per month
  damageDeposit: 500,
  minMonths: 1,
  maxMonths: 6
}
```

**Expected pricing_list Structure:**
```javascript
{
  "Host Compensation": [null, 66.67, 66.67, 66.67, 66.67, 66.67, 66.67, 66.67], // 2000/30 per night
  "Nightly Price": [null, 78.00, 78.00, 78.00, 78.00, 78.00, 78.00, 78.00],     // With markup
  "rental type": "Monthly",
  "Combined Markup": 0.17
}
```

---

## Systematic Approach

### Phase 1: Pre-Test Database Snapshot

```
1. Query existing pricing_list records for comparison baseline
2. Note current listing count for test user
3. Capture ZAT configuration (site markup, discounts)
```

### Phase 2: Sequential Listing Creation (Playwright)

```
FOR EACH rental_type IN ['Nightly', 'Weekly', 'Monthly']:
  1. Navigate to /host-my-space
  2. Complete SelfListingPage wizard (Sections 1-7)
  3. Submit listing
  4. Capture listing._id from response
  5. Wait for pricing_list creation (async process)
  6. Query pricing_list for new listing
  7. Validate structure against expected schema
  8. Log discrepancies
```

### Phase 3: Post-Creation Validation (Supabase MCP)

```
FOR EACH created_listing:
  1. Query pricing_list by listing FK
  2. Validate array lengths (should be 8: index 0-7)
  3. Validate Host Compensation values
  4. Validate Nightly Price calculations
  5. Validate markup/discount multipliers
  6. Cross-reference with ZAT config
```

### Phase 4: Unit Price Test Page Verification

```
FOR EACH created_listing:
  1. Navigate to /_internal/z-pricing-unit-test
  2. Search for listing by ID
  3. View Section 10: Pricing List Grid
  4. Compare displayed values vs database
  5. Run "Run Price List" calculation
  6. Compare workflow vs formula results (Section 11)
  7. Check validation flags (Section 12)
```

---

## Agent Orchestration Workflow

### Master Orchestration Prompt

```markdown
# E2E Pricing List Test Orchestration

## Mission
Execute systematic E2E testing of listing creation for all rental types and debug pricing list structure creation.

## Phase Sequence

### Phase 1: Environment Verification
**Agent**: mcp-tool-specialist (Supabase MCP)
**Actions**:
1. Query `zat_config` table for current pricing configuration
2. Query `pricing_list` table to get baseline count
3. Query test user's existing listings
**Output**: Environment snapshot JSON

### Phase 2: Nightly Listing Creation
**Agent**: mcp-tool-specialist (Playwright MCP)
**Actions**:
1. Navigate to http://localhost:8000/host-my-space
2. Complete listing creation wizard with NIGHTLY data
3. Submit and capture listing ID
**Output**: Nightly listing ID

### Phase 3: Nightly Pricing Validation
**Agent**: mcp-tool-specialist (Supabase MCP)
**Actions**:
1. Query pricing_list WHERE listing = [nightly_listing_id]
2. Validate array structure and calculations
**Output**: Validation report

### Phase 4: Weekly Listing Creation
**Agent**: mcp-tool-specialist (Playwright MCP)
**Actions**: Same as Phase 2 with WEEKLY data
**Output**: Weekly listing ID

### Phase 5: Weekly Pricing Validation
**Agent**: mcp-tool-specialist (Supabase MCP)
**Actions**: Same as Phase 3 for weekly listing
**Output**: Validation report

### Phase 6: Monthly Listing Creation
**Agent**: mcp-tool-specialist (Playwright MCP)
**Actions**: Same as Phase 2 with MONTHLY data
**Output**: Monthly listing ID

### Phase 7: Monthly Pricing Validation
**Agent**: mcp-tool-specialist (Supabase MCP)
**Actions**: Same as Phase 3 for monthly listing
**Output**: Validation report

### Phase 8: Unit Test Page Cross-Validation
**Agent**: mcp-tool-specialist (Playwright MCP)
**Actions**:
1. Navigate to /_internal/z-pricing-unit-test
2. Test each listing in Section 10 grid
3. Run workflow check (Section 11)
**Output**: Cross-validation report

### Phase 9: Fix Implementation (if issues found)
**Agent**: implementation-planner → plan-executor
**Actions**:
1. Analyze validation failures
2. Create fix plan
3. Execute fixes
**Output**: Fixed code + changelog

### Phase 10: Regression Test
**Agent**: mcp-tool-specialist (Playwright + Supabase)
**Actions**: Re-run Phases 2-7 to confirm fixes
**Output**: Final validation report
```

---

## Playwright MCP Test Scripts

### Test Script 1: Navigate to Listing Creation

```javascript
// Playwright MCP - Navigate to host-my-space
await mcp__playwright__browser_navigate({ url: 'http://localhost:8000/host-my-space' });
await mcp__playwright__browser_snapshot({});
```

### Test Script 2: Complete Section 1 (Space Snapshot)

```javascript
// After snapshot, fill Section 1 fields
// Find and fill address input
await mcp__playwright__browser_type({
  ref: '[address-input-ref]',
  text: '123 Test Street, New York, NY 10001',
  element: 'Address input field'
});

// Select space type
await mcp__playwright__browser_click({
  ref: '[entire-place-option-ref]',
  element: 'Entire place option'
});

// Fill bedroom count
await mcp__playwright__browser_type({
  ref: '[bedroom-count-ref]',
  text: '2',
  element: 'Bedroom count'
});

// Continue to next section
await mcp__playwright__browser_click({
  ref: '[continue-button-ref]',
  element: 'Continue button'
});
```

### Test Script 3: Complete Section 4 (Pricing - NIGHTLY)

```javascript
// Select Nightly rental type
await mcp__playwright__browser_click({
  ref: '[nightly-card-ref]',
  element: 'Nightly rental type card'
});

// Fill nightly prices using slider or inputs
await mcp__playwright__browser_fill_form({
  fields: [
    { name: 'One night price', type: 'textbox', ref: '[one-night-price-ref]', value: '100' },
    { name: 'Two night price', type: 'textbox', ref: '[two-night-price-ref]', value: '95' },
    { name: 'Three night price', type: 'textbox', ref: '[three-night-price-ref]', value: '90' },
    { name: 'Four night price', type: 'textbox', ref: '[four-night-price-ref]', value: '85' },
    { name: 'Five night price', type: 'textbox', ref: '[five-night-price-ref]', value: '80' },
    { name: 'Six night price', type: 'textbox', ref: '[six-night-price-ref]', value: '75' },
    { name: 'Seven night price', type: 'textbox', ref: '[seven-night-price-ref]', value: '70' },
    { name: 'Damage deposit', type: 'textbox', ref: '[damage-deposit-ref]', value: '500' }
  ]
});

// Continue to next section
await mcp__playwright__browser_click({
  ref: '[continue-button-ref]',
  element: 'Continue button'
});
```

### Test Script 4: Complete Section 4 (Pricing - WEEKLY)

```javascript
// Select Weekly rental type
await mcp__playwright__browser_click({
  ref: '[weekly-card-ref]',
  element: 'Weekly rental type card'
});

// Fill weekly compensation
await mcp__playwright__browser_fill_form({
  fields: [
    { name: 'Weekly compensation', type: 'textbox', ref: '[weekly-comp-ref]', value: '500' },
    { name: 'Damage deposit', type: 'textbox', ref: '[damage-deposit-ref]', value: '500' },
    { name: 'Min weeks', type: 'textbox', ref: '[min-weeks-ref]', value: '1' },
    { name: 'Max weeks', type: 'textbox', ref: '[max-weeks-ref]', value: '4' }
  ]
});
```

### Test Script 5: Complete Section 4 (Pricing - MONTHLY)

```javascript
// Select Monthly rental type
await mcp__playwright__browser_click({
  ref: '[monthly-card-ref]',
  element: 'Monthly rental type card'
});

// Fill monthly compensation
await mcp__playwright__browser_fill_form({
  fields: [
    { name: 'Monthly compensation', type: 'textbox', ref: '[monthly-comp-ref]', value: '2000' },
    { name: 'Damage deposit', type: 'textbox', ref: '[damage-deposit-ref]', value: '500' },
    { name: 'Min months', type: 'textbox', ref: '[min-months-ref]', value: '1' },
    { name: 'Max months', type: 'textbox', ref: '[max-months-ref]', value: '6' }
  ]
});
```

### Test Script 6: Unit Price Test Page Verification

```javascript
// Navigate to internal test page
await mcp__playwright__browser_navigate({ url: 'http://localhost:8000/_internal/z-pricing-unit-test' });
await mcp__playwright__browser_snapshot({});

// Search for listing by ID
await mcp__playwright__browser_type({
  ref: '[listing-search-input-ref]',
  text: '[LISTING_ID]',
  element: 'Listing search input'
});

await mcp__playwright__browser_click({
  ref: '[search-button-ref]',
  element: 'Search button'
});

// Wait for results and select listing
await mcp__playwright__browser_wait_for({ text: 'Host Compensation' });

// Take screenshot of pricing grid
await mcp__playwright__browser_take_screenshot({
  type: 'png',
  filename: 'pricing-grid-[RENTAL_TYPE].png'
});

// Run pricing calculation
await mcp__playwright__browser_click({
  ref: '[run-price-list-button-ref]',
  element: 'Run Price List button'
});

// Check workflow comparison (Section 11)
await mcp__playwright__browser_snapshot({});
```

---

## Supabase MCP Debug Queries

### Query 1: Get ZAT Configuration

```sql
SELECT * FROM zat_config ORDER BY created_at DESC LIMIT 1;
```

**Expected Fields:**
- `site_markup` (0.17)
- `full_time_discount` (0.13)
- `unused_nights_discount_multiplier` (0.03)

### Query 2: Get Pricing List for Listing

```sql
SELECT
  _id,
  listing,
  "rental type",
  "Host Compensation",
  "Nightly Price",
  "Unused Nights Discount",
  "Markup and Discount Multiplier",
  "Combined Markup",
  "Unit Markup",
  "Overall Site Markup",
  "Full Time Discount",
  "Starting Nightly Price",
  "Slope",
  "Weekly Price Adjust"
FROM pricing_list
WHERE listing = '[LISTING_ID]';
```

### Query 3: Validate Array Lengths

```sql
SELECT
  _id,
  listing,
  "rental type",
  array_length("Host Compensation", 1) as host_comp_length,
  array_length("Nightly Price", 1) as nightly_price_length,
  array_length("Unused Nights Discount", 1) as discount_length,
  array_length("Markup and Discount Multiplier", 1) as multiplier_length
FROM pricing_list
WHERE listing = '[LISTING_ID]';
```

**Expected**: All arrays should have length 8 (index 0-7)

### Query 4: Compare Host Compensation vs Expected

```sql
-- For NIGHTLY listing with input [100, 95, 90, 85, 80, 75, 70]
SELECT
  listing,
  "Host Compensation"[2] as night_1_actual,  -- Should be 100
  "Host Compensation"[3] as night_2_actual,  -- Should be 95
  "Host Compensation"[4] as night_3_actual,  -- Should be 90
  "Host Compensation"[5] as night_4_actual,  -- Should be 85
  "Host Compensation"[6] as night_5_actual,  -- Should be 80
  "Host Compensation"[7] as night_6_actual,  -- Should be 75
  "Host Compensation"[8] as night_7_actual   -- Should be 70
FROM pricing_list
WHERE listing = '[LISTING_ID]';
```

### Query 5: Validate Nightly Price Calculations

```sql
-- Nightly Price = Host Compensation × (1 + Combined Markup) × (1 - Unused Nights Discount)
SELECT
  listing,
  "Host Compensation"[2] as host_1,
  "Combined Markup" as markup,
  "Unused Nights Discount"[2] as discount_1,
  "Nightly Price"[2] as actual_price_1,
  ROUND("Host Compensation"[2] * (1 + "Combined Markup") * (1 - "Unused Nights Discount"[2]), 2) as expected_price_1
FROM pricing_list
WHERE listing = '[LISTING_ID]';
```

### Query 6: Get All Test Listings

```sql
SELECT
  l._id,
  l.title,
  l."rental type",
  l.created_date,
  pl."Host Compensation",
  pl."Nightly Price"
FROM listing l
LEFT JOIN pricing_list pl ON pl.listing = l._id
WHERE l.creator = '[TEST_USER_ID]'
ORDER BY l.created_date DESC
LIMIT 10;
```

---

## Pricing List Structure Reference

### Array Index Mapping

| Array Index | Night Count | Description |
|-------------|-------------|-------------|
| 0 | N/A | Unused (null placeholder) |
| 1 | 1 night | Single night rate |
| 2 | 2 nights | Weekend rate |
| 3 | 3 nights | Short stay |
| 4 | 4 nights | Mid-week |
| 5 | 5 nights | Extended stay |
| 6 | 6 nights | Near full-time |
| 7 | 7 nights | Full-time (full week) |

### Calculation Formulas

**Host Compensation Array** (input from form):
```
Nightly: Direct input from price slider
Weekly: weeklyCompensation / 7 (same for all indices)
Monthly: monthlyCompensation / 30 (same for all indices)
```

**Unused Nights Discount Array**:
```
discount[n] = (7 - n) * 0.03
discount[1] = 0.18 (6 unused nights)
discount[2] = 0.15 (5 unused nights)
...
discount[7] = 0 (0 unused nights)
```

**Combined Markup**:
```
combinedMarkup = siteMarkup + unitMarkup
Default: 0.17 + 0 = 0.17
```

**Markup and Discount Multiplier Array**:
```
multiplier[n] = (1 + combinedMarkup) × (1 - unusedNightsDiscount[n])
```

**Nightly Price Array** (guest-facing):
```
nightlyPrice[n] = hostCompensation[n] × multiplier[n]
```

**Starting Nightly Price** (lowest rate for search):
```
startingNightlyPrice = nightlyPrice[7]  // 7-night rate is always lowest
```

**Slope** (price gradient):
```
slope = (nightlyPrice[1] - nightlyPrice[7]) / 6
```

---

## Validation Checklist

### Structural Validations

- [ ] All arrays have length 8 (indices 0-7)
- [ ] Index 0 is null for all arrays
- [ ] Indices 1-7 contain valid numbers

### Calculation Validations (Nightly)

- [ ] Host Compensation matches form input
- [ ] Unused Nights Discount follows `(7-n) * 0.03` formula
- [ ] Combined Markup = Site Markup (0.17) + Unit Markup (0)
- [ ] Multiplier = `(1 + markup) × (1 - discount)`
- [ ] Nightly Price = `Host Comp × Multiplier`
- [ ] Starting Nightly = nightlyPrice[7]
- [ ] Slope = `(price[1] - price[7]) / 6`

### Calculation Validations (Weekly)

- [ ] Host Compensation = weeklyCompensation / 7 (all indices same)
- [ ] Nightly Price reflects weekly prorated rate

### Calculation Validations (Monthly)

- [ ] Host Compensation = monthlyCompensation / 30 (all indices same)
- [ ] Nightly Price reflects monthly prorated rate

### Integration Validations

- [ ] Listing appears in search results
- [ ] Search displays correct Starting Nightly Price
- [ ] View listing page shows correct pricing grid
- [ ] Reservation flow uses correct Nightly Price for selected nights

---

## File References

### Pricing List Creation

| File | Purpose |
|------|---------|
| [supabase/functions/listing/handlers/create.ts](supabase/functions/listing/handlers/create.ts) | Listing creation handler |
| [supabase/functions/listing/handlers/submit.ts](supabase/functions/listing/handlers/submit.ts) | Full listing submission |
| [app/src/logic/calculators/pricingList/](app/src/logic/calculators/pricingList/) | Pure pricing functions |
| [app/src/logic/processors/pricingList/](app/src/logic/processors/pricingList/) | Data transformations |
| [app/src/logic/constants/pricingConstants.js](app/src/logic/constants/pricingConstants.js) | Pricing configuration |

### Listing Creation UI

| File | Purpose |
|------|---------|
| [app/src/islands/pages/SelfListingPage/](app/src/islands/pages/SelfListingPage/) | Listing creation wizard |
| [app/src/islands/pages/SelfListingPage/sections/Section4Pricing.tsx](app/src/islands/pages/SelfListingPage/sections/Section4Pricing.tsx) | Pricing form section |
| [app/src/islands/pages/SelfListingPage/store/useListingStore.ts](app/src/islands/pages/SelfListingPage/store/useListingStore.ts) | Form state management |

### Unit Test Page

| File | Purpose |
|------|---------|
| [app/src/islands/pages/ZPricingUnitTestPage/ZPricingUnitTestPage.jsx](app/src/islands/pages/ZPricingUnitTestPage/ZPricingUnitTestPage.jsx) | Test page UI |
| [app/src/islands/pages/ZPricingUnitTestPage/useZPricingUnitTestPageLogic.js](app/src/islands/pages/ZPricingUnitTestPage/useZPricingUnitTestPageLogic.js) | Test page logic |
| [app/src/islands/pages/ZPricingUnitTestPage/components/Section10PricingListGrid.jsx](app/src/islands/pages/ZPricingUnitTestPage/components/Section10PricingListGrid.jsx) | Pricing grid display |

### Pricing Calculators

| File | Purpose |
|------|---------|
| [app/src/logic/calculators/pricingList/calculateHostCompensationArray.js](app/src/logic/calculators/pricingList/calculateHostCompensationArray.js) | Host compensation array |
| [app/src/logic/calculators/pricingList/calculateNightlyPricesArray.js](app/src/logic/calculators/pricingList/calculateNightlyPricesArray.js) | Guest-facing prices |
| [app/src/logic/calculators/pricingList/calculateUnusedNightsDiscountArray.js](app/src/logic/calculators/pricingList/calculateUnusedNightsDiscountArray.js) | Discount array |
| [app/src/logic/calculators/pricingList/calculateMarkupAndDiscountMultipliersArray.js](app/src/logic/calculators/pricingList/calculateMarkupAndDiscountMultipliersArray.js) | Multiplier array |

---

## Execution Command

To run the full E2E test suite, execute the following orchestration prompt:

```
Execute the E2E Pricing List Test Orchestration defined in this document.

Start with Phase 1 (Environment Verification) and proceed sequentially through all 10 phases.

For each listing type (Nightly, Weekly, Monthly):
1. Create the listing via Playwright MCP
2. Query and validate pricing_list via Supabase MCP
3. Cross-validate on Unit Test Page via Playwright MCP

Report all validation failures with:
- Expected values
- Actual values
- Calculation formula used
- Suggested fix

If issues are found, proceed to Phase 9 (Fix Implementation) before Phase 10 (Regression Test).
```

---

*Document generated: 2026-01-29T16:53:49*
*Target: splitlease-backend-dev*
