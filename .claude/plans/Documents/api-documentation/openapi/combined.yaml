openapi: 3.0.3
info:
  title: Split Lease API
  description: |
    Complete API documentation for Split Lease Supabase Edge Functions.

    ## Overview
    Split Lease is a flexible rental marketplace for NYC properties enabling split scheduling,
    repeat stays, and proposal-based booking.

    ## Request Pattern
    All Edge Functions use an action-based request pattern:
    ```json
    {
      "action": "action_name",
      "payload": { ... }
    }
    ```

    ## Authentication
    - **JWT Token**: Primary method via `Authorization: Bearer {token}` header
    - **Legacy User ID**: Fallback via `user_id` in payload
    - **Public**: Some actions don't require authentication
    - **Prompt-Based**: AI Gateway uses prompt-specific auth

    ## Day Indexing
    All day indices use 0-based indexing (0=Sunday, 6=Saturday).

    ## ID Format
    Bubble-style IDs: `1234567890123x0987654321`
  version: 1.0.0
  contact:
    name: Split Lease Engineering

servers:
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions
    variables:
      project-ref:
        default: your-project-ref
        description: Supabase project reference

tags:
  - name: Proposal
    description: Rental proposal operations
  - name: Listing
    description: Property listing operations
  - name: Lease
    description: Lease management operations
  - name: Messages
    description: Real-time messaging operations
  - name: Auth
    description: Authentication operations
  - name: AI
    description: AI Gateway operations

paths:
  # ==========================================================================
  # PROPOSAL ENDPOINTS
  # ==========================================================================
  /proposal:
    post:
      tags:
        - Proposal
      summary: Proposal Operations
      description: |
        All proposal operations via action-based routing.

        **Available Actions:**
        - `create` - Create new proposal
        - `update` - Update proposal fields
        - `get` - Get proposal details
        - `suggest` - AI-powered schedule suggestions
        - `create_suggested` - Create from AI suggestion
        - `create_mockup` - Create mockup proposal
        - `get_prefill_data` - Get form prefill data
        - `createTestProposal` - Create test proposal
        - `createTestRentalApplication` - Create test application
        - `acceptProposal` - Accept proposal
        - `createCounteroffer` - Create host counteroffer
        - `acceptCounteroffer` - Accept counteroffer
      operationId: proposalAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum:
                    - create
                    - update
                    - get
                    - suggest
                    - create_suggested
                    - create_mockup
                    - get_prefill_data
                    - createTestProposal
                    - createTestRentalApplication
                    - acceptProposal
                    - createCounteroffer
                    - acceptCounteroffer
                payload:
                  type: object
            examples:
              create:
                summary: Create proposal
                value:
                  action: create
                  payload:
                    listing_id: "1234567890123x0987654321"
                    days_selected: [1, 2, 3]
                    weeks_selected: [1, 2, 3, 4]
                    proposed_start_date: "2025-03-01"
                    proposed_end_date: "2025-06-30"
              get:
                summary: Get proposal
                value:
                  action: get
                  payload:
                    proposal_id: "1234567890123x0987654321"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'
      security:
        - bearerAuth: []
        - {}

  # ==========================================================================
  # LISTING ENDPOINTS
  # ==========================================================================
  /listing:
    post:
      tags:
        - Listing
      summary: Listing Operations
      description: |
        All listing operations via action-based routing.

        **Available Actions:**
        - `create` - Create draft listing
        - `get` - Get listing details
        - `submit` - Submit listing for review
        - `delete` - Delete listing
      operationId: listingAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [create, get, submit, delete]
                payload:
                  type: object
            examples:
              create:
                summary: Create listing
                value:
                  action: create
                  payload:
                    listing_name: "Cozy Brooklyn Apartment"
              get:
                summary: Get listing
                value:
                  action: get
                  payload:
                    listing_id: "1234567890123x0987654321"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'
      security:
        - bearerAuth: []
        - {}

  # ==========================================================================
  # LEASE ENDPOINTS
  # ==========================================================================
  /lease:
    post:
      tags:
        - Lease
      summary: Lease Operations
      description: |
        All lease operations via action-based routing.

        **Available Actions:**
        - `create` - Create lease from proposal
        - `get` - Get lease details
        - `generate_dates` - Generate stay dates
        - `get_host_leases` - Get host's leases
        - `get_guest_leases` - Get guest's leases
      operationId: leaseAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [create, get, generate_dates, get_host_leases, get_guest_leases]
                payload:
                  type: object
            examples:
              create:
                summary: Create lease
                value:
                  action: create
                  payload:
                    proposalId: "1234567890123x0987654321"
                    isCounteroffer: false
                    fourWeekRent: 2000
                    fourWeekCompensation: 1800
              get_host_leases:
                summary: Get host leases
                value:
                  action: get_host_leases
                  payload:
                    limit: 20
                    offset: 0
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'
      security:
        - bearerAuth: []
        - {}

  # ==========================================================================
  # MESSAGES ENDPOINTS
  # ==========================================================================
  /messages:
    post:
      tags:
        - Messages
      summary: Message Operations
      description: |
        All messaging operations via action-based routing.

        **Available Actions:**
        - `send_message` - Send message
        - `get_messages` - Get thread messages
        - `get_threads` - Get user's threads
        - `send_guest_inquiry` - Public inquiry
        - `create_proposal_thread` - Create proposal thread
        - `send_splitbot_message` - Send SplitBot message
        - `admin_get_all_threads` - Admin: list threads
        - `admin_delete_thread` - Admin: delete thread
        - `admin_send_reminder` - Admin: send reminder
      operationId: messagesAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum:
                    - send_message
                    - get_messages
                    - get_threads
                    - send_guest_inquiry
                    - create_proposal_thread
                    - send_splitbot_message
                    - admin_get_all_threads
                    - admin_delete_thread
                    - admin_send_reminder
                payload:
                  type: object
            examples:
              send_message:
                summary: Send message
                value:
                  action: send_message
                  payload:
                    thread_id: "1234567890123x0987654321"
                    message_body: "Hello!"
              send_guest_inquiry:
                summary: Guest inquiry
                value:
                  action: send_guest_inquiry
                  payload:
                    guest_name: "John Doe"
                    guest_email: "john@example.com"
                    listing_id: "1234567890123x0987654321"
                    message: "I'm interested"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'
      security:
        - bearerAuth: []
        - {}

  # ==========================================================================
  # AUTH ENDPOINTS
  # ==========================================================================
  /auth-user:
    post:
      tags:
        - Auth
      summary: Authentication Operations
      description: |
        All authentication operations via action-based routing.

        **Available Actions:**
        - `login` - Authenticate user
        - `signup` - Create new user
        - `logout` - Log out user
        - `validate` - Validate token
        - `request_password_reset` - Request reset email
        - `update_password` - Update password
        - `generate_magic_link` - Generate magic link
        - `oauth_signup` - OAuth signup
        - `oauth_login` - OAuth login
        - `send_magic_link_sms` - Send SMS magic link
        - `verify_email` - Verify email

        Note: All auth actions are public by design.
      operationId: authUserAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum:
                    - login
                    - signup
                    - logout
                    - validate
                    - request_password_reset
                    - update_password
                    - generate_magic_link
                    - oauth_signup
                    - oauth_login
                    - send_magic_link_sms
                    - verify_email
                payload:
                  type: object
            examples:
              login:
                summary: Login
                value:
                  action: login
                  payload:
                    email: "user@example.com"
                    password: "securepassword"
              signup:
                summary: Signup
                value:
                  action: signup
                  payload:
                    email: "newuser@example.com"
                    password: "securepassword"
                    retype: "securepassword"
                    additionalData:
                      firstName: "John"
                      lastName: "Doe"
                      userType: "Guest"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # ==========================================================================
  # AI GATEWAY ENDPOINTS
  # ==========================================================================
  /ai-gateway:
    post:
      tags:
        - AI
      summary: AI Gateway Operations
      description: |
        AI completion and streaming operations.

        **Available Actions:**
        - `complete` - Non-streaming completion
        - `stream` - Streaming completion (SSE)

        **Public Prompts** (no auth):
        - listing-description
        - listing-title
        - neighborhood-description
        - parse-call-transcription
        - negotiation-summary-suggested
        - negotiation-summary-counteroffer
        - negotiation-summary-host
        - echo-test

        **Protected Prompts** (JWT required):
        - deepfake-script
        - narration-script
        - jingle-lyrics
      operationId: aiGatewayAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - payload
              properties:
                action:
                  type: string
                  enum: [complete, stream]
                payload:
                  type: object
                  required:
                    - prompt_key
                  properties:
                    prompt_key:
                      type: string
                    variables:
                      type: object
                    options:
                      type: object
                      properties:
                        model:
                          type: string
                          enum: [gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo]
                        temperature:
                          type: number
                        max_tokens:
                          type: integer
            examples:
              complete:
                summary: Complete
                value:
                  action: complete
                  payload:
                    prompt_key: "listing-description"
                    variables:
                      neighborhood: "Brooklyn Heights"
                      beds: 2
                      bathrooms: 1
              stream:
                summary: Stream
                value:
                  action: stream
                  payload:
                    prompt_key: "listing-description"
                    variables:
                      neighborhood: "Brooklyn Heights"
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE stream of completion chunks
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthenticationError'
        '500':
          $ref: '#/components/responses/InternalError'
      security:
        - bearerAuth: []
        - {}

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          description: Action-specific response data

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Programmatic error code
        details:
          type: object
          description: Additional error context

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "Missing required field: listing_id"
            code: "VALIDATION_ERROR"

    AuthenticationError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "Invalid or expired token"
            code: "AUTHENTICATION_REQUIRED"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "An unexpected error occurred"
            code: "INTERNAL_ERROR"
