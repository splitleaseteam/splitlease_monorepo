openapi: 3.0.3
info:
  title: Split Lease AI Gateway API
  description: |
    AI Gateway Edge Function for Split Lease marketplace.
    Proxies AI requests to OpenAI with prompt templating and data loaders.

    All requests use the action-based pattern: `{ action, payload }`.

    ## Prompt System
    - Prompts are registered via `registerPrompt()` in the prompt registry
    - Supports `{{variable}}` interpolation for user-provided values
    - Supports `{{loader.field}}` for data loader values
    - Public prompts don't require authentication

    ## Available Prompts
    - `listing-description` - Generate listing descriptions (public)
    - `listing-title` - Generate listing titles (public)
    - `neighborhood-description` - Generate neighborhood descriptions (public)
    - `parse-call-transcription` - Parse call transcriptions (public)
    - `negotiation-summary-suggested` - Summarize suggested proposals (public)
    - `negotiation-summary-counteroffer` - Summarize counteroffers (public)
    - `negotiation-summary-host` - Generate host proposal summaries (public)
    - `deepfake-script` - Generate deepfake video scripts
    - `narration-script` - Generate narration scripts
    - `jingle-lyrics` - Generate jingle lyrics
  version: 1.0.0
  contact:
    name: Split Lease Engineering

servers:
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions

paths:
  /ai-gateway:
    post:
      summary: AI Gateway Operations
      description: AI completion and streaming operations
      operationId: aiGatewayAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CompleteRequest'
                - $ref: '#/components/schemas/StreamRequest'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompleteResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE stream of completion chunks
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required (for non-public prompts)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []
        - {}  # Public prompts don't require auth

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token (required for non-public prompts)

  schemas:
    # =========================================================================
    # REQUEST SCHEMAS
    # =========================================================================

    CompleteRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [complete]
        payload:
          $ref: '#/components/schemas/AIPayload'
      example:
        action: complete
        payload:
          prompt_key: "listing-description"
          variables:
            neighborhood: "Brooklyn Heights"
            amenities: ["WiFi", "Air Conditioning", "Washer/Dryer"]
            beds: 2
            bathrooms: 1
            space_type: "Entire apartment"

    StreamRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [stream]
        payload:
          $ref: '#/components/schemas/AIPayload'
      example:
        action: stream
        payload:
          prompt_key: "listing-description"
          variables:
            neighborhood: "Brooklyn Heights"
            amenities: ["WiFi", "Air Conditioning"]
            beds: 2
            bathrooms: 1

    AIPayload:
      type: object
      required:
        - prompt_key
      properties:
        prompt_key:
          type: string
          description: |
            Registered prompt key. Public prompts:
            - listing-description
            - listing-title
            - neighborhood-description
            - parse-call-transcription
            - negotiation-summary-suggested
            - negotiation-summary-counteroffer
            - negotiation-summary-host
            - echo-test
        variables:
          type: object
          additionalProperties: true
          description: Variables for template interpolation ({{variable}})
        options:
          type: object
          properties:
            model:
              type: string
              enum: [gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo]
              description: Override default model
            temperature:
              type: number
              minimum: 0
              maximum: 2
              description: Override default temperature
            max_tokens:
              type: integer
              minimum: 1
              maximum: 4096
              description: Override default max tokens

    # =========================================================================
    # RESPONSE SCHEMAS
    # =========================================================================

    CompleteResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          properties:
            content:
              type: string
              description: Generated text content
            model:
              type: string
              description: Model used for generation
            usage:
              type: object
              properties:
                prompt_tokens:
                  type: integer
                completion_tokens:
                  type: integer
                total_tokens:
                  type: integer
      example:
        success: true
        data:
          content: "Welcome to this charming Brooklyn Heights apartment..."
          model: "gpt-4o"
          usage:
            prompt_tokens: 150
            completion_tokens: 200
            total_tokens: 350

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: string

    # =========================================================================
    # PROMPT CONFIGURATION
    # =========================================================================

    PromptConfig:
      type: object
      description: Prompt configuration schema (internal reference)
      properties:
        key:
          type: string
        name:
          type: string
        description:
          type: string
        systemPrompt:
          type: string
        userPromptTemplate:
          type: string
          description: Supports {{variable}} interpolation
        defaults:
          type: object
          properties:
            model:
              type: string
              enum: [gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo]
            temperature:
              type: number
            maxTokens:
              type: integer
        requiredLoaders:
          type: array
          items:
            type: string
          description: Data loaders to execute before prompt
        responseFormat:
          type: string
          enum: [text, json]
        jsonSchema:
          type: object
          description: JSON schema for structured responses

# =========================================================================
# PROMPT-BASED AUTHENTICATION MATRIX
# =========================================================================
# Prompt Key                     | Auth Required | Notes
# -------------------------------|---------------|---------------------------
# listing-description            | No            | Public - self-listing
# listing-title                  | No            | Public - self-listing
# neighborhood-description       | No            | Public - self-listing
# parse-call-transcription       | No            | Public - voice processing
# echo-test                      | No            | Public - testing
# negotiation-summary-suggested  | No            | Public - proposal flow
# negotiation-summary-counteroffer | No          | Public - proposal flow
# negotiation-summary-host       | No            | Public - proposal flow
# deepfake-script                | Yes (JWT)     | Protected - AI tools
# narration-script               | Yes (JWT)     | Protected - AI tools
# jingle-lyrics                  | Yes (JWT)     | Protected - AI tools
#
# NOTE: Authentication is based on prompt_key, not action.
# All public prompts are defined in PUBLIC_PROMPTS set in index.ts
