openapi: 3.0.3
info:
  title: Split Lease Listing API
  description: |
    Listing Edge Function for Split Lease marketplace.
    Handles listing CRUD operations with Supabase-first pattern.

    All requests use the action-based pattern: `{ action, payload }`.
  version: 1.0.0
  contact:
    name: Split Lease Engineering

servers:
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions

paths:
  /listing:
    post:
      summary: Listing Operations
      description: All listing operations via action-based routing
      operationId: listingAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CreateListingRequest'
                - $ref: '#/components/schemas/GetListingRequest'
                - $ref: '#/components/schemas/SubmitListingRequest'
                - $ref: '#/components/schemas/DeleteListingRequest'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # =========================================================================
    # REQUEST SCHEMAS
    # =========================================================================

    CreateListingRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [create]
        payload:
          $ref: '#/components/schemas/CreateListingPayload'
      example:
        action: create
        payload:
          listing_name: "Cozy Brooklyn Apartment"
          user_email: "host@example.com"

    CreateListingPayload:
      type: object
      required:
        - listing_name
      properties:
        listing_name:
          type: string
          description: Name/title for the listing
        user_email:
          type: string
          format: email
          description: Host's email (optional - for logged-in users)

    GetListingRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [get]
        payload:
          $ref: '#/components/schemas/GetListingPayload'
      example:
        action: get
        payload:
          listing_id: "1234567890123x0987654321"

    GetListingPayload:
      type: object
      required:
        - listing_id
      properties:
        listing_id:
          type: string
          description: Listing ID to retrieve

    SubmitListingRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [submit]
        payload:
          $ref: '#/components/schemas/SubmitListingPayload'
      example:
        action: submit
        payload:
          listing_id: "1234567890123x0987654321"
          user_email: "host@example.com"
          listing_data:
            Name: "Cozy Brooklyn Apartment"
            "Type of Space": "Entire apartment"
            Bedrooms: 2
            Beds: 2
            Bathrooms: 1
            City: "Brooklyn"
            State: "NY"
            Zip: "11201"

    SubmitListingPayload:
      type: object
      required:
        - listing_id
        - user_email
        - listing_data
      properties:
        listing_id:
          type: string
          description: Listing ID to update
        user_email:
          type: string
          format: email
          description: Host's email for user association
        user_unique_id:
          type: string
          description: Optional user ID
        listing_data:
          $ref: '#/components/schemas/ListingData'

    ListingData:
      type: object
      description: Complete listing form data
      properties:
        # Basic Info
        Name:
          type: string
        "Type of Space":
          type: string
          enum: [Entire apartment, Private room, Shared room]
        Bedrooms:
          type: integer
        Beds:
          type: integer
        Bathrooms:
          type: number
        "Type of Kitchen":
          type: string
        "Type of Parking":
          type: string

        # Address
        Address:
          type: string
        "Street Number":
          type: string
        Street:
          type: string
        City:
          type: string
        State:
          type: string
        Zip:
          type: string
        Neighborhood:
          type: string
        Latitude:
          type: number
        Longitude:
          type: number

        # Amenities
        "Amenities Inside Unit":
          type: array
          items:
            type: string
        "Amenities Outside Unit":
          type: array
          items:
            type: string

        # Descriptions
        "Description of Lodging":
          type: string
        "Neighborhood Description":
          type: string

        # Lease Style
        "Rental Type":
          type: string
          enum: [nightly, weekly, monthly]
        "Available Nights":
          type: array
          items:
            type: string
        "Weekly Pattern":
          type: string

        # Pricing
        "Damage Deposit":
          type: number
        "Maintenance Fee":
          type: number
        "Monthly Compensation":
          type: number
        "Weekly Compensation":
          type: number
        "Price 1 night selected":
          type: number
        "Price 2 nights selected":
          type: number
        "Price 3 nights selected":
          type: number
        "Price 4 nights selected":
          type: number
        "Price 5 nights selected":
          type: number
        "Price 6 nights selected":
          type: number
        "Price 7 nights selected":
          type: number

        # Rules
        "Cancellation Policy":
          type: string
        "Preferred Gender":
          type: string
        "Number of Guests":
          type: integer
        "Check-In Time":
          type: string
        "Check-Out Time":
          type: string
        "Ideal Min Duration":
          type: integer
        "Ideal Max Duration":
          type: integer
        "House Rules":
          type: array
          items:
            type: string
        "Blocked Dates":
          type: array
          items:
            type: string
            format: date

        # Safety & Review
        "Safety Features":
          type: array
          items:
            type: string
        "Square Footage":
          type: number
        "First Day Available":
          type: string
          format: date
        "Previous Reviews Link":
          type: string
        "Optional Notes":
          type: string

        # Status
        Status:
          type: string
        "Is Draft":
          type: boolean

    DeleteListingRequest:
      type: object
      required:
        - action
        - payload
      properties:
        action:
          type: string
          enum: [delete]
        payload:
          $ref: '#/components/schemas/DeleteListingPayload'
      example:
        action: delete
        payload:
          listing_id: "1234567890123x0987654321"
          user_email: "host@example.com"

    DeleteListingPayload:
      type: object
      required:
        - listing_id
      properties:
        listing_id:
          type: string
          description: Listing ID to delete (soft delete)
        user_email:
          type: string
          format: email
          description: Optional email for ownership verification

    # =========================================================================
    # RESPONSE SCHEMAS
    # =========================================================================

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          oneOf:
            - $ref: '#/components/schemas/CreateListingResponse'
            - $ref: '#/components/schemas/GetListingResponse'
            - $ref: '#/components/schemas/SubmitListingResponse'
            - $ref: '#/components/schemas/DeleteListingResponse'

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: string

    CreateListingResponse:
      type: object
      properties:
        _id:
          type: string
          description: Generated listing ID
        listing_id:
          type: string
          description: Same as _id
        Name:
          type: string
          description: Listing name
        Status:
          type: string
          description: Initial status (Draft)
        Active:
          type: boolean
          description: Whether listing is active
        "Host User":
          type: string
          description: User ID of host (if logged in)
        "Created Date":
          type: string
          format: date-time
        "Modified Date":
          type: string
          format: date-time

    GetListingResponse:
      type: object
      description: Full listing data from Bubble Data API
      additionalProperties: true

    SubmitListingResponse:
      type: object
      properties:
        _id:
          type: string
        listing_id:
          type: string
        status:
          type: string
        name:
          type: string
        message:
          type: string
          description: Success message
      additionalProperties: true

    DeleteListingResponse:
      type: object
      properties:
        deleted:
          type: boolean
          enum: [true]
        listing_id:
          type: string
        deletedAt:
          type: string
          format: date-time

# =========================================================================
# ACTION AUTHENTICATION MATRIX
# =========================================================================
# Action  | Auth Required | Notes
# --------|---------------|------------------------------------------
# create  | No            | Public (user_email optional)
# get     | No            | Public read
# submit  | Yes (JWT)     | Protected - validates via user_email
# delete  | No            | Public (Bubble workflow handles auth)
